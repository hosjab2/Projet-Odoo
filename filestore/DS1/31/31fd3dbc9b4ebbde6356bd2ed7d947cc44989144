
/* /web_editor/static/lib/cropperjs/cropper.js defined in bundle 'web_editor.assets_wysiwyg' */
(function(global,factory){typeof exports==='object'&&typeof module!=='undefined'?module.exports=factory():typeof define==='function'&&define.amd?define(factory):(global=global||self,global.Cropper=factory());}(this,function(){'use strict';function _typeof(obj){if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){_typeof=function(obj){return typeof obj;};}else{_typeof=function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};}
return _typeof(obj);}
function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}
function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}
function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor;}
function _toConsumableArray(arr){return _arrayWithoutHoles(arr)||_iterableToArray(arr)||_nonIterableSpread();}
function _arrayWithoutHoles(arr){if(Array.isArray(arr)){for(var i=0,arr2=new Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2;}}
function _iterableToArray(iter){if(Symbol.iterator in Object(iter)||Object.prototype.toString.call(iter)==="[object Arguments]")return Array.from(iter);}
function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance");}
var IS_BROWSER=typeof window!=='undefined'&&typeof window.document!=='undefined';var WINDOW=IS_BROWSER?window:{};var IS_TOUCH_DEVICE=IS_BROWSER?'ontouchstart'in WINDOW.document.documentElement:false;var HAS_POINTER_EVENT=IS_BROWSER?'PointerEvent'in WINDOW:false;var NAMESPACE='cropper';var ACTION_ALL='all';var ACTION_CROP='crop';var ACTION_MOVE='move';var ACTION_ZOOM='zoom';var ACTION_EAST='e';var ACTION_WEST='w';var ACTION_SOUTH='s';var ACTION_NORTH='n';var ACTION_NORTH_EAST='ne';var ACTION_NORTH_WEST='nw';var ACTION_SOUTH_EAST='se';var ACTION_SOUTH_WEST='sw';var CLASS_CROP="".concat(NAMESPACE,"-crop");var CLASS_DISABLED="".concat(NAMESPACE,"-disabled");var CLASS_HIDDEN="".concat(NAMESPACE,"-hidden");var CLASS_HIDE="".concat(NAMESPACE,"-hide");var CLASS_INVISIBLE="".concat(NAMESPACE,"-invisible");var CLASS_MODAL="".concat(NAMESPACE,"-modal");var CLASS_MOVE="".concat(NAMESPACE,"-move");var DATA_ACTION="".concat(NAMESPACE,"Action");var DATA_PREVIEW="".concat(NAMESPACE,"Preview");var DRAG_MODE_CROP='crop';var DRAG_MODE_MOVE='move';var DRAG_MODE_NONE='none';var EVENT_CROP='crop';var EVENT_CROP_END='cropend';var EVENT_CROP_MOVE='cropmove';var EVENT_CROP_START='cropstart';var EVENT_DBLCLICK='dblclick';var EVENT_TOUCH_START=IS_TOUCH_DEVICE?'touchstart':'mousedown';var EVENT_TOUCH_MOVE=IS_TOUCH_DEVICE?'touchmove':'mousemove';var EVENT_TOUCH_END=IS_TOUCH_DEVICE?'touchend touchcancel':'mouseup';var EVENT_POINTER_DOWN=HAS_POINTER_EVENT?'pointerdown':EVENT_TOUCH_START;var EVENT_POINTER_MOVE=HAS_POINTER_EVENT?'pointermove':EVENT_TOUCH_MOVE;var EVENT_POINTER_UP=HAS_POINTER_EVENT?'pointerup pointercancel':EVENT_TOUCH_END;var EVENT_READY='ready';var EVENT_RESIZE='resize';var EVENT_WHEEL='wheel';var EVENT_ZOOM='zoom';var MIME_TYPE_JPEG='image/jpeg';var REGEXP_ACTIONS=/^e|w|s|n|se|sw|ne|nw|all|crop|move|zoom$/;var REGEXP_DATA_URL=/^data:/;var REGEXP_DATA_URL_JPEG=/^data:image\/jpeg;base64,/;var REGEXP_TAG_NAME=/^img|canvas$/i;var MIN_CONTAINER_WIDTH=200;var MIN_CONTAINER_HEIGHT=100;var DEFAULTS={viewMode:0,dragMode:DRAG_MODE_CROP,initialAspectRatio:NaN,aspectRatio:NaN,data:null,preview:'',responsive:true,restore:true,checkCrossOrigin:true,checkOrientation:true,modal:true,guides:true,center:true,highlight:true,background:true,autoCrop:true,autoCropArea:0.8,movable:true,rotatable:true,scalable:true,zoomable:true,zoomOnTouch:true,zoomOnWheel:true,wheelZoomRatio:0.1,cropBoxMovable:true,cropBoxResizable:true,toggleDragModeOnDblclick:true,minCanvasWidth:0,minCanvasHeight:0,minCropBoxWidth:0,minCropBoxHeight:0,minContainerWidth:200,minContainerHeight:100,ready:null,cropstart:null,cropmove:null,cropend:null,crop:null,zoom:null};var TEMPLATE='<div class="cropper-container" touch-action="none">'+'<div class="cropper-wrap-box">'+'<div class="cropper-canvas"></div>'+'</div>'+'<div class="cropper-drag-box"></div>'+'<div class="cropper-crop-box">'+'<span class="cropper-view-box"></span>'+'<span class="cropper-dashed dashed-h"></span>'+'<span class="cropper-dashed dashed-v"></span>'+'<span class="cropper-center"></span>'+'<span class="cropper-face"></span>'+'<span class="cropper-line line-e" data-cropper-action="e"></span>'+'<span class="cropper-line line-n" data-cropper-action="n"></span>'+'<span class="cropper-line line-w" data-cropper-action="w"></span>'+'<span class="cropper-line line-s" data-cropper-action="s"></span>'+'<span class="cropper-point point-e" data-cropper-action="e"></span>'+'<span class="cropper-point point-n" data-cropper-action="n"></span>'+'<span class="cropper-point point-w" data-cropper-action="w"></span>'+'<span class="cropper-point point-s" data-cropper-action="s"></span>'+'<span class="cropper-point point-ne" data-cropper-action="ne"></span>'+'<span class="cropper-point point-nw" data-cropper-action="nw"></span>'+'<span class="cropper-point point-sw" data-cropper-action="sw"></span>'+'<span class="cropper-point point-se" data-cropper-action="se"></span>'+'</div>'+'</div>';var isNaN=Number.isNaN||WINDOW.isNaN;function isNumber(value){return typeof value==='number'&&!isNaN(value);}
var isPositiveNumber=function isPositiveNumber(value){return value>0&&value<Infinity;};function isUndefined(value){return typeof value==='undefined';}
function isObject(value){return _typeof(value)==='object'&&value!==null;}
var hasOwnProperty=Object.prototype.hasOwnProperty;function isPlainObject(value){if(!isObject(value)){return false;}
try{var _constructor=value.constructor;var prototype=_constructor.prototype;return _constructor&&prototype&&hasOwnProperty.call(prototype,'isPrototypeOf');}catch(error){return false;}}
function isFunction(value){return typeof value==='function';}
var slice=Array.prototype.slice;function toArray(value){return Array.from?Array.from(value):slice.call(value);}
function forEach(data,callback){if(data&&isFunction(callback)){if(Array.isArray(data)||isNumber(data.length)){toArray(data).forEach(function(value,key){callback.call(data,value,key,data);});}else if(isObject(data)){Object.keys(data).forEach(function(key){callback.call(data,data[key],key,data);});}}
return data;}
var assign=Object.assign||function assign(target){for(var _len=arguments.length,args=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key];}
if(isObject(target)&&args.length>0){args.forEach(function(arg){if(isObject(arg)){Object.keys(arg).forEach(function(key){target[key]=arg[key];});}});}
return target;};var REGEXP_DECIMALS=/\.\d*(?:0|9){12}\d*$/;function normalizeDecimalNumber(value){var times=arguments.length>1&&arguments[1]!==undefined?arguments[1]:100000000000;return REGEXP_DECIMALS.test(value)?Math.round(value*times)/times:value;}
var REGEXP_SUFFIX=/^width|height|left|top|marginLeft|marginTop$/;function setStyle(element,styles){var style=element.style;forEach(styles,function(value,property){if(REGEXP_SUFFIX.test(property)&&isNumber(value)){value="".concat(value,"px");}
style[property]=value;});}
function hasClass(element,value){return element.classList?element.classList.contains(value):element.className.indexOf(value)>-1;}
function addClass(element,value){if(!value){return;}
if(isNumber(element.length)){forEach(element,function(elem){addClass(elem,value);});return;}
if(element.classList){element.classList.add(value);return;}
var className=element.className.trim();if(!className){element.className=value;}else if(className.indexOf(value)<0){element.className="".concat(className," ").concat(value);}}
function removeClass(element,value){if(!value){return;}
if(isNumber(element.length)){forEach(element,function(elem){removeClass(elem,value);});return;}
if(element.classList){element.classList.remove(value);return;}
if(element.className.indexOf(value)>=0){element.className=element.className.replace(value,'');}}
function toggleClass(element,value,added){if(!value){return;}
if(isNumber(element.length)){forEach(element,function(elem){toggleClass(elem,value,added);});return;}
if(added){addClass(element,value);}else{removeClass(element,value);}}
var REGEXP_CAMEL_CASE=/([a-z\d])([A-Z])/g;function toParamCase(value){return value.replace(REGEXP_CAMEL_CASE,'$1-$2').toLowerCase();}
function getData(element,name){if(isObject(element[name])){return element[name];}
if(element.dataset){return element.dataset[name];}
return element.getAttribute("data-".concat(toParamCase(name)));}
function setData(element,name,data){if(isObject(data)){element[name]=data;}else if(element.dataset){element.dataset[name]=data;}else{element.setAttribute("data-".concat(toParamCase(name)),data);}}
function removeData(element,name){if(isObject(element[name])){try{delete element[name];}catch(error){element[name]=undefined;}}else if(element.dataset){try{delete element.dataset[name];}catch(error){element.dataset[name]=undefined;}}else{element.removeAttribute("data-".concat(toParamCase(name)));}}
var REGEXP_SPACES=/\s\s*/;var onceSupported=function(){var supported=false;if(IS_BROWSER){var once=false;var listener=function listener(){};var options=Object.defineProperty({},'once',{get:function get(){supported=true;return once;},set:function set(value){once=value;}});WINDOW.addEventListener('test',listener,options);WINDOW.removeEventListener('test',listener,options);}
return supported;}();function removeListener(element,type,listener){var options=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};var handler=listener;type.trim().split(REGEXP_SPACES).forEach(function(event){if(!onceSupported){var listeners=element.listeners;if(listeners&&listeners[event]&&listeners[event][listener]){handler=listeners[event][listener];delete listeners[event][listener];if(Object.keys(listeners[event]).length===0){delete listeners[event];}
if(Object.keys(listeners).length===0){delete element.listeners;}}}
element.removeEventListener(event,handler,options);});}
function addListener(element,type,listener){var options=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};var _handler=listener;type.trim().split(REGEXP_SPACES).forEach(function(event){if(options.once&&!onceSupported){var _element$listeners=element.listeners,listeners=_element$listeners===void 0?{}:_element$listeners;_handler=function handler(){delete listeners[event][listener];element.removeEventListener(event,_handler,options);for(var _len2=arguments.length,args=new Array(_len2),_key2=0;_key2<_len2;_key2++){args[_key2]=arguments[_key2];}
listener.apply(element,args);};if(!listeners[event]){listeners[event]={};}
if(listeners[event][listener]){element.removeEventListener(event,listeners[event][listener],options);}
listeners[event][listener]=_handler;element.listeners=listeners;}
element.addEventListener(event,_handler,options);});}
function dispatchEvent(element,type,data){var event;if(isFunction(Event)&&isFunction(CustomEvent)){event=new CustomEvent(type,{detail:data,bubbles:true,cancelable:true});}else{event=document.createEvent('CustomEvent');event.initCustomEvent(type,true,true,data);}
return element.dispatchEvent(event);}
function getOffset(element){var box=element.getBoundingClientRect();return{left:box.left+(window.pageXOffset-document.documentElement.clientLeft),top:box.top+(window.pageYOffset-document.documentElement.clientTop)};}
var location=WINDOW.location;var REGEXP_ORIGINS=/^(\w+:)\/\/([^:/?#]*):?(\d*)/i;function isCrossOriginURL(url){var parts=url.match(REGEXP_ORIGINS);return parts!==null&&(parts[1]!==location.protocol||parts[2]!==location.hostname||parts[3]!==location.port);}
function addTimestamp(url){var timestamp="timestamp=".concat(new Date().getTime());return url+(url.indexOf('?')===-1?'?':'&')+timestamp;}
function getTransforms(_ref){var rotate=_ref.rotate,scaleX=_ref.scaleX,scaleY=_ref.scaleY,translateX=_ref.translateX,translateY=_ref.translateY;var values=[];if(isNumber(translateX)&&translateX!==0){values.push("translateX(".concat(translateX,"px)"));}
if(isNumber(translateY)&&translateY!==0){values.push("translateY(".concat(translateY,"px)"));}
if(isNumber(rotate)&&rotate!==0){values.push("rotate(".concat(rotate,"deg)"));}
if(isNumber(scaleX)&&scaleX!==1){values.push("scaleX(".concat(scaleX,")"));}
if(isNumber(scaleY)&&scaleY!==1){values.push("scaleY(".concat(scaleY,")"));}
var transform=values.length?values.join(' '):'none';return{WebkitTransform:transform,msTransform:transform,transform:transform};}
function getMaxZoomRatio(pointers){var pointers2=assign({},pointers);var ratios=[];forEach(pointers,function(pointer,pointerId){delete pointers2[pointerId];forEach(pointers2,function(pointer2){var x1=Math.abs(pointer.startX-pointer2.startX);var y1=Math.abs(pointer.startY-pointer2.startY);var x2=Math.abs(pointer.endX-pointer2.endX);var y2=Math.abs(pointer.endY-pointer2.endY);var z1=Math.sqrt(x1*x1+y1*y1);var z2=Math.sqrt(x2*x2+y2*y2);var ratio=(z2-z1)/z1;ratios.push(ratio);});});ratios.sort(function(a,b){return Math.abs(a)<Math.abs(b);});return ratios[0];}
function getPointer(_ref2,endOnly){var pageX=_ref2.pageX,pageY=_ref2.pageY;var end={endX:pageX,endY:pageY};return endOnly?end:assign({startX:pageX,startY:pageY},end);}
function getPointersCenter(pointers){var pageX=0;var pageY=0;var count=0;forEach(pointers,function(_ref3){var startX=_ref3.startX,startY=_ref3.startY;pageX+=startX;pageY+=startY;count+=1;});pageX/=count;pageY/=count;return{pageX:pageX,pageY:pageY};}
function getAdjustedSizes(_ref4)
{var aspectRatio=_ref4.aspectRatio,height=_ref4.height,width=_ref4.width;var type=arguments.length>1&&arguments[1]!==undefined?arguments[1]:'contain';var isValidWidth=isPositiveNumber(width);var isValidHeight=isPositiveNumber(height);if(isValidWidth&&isValidHeight){var adjustedWidth=height*aspectRatio;if(type==='contain'&&adjustedWidth>width||type==='cover'&&adjustedWidth<width){height=width/aspectRatio;}else{width=height*aspectRatio;}}else if(isValidWidth){height=width/aspectRatio;}else if(isValidHeight){width=height*aspectRatio;}
return{width:width,height:height};}
function getRotatedSizes(_ref5){var width=_ref5.width,height=_ref5.height,degree=_ref5.degree;degree=Math.abs(degree)%180;if(degree===90){return{width:height,height:width};}
var arc=degree%90*Math.PI/180;var sinArc=Math.sin(arc);var cosArc=Math.cos(arc);var newWidth=width*cosArc+height*sinArc;var newHeight=width*sinArc+height*cosArc;return degree>90?{width:newHeight,height:newWidth}:{width:newWidth,height:newHeight};}
function getSourceCanvas(image,_ref6,_ref7,_ref8){var imageAspectRatio=_ref6.aspectRatio,imageNaturalWidth=_ref6.naturalWidth,imageNaturalHeight=_ref6.naturalHeight,_ref6$rotate=_ref6.rotate,rotate=_ref6$rotate===void 0?0:_ref6$rotate,_ref6$scaleX=_ref6.scaleX,scaleX=_ref6$scaleX===void 0?1:_ref6$scaleX,_ref6$scaleY=_ref6.scaleY,scaleY=_ref6$scaleY===void 0?1:_ref6$scaleY;var aspectRatio=_ref7.aspectRatio,naturalWidth=_ref7.naturalWidth,naturalHeight=_ref7.naturalHeight;var _ref8$fillColor=_ref8.fillColor,fillColor=_ref8$fillColor===void 0?'transparent':_ref8$fillColor,_ref8$imageSmoothingE=_ref8.imageSmoothingEnabled,imageSmoothingEnabled=_ref8$imageSmoothingE===void 0?true:_ref8$imageSmoothingE,_ref8$imageSmoothingQ=_ref8.imageSmoothingQuality,imageSmoothingQuality=_ref8$imageSmoothingQ===void 0?'low':_ref8$imageSmoothingQ,_ref8$maxWidth=_ref8.maxWidth,maxWidth=_ref8$maxWidth===void 0?Infinity:_ref8$maxWidth,_ref8$maxHeight=_ref8.maxHeight,maxHeight=_ref8$maxHeight===void 0?Infinity:_ref8$maxHeight,_ref8$minWidth=_ref8.minWidth,minWidth=_ref8$minWidth===void 0?0:_ref8$minWidth,_ref8$minHeight=_ref8.minHeight,minHeight=_ref8$minHeight===void 0?0:_ref8$minHeight;var canvas=document.createElement('canvas');var context=canvas.getContext('2d');var maxSizes=getAdjustedSizes({aspectRatio:aspectRatio,width:maxWidth,height:maxHeight});var minSizes=getAdjustedSizes({aspectRatio:aspectRatio,width:minWidth,height:minHeight},'cover');var width=Math.min(maxSizes.width,Math.max(minSizes.width,naturalWidth));var height=Math.min(maxSizes.height,Math.max(minSizes.height,naturalHeight));var destMaxSizes=getAdjustedSizes({aspectRatio:imageAspectRatio,width:maxWidth,height:maxHeight});var destMinSizes=getAdjustedSizes({aspectRatio:imageAspectRatio,width:minWidth,height:minHeight},'cover');var destWidth=Math.min(destMaxSizes.width,Math.max(destMinSizes.width,imageNaturalWidth));var destHeight=Math.min(destMaxSizes.height,Math.max(destMinSizes.height,imageNaturalHeight));var params=[-destWidth/2,-destHeight/2,destWidth,destHeight];canvas.width=normalizeDecimalNumber(width);canvas.height=normalizeDecimalNumber(height);context.fillStyle=fillColor;context.fillRect(0,0,width,height);context.save();context.translate(width/2,height/2);context.rotate(rotate*Math.PI/180);context.scale(scaleX,scaleY);context.imageSmoothingEnabled=imageSmoothingEnabled;context.imageSmoothingQuality=imageSmoothingQuality;params=params.map(normalizeDecimalNumber);context.drawImage(image,params[0],params[1],Math.floor(params[2]),Math.floor(params[3]));context.restore();return canvas;}
var fromCharCode=String.fromCharCode;function getStringFromCharCode(dataView,start,length){var str='';length+=start;for(var i=start;i<length;i+=1){str+=fromCharCode(dataView.getUint8(i));}
return str;}
var REGEXP_DATA_URL_HEAD=/^data:.*,/;function dataURLToArrayBuffer(dataURL){var base64=dataURL.replace(REGEXP_DATA_URL_HEAD,'');var binary=atob(base64);var arrayBuffer=new ArrayBuffer(binary.length);var uint8=new Uint8Array(arrayBuffer);forEach(uint8,function(value,i){uint8[i]=binary.charCodeAt(i);});return arrayBuffer;}
function arrayBufferToDataURL(arrayBuffer,mimeType){var chunks=[];var chunkSize=8192;var uint8=new Uint8Array(arrayBuffer);while(uint8.length>0){chunks.push(fromCharCode.apply(null,toArray(uint8.subarray(0,chunkSize))));uint8=uint8.subarray(chunkSize);}
return"data:".concat(mimeType,";base64,").concat(btoa(chunks.join('')));}
function resetAndGetOrientation(arrayBuffer){var dataView=new DataView(arrayBuffer);var orientation;try{var littleEndian;var app1Start;var ifdStart;if(dataView.getUint8(0)===0xFF&&dataView.getUint8(1)===0xD8){var length=dataView.byteLength;var offset=2;while(offset+1<length){if(dataView.getUint8(offset)===0xFF&&dataView.getUint8(offset+1)===0xE1){app1Start=offset;break;}
offset+=1;}}
if(app1Start){var exifIDCode=app1Start+4;var tiffOffset=app1Start+10;if(getStringFromCharCode(dataView,exifIDCode,4)==='Exif'){var endianness=dataView.getUint16(tiffOffset);littleEndian=endianness===0x4949;if(littleEndian||endianness===0x4D4D){if(dataView.getUint16(tiffOffset+2,littleEndian)===0x002A){var firstIFDOffset=dataView.getUint32(tiffOffset+4,littleEndian);if(firstIFDOffset>=0x00000008){ifdStart=tiffOffset+firstIFDOffset;}}}}}
if(ifdStart){var _length=dataView.getUint16(ifdStart,littleEndian);var _offset;var i;for(i=0;i<_length;i+=1){_offset=ifdStart+i*12+2;if(dataView.getUint16(_offset,littleEndian)===0x0112){_offset+=8;orientation=dataView.getUint16(_offset,littleEndian);dataView.setUint16(_offset,1,littleEndian);break;}}}}catch(error){orientation=1;}
return orientation;}
function parseOrientation(orientation){var rotate=0;var scaleX=1;var scaleY=1;switch(orientation){case 2:scaleX=-1;break;case 3:rotate=-180;break;case 4:scaleY=-1;break;case 5:rotate=90;scaleY=-1;break;case 6:rotate=90;break;case 7:rotate=90;scaleX=-1;break;case 8:rotate=-90;break;default:}
return{rotate:rotate,scaleX:scaleX,scaleY:scaleY};}
var render={render:function render(){this.initContainer();this.initCanvas();this.initCropBox();this.renderCanvas();if(this.cropped){this.renderCropBox();}},initContainer:function initContainer(){var element=this.element,options=this.options,container=this.container,cropper=this.cropper;addClass(cropper,CLASS_HIDDEN);removeClass(element,CLASS_HIDDEN);var containerData={width:Math.max(container.offsetWidth,Number(options.minContainerWidth)||200),height:Math.max(container.offsetHeight,Number(options.minContainerHeight)||100)};this.containerData=containerData;setStyle(cropper,{width:containerData.width,height:containerData.height});addClass(element,CLASS_HIDDEN);removeClass(cropper,CLASS_HIDDEN);},initCanvas:function initCanvas(){var containerData=this.containerData,imageData=this.imageData;var viewMode=this.options.viewMode;var rotated=Math.abs(imageData.rotate)%180===90;var naturalWidth=rotated?imageData.naturalHeight:imageData.naturalWidth;var naturalHeight=rotated?imageData.naturalWidth:imageData.naturalHeight;var aspectRatio=naturalWidth/naturalHeight;var canvasWidth=containerData.width;var canvasHeight=containerData.height;if(containerData.height*aspectRatio>containerData.width){if(viewMode===3){canvasWidth=containerData.height*aspectRatio;}else{canvasHeight=containerData.width/aspectRatio;}}else if(viewMode===3){canvasHeight=containerData.width/aspectRatio;}else{canvasWidth=containerData.height*aspectRatio;}
var canvasData={aspectRatio:aspectRatio,naturalWidth:naturalWidth,naturalHeight:naturalHeight,width:canvasWidth,height:canvasHeight};canvasData.left=(containerData.width-canvasWidth)/2;canvasData.top=(containerData.height-canvasHeight)/2;canvasData.oldLeft=canvasData.left;canvasData.oldTop=canvasData.top;this.canvasData=canvasData;this.limited=viewMode===1||viewMode===2;this.limitCanvas(true,true);this.initialImageData=assign({},imageData);this.initialCanvasData=assign({},canvasData);},limitCanvas:function limitCanvas(sizeLimited,positionLimited){var options=this.options,containerData=this.containerData,canvasData=this.canvasData,cropBoxData=this.cropBoxData;var viewMode=options.viewMode;var aspectRatio=canvasData.aspectRatio;var cropped=this.cropped&&cropBoxData;if(sizeLimited){var minCanvasWidth=Number(options.minCanvasWidth)||0;var minCanvasHeight=Number(options.minCanvasHeight)||0;if(viewMode>1){minCanvasWidth=Math.max(minCanvasWidth,containerData.width);minCanvasHeight=Math.max(minCanvasHeight,containerData.height);if(viewMode===3){if(minCanvasHeight*aspectRatio>minCanvasWidth){minCanvasWidth=minCanvasHeight*aspectRatio;}else{minCanvasHeight=minCanvasWidth/aspectRatio;}}}else if(viewMode>0){if(minCanvasWidth){minCanvasWidth=Math.max(minCanvasWidth,cropped?cropBoxData.width:0);}else if(minCanvasHeight){minCanvasHeight=Math.max(minCanvasHeight,cropped?cropBoxData.height:0);}else if(cropped){minCanvasWidth=cropBoxData.width;minCanvasHeight=cropBoxData.height;if(minCanvasHeight*aspectRatio>minCanvasWidth){minCanvasWidth=minCanvasHeight*aspectRatio;}else{minCanvasHeight=minCanvasWidth/aspectRatio;}}}
var _getAdjustedSizes=getAdjustedSizes({aspectRatio:aspectRatio,width:minCanvasWidth,height:minCanvasHeight});minCanvasWidth=_getAdjustedSizes.width;minCanvasHeight=_getAdjustedSizes.height;canvasData.minWidth=minCanvasWidth;canvasData.minHeight=minCanvasHeight;canvasData.maxWidth=Infinity;canvasData.maxHeight=Infinity;}
if(positionLimited){if(viewMode>(cropped?0:1)){var newCanvasLeft=containerData.width-canvasData.width;var newCanvasTop=containerData.height-canvasData.height;canvasData.minLeft=Math.min(0,newCanvasLeft);canvasData.minTop=Math.min(0,newCanvasTop);canvasData.maxLeft=Math.max(0,newCanvasLeft);canvasData.maxTop=Math.max(0,newCanvasTop);if(cropped&&this.limited){canvasData.minLeft=Math.min(cropBoxData.left,cropBoxData.left+(cropBoxData.width-canvasData.width));canvasData.minTop=Math.min(cropBoxData.top,cropBoxData.top+(cropBoxData.height-canvasData.height));canvasData.maxLeft=cropBoxData.left;canvasData.maxTop=cropBoxData.top;if(viewMode===2){if(canvasData.width>=containerData.width){canvasData.minLeft=Math.min(0,newCanvasLeft);canvasData.maxLeft=Math.max(0,newCanvasLeft);}
if(canvasData.height>=containerData.height){canvasData.minTop=Math.min(0,newCanvasTop);canvasData.maxTop=Math.max(0,newCanvasTop);}}}}else{canvasData.minLeft=-canvasData.width;canvasData.minTop=-canvasData.height;canvasData.maxLeft=containerData.width;canvasData.maxTop=containerData.height;}}},renderCanvas:function renderCanvas(changed,transformed){var canvasData=this.canvasData,imageData=this.imageData;if(transformed){var _getRotatedSizes=getRotatedSizes({width:imageData.naturalWidth*Math.abs(imageData.scaleX||1),height:imageData.naturalHeight*Math.abs(imageData.scaleY||1),degree:imageData.rotate||0}),naturalWidth=_getRotatedSizes.width,naturalHeight=_getRotatedSizes.height;var width=canvasData.width*(naturalWidth/canvasData.naturalWidth);var height=canvasData.height*(naturalHeight/canvasData.naturalHeight);canvasData.left-=(width-canvasData.width)/2;canvasData.top-=(height-canvasData.height)/2;canvasData.width=width;canvasData.height=height;canvasData.aspectRatio=naturalWidth/naturalHeight;canvasData.naturalWidth=naturalWidth;canvasData.naturalHeight=naturalHeight;this.limitCanvas(true,false);}
if(canvasData.width>canvasData.maxWidth||canvasData.width<canvasData.minWidth){canvasData.left=canvasData.oldLeft;}
if(canvasData.height>canvasData.maxHeight||canvasData.height<canvasData.minHeight){canvasData.top=canvasData.oldTop;}
canvasData.width=Math.min(Math.max(canvasData.width,canvasData.minWidth),canvasData.maxWidth);canvasData.height=Math.min(Math.max(canvasData.height,canvasData.minHeight),canvasData.maxHeight);this.limitCanvas(false,true);canvasData.left=Math.min(Math.max(canvasData.left,canvasData.minLeft),canvasData.maxLeft);canvasData.top=Math.min(Math.max(canvasData.top,canvasData.minTop),canvasData.maxTop);canvasData.oldLeft=canvasData.left;canvasData.oldTop=canvasData.top;setStyle(this.canvas,assign({width:canvasData.width,height:canvasData.height},getTransforms({translateX:canvasData.left,translateY:canvasData.top})));this.renderImage(changed);if(this.cropped&&this.limited){this.limitCropBox(true,true);}},renderImage:function renderImage(changed){var canvasData=this.canvasData,imageData=this.imageData;var width=imageData.naturalWidth*(canvasData.width/canvasData.naturalWidth);var height=imageData.naturalHeight*(canvasData.height/canvasData.naturalHeight);assign(imageData,{width:width,height:height,left:(canvasData.width-width)/2,top:(canvasData.height-height)/2});setStyle(this.image,assign({width:imageData.width,height:imageData.height},getTransforms(assign({translateX:imageData.left,translateY:imageData.top},imageData))));if(changed){this.output();}},initCropBox:function initCropBox(){var options=this.options,canvasData=this.canvasData;var aspectRatio=options.aspectRatio||options.initialAspectRatio;var autoCropArea=Number(options.autoCropArea)||0.8;var cropBoxData={width:canvasData.width,height:canvasData.height};if(aspectRatio){if(canvasData.height*aspectRatio>canvasData.width){cropBoxData.height=cropBoxData.width/aspectRatio;}else{cropBoxData.width=cropBoxData.height*aspectRatio;}}
this.cropBoxData=cropBoxData;this.limitCropBox(true,true);cropBoxData.width=Math.min(Math.max(cropBoxData.width,cropBoxData.minWidth),cropBoxData.maxWidth);cropBoxData.height=Math.min(Math.max(cropBoxData.height,cropBoxData.minHeight),cropBoxData.maxHeight);cropBoxData.width=Math.max(cropBoxData.minWidth,cropBoxData.width*autoCropArea);cropBoxData.height=Math.max(cropBoxData.minHeight,cropBoxData.height*autoCropArea);cropBoxData.left=canvasData.left+(canvasData.width-cropBoxData.width)/2;cropBoxData.top=canvasData.top+(canvasData.height-cropBoxData.height)/2;cropBoxData.oldLeft=cropBoxData.left;cropBoxData.oldTop=cropBoxData.top;this.initialCropBoxData=assign({},cropBoxData);},limitCropBox:function limitCropBox(sizeLimited,positionLimited){var options=this.options,containerData=this.containerData,canvasData=this.canvasData,cropBoxData=this.cropBoxData,limited=this.limited;var aspectRatio=options.aspectRatio;if(sizeLimited){var minCropBoxWidth=Number(options.minCropBoxWidth)||0;var minCropBoxHeight=Number(options.minCropBoxHeight)||0;var maxCropBoxWidth=limited?Math.min(containerData.width,canvasData.width,canvasData.width+canvasData.left,containerData.width-canvasData.left):containerData.width;var maxCropBoxHeight=limited?Math.min(containerData.height,canvasData.height,canvasData.height+canvasData.top,containerData.height-canvasData.top):containerData.height;minCropBoxWidth=Math.min(minCropBoxWidth,containerData.width);minCropBoxHeight=Math.min(minCropBoxHeight,containerData.height);if(aspectRatio){if(minCropBoxWidth&&minCropBoxHeight){if(minCropBoxHeight*aspectRatio>minCropBoxWidth){minCropBoxHeight=minCropBoxWidth/aspectRatio;}else{minCropBoxWidth=minCropBoxHeight*aspectRatio;}}else if(minCropBoxWidth){minCropBoxHeight=minCropBoxWidth/aspectRatio;}else if(minCropBoxHeight){minCropBoxWidth=minCropBoxHeight*aspectRatio;}
if(maxCropBoxHeight*aspectRatio>maxCropBoxWidth){maxCropBoxHeight=maxCropBoxWidth/aspectRatio;}else{maxCropBoxWidth=maxCropBoxHeight*aspectRatio;}}
cropBoxData.minWidth=Math.min(minCropBoxWidth,maxCropBoxWidth);cropBoxData.minHeight=Math.min(minCropBoxHeight,maxCropBoxHeight);cropBoxData.maxWidth=maxCropBoxWidth;cropBoxData.maxHeight=maxCropBoxHeight;}
if(positionLimited){if(limited){cropBoxData.minLeft=Math.max(0,canvasData.left);cropBoxData.minTop=Math.max(0,canvasData.top);cropBoxData.maxLeft=Math.min(containerData.width,canvasData.left+canvasData.width)-cropBoxData.width;cropBoxData.maxTop=Math.min(containerData.height,canvasData.top+canvasData.height)-cropBoxData.height;}else{cropBoxData.minLeft=0;cropBoxData.minTop=0;cropBoxData.maxLeft=containerData.width-cropBoxData.width;cropBoxData.maxTop=containerData.height-cropBoxData.height;}}},renderCropBox:function renderCropBox(){var options=this.options,containerData=this.containerData,cropBoxData=this.cropBoxData;if(cropBoxData.width>cropBoxData.maxWidth||cropBoxData.width<cropBoxData.minWidth){cropBoxData.left=cropBoxData.oldLeft;}
if(cropBoxData.height>cropBoxData.maxHeight||cropBoxData.height<cropBoxData.minHeight){cropBoxData.top=cropBoxData.oldTop;}
cropBoxData.width=Math.min(Math.max(cropBoxData.width,cropBoxData.minWidth),cropBoxData.maxWidth);cropBoxData.height=Math.min(Math.max(cropBoxData.height,cropBoxData.minHeight),cropBoxData.maxHeight);this.limitCropBox(false,true);cropBoxData.left=Math.min(Math.max(cropBoxData.left,cropBoxData.minLeft),cropBoxData.maxLeft);cropBoxData.top=Math.min(Math.max(cropBoxData.top,cropBoxData.minTop),cropBoxData.maxTop);cropBoxData.oldLeft=cropBoxData.left;cropBoxData.oldTop=cropBoxData.top;if(options.movable&&options.cropBoxMovable){setData(this.face,DATA_ACTION,cropBoxData.width>=containerData.width&&cropBoxData.height>=containerData.height?ACTION_MOVE:ACTION_ALL);}
setStyle(this.cropBox,assign({width:cropBoxData.width,height:cropBoxData.height},getTransforms({translateX:cropBoxData.left,translateY:cropBoxData.top})));if(this.cropped&&this.limited){this.limitCanvas(true,true);}
if(!this.disabled){this.output();}},output:function output(){this.preview();dispatchEvent(this.element,EVENT_CROP,this.getData());}};var preview={initPreview:function initPreview(){var element=this.element,crossOrigin=this.crossOrigin;var preview=this.options.preview;var url=crossOrigin?this.crossOriginUrl:this.url;var alt=element.alt||'The image to preview';var image=document.createElement('img');if(crossOrigin){image.crossOrigin=crossOrigin;}
image.src=url;image.alt=alt;this.viewBox.appendChild(image);this.viewBoxImage=image;if(!preview){return;}
var previews=preview;if(typeof preview==='string'){previews=element.ownerDocument.querySelectorAll(preview);}else if(preview.querySelector){previews=[preview];}
this.previews=previews;forEach(previews,function(el){var img=document.createElement('img');setData(el,DATA_PREVIEW,{width:el.offsetWidth,height:el.offsetHeight,html:el.innerHTML});if(crossOrigin){img.crossOrigin=crossOrigin;}
img.src=url;img.alt=alt;img.style.cssText='display:block;'+'width:100%;'+'height:auto;'+'min-width:0!important;'+'min-height:0!important;'+'max-width:none!important;'+'max-height:none!important;'+'image-orientation:0deg!important;"';el.innerHTML='';el.appendChild(img);});},resetPreview:function resetPreview(){forEach(this.previews,function(element){var data=getData(element,DATA_PREVIEW);setStyle(element,{width:data.width,height:data.height});element.innerHTML=data.html;removeData(element,DATA_PREVIEW);});},preview:function preview(){var imageData=this.imageData,canvasData=this.canvasData,cropBoxData=this.cropBoxData;var cropBoxWidth=cropBoxData.width,cropBoxHeight=cropBoxData.height;var width=imageData.width,height=imageData.height;var left=cropBoxData.left-canvasData.left-imageData.left;var top=cropBoxData.top-canvasData.top-imageData.top;if(!this.cropped||this.disabled){return;}
setStyle(this.viewBoxImage,assign({width:width,height:height},getTransforms(assign({translateX:-left,translateY:-top},imageData))));forEach(this.previews,function(element){var data=getData(element,DATA_PREVIEW);var originalWidth=data.width;var originalHeight=data.height;var newWidth=originalWidth;var newHeight=originalHeight;var ratio=1;if(cropBoxWidth){ratio=originalWidth/cropBoxWidth;newHeight=cropBoxHeight*ratio;}
if(cropBoxHeight&&newHeight>originalHeight){ratio=originalHeight/cropBoxHeight;newWidth=cropBoxWidth*ratio;newHeight=originalHeight;}
setStyle(element,{width:newWidth,height:newHeight});setStyle(element.getElementsByTagName('img')[0],assign({width:width*ratio,height:height*ratio},getTransforms(assign({translateX:-left*ratio,translateY:-top*ratio},imageData))));});}};var events={bind:function bind(){var element=this.element,options=this.options,cropper=this.cropper;if(isFunction(options.cropstart)){addListener(element,EVENT_CROP_START,options.cropstart);}
if(isFunction(options.cropmove)){addListener(element,EVENT_CROP_MOVE,options.cropmove);}
if(isFunction(options.cropend)){addListener(element,EVENT_CROP_END,options.cropend);}
if(isFunction(options.crop)){addListener(element,EVENT_CROP,options.crop);}
if(isFunction(options.zoom)){addListener(element,EVENT_ZOOM,options.zoom);}
addListener(cropper,EVENT_POINTER_DOWN,this.onCropStart=this.cropStart.bind(this));if(options.zoomable&&options.zoomOnWheel){addListener(cropper,EVENT_WHEEL,this.onWheel=this.wheel.bind(this),{passive:false,capture:true});}
if(options.toggleDragModeOnDblclick){addListener(cropper,EVENT_DBLCLICK,this.onDblclick=this.dblclick.bind(this));}
addListener(element.ownerDocument,EVENT_POINTER_MOVE,this.onCropMove=this.cropMove.bind(this));addListener(element.ownerDocument,EVENT_POINTER_UP,this.onCropEnd=this.cropEnd.bind(this));if(options.responsive){addListener(window,EVENT_RESIZE,this.onResize=this.resize.bind(this));}},unbind:function unbind(){var element=this.element,options=this.options,cropper=this.cropper;if(isFunction(options.cropstart)){removeListener(element,EVENT_CROP_START,options.cropstart);}
if(isFunction(options.cropmove)){removeListener(element,EVENT_CROP_MOVE,options.cropmove);}
if(isFunction(options.cropend)){removeListener(element,EVENT_CROP_END,options.cropend);}
if(isFunction(options.crop)){removeListener(element,EVENT_CROP,options.crop);}
if(isFunction(options.zoom)){removeListener(element,EVENT_ZOOM,options.zoom);}
removeListener(cropper,EVENT_POINTER_DOWN,this.onCropStart);if(options.zoomable&&options.zoomOnWheel){removeListener(cropper,EVENT_WHEEL,this.onWheel,{passive:false,capture:true});}
if(options.toggleDragModeOnDblclick){removeListener(cropper,EVENT_DBLCLICK,this.onDblclick);}
removeListener(element.ownerDocument,EVENT_POINTER_MOVE,this.onCropMove);removeListener(element.ownerDocument,EVENT_POINTER_UP,this.onCropEnd);if(options.responsive){removeListener(window,EVENT_RESIZE,this.onResize);}}};var handlers={resize:function resize(){var options=this.options,container=this.container,containerData=this.containerData;var minContainerWidth=Number(options.minContainerWidth)||MIN_CONTAINER_WIDTH;var minContainerHeight=Number(options.minContainerHeight)||MIN_CONTAINER_HEIGHT;if(this.disabled||containerData.width<=minContainerWidth||containerData.height<=minContainerHeight){return;}
var ratio=container.offsetWidth/containerData.width;if(ratio!==1||container.offsetHeight!==containerData.height){var canvasData;var cropBoxData;if(options.restore){canvasData=this.getCanvasData();cropBoxData=this.getCropBoxData();}
this.render();if(options.restore){this.setCanvasData(forEach(canvasData,function(n,i){canvasData[i]=n*ratio;}));this.setCropBoxData(forEach(cropBoxData,function(n,i){cropBoxData[i]=n*ratio;}));}}},dblclick:function dblclick(){if(this.disabled||this.options.dragMode===DRAG_MODE_NONE){return;}
this.setDragMode(hasClass(this.dragBox,CLASS_CROP)?DRAG_MODE_MOVE:DRAG_MODE_CROP);},wheel:function wheel(event){var _this=this;var ratio=Number(this.options.wheelZoomRatio)||0.1;var delta=1;if(this.disabled){return;}
event.preventDefault();if(this.wheeling){return;}
this.wheeling=true;setTimeout(function(){_this.wheeling=false;},50);if(event.deltaY){delta=event.deltaY>0?1:-1;}else if(event.wheelDelta){delta=-event.wheelDelta/120;}else if(event.detail){delta=event.detail>0?1:-1;}
this.zoom(-delta*ratio,event);},cropStart:function cropStart(event){var buttons=event.buttons,button=event.button;if(this.disabled||isNumber(buttons)&&buttons!==1||isNumber(button)&&button!==0||event.ctrlKey){return;}
var options=this.options,pointers=this.pointers;var action;if(event.changedTouches){forEach(event.changedTouches,function(touch){pointers[touch.identifier]=getPointer(touch);});}else{pointers[event.pointerId||0]=getPointer(event);}
if(Object.keys(pointers).length>1&&options.zoomable&&options.zoomOnTouch){action=ACTION_ZOOM;}else{action=getData(event.target,DATA_ACTION);}
if(!REGEXP_ACTIONS.test(action)){return;}
if(dispatchEvent(this.element,EVENT_CROP_START,{originalEvent:event,action:action})===false){return;}
event.preventDefault();this.action=action;this.cropping=false;if(action===ACTION_CROP){this.cropping=true;addClass(this.dragBox,CLASS_MODAL);}},cropMove:function cropMove(event){var action=this.action;if(this.disabled||!action){return;}
var pointers=this.pointers;event.preventDefault();if(dispatchEvent(this.element,EVENT_CROP_MOVE,{originalEvent:event,action:action})===false){return;}
if(event.changedTouches){forEach(event.changedTouches,function(touch){assign(pointers[touch.identifier]||{},getPointer(touch,true));});}else{assign(pointers[event.pointerId||0]||{},getPointer(event,true));}
this.change(event);},cropEnd:function cropEnd(event){if(this.disabled){return;}
var action=this.action,pointers=this.pointers;if(event.changedTouches){forEach(event.changedTouches,function(touch){delete pointers[touch.identifier];});}else{delete pointers[event.pointerId||0];}
if(!action){return;}
event.preventDefault();if(!Object.keys(pointers).length){this.action='';}
if(this.cropping){this.cropping=false;toggleClass(this.dragBox,CLASS_MODAL,this.cropped&&this.options.modal);}
dispatchEvent(this.element,EVENT_CROP_END,{originalEvent:event,action:action});}};var change={change:function change(event){var options=this.options,canvasData=this.canvasData,containerData=this.containerData,cropBoxData=this.cropBoxData,pointers=this.pointers;var action=this.action;var aspectRatio=options.aspectRatio;var left=cropBoxData.left,top=cropBoxData.top,width=cropBoxData.width,height=cropBoxData.height;var right=left+width;var bottom=top+height;var minLeft=0;var minTop=0;var maxWidth=containerData.width;var maxHeight=containerData.height;var renderable=true;var offset;if(!aspectRatio&&event.shiftKey){aspectRatio=width&&height?width/height:1;}
if(this.limited){minLeft=cropBoxData.minLeft;minTop=cropBoxData.minTop;maxWidth=minLeft+Math.min(containerData.width,canvasData.width,canvasData.left+canvasData.width);maxHeight=minTop+Math.min(containerData.height,canvasData.height,canvasData.top+canvasData.height);}
var pointer=pointers[Object.keys(pointers)[0]];var range={x:pointer.endX-pointer.startX,y:pointer.endY-pointer.startY};var check=function check(side){switch(side){case ACTION_EAST:if(right+range.x>maxWidth){range.x=maxWidth-right;}
break;case ACTION_WEST:if(left+range.x<minLeft){range.x=minLeft-left;}
break;case ACTION_NORTH:if(top+range.y<minTop){range.y=minTop-top;}
break;case ACTION_SOUTH:if(bottom+range.y>maxHeight){range.y=maxHeight-bottom;}
break;default:}};switch(action){case ACTION_ALL:left+=range.x;top+=range.y;break;case ACTION_EAST:if(range.x>=0&&(right>=maxWidth||aspectRatio&&(top<=minTop||bottom>=maxHeight))){renderable=false;break;}
check(ACTION_EAST);width+=range.x;if(width<0){action=ACTION_WEST;width=-width;left-=width;}
if(aspectRatio){height=width/aspectRatio;top+=(cropBoxData.height-height)/2;}
break;case ACTION_NORTH:if(range.y<=0&&(top<=minTop||aspectRatio&&(left<=minLeft||right>=maxWidth))){renderable=false;break;}
check(ACTION_NORTH);height-=range.y;top+=range.y;if(height<0){action=ACTION_SOUTH;height=-height;top-=height;}
if(aspectRatio){width=height*aspectRatio;left+=(cropBoxData.width-width)/2;}
break;case ACTION_WEST:if(range.x<=0&&(left<=minLeft||aspectRatio&&(top<=minTop||bottom>=maxHeight))){renderable=false;break;}
check(ACTION_WEST);width-=range.x;left+=range.x;if(width<0){action=ACTION_EAST;width=-width;left-=width;}
if(aspectRatio){height=width/aspectRatio;top+=(cropBoxData.height-height)/2;}
break;case ACTION_SOUTH:if(range.y>=0&&(bottom>=maxHeight||aspectRatio&&(left<=minLeft||right>=maxWidth))){renderable=false;break;}
check(ACTION_SOUTH);height+=range.y;if(height<0){action=ACTION_NORTH;height=-height;top-=height;}
if(aspectRatio){width=height*aspectRatio;left+=(cropBoxData.width-width)/2;}
break;case ACTION_NORTH_EAST:if(aspectRatio){if(range.y<=0&&(top<=minTop||right>=maxWidth)){renderable=false;break;}
check(ACTION_NORTH);height-=range.y;top+=range.y;width=height*aspectRatio;}else{check(ACTION_NORTH);check(ACTION_EAST);if(range.x>=0){if(right<maxWidth){width+=range.x;}else if(range.y<=0&&top<=minTop){renderable=false;}}else{width+=range.x;}
if(range.y<=0){if(top>minTop){height-=range.y;top+=range.y;}}else{height-=range.y;top+=range.y;}}
if(width<0&&height<0){action=ACTION_SOUTH_WEST;height=-height;width=-width;top-=height;left-=width;}else if(width<0){action=ACTION_NORTH_WEST;width=-width;left-=width;}else if(height<0){action=ACTION_SOUTH_EAST;height=-height;top-=height;}
break;case ACTION_NORTH_WEST:if(aspectRatio){if(range.y<=0&&(top<=minTop||left<=minLeft)){renderable=false;break;}
check(ACTION_NORTH);height-=range.y;top+=range.y;width=height*aspectRatio;left+=cropBoxData.width-width;}else{check(ACTION_NORTH);check(ACTION_WEST);if(range.x<=0){if(left>minLeft){width-=range.x;left+=range.x;}else if(range.y<=0&&top<=minTop){renderable=false;}}else{width-=range.x;left+=range.x;}
if(range.y<=0){if(top>minTop){height-=range.y;top+=range.y;}}else{height-=range.y;top+=range.y;}}
if(width<0&&height<0){action=ACTION_SOUTH_EAST;height=-height;width=-width;top-=height;left-=width;}else if(width<0){action=ACTION_NORTH_EAST;width=-width;left-=width;}else if(height<0){action=ACTION_SOUTH_WEST;height=-height;top-=height;}
break;case ACTION_SOUTH_WEST:if(aspectRatio){if(range.x<=0&&(left<=minLeft||bottom>=maxHeight)){renderable=false;break;}
check(ACTION_WEST);width-=range.x;left+=range.x;height=width/aspectRatio;}else{check(ACTION_SOUTH);check(ACTION_WEST);if(range.x<=0){if(left>minLeft){width-=range.x;left+=range.x;}else if(range.y>=0&&bottom>=maxHeight){renderable=false;}}else{width-=range.x;left+=range.x;}
if(range.y>=0){if(bottom<maxHeight){height+=range.y;}}else{height+=range.y;}}
if(width<0&&height<0){action=ACTION_NORTH_EAST;height=-height;width=-width;top-=height;left-=width;}else if(width<0){action=ACTION_SOUTH_EAST;width=-width;left-=width;}else if(height<0){action=ACTION_NORTH_WEST;height=-height;top-=height;}
break;case ACTION_SOUTH_EAST:if(aspectRatio){if(range.x>=0&&(right>=maxWidth||bottom>=maxHeight)){renderable=false;break;}
check(ACTION_EAST);width+=range.x;height=width/aspectRatio;}else{check(ACTION_SOUTH);check(ACTION_EAST);if(range.x>=0){if(right<maxWidth){width+=range.x;}else if(range.y>=0&&bottom>=maxHeight){renderable=false;}}else{width+=range.x;}
if(range.y>=0){if(bottom<maxHeight){height+=range.y;}}else{height+=range.y;}}
if(width<0&&height<0){action=ACTION_NORTH_WEST;height=-height;width=-width;top-=height;left-=width;}else if(width<0){action=ACTION_SOUTH_WEST;width=-width;left-=width;}else if(height<0){action=ACTION_NORTH_EAST;height=-height;top-=height;}
break;case ACTION_MOVE:this.move(range.x,range.y);renderable=false;break;case ACTION_ZOOM:this.zoom(getMaxZoomRatio(pointers),event);renderable=false;break;case ACTION_CROP:if(!range.x||!range.y){renderable=false;break;}
offset=getOffset(this.cropper);left=pointer.startX-offset.left;top=pointer.startY-offset.top;width=cropBoxData.minWidth;height=cropBoxData.minHeight;if(range.x>0){action=range.y>0?ACTION_SOUTH_EAST:ACTION_NORTH_EAST;}else if(range.x<0){left-=width;action=range.y>0?ACTION_SOUTH_WEST:ACTION_NORTH_WEST;}
if(range.y<0){top-=height;}
if(!this.cropped){removeClass(this.cropBox,CLASS_HIDDEN);this.cropped=true;if(this.limited){this.limitCropBox(true,true);}}
break;default:}
if(renderable){cropBoxData.width=width;cropBoxData.height=height;cropBoxData.left=left;cropBoxData.top=top;this.action=action;this.renderCropBox();}
forEach(pointers,function(p){p.startX=p.endX;p.startY=p.endY;});}};var methods={crop:function crop(){if(this.ready&&!this.cropped&&!this.disabled){this.cropped=true;this.limitCropBox(true,true);if(this.options.modal){addClass(this.dragBox,CLASS_MODAL);}
removeClass(this.cropBox,CLASS_HIDDEN);this.setCropBoxData(this.initialCropBoxData);}
return this;},reset:function reset(){if(this.ready&&!this.disabled){this.imageData=assign({},this.initialImageData);this.canvasData=assign({},this.initialCanvasData);this.cropBoxData=assign({},this.initialCropBoxData);this.renderCanvas();if(this.cropped){this.renderCropBox();}}
return this;},clear:function clear(){if(this.cropped&&!this.disabled){assign(this.cropBoxData,{left:0,top:0,width:0,height:0});this.cropped=false;this.renderCropBox();this.limitCanvas(true,true);this.renderCanvas();removeClass(this.dragBox,CLASS_MODAL);addClass(this.cropBox,CLASS_HIDDEN);}
return this;},replace:function replace(url){var hasSameSize=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(!this.disabled&&url){if(this.isImg){this.element.src=url;}
if(hasSameSize){this.url=url;this.image.src=url;if(this.ready){this.viewBoxImage.src=url;forEach(this.previews,function(element){element.getElementsByTagName('img')[0].src=url;});}}else{if(this.isImg){this.replaced=true;}
this.options.data=null;this.uncreate();this.load(url);}}
return this;},enable:function enable(){if(this.ready&&this.disabled){this.disabled=false;removeClass(this.cropper,CLASS_DISABLED);}
return this;},disable:function disable(){if(this.ready&&!this.disabled){this.disabled=true;addClass(this.cropper,CLASS_DISABLED);}
return this;},destroy:function destroy(){var element=this.element;if(!element[NAMESPACE]){return this;}
element[NAMESPACE]=undefined;if(this.isImg&&this.replaced){element.src=this.originalUrl;}
this.uncreate();return this;},move:function move(offsetX){var offsetY=arguments.length>1&&arguments[1]!==undefined?arguments[1]:offsetX;var _this$canvasData=this.canvasData,left=_this$canvasData.left,top=_this$canvasData.top;return this.moveTo(isUndefined(offsetX)?offsetX:left+Number(offsetX),isUndefined(offsetY)?offsetY:top+Number(offsetY));},moveTo:function moveTo(x){var y=arguments.length>1&&arguments[1]!==undefined?arguments[1]:x;var canvasData=this.canvasData;var changed=false;x=Number(x);y=Number(y);if(this.ready&&!this.disabled&&this.options.movable){if(isNumber(x)){canvasData.left=x;changed=true;}
if(isNumber(y)){canvasData.top=y;changed=true;}
if(changed){this.renderCanvas(true);}}
return this;},zoom:function zoom(ratio,_originalEvent){var canvasData=this.canvasData;ratio=Number(ratio);if(ratio<0){ratio=1/(1-ratio);}else{ratio=1+ratio;}
return this.zoomTo(canvasData.width*ratio/canvasData.naturalWidth,null,_originalEvent);},zoomTo:function zoomTo(ratio,pivot,_originalEvent){var options=this.options,canvasData=this.canvasData;var width=canvasData.width,height=canvasData.height,naturalWidth=canvasData.naturalWidth,naturalHeight=canvasData.naturalHeight;ratio=Number(ratio);if(ratio>=0&&this.ready&&!this.disabled&&options.zoomable){var newWidth=naturalWidth*ratio;var newHeight=naturalHeight*ratio;if(dispatchEvent(this.element,EVENT_ZOOM,{ratio:ratio,oldRatio:width/naturalWidth,originalEvent:_originalEvent})===false){return this;}
if(_originalEvent){var pointers=this.pointers;var offset=getOffset(this.cropper);var center=pointers&&Object.keys(pointers).length?getPointersCenter(pointers):{pageX:_originalEvent.pageX,pageY:_originalEvent.pageY};canvasData.left-=(newWidth-width)*((center.pageX-offset.left-canvasData.left)/width);canvasData.top-=(newHeight-height)*((center.pageY-offset.top-canvasData.top)/height);}else if(isPlainObject(pivot)&&isNumber(pivot.x)&&isNumber(pivot.y)){canvasData.left-=(newWidth-width)*((pivot.x-canvasData.left)/width);canvasData.top-=(newHeight-height)*((pivot.y-canvasData.top)/height);}else{canvasData.left-=(newWidth-width)/2;canvasData.top-=(newHeight-height)/2;}
canvasData.width=newWidth;canvasData.height=newHeight;this.renderCanvas(true);}
return this;},rotate:function rotate(degree){return this.rotateTo((this.imageData.rotate||0)+Number(degree));},rotateTo:function rotateTo(degree){degree=Number(degree);if(isNumber(degree)&&this.ready&&!this.disabled&&this.options.rotatable){this.imageData.rotate=degree%360;this.renderCanvas(true,true);}
return this;},scaleX:function scaleX(_scaleX){var scaleY=this.imageData.scaleY;return this.scale(_scaleX,isNumber(scaleY)?scaleY:1);},scaleY:function scaleY(_scaleY){var scaleX=this.imageData.scaleX;return this.scale(isNumber(scaleX)?scaleX:1,_scaleY);},scale:function scale(scaleX){var scaleY=arguments.length>1&&arguments[1]!==undefined?arguments[1]:scaleX;var imageData=this.imageData;var transformed=false;scaleX=Number(scaleX);scaleY=Number(scaleY);if(this.ready&&!this.disabled&&this.options.scalable){if(isNumber(scaleX)){imageData.scaleX=scaleX;transformed=true;}
if(isNumber(scaleY)){imageData.scaleY=scaleY;transformed=true;}
if(transformed){this.renderCanvas(true,true);}}
return this;},getData:function getData(){var rounded=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;var options=this.options,imageData=this.imageData,canvasData=this.canvasData,cropBoxData=this.cropBoxData;var data;if(this.ready&&this.cropped){data={x:cropBoxData.left-canvasData.left,y:cropBoxData.top-canvasData.top,width:cropBoxData.width,height:cropBoxData.height};var ratio=imageData.width/imageData.naturalWidth;forEach(data,function(n,i){data[i]=n/ratio;});if(rounded){var bottom=Math.round(data.y+data.height);var right=Math.round(data.x+data.width);data.x=Math.round(data.x);data.y=Math.round(data.y);data.width=right-data.x;data.height=bottom-data.y;}}else{data={x:0,y:0,width:0,height:0};}
if(options.rotatable){data.rotate=imageData.rotate||0;}
if(options.scalable){data.scaleX=imageData.scaleX||1;data.scaleY=imageData.scaleY||1;}
return data;},setData:function setData(data){var options=this.options,imageData=this.imageData,canvasData=this.canvasData;var cropBoxData={};if(this.ready&&!this.disabled&&isPlainObject(data)){var transformed=false;if(options.rotatable){if(isNumber(data.rotate)&&data.rotate!==imageData.rotate){imageData.rotate=data.rotate;transformed=true;}}
if(options.scalable){if(isNumber(data.scaleX)&&data.scaleX!==imageData.scaleX){imageData.scaleX=data.scaleX;transformed=true;}
if(isNumber(data.scaleY)&&data.scaleY!==imageData.scaleY){imageData.scaleY=data.scaleY;transformed=true;}}
if(transformed){this.renderCanvas(true,true);}
var ratio=imageData.width/imageData.naturalWidth;if(isNumber(data.x)){cropBoxData.left=data.x*ratio+canvasData.left;}
if(isNumber(data.y)){cropBoxData.top=data.y*ratio+canvasData.top;}
if(isNumber(data.width)){cropBoxData.width=data.width*ratio;}
if(isNumber(data.height)){cropBoxData.height=data.height*ratio;}
this.setCropBoxData(cropBoxData);}
return this;},getContainerData:function getContainerData(){return this.ready?assign({},this.containerData):{};},getImageData:function getImageData(){return this.sized?assign({},this.imageData):{};},getCanvasData:function getCanvasData(){var canvasData=this.canvasData;var data={};if(this.ready){forEach(['left','top','width','height','naturalWidth','naturalHeight'],function(n){data[n]=canvasData[n];});}
return data;},setCanvasData:function setCanvasData(data){var canvasData=this.canvasData;var aspectRatio=canvasData.aspectRatio;if(this.ready&&!this.disabled&&isPlainObject(data)){if(isNumber(data.left)){canvasData.left=data.left;}
if(isNumber(data.top)){canvasData.top=data.top;}
if(isNumber(data.width)){canvasData.width=data.width;canvasData.height=data.width/aspectRatio;}else if(isNumber(data.height)){canvasData.height=data.height;canvasData.width=data.height*aspectRatio;}
this.renderCanvas(true);}
return this;},getCropBoxData:function getCropBoxData(){var cropBoxData=this.cropBoxData;var data;if(this.ready&&this.cropped){data={left:cropBoxData.left,top:cropBoxData.top,width:cropBoxData.width,height:cropBoxData.height};}
return data||{};},setCropBoxData:function setCropBoxData(data){var cropBoxData=this.cropBoxData;var aspectRatio=this.options.aspectRatio;var widthChanged;var heightChanged;if(this.ready&&this.cropped&&!this.disabled&&isPlainObject(data)){if(isNumber(data.left)){cropBoxData.left=data.left;}
if(isNumber(data.top)){cropBoxData.top=data.top;}
if(isNumber(data.width)&&data.width!==cropBoxData.width){widthChanged=true;cropBoxData.width=data.width;}
if(isNumber(data.height)&&data.height!==cropBoxData.height){heightChanged=true;cropBoxData.height=data.height;}
if(aspectRatio){if(widthChanged){cropBoxData.height=cropBoxData.width/aspectRatio;}else if(heightChanged){cropBoxData.width=cropBoxData.height*aspectRatio;}}
this.renderCropBox();}
return this;},getCroppedCanvas:function getCroppedCanvas(){var options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(!this.ready||!window.HTMLCanvasElement){return null;}
var canvasData=this.canvasData;var source=getSourceCanvas(this.image,this.imageData,canvasData,options);if(!this.cropped){return source;}
var _this$getData=this.getData(),initialX=_this$getData.x,initialY=_this$getData.y,initialWidth=_this$getData.width,initialHeight=_this$getData.height;var ratio=source.width/Math.floor(canvasData.naturalWidth);if(ratio!==1){initialX*=ratio;initialY*=ratio;initialWidth*=ratio;initialHeight*=ratio;}
var aspectRatio=initialWidth/initialHeight;var maxSizes=getAdjustedSizes({aspectRatio:aspectRatio,width:options.maxWidth||Infinity,height:options.maxHeight||Infinity});var minSizes=getAdjustedSizes({aspectRatio:aspectRatio,width:options.minWidth||0,height:options.minHeight||0},'cover');var _getAdjustedSizes=getAdjustedSizes({aspectRatio:aspectRatio,width:options.width||(ratio!==1?source.width:initialWidth),height:options.height||(ratio!==1?source.height:initialHeight)}),width=_getAdjustedSizes.width,height=_getAdjustedSizes.height;width=Math.min(maxSizes.width,Math.max(minSizes.width,width));height=Math.min(maxSizes.height,Math.max(minSizes.height,height));var canvas=document.createElement('canvas');var context=canvas.getContext('2d');canvas.width=normalizeDecimalNumber(width);canvas.height=normalizeDecimalNumber(height);context.fillStyle=options.fillColor||'transparent';context.fillRect(0,0,width,height);var _options$imageSmoothi=options.imageSmoothingEnabled,imageSmoothingEnabled=_options$imageSmoothi===void 0?true:_options$imageSmoothi,imageSmoothingQuality=options.imageSmoothingQuality;context.imageSmoothingEnabled=imageSmoothingEnabled;if(imageSmoothingQuality){context.imageSmoothingQuality=imageSmoothingQuality;}
var sourceWidth=source.width;var sourceHeight=source.height;var srcX=initialX;var srcY=initialY;var srcWidth;var srcHeight;var dstX;var dstY;var dstWidth;var dstHeight;if(srcX<=-initialWidth||srcX>sourceWidth){srcX=0;srcWidth=0;dstX=0;dstWidth=0;}else if(srcX<=0){dstX=-srcX;srcX=0;srcWidth=Math.min(sourceWidth,initialWidth+srcX);dstWidth=srcWidth;}else if(srcX<=sourceWidth){dstX=0;srcWidth=Math.min(initialWidth,sourceWidth-srcX);dstWidth=srcWidth;}
if(srcWidth<=0||srcY<=-initialHeight||srcY>sourceHeight){srcY=0;srcHeight=0;dstY=0;dstHeight=0;}else if(srcY<=0){dstY=-srcY;srcY=0;srcHeight=Math.min(sourceHeight,initialHeight+srcY);dstHeight=srcHeight;}else if(srcY<=sourceHeight){dstY=0;srcHeight=Math.min(initialHeight,sourceHeight-srcY);dstHeight=srcHeight;}
var params=[srcX,srcY,srcWidth,srcHeight];if(dstWidth>0&&dstHeight>0){var scale=width/initialWidth;params.push(dstX*scale,dstY*scale,dstWidth*scale,dstHeight*scale);}
context.drawImage.apply(context,[source].concat(_toConsumableArray(params.map(function(param){return Math.floor(normalizeDecimalNumber(param));}))));return canvas;},setAspectRatio:function setAspectRatio(aspectRatio){var options=this.options;if(!this.disabled&&!isUndefined(aspectRatio)){options.aspectRatio=Math.max(0,aspectRatio)||NaN;if(this.ready){this.initCropBox();if(this.cropped){this.renderCropBox();}}}
return this;},setDragMode:function setDragMode(mode){var options=this.options,dragBox=this.dragBox,face=this.face;if(this.ready&&!this.disabled){var croppable=mode===DRAG_MODE_CROP;var movable=options.movable&&mode===DRAG_MODE_MOVE;mode=croppable||movable?mode:DRAG_MODE_NONE;options.dragMode=mode;setData(dragBox,DATA_ACTION,mode);toggleClass(dragBox,CLASS_CROP,croppable);toggleClass(dragBox,CLASS_MOVE,movable);if(!options.cropBoxMovable){setData(face,DATA_ACTION,mode);toggleClass(face,CLASS_CROP,croppable);toggleClass(face,CLASS_MOVE,movable);}}
return this;}};var AnotherCropper=WINDOW.Cropper;var Cropper=function(){function Cropper(element){var options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};_classCallCheck(this,Cropper);if(!element||!REGEXP_TAG_NAME.test(element.tagName)){throw new Error('The first argument is required and must be an <img> or <canvas> element.');}
this.element=element;this.options=assign({},DEFAULTS,isPlainObject(options)&&options);this.cropped=false;this.disabled=false;this.pointers={};this.ready=false;this.reloading=false;this.replaced=false;this.sized=false;this.sizing=false;this.init();}
_createClass(Cropper,[{key:"init",value:function init(){var element=this.element;var tagName=element.tagName.toLowerCase();var url;if(element[NAMESPACE]){return;}
element[NAMESPACE]=this;if(tagName==='img'){this.isImg=true;url=element.getAttribute('src')||'';this.originalUrl=url;if(!url){return;}
url=element.src;}else if(tagName==='canvas'&&window.HTMLCanvasElement){url=element.toDataURL();}
this.load(url);}},{key:"load",value:function load(url){var _this=this;if(!url){return;}
this.url=url;this.imageData={};var element=this.element,options=this.options;if(!options.rotatable&&!options.scalable){options.checkOrientation=false;}
if(!options.checkOrientation||!window.ArrayBuffer){this.clone();return;}
if(REGEXP_DATA_URL.test(url)){if(REGEXP_DATA_URL_JPEG.test(url)){this.read(dataURLToArrayBuffer(url));}else{this.clone();}
return;}
var xhr=new XMLHttpRequest();var clone=this.clone.bind(this);this.reloading=true;this.xhr=xhr;xhr.onabort=clone;xhr.onerror=clone;xhr.ontimeout=clone;xhr.onprogress=function(){if(xhr.getResponseHeader('content-type')!==MIME_TYPE_JPEG){xhr.abort();}};xhr.onload=function(){_this.read(xhr.response);};xhr.onloadend=function(){_this.reloading=false;_this.xhr=null;};if(options.checkCrossOrigin&&isCrossOriginURL(url)&&element.crossOrigin){url=addTimestamp(url);}
xhr.open('GET',url);xhr.responseType='arraybuffer';xhr.withCredentials=element.crossOrigin==='use-credentials';xhr.send();}},{key:"read",value:function read(arrayBuffer){var options=this.options,imageData=this.imageData;var orientation=resetAndGetOrientation(arrayBuffer);var rotate=0;var scaleX=1;var scaleY=1;if(orientation>1){this.url=arrayBufferToDataURL(arrayBuffer,MIME_TYPE_JPEG);var _parseOrientation=parseOrientation(orientation);rotate=_parseOrientation.rotate;scaleX=_parseOrientation.scaleX;scaleY=_parseOrientation.scaleY;}
if(options.rotatable){imageData.rotate=rotate;}
if(options.scalable){imageData.scaleX=scaleX;imageData.scaleY=scaleY;}
this.clone();}},{key:"clone",value:function clone(){var element=this.element,url=this.url;var crossOrigin=element.crossOrigin;var crossOriginUrl=url;if(this.options.checkCrossOrigin&&isCrossOriginURL(url)){if(!crossOrigin){crossOrigin='anonymous';}
crossOriginUrl=addTimestamp(url);}
this.crossOrigin=crossOrigin;this.crossOriginUrl=crossOriginUrl;var image=document.createElement('img');if(crossOrigin){image.crossOrigin=crossOrigin;}
image.src=crossOriginUrl||url;image.alt=element.alt||'The image to crop';this.image=image;image.onload=this.start.bind(this);image.onerror=this.stop.bind(this);addClass(image,CLASS_HIDE);element.parentNode.insertBefore(image,element.nextSibling);}},{key:"start",value:function start(){var _this2=this;var image=this.image;image.onload=null;image.onerror=null;this.sizing=true;var isIOSWebKit=WINDOW.navigator&&/(?:iPad|iPhone|iPod).*?AppleWebKit/i.test(WINDOW.navigator.userAgent);var done=function done(naturalWidth,naturalHeight){assign(_this2.imageData,{naturalWidth:naturalWidth,naturalHeight:naturalHeight,aspectRatio:naturalWidth/naturalHeight});_this2.sizing=false;_this2.sized=true;_this2.build();};if(image.naturalWidth&&!isIOSWebKit){done(image.naturalWidth,image.naturalHeight);return;}
var sizingImage=document.createElement('img');var body=document.body||document.documentElement;this.sizingImage=sizingImage;sizingImage.onload=function(){done(sizingImage.width,sizingImage.height);if(!isIOSWebKit){body.removeChild(sizingImage);}};sizingImage.src=image.src;if(!isIOSWebKit){sizingImage.style.cssText='left:0;'+'max-height:none!important;'+'max-width:none!important;'+'min-height:0!important;'+'min-width:0!important;'+'opacity:0;'+'position:absolute;'+'top:0;'+'z-index:-1;';body.appendChild(sizingImage);}}},{key:"stop",value:function stop(){var image=this.image;image.onload=null;image.onerror=null;image.parentNode.removeChild(image);this.image=null;}},{key:"build",value:function build(){if(!this.sized||this.ready){return;}
var element=this.element,options=this.options,image=this.image;var container=element.parentNode;var template=document.createElement('div');template.innerHTML=TEMPLATE;var cropper=template.querySelector(".".concat(NAMESPACE,"-container"));var canvas=cropper.querySelector(".".concat(NAMESPACE,"-canvas"));var dragBox=cropper.querySelector(".".concat(NAMESPACE,"-drag-box"));var cropBox=cropper.querySelector(".".concat(NAMESPACE,"-crop-box"));var face=cropBox.querySelector(".".concat(NAMESPACE,"-face"));this.container=container;this.cropper=cropper;this.canvas=canvas;this.dragBox=dragBox;this.cropBox=cropBox;this.viewBox=cropper.querySelector(".".concat(NAMESPACE,"-view-box"));this.face=face;canvas.appendChild(image);addClass(element,CLASS_HIDDEN);container.insertBefore(cropper,element.nextSibling);if(!this.isImg){removeClass(image,CLASS_HIDE);}
this.initPreview();this.bind();options.initialAspectRatio=Math.max(0,options.initialAspectRatio)||NaN;options.aspectRatio=Math.max(0,options.aspectRatio)||NaN;options.viewMode=Math.max(0,Math.min(3,Math.round(options.viewMode)))||0;addClass(cropBox,CLASS_HIDDEN);if(!options.guides){addClass(cropBox.getElementsByClassName("".concat(NAMESPACE,"-dashed")),CLASS_HIDDEN);}
if(!options.center){addClass(cropBox.getElementsByClassName("".concat(NAMESPACE,"-center")),CLASS_HIDDEN);}
if(options.background){addClass(cropper,"".concat(NAMESPACE,"-bg"));}
if(!options.highlight){addClass(face,CLASS_INVISIBLE);}
if(options.cropBoxMovable){addClass(face,CLASS_MOVE);setData(face,DATA_ACTION,ACTION_ALL);}
if(!options.cropBoxResizable){addClass(cropBox.getElementsByClassName("".concat(NAMESPACE,"-line")),CLASS_HIDDEN);addClass(cropBox.getElementsByClassName("".concat(NAMESPACE,"-point")),CLASS_HIDDEN);}
this.render();this.ready=true;this.setDragMode(options.dragMode);if(options.autoCrop){this.crop();}
this.setData(options.data);if(isFunction(options.ready)){addListener(element,EVENT_READY,options.ready,{once:true});}
dispatchEvent(element,EVENT_READY);}},{key:"unbuild",value:function unbuild(){if(!this.ready){return;}
this.ready=false;this.unbind();this.resetPreview();this.cropper.parentNode.removeChild(this.cropper);removeClass(this.element,CLASS_HIDDEN);}},{key:"uncreate",value:function uncreate(){if(this.ready){this.unbuild();this.ready=false;this.cropped=false;}else if(this.sizing){this.sizingImage.onload=null;this.sizing=false;this.sized=false;}else if(this.reloading){this.xhr.onabort=null;this.xhr.abort();}else if(this.image){this.stop();}}}],[{key:"noConflict",value:function noConflict(){window.Cropper=AnotherCropper;return Cropper;}},{key:"setDefaults",value:function setDefaults(options){assign(DEFAULTS,isPlainObject(options)&&options);}}]);return Cropper;}();assign(Cropper.prototype,render,preview,events,handlers,change,methods);return Cropper;}));;

/* /web_editor/static/lib/jquery-cropper/jquery-cropper.js defined in bundle 'web_editor.assets_wysiwyg' */
(function(global,factory){typeof exports==='object'&&typeof module!=='undefined'?factory(require('jquery'),require('cropperjs')):typeof define==='function'&&define.amd?define(['jquery','cropperjs'],factory):(factory(global.jQuery,global.Cropper));}(this,(function($,Cropper){'use strict';$=$&&$.hasOwnProperty('default')?$['default']:$;Cropper=Cropper&&Cropper.hasOwnProperty('default')?Cropper['default']:Cropper;if($.fn){var AnotherCropper=$.fn.cropper;var NAMESPACE='cropper';$.fn.cropper=function jQueryCropper(option){for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key];}
var result=void 0;this.each(function(i,element){var $element=$(element);var isDestroy=option==='destroy';var cropper=$element.data(NAMESPACE);if(!cropper){if(isDestroy){return;}
var options=$.extend({},$element.data(),$.isPlainObject(option)&&option);cropper=new Cropper(element,options);$element.data(NAMESPACE,cropper);}
if(typeof option==='string'){var fn=cropper[option];if($.isFunction(fn)){result=fn.apply(cropper,args);if(result===cropper){result=undefined;}
if(isDestroy){$element.removeData(NAMESPACE);}}}});return result!==undefined?result:this;};$.fn.cropper.Constructor=Cropper;$.fn.cropper.setDefaults=Cropper.setDefaults;$.fn.cropper.noConflict=function noConflict(){$.fn.cropper=AnotherCropper;return this;};}})));;

/* /web_editor/static/lib/jQuery.transfo.js defined in bundle 'web_editor.assets_wysiwyg' */
(function($){'use strict';var rad=Math.PI/180;var methods={init:function(settings){return this.each(function(){var $this=$(this),transfo=$this.data('transfo');if(!transfo){_init($this,settings);}else{_overwriteOptions($this,transfo,settings);_targetCss($this,transfo);}});},destroy:function(){return this.each(function(){var $this=$(this);if($this.data('transfo')){_destroy($this);}});},reset:function(){return this.each(function(){var $this=$(this);if($this.data('transfo')){_reset($this);}});},toggle:function(){return this.each(function(){var $this=$(this);var transfo=$this.data('transfo');if(transfo){transfo.settings.hide=!transfo.settings.hide;_showHide($this,transfo);}});},hide:function(){return this.each(function(){var $this=$(this);var transfo=$this.data('transfo');if(transfo){transfo.settings.hide=true;_showHide($this,transfo);}});},show:function(){return this.each(function(){var $this=$(this);var transfo=$this.data('transfo');if(transfo){transfo.settings.hide=false;_showHide($this,transfo);}});},settings:function(){if(this.length>1){this.map(function(){var $this=$(this);return $this.data('transfo')&&$this.data('transfo').settings;});}
return this.data('transfo')&&$this.data('transfo').settings;},center:function(){if(this.length>1){this.map(function(){var $this=$(this);return $this.data('transfo')&&$this.data('transfo').$center.offset();});}
return this.data('transfo')&&this.data('transfo').$center.offset();}};$.fn.transfo=function(method){if(methods[method]){return methods[method].apply(this,Array.prototype.slice.call(arguments,1));}else if(typeof method==='object'||!method){return methods.init.apply(this,arguments);}else{$.error('Method '+method+' does not exist on jQuery.transfo');}
return false;};function _init($this,settings){var transfo={};$this.data('transfo',transfo);transfo.settings=settings;transfo.settings.document=transfo.settings.document||document;var css="box-sizing: border-box; position: absolute; background-color: #fff; border: 1px solid #ccc; width: 8px; height: 8px; margin-left: -4px; margin-top: -4px;";transfo.$markup=$(''
+'<div class="transfo-container">'
+'<div class="transfo-controls">'
+'<div style="cursor: crosshair; position: absolute; margin: -30px; top: 0; right: 0; padding: 1px 0 0 1px;" class="transfo-rotator">'
+'<span class="fa-stack fa-lg">'
+'<i class="fa fa-circle fa-stack-2x"></i>'
+'<i class="fa fa-repeat fa-stack-1x fa-inverse"></i>'
+'</span>'
+'</div>'
+'<div style="'+css+'top: 0%; left: 0%; cursor: nw-resize;" class="transfo-scaler-tl"></div>'
+'<div style="'+css+'top: 0%; left: 100%; cursor: ne-resize;" class="transfo-scaler-tr"></div>'
+'<div style="'+css+'top: 100%; left: 100%; cursor: se-resize;" class="transfo-scaler-br"></div>'
+'<div style="'+css+'top: 100%; left: 0%; cursor: sw-resize;" class="transfo-scaler-bl"></div>'
+'<div style="'+css+'top: 0%; left: 50%; cursor: n-resize;" class="transfo-scaler-tc"></div>'
+'<div style="'+css+'top: 100%; left: 50%; cursor: s-resize;" class="transfo-scaler-bc"></div>'
+'<div style="'+css+'top: 50%; left: 0%; cursor: w-resize;" class="transfo-scaler-ml"></div>'
+'<div style="'+css+'top: 50%; left: 100%; cursor: e-resize;" class="transfo-scaler-mr"></div>'
+'<div style="'+css+'border: 0; width: 0px; height: 0px; top: 50%; left: 50%;" class="transfo-scaler-mc"></div>'
+'</div>'
+'</div>');transfo.$center=transfo.$markup.find(".transfo-scaler-mc");_setOptions($this,transfo);_overwriteOptions($this,transfo,settings);$(transfo.settings.document.body).append(transfo.$markup);setTimeout(function(){_targetCss($this,transfo);},0);_bind($this,transfo);_targetCss($this,transfo);_stop_animation($this[0]);}
function _overwriteOptions($this,transfo,settings){transfo.settings=$.extend(transfo.settings,settings||{});}
function _stop_animation(target){target.style.webkitAnimationPlayState="paused";target.style.animationPlayState="paused";target.style.webkitTransition="none";target.style.transition="none";}
function _setOptions($this,transfo){var style=$this.attr("style")||"";var transform=style.match(/transform\s*:([^;]+)/)?style.match(/transform\s*:([^;]+)/)[1]:"";transfo.settings={};transfo.settings.angle=transform.indexOf('rotate')!=-1?parseFloat(transform.match(/rotate\(([^)]+)deg\)/)[1]):0;transfo.settings.scalex=transform.indexOf('scaleX')!=-1?parseFloat(transform.match(/scaleX\(([^)]+)\)/)[1]):1;transfo.settings.scaley=transform.indexOf('scaleY')!=-1?parseFloat(transform.match(/scaleY\(([^)]+)\)/)[1]):1;transfo.settings.style=style.replace(/[^;]*transform[^;]+/g,'').replace(/;+/g,';');$this.attr("style",transfo.settings.style);_stop_animation($this[0]);transfo.settings.pos=$this.offset();transfo.settings.height=$this.innerHeight();transfo.settings.width=$this.innerWidth();var translatex=transform.match(/translateX\(([0-9.-]+)(%|px)\)/);var translatey=transform.match(/translateY\(([0-9.-]+)(%|px)\)/);transfo.settings.translate="%";if(translatex&&translatex[2]==="%"){transfo.settings.translatexp=parseFloat(translatex[1]);transfo.settings.translatex=transfo.settings.translatexp/100*transfo.settings.width;}else{transfo.settings.translatex=translatex?parseFloat(translatex[1]):0;}
if(translatey&&translatey[2]==="%"){transfo.settings.translateyp=parseFloat(translatey[1]);transfo.settings.translatey=transfo.settings.translateyp/100*transfo.settings.height;}else{transfo.settings.translatey=translatey?parseFloat(translatey[1]):0;}
transfo.settings.css=window.getComputedStyle($this[0],null);transfo.settings.rotationStep=5;transfo.settings.hide=false;transfo.settings.callback=function(){};}
function _bind($this,transfo){function mousedown(event){_mouseDown($this,this,transfo,event);$(transfo.settings.document).on("mousemove",mousemove).on("mouseup",mouseup);}
function mousemove(event){_mouseMove($this,this,transfo,event);}
function mouseup(event){_mouseUp($this,this,transfo,event);$(transfo.settings.document).off("mousemove",mousemove).off("mouseup",mouseup);}
transfo.$markup.off().on("mousedown",mousedown);transfo.$markup.find(".transfo-controls >:not(.transfo-scaler-mc)").off().on("mousedown",mousedown);}
function _mouseDown($this,div,transfo,event){event.preventDefault();if(transfo.active||event.which!==1)return;var type="position",$e=$(div);if($e.hasClass("transfo-rotator"))type="rotator";else if($e.hasClass("transfo-scaler-tl"))type="tl";else if($e.hasClass("transfo-scaler-tr"))type="tr";else if($e.hasClass("transfo-scaler-br"))type="br";else if($e.hasClass("transfo-scaler-bl"))type="bl";else if($e.hasClass("transfo-scaler-tc"))type="tc";else if($e.hasClass("transfo-scaler-bc"))type="bc";else if($e.hasClass("transfo-scaler-ml"))type="ml";else if($e.hasClass("transfo-scaler-mr"))type="mr";transfo.active={"type":type,"scalex":transfo.settings.scalex,"scaley":transfo.settings.scaley,"pageX":event.pageX,"pageY":event.pageY,"center":transfo.$center.offset(),};}
function _mouseUp($this,div,transfo,event){transfo.active=null;}
function _mouseMove($this,div,transfo,event){event.preventDefault();if(!transfo.active)return;var settings=transfo.settings;var center=transfo.active.center;var cdx=center.left-event.pageX;var cdy=center.top-event.pageY;if(transfo.active.type=="rotator"){var ang,dang=Math.atan((settings.width*settings.scalex)/(settings.height*settings.scaley))/rad;if(cdy)ang=Math.atan(-cdx/cdy)/rad;else ang=0;if(event.pageY>=center.top&&event.pageX>=center.left)ang+=180;else if(event.pageY>=center.top&&event.pageX<center.left)ang+=180;else if(event.pageY<center.top&&event.pageX<center.left)ang+=360;ang-=dang;if(settings.scaley<0&&settings.scalex<0)ang+=180;if(!event.ctrlKey){settings.angle=Math.round(ang/transfo.settings.rotationStep)*transfo.settings.rotationStep;}else{settings.angle=ang;}
_targetCss($this,transfo);var new_center=transfo.$center.offset();var x=center.left-new_center.left;var y=center.top-new_center.top;var angle=ang*rad;settings.translatex+=x*Math.cos(angle)-y*Math.sin(-angle);settings.translatey+=-x*Math.sin(angle)+y*Math.cos(-angle);}
else if(transfo.active.type=="position"){var angle=settings.angle*rad;var x=event.pageX-transfo.active.pageX;var y=event.pageY-transfo.active.pageY;transfo.active.pageX=event.pageX;transfo.active.pageY=event.pageY;var dx=x*Math.cos(angle)-y*Math.sin(-angle);var dy=-x*Math.sin(angle)+y*Math.cos(-angle);settings.translatex+=dx;settings.translatey+=dy;}
else if(transfo.active.type.length===2){var angle=settings.angle*rad;var dx=cdx*Math.cos(angle)-cdy*Math.sin(-angle);var dy=-cdx*Math.sin(angle)+cdy*Math.cos(-angle);if(transfo.active.type.indexOf("t")!=-1){settings.scaley=dy/(settings.height/2);}
if(transfo.active.type.indexOf("b")!=-1){settings.scaley=-dy/(settings.height/2);}
if(transfo.active.type.indexOf("l")!=-1){settings.scalex=dx/(settings.width/2);}
if(transfo.active.type.indexOf("r")!=-1){settings.scalex=-dx/(settings.width/2);}
if(settings.scaley>0&&settings.scaley<0.05)settings.scaley=0.05;if(settings.scalex>0&&settings.scalex<0.05)settings.scalex=0.05;if(settings.scaley<0&&settings.scaley>-0.05)settings.scaley=-0.05;if(settings.scalex<0&&settings.scalex>-0.05)settings.scalex=-0.05;if(event.shiftKey&&(transfo.active.type==="tl"||transfo.active.type==="bl"||transfo.active.type==="tr"||transfo.active.type==="br")){settings.scaley=settings.scalex;}}
settings.angle=Math.round(settings.angle);settings.translatex=Math.round(settings.translatex);settings.translatey=Math.round(settings.translatey);settings.scalex=Math.round(settings.scalex*100)/100;settings.scaley=Math.round(settings.scaley*100)/100;_targetCss($this,transfo);_stop_animation($this[0]);return false;}
function _setCss($this,css,settings){var transform="";var trans=false;if(settings.angle!==0){trans=true;transform+=" rotate("+settings.angle+"deg) ";}
if(settings.translatex){trans=true;transform+=" translateX("+(settings.translate==="%"?settings.translatexp+"%":settings.translatex+"px")+") ";}
if(settings.translatey){trans=true;transform+=" translateY("+(settings.translate==="%"?settings.translateyp+"%":settings.translatey+"px")+") ";}
if(settings.scalex!=1){trans=true;transform+=" scaleX("+settings.scalex+") ";}
if(settings.scaley!=1){trans=true;transform+=" scaleY("+settings.scaley+") ";}
if(trans){css+=";"
css+="-webkit-transform:"+transform+";"
+"-moz-transform:"+transform+";"
+"-ms-transform:"+transform+";"
+"-o-transform:"+transform+";"
+"transform:"+transform+";";}
css=css.replace(/(\s*;)+/g,';').replace(/^\s*;|;\s*$/g,'');$this.attr("style",css);}
function _targetCss($this,transfo){var settings=transfo.settings;var width=parseFloat(settings.css.width);var height=parseFloat(settings.css.height);settings.translatexp=Math.round(settings.translatex/width*1000)/10;settings.translateyp=Math.round(settings.translatey/height*1000)/10;_setCss($this,settings.style,settings);transfo.$markup.css({"position":"absolute","width":width+"px","height":height+"px","top":settings.pos.top+"px","left":settings.pos.left+"px"});var $controls=transfo.$markup.find('.transfo-controls');_setCss($controls,"width:"+width+"px;"+"height:"+height+"px;"+"cursor: move;",settings);$controls.children().css("transform","scaleX("+(1/settings.scalex)+") scaleY("+(1/settings.scaley)+")");_showHide($this,transfo);transfo.settings.callback.call($this[0],$this);}
function _showHide($this,transfo){transfo.$markup.css("z-index",transfo.settings.hide?-1:1000);if(transfo.settings.hide){transfo.$markup.find(".transfo-controls > *").hide();transfo.$markup.find(".transfo-scaler-mc").show();}else{transfo.$markup.find(".transfo-controls > *").show();}}
function _destroy($this){$this.data('transfo').$markup.remove();$this.removeData('transfo');}
function _reset($this){var transfo=$this.data('transfo');_destroy($this);$this.transfo(transfo.settings);}})(jQuery);;

/* /web/static/lib/nearest/jquery.nearest.js defined in bundle 'web_editor.assets_wysiwyg' */
;(function($,undefined){var rPerc=/^([\d.]+)%$/;function nearest(selector,options,thisObj){selector||(selector='div');var $container=$(options.container),containerOffset=$container.offset()||{left:0,top:0},containerDims=[containerOffset.left+$container.width(),containerOffset.top+$container.height()],percProps={x:0,y:1,w:0,h:1},prop,match;for(prop in percProps)if(percProps.hasOwnProperty(prop)){match=rPerc.exec(options[prop]);if(match){options[prop]=containerDims[percProps[prop]]*match[1]/100;}}
var $all=$(selector),cache=[],furthest=!!options.furthest,checkX=!!options.checkHoriz,checkY=!!options.checkVert,compDist=furthest?0:Infinity,point1x=parseFloat(options.x)||0,point1y=parseFloat(options.y)||0,point2x=parseFloat(point1x+options.w)||point1x,point2y=parseFloat(point1y+options.h)||point1y,tolerance=options.tolerance||0,hasEach2=!!$.fn.each2,min=Math.min,max=Math.max;if(!options.includeSelf&&thisObj){$all=$all.not(thisObj);}
if(tolerance<0){tolerance=0;}
$all[hasEach2?'each2':'each'](function(i,elem){var $this=hasEach2?elem:$(this),off=$this.offset(),x=off.left,y=off.top,w=$this.outerWidth(),h=$this.outerHeight(),x2=x+w,y2=y+h,maxX1=max(x,point1x),minX2=min(x2,point2x),maxY1=max(y,point1y),minY2=min(y2,point2y),intersectX=minX2>=maxX1,intersectY=minY2>=maxY1,distX,distY,distT,isValid;if((checkX&&checkY)||(!checkX&&!checkY&&intersectX&&intersectY)||(checkX&&intersectY)||(checkY&&intersectX)){distX=intersectX?0:maxX1-minX2;distY=intersectY?0:maxY1-minY2;distT=intersectX||intersectY?max(distX,distY):Math.sqrt(distX*distX+distY*distY);isValid=furthest?distT>=compDist-tolerance:distT<=compDist+tolerance;if(isValid){compDist=furthest?max(compDist,distT):min(compDist,distT);cache.push({node:this,dist:distT});}}});var len=cache.length,filtered=[],compMin,compMax,i,item;if(len){if(furthest){compMin=compDist-tolerance;compMax=compDist;}else{compMin=compDist;compMax=compDist+tolerance;}
for(i=0;i<len;i++){item=cache[i];if(item.dist>=compMin&&item.dist<=compMax){filtered.push(item.node);}}}
return filtered;}
$.each(['nearest','furthest','touching'],function(i,name){var defaults={x:0,y:0,w:0,h:0,tolerance:1,container:document,furthest:name=='furthest',includeSelf:false,checkHoriz:name!='touching',checkVert:name!='touching'};$[name]=function(point,selector,options){if(!point||point.x===undefined||point.y===undefined){return $([]);}
var opts=$.extend({},defaults,point,options||{});return $(nearest(selector,opts));};$.fn[name]=function(selector,options){var opts;if(selector&&$.isPlainObject(selector)){opts=$.extend({},defaults,selector,options||{});return this.pushStack(nearest(this,opts));}
var offset=this.offset(),dimensions={x:offset.left,y:offset.top,w:this.outerWidth(),h:this.outerHeight()};opts=$.extend({},defaults,dimensions,options||{});return this.pushStack(nearest(selector,opts,this));};});})(jQuery);;

/* /web_editor/static/lib/webgl-image-filter/webgl-image-filter.js defined in bundle 'web_editor.assets_wysiwyg' */
(function(window){var WebGLProgram=function(gl,vertexSource,fragmentSource){var _collect=function(source,prefix,collection){var r=new RegExp('\\b'+prefix+' \\w+ (\\w+)','ig');source.replace(r,function(match,name){collection[name]=0;return match;});};var _compile=function(gl,source,type){var shader=gl.createShader(type);gl.shaderSource(shader,source);gl.compileShader(shader);if(!gl.getShaderParameter(shader,gl.COMPILE_STATUS)){console.log(gl.getShaderInfoLog(shader));return null;}
return shader;};this.uniform={};this.attribute={};var _vsh=_compile(gl,vertexSource,gl.VERTEX_SHADER);var _fsh=_compile(gl,fragmentSource,gl.FRAGMENT_SHADER);this.id=gl.createProgram();gl.attachShader(this.id,_vsh);gl.attachShader(this.id,_fsh);gl.linkProgram(this.id);if(!gl.getProgramParameter(this.id,gl.LINK_STATUS)){console.log(gl.getProgramInfoLog(this.id));}
gl.useProgram(this.id);_collect(vertexSource,'attribute',this.attribute);for(var a in this.attribute){this.attribute[a]=gl.getAttribLocation(this.id,a);}
_collect(vertexSource,'uniform',this.uniform);_collect(fragmentSource,'uniform',this.uniform);for(var u in this.uniform){this.uniform[u]=gl.getUniformLocation(this.id,u);}};const identityMatrix=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,];const weightedAvg=(a,b,w)=>a*w+b*(1-w);var WebGLImageFilter=window.WebGLImageFilter=function(params){if(!params)
params={};var
gl=null,_drawCount=0,_sourceTexture=null,_lastInChain=false,_currentFramebufferIndex=-1,_tempFramebuffers=[null,null],_filterChain=[],_width=-1,_height=-1,_vertexBuffer=null,_currentProgram=null,_canvas=params.canvas||document.createElement('canvas');var _shaderProgramCache={};var gl=_canvas.getContext("webgl")||_canvas.getContext("experimental-webgl");if(!gl){throw"Couldn't get WebGL context";}
this.addFilter=function(name){var args=Array.prototype.slice.call(arguments,1);var filter=_filter[name];_filterChain.push({func:filter,args:args});};this.reset=function(){_filterChain=[];};this.apply=function(image){_resize(image.width,image.height);_drawCount=0;if(!_sourceTexture)
_sourceTexture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,_sourceTexture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,image);if(_filterChain.length==0){var program=_compileShader(SHADER.FRAGMENT_IDENTITY);_draw();return _canvas;}
for(var i=0;i<_filterChain.length;i++){_lastInChain=(i==_filterChain.length-1);var f=_filterChain[i];f.func.apply(this,f.args||[]);}
return _canvas;};var _resize=function(width,height){if(width==_width&&height==_height){return;}
_canvas.width=_width=width;_canvas.height=_height=height;if(!_vertexBuffer){var vertices=new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,-1,1,0,0,1,-1,1,1,1,1,1,0]);_vertexBuffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,_vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,vertices,gl.STATIC_DRAW);gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,true);}
gl.viewport(0,0,_width,_height);_tempFramebuffers=[null,null];};var _getTempFramebuffer=function(index){_tempFramebuffers[index]=_tempFramebuffers[index]||_createFramebufferTexture(_width,_height);return _tempFramebuffers[index];};var _createFramebufferTexture=function(width,height){var fbo=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,fbo);var renderbuffer=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,renderbuffer);var texture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,texture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,width,height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,texture,0);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindFramebuffer(gl.FRAMEBUFFER,null);return{fbo:fbo,texture:texture};};var _draw=function(flags){var source=null,target=null,flipY=false;if(_drawCount==0){source=_sourceTexture;}
else{source=_getTempFramebuffer(_currentFramebufferIndex).texture;}
_drawCount++;if(_lastInChain&&!(flags&DRAW.INTERMEDIATE)){target=null;flipY=_drawCount%2==0;}
else{_currentFramebufferIndex=(_currentFramebufferIndex+1)%2;target=_getTempFramebuffer(_currentFramebufferIndex).fbo;}
gl.bindTexture(gl.TEXTURE_2D,source);gl.bindFramebuffer(gl.FRAMEBUFFER,target);gl.uniform1f(_currentProgram.uniform.flipY,(flipY?-1:1));gl.drawArrays(gl.TRIANGLES,0,6);};var _compileShader=function(fragmentSource){if(_shaderProgramCache[fragmentSource]){_currentProgram=_shaderProgramCache[fragmentSource];gl.useProgram(_currentProgram.id);return _currentProgram;}
_currentProgram=new WebGLProgram(gl,SHADER.VERTEX_IDENTITY,fragmentSource);var floatSize=Float32Array.BYTES_PER_ELEMENT;var vertSize=4*floatSize;gl.enableVertexAttribArray(_currentProgram.attribute.pos);gl.vertexAttribPointer(_currentProgram.attribute.pos,2,gl.FLOAT,false,vertSize,0*floatSize);gl.enableVertexAttribArray(_currentProgram.attribute.uv);gl.vertexAttribPointer(_currentProgram.attribute.uv,2,gl.FLOAT,false,vertSize,2*floatSize);_shaderProgramCache[fragmentSource]=_currentProgram;return _currentProgram;};var DRAW={INTERMEDIATE:1};var SHADER={};SHADER.VERTEX_IDENTITY=['precision highp float;','attribute vec2 pos;','attribute vec2 uv;','varying vec2 vUv;','uniform float flipY;','void main(void) {','vUv = uv;','gl_Position = vec4(pos.x, pos.y*flipY, 0.0, 1.);','}'].join('\n');SHADER.FRAGMENT_IDENTITY=['precision highp float;','varying vec2 vUv;','uniform sampler2D texture;','void main(void) {','gl_FragColor = texture2D(texture, vUv);','}',].join('\n');var _filter={};_filter.colorMatrix=function(matrix,amount=1){matrix=matrix.map((coef,index)=>weightedAvg(coef,identityMatrix[index],amount));var m=new Float32Array(matrix);m[4]/=255;m[9]/=255;m[14]/=255;m[19]/=255;var shader=(1==m[18]&&0==m[3]&&0==m[8]&&0==m[13]&&0==m[15]&&0==m[16]&&0==m[17]&&0==m[19])?_filter.colorMatrix.SHADER.WITHOUT_ALPHA:_filter.colorMatrix.SHADER.WITH_ALPHA;var program=_compileShader(shader);gl.uniform1fv(program.uniform.m,m);_draw();};_filter.colorMatrix.SHADER={};_filter.colorMatrix.SHADER.WITH_ALPHA=['precision highp float;','varying vec2 vUv;','uniform sampler2D texture;','uniform float m[20];','void main(void) {','vec4 c = texture2D(texture, vUv);','gl_FragColor.r = m[0] * c.r + m[1] * c.g + m[2] * c.b + m[3] * c.a + m[4];','gl_FragColor.g = m[5] * c.r + m[6] * c.g + m[7] * c.b + m[8] * c.a + m[9];','gl_FragColor.b = m[10] * c.r + m[11] * c.g + m[12] * c.b + m[13] * c.a + m[14];','gl_FragColor.a = m[15] * c.r + m[16] * c.g + m[17] * c.b + m[18] * c.a + m[19];','}',].join('\n');_filter.colorMatrix.SHADER.WITHOUT_ALPHA=['precision highp float;','varying vec2 vUv;','uniform sampler2D texture;','uniform float m[20];','void main(void) {','vec4 c = texture2D(texture, vUv);','gl_FragColor.r = m[0] * c.r + m[1] * c.g + m[2] * c.b + m[4];','gl_FragColor.g = m[5] * c.r + m[6] * c.g + m[7] * c.b + m[9];','gl_FragColor.b = m[10] * c.r + m[11] * c.g + m[12] * c.b + m[14];','gl_FragColor.a = c.a;','}',].join('\n');_filter.brightness=function(brightness){var b=(brightness||0)+1;_filter.colorMatrix([b,0,0,0,0,0,b,0,0,0,0,0,b,0,0,0,0,0,1,0]);};_filter.saturation=function(amount){var x=(amount||0)*2/3+1;var y=((x-1)*-0.5);_filter.colorMatrix([x,y,y,0,0,y,x,y,0,0,y,y,x,0,0,0,0,0,1,0]);};_filter.desaturate=function(){_filter.saturation(-1);};_filter.contrast=function(amount){var v=(amount||0)+1;var o=-128*(v-1);_filter.colorMatrix([v,0,0,0,o,0,v,0,0,o,0,0,v,0,o,0,0,0,1,0]);};_filter.negative=function(){_filter.contrast(-2);};_filter.hue=function(rotation){rotation=(rotation||0)/180*Math.PI;var cos=Math.cos(rotation),sin=Math.sin(rotation),lumR=0.213,lumG=0.715,lumB=0.072;_filter.colorMatrix([lumR+cos*(1-lumR)+sin*(-lumR),lumG+cos*(-lumG)+sin*(-lumG),lumB+cos*(-lumB)+sin*(1-lumB),0,0,lumR+cos*(-lumR)+sin*(0.143),lumG+cos*(1-lumG)+sin*(0.140),lumB+cos*(-lumB)+sin*(-0.283),0,0,lumR+cos*(-lumR)+sin*(-(1-lumR)),lumG+cos*(-lumG)+sin*(lumG),lumB+cos*(1-lumB)+sin*(lumB),0,0,0,0,0,1,0]);};_filter.desaturateLuminance=function(amount){_filter.colorMatrix([0.2764723,0.9297080,0.0938197,0,-37.1,0.2764723,0.9297080,0.0938197,0,-37.1,0.2764723,0.9297080,0.0938197,0,-37.1,0,0,0,1,0],amount);};_filter.sepia=function(amount){_filter.colorMatrix([0.393,0.7689999,0.18899999,0,0,0.349,0.6859999,0.16799999,0,0,0.272,0.5339999,0.13099999,0,0,0,0,0,1,0],amount);};_filter.brownie=function(amount){_filter.colorMatrix([0.5997023498159715,0.34553243048391263,-0.2708298674538042,0,47.43192855600873,-0.037703249837783157,0.8609577587992641,0.15059552388459913,0,-36.96841498319127,0.24113635128153335,-0.07441037908422492,0.44972182064877153,0,-7.562075277591283,0,0,0,1,0],amount);};_filter.vintagePinhole=function(amount){_filter.colorMatrix([0.6279345635605994,0.3202183420819367,-0.03965408211312453,0,9.651285835294123,0.02578397704808868,0.6441188644374771,0.03259127616149294,0,7.462829176470591,0.0466055556782719,-0.0851232987247891,0.5241648018700465,0,5.159190588235296,0,0,0,1,0],amount);};_filter.kodachrome=function(amount){_filter.colorMatrix([1.1285582396593525,-0.3967382283601348,-0.03992559172921793,0,63.72958762196502,-0.16404339962244616,1.0835251566291304,-0.05498805115633132,0,24.732407896706203,-0.16786010706155763,-0.5603416277695248,1.6014850761964943,0,35.62982807460946,0,0,0,1,0],amount);};_filter.technicolor=function(amount){_filter.colorMatrix([1.9125277891456083,-0.8545344976951645,-0.09155508482755585,0,11.793603434377337,-0.3087833385928097,1.7658908555458428,-0.10601743074722245,0,-70.35205161461398,-0.231103377548616,-0.7501899197440212,1.847597816108189,0,30.950940869491138,0,0,0,1,0],amount);};_filter.polaroid=function(amount){_filter.colorMatrix([1.438,-0.062,-0.062,0,0,-0.122,1.378,-0.122,0,0,-0.016,-0.016,1.483,0,0,0,0,0,1,0],amount);};_filter.shiftToBGR=function(amount){_filter.colorMatrix([0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0],amount);};_filter.convolution=function(matrix){var m=new Float32Array(matrix);var pixelSizeX=1/_width;var pixelSizeY=1/_height;var program=_compileShader(_filter.convolution.SHADER);gl.uniform1fv(program.uniform.m,m);gl.uniform2f(program.uniform.px,pixelSizeX,pixelSizeY);_draw();};_filter.convolution.SHADER=['precision highp float;','varying vec2 vUv;','uniform sampler2D texture;','uniform vec2 px;','uniform float m[9];','void main(void) {','vec4 c11 = texture2D(texture, vUv - px);','vec4 c12 = texture2D(texture, vec2(vUv.x, vUv.y - px.y));','vec4 c13 = texture2D(texture, vec2(vUv.x + px.x, vUv.y - px.y));','vec4 c21 = texture2D(texture, vec2(vUv.x - px.x, vUv.y) );','vec4 c22 = texture2D(texture, vUv);','vec4 c23 = texture2D(texture, vec2(vUv.x + px.x, vUv.y) );','vec4 c31 = texture2D(texture, vec2(vUv.x - px.x, vUv.y + px.y) );','vec4 c32 = texture2D(texture, vec2(vUv.x, vUv.y + px.y) );','vec4 c33 = texture2D(texture, vUv + px );','gl_FragColor = ','c11 * m[0] + c12 * m[1] + c22 * m[2] +','c21 * m[3] + c22 * m[4] + c23 * m[5] +','c31 * m[6] + c32 * m[7] + c33 * m[8];','gl_FragColor.a = c22.a;','}',].join('\n');_filter.detectEdges=function(){_filter.convolution.call(this,[0,1,0,1,-4,1,0,1,0]);};_filter.sobelX=function(){_filter.convolution.call(this,[-1,0,1,-2,0,2,-1,0,1]);};_filter.sobelY=function(){_filter.convolution.call(this,[-1,-2,-1,0,0,0,1,2,1]);};_filter.sharpen=function(amount){var a=amount||1;_filter.convolution.call(this,[0,-1*a,0,-1*a,1+4*a,-1*a,0,-1*a,0]);};_filter.emboss=function(size){var s=size||1;_filter.convolution.call(this,[-2*s,-1*s,0,-1*s,1,1*s,0,1*s,2*s]);};_filter.blur=function(size){var blurSizeX=(size/7)/_width;var blurSizeY=(size/7)/_height;var program=_compileShader(_filter.blur.SHADER);gl.uniform2f(program.uniform.px,0,blurSizeY);_draw(DRAW.INTERMEDIATE);gl.uniform2f(program.uniform.px,blurSizeX,0);_draw();};_filter.blur.SHADER=['precision highp float;','varying vec2 vUv;','uniform sampler2D texture;','uniform vec2 px;','void main(void) {','gl_FragColor = vec4(0.0);','gl_FragColor += texture2D(texture, vUv + vec2(-7.0*px.x, -7.0*px.y))*0.0044299121055113265;','gl_FragColor += texture2D(texture, vUv + vec2(-6.0*px.x, -6.0*px.y))*0.00895781211794;','gl_FragColor += texture2D(texture, vUv + vec2(-5.0*px.x, -5.0*px.y))*0.0215963866053;','gl_FragColor += texture2D(texture, vUv + vec2(-4.0*px.x, -4.0*px.y))*0.0443683338718;','gl_FragColor += texture2D(texture, vUv + vec2(-3.0*px.x, -3.0*px.y))*0.0776744219933;','gl_FragColor += texture2D(texture, vUv + vec2(-2.0*px.x, -2.0*px.y))*0.115876621105;','gl_FragColor += texture2D(texture, vUv + vec2(-1.0*px.x, -1.0*px.y))*0.147308056121;','gl_FragColor += texture2D(texture, vUv                             )*0.159576912161;','gl_FragColor += texture2D(texture, vUv + vec2( 1.0*px.x,  1.0*px.y))*0.147308056121;','gl_FragColor += texture2D(texture, vUv + vec2( 2.0*px.x,  2.0*px.y))*0.115876621105;','gl_FragColor += texture2D(texture, vUv + vec2( 3.0*px.x,  3.0*px.y))*0.0776744219933;','gl_FragColor += texture2D(texture, vUv + vec2( 4.0*px.x,  4.0*px.y))*0.0443683338718;','gl_FragColor += texture2D(texture, vUv + vec2( 5.0*px.x,  5.0*px.y))*0.0215963866053;','gl_FragColor += texture2D(texture, vUv + vec2( 6.0*px.x,  6.0*px.y))*0.00895781211794;','gl_FragColor += texture2D(texture, vUv + vec2( 7.0*px.x,  7.0*px.y))*0.0044299121055113265;','}',].join('\n');_filter.pixelate=function(size){var blurSizeX=(size)/_width;var blurSizeY=(size)/_height;var program=_compileShader(_filter.pixelate.SHADER);gl.uniform2f(program.uniform.size,blurSizeX,blurSizeY);_draw();};_filter.pixelate.SHADER=['precision highp float;','varying vec2 vUv;','uniform vec2 size;','uniform sampler2D texture;','vec2 pixelate(vec2 coord, vec2 size) {','return floor( coord / size ) * size;','}','void main(void) {','gl_FragColor = vec4(0.0);','vec2 coord = pixelate(vUv, size);','gl_FragColor += texture2D(texture, coord);','}',].join('\n');};})(window);;

/* /web_editor/static/lib/odoo-editor/src/OdooEditor.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('@web_editor/../lib/odoo-editor/src/OdooEditor',async function(require){'use strict';let __exports={};'use strict';require("@web_editor/../lib/odoo-editor/src/commands/deleteBackward");require("@web_editor/../lib/odoo-editor/src/commands/deleteForward");require("@web_editor/../lib/odoo-editor/src/commands/enter");require("@web_editor/../lib/odoo-editor/src/commands/shiftEnter");require("@web_editor/../lib/odoo-editor/src/commands/shiftTab");require("@web_editor/../lib/odoo-editor/src/commands/tab");require("@web_editor/../lib/odoo-editor/src/commands/toggleList");require("@web_editor/../lib/odoo-editor/src/commands/align");const{sanitize}=require("@web_editor/../lib/odoo-editor/src/utils/sanitize");const{serializeNode,unserializeNode,serializeSelection}=require("@web_editor/../lib/odoo-editor/src/utils/serialize");const{closestBlock,commonParentGet,containsUnremovable,DIRECTIONS,endPos,getCursorDirection,getListMode,getOuid,insertText,isColorGradient,nodeSize,preserveCursor,setSelection,startPos,toggleClass,closestElement,isVisible,rgbToHex,isFontAwesome,getInSelection,getDeepRange,ancestors,firstLeaf,nextLeaf,isUnremovable,fillEmpty,isEmptyBlock,getUrlsInfosInString,URL_REGEX,isBold,YOUTUBE_URL_GET_VIDEO_ID,unwrapContents,peek,}=require("@web_editor/../lib/odoo-editor/src/utils/utils");const{editorCommands}=require("@web_editor/../lib/odoo-editor/src/commands/commands");const{Powerbox}=require("@web_editor/../lib/odoo-editor/src/powerbox/Powerbox");const{TablePicker}=require("@web_editor/../lib/odoo-editor/src/tablepicker/TablePicker");Object.assign(__exports,require("@web_editor/../lib/odoo-editor/src/utils/utils"));const{UNBREAKABLE_ROLLBACK_CODE,UNREMOVABLE_ROLLBACK_CODE}=require("@web_editor/../lib/odoo-editor/src/utils/constants");const BACKSPACE_ONLY_COMMANDS=['oDeleteBackward','oDeleteForward'];const BACKSPACE_FIRST_COMMANDS=BACKSPACE_ONLY_COMMANDS.concat(['oEnter','oShiftEnter']);const HISTORY_SNAPSHOT_INTERVAL=1000*60;const HISTORY_SNAPSHOT_BUFFER_TIME=1000*10;const KEYBOARD_TYPES={VIRTUAL:'VIRTUAL',PHYSICAL:'PHYSICAL',UNKNOWN:'UKNOWN'};const IS_KEYBOARD_EVENT_UNDO=ev=>ev.key==='z'&&(ev.ctrlKey||ev.metaKey);const IS_KEYBOARD_EVENT_REDO=ev=>ev.key==='y'&&(ev.ctrlKey||ev.metaKey);const IS_KEYBOARD_EVENT_BOLD=ev=>ev.key==='b'&&(ev.ctrlKey||ev.metaKey);const CLIPBOARD_BLACKLISTS={unwrap:['.Apple-interchange-newline','DIV'],remove:['META','STYLE','SCRIPT'],};const CLIPBOARD_WHITELISTS={nodes:['P','H1','H2','H3','H4','H5','H6','BLOCKQUOTE','PRE','UL','OL','LI','I','B','U','EM','STRONG','TABLE','TH','TBODY','TR','TD','IMG','BR','A','.fa',],classes:[/^float-/,'d-block','mx-auto','img-fluid','img-thumbnail','rounded','rounded-circle',/^padding-/,/^shadow/,/^text-o-/,/^bg-o-/,'o_checked','o_checklist',/^btn/,/^fa/,],attributes:['class','href','src'],};function defaultOptions(defaultObject,object){const newObject=Object.assign({},defaultObject,object);for(const[key,value]of Object.entries(object)){if(typeof value==='undefined'){newObject[key]=defaultObject[key];}}
return newObject;}
const OdooEditor=__exports.OdooEditor=class OdooEditor extends EventTarget{constructor(editable,options={}){super();this.options=defaultOptions({controlHistoryFromDocument:false,getContextFromParentRect:()=>{return{top:0,left:0};},toSanitize:true,isRootEditable:true,placeholder:false,defaultLinkAttributes:{},plugins:[],getContentEditableAreas:()=>[],getPowerboxElement:()=>{const selection=document.getSelection();if(selection.isCollapsed&&selection.rangeCount){return closestElement(selection.anchorNode,'P, DIV');}},isHintBlacklisted:()=>false,_t:string=>string,},options,);this.document=options.document||document;this.isMobile=matchMedia('(max-width: 767px)').matches;this.keyboardType=KEYBOARD_TYPES.UNKNOWN;this._checkStepUnbreakable=true;this._domListeners=[];this._observerTimeoutUnactive=new Set();this._observerUnactiveLabels=new Set();this._currentMouseState='mouseup';this._onKeyupResetContenteditableNodes=[];this._toRollback=false;this._idToNodeMap=new Map();this._plugins=[];for(const plugin of this.options.plugins){this._pluginAdd(plugin);}
if(editable.innerHTML.trim()===''){editable.innerHTML='<p><br></p>';}
editable.oid='root';this._idToNodeMap.set(1,editable);this.editable=this.options.toSanitize?sanitize(editable):editable;this._activateContenteditable();this._collabClientId=this.options.collaborationClientId;this._collabSelectionInfos=new Map();this._collabSelectionColor=`hsl(${(Math.random() * 360).toFixed(0)}, 75%, 50%)`;this._collabSelectionsContainer=this.document.createElement('div');this._collabSelectionsContainer.classList.add('oe-collaboration-selections-container');this.editable.before(this._collabSelectionsContainer);this.idSet(editable);this._historyStepsActive=true;this.historyReset();this._pluginCall('sanitizeElement',[editable]);this._createCommandBar();this.toolbarTablePicker=new TablePicker({document:this.document});this.toolbarTablePicker.addEventListener('cell-selected',ev=>{this.execCommand('insertTable',{rowNumber:ev.detail.rowNumber,colNumber:ev.detail.colNumber,});});this.observerActive();this.addDomListener(this.editable,'keydown',this._onKeyDown);this.addDomListener(this.editable,'input',this._onInput);this.addDomListener(this.editable,'beforeinput',this._onBeforeInput);this.addDomListener(this.editable,'mousedown',this._onMouseDown);this.addDomListener(this.editable,'mouseup',this._onMouseup);this.addDomListener(this.editable,'paste',this._onPaste);this.addDomListener(this.editable,'drop',this._onDrop);this.addDomListener(this.document,'selectionchange',this._onSelectionChange);this.addDomListener(this.document,'selectionchange',this._handleCommandHint);this.addDomListener(this.document,'keydown',this._onDocumentKeydown);this.addDomListener(this.document,'keyup',this._onDocumentKeyup);this.addDomListener(this.document,'mousedown',this._onDoumentMousedown);this.addDomListener(this.document,'mouseup',this._onDoumentMouseup);this.multiselectionRefresh=this.multiselectionRefresh.bind(this);this._resizeObserver=new ResizeObserver(this.multiselectionRefresh);this._resizeObserver.observe(this.document.body);this._resizeObserver.observe(this.editable);this.addDomListener(this.editable,'scroll',this.multiselectionRefresh);if(this._collabClientId){this._snapshotInterval=setInterval(()=>{this._historyMakeSnapshot();},HISTORY_SNAPSHOT_INTERVAL);}
if(this.options.toolbar){this.toolbar=this.options.toolbar;this.bindExecCommand(this.toolbar);const toolbarAnchors=this.toolbar.querySelectorAll('a');toolbarAnchors.forEach(a=>a.addEventListener('click',e=>e.preventDefault()));const tablepickerDropdown=this.toolbar.querySelector('.oe-tablepicker-dropdown');tablepickerDropdown&&tablepickerDropdown.append(this.toolbarTablePicker.el);this.toolbarTablePicker.show();const tableDropdownButton=this.toolbar.querySelector('#tableDropdownButton');tableDropdownButton&&tableDropdownButton.addEventListener('click',()=>{this.toolbarTablePicker.reset();});for(const colorLabel of this.toolbar.querySelectorAll('label')){colorLabel.addEventListener('mousedown',ev=>{if(ev.detail<2){ev.preventDefault();ev.currentTarget.dispatchEvent(new MouseEvent('click',{detail:2}));}});colorLabel.addEventListener('input',ev=>{this.document.execCommand(ev.target.name,false,ev.target.value);this.updateColorpickerLabels();});}
if(this.isMobile){this.editable.before(this.toolbar);}}
if(editable.textContent===''&&this.options.placeholder){this._makeHint(editable.firstChild,this.options.placeholder,true);}}
destroy(){this.observerUnactive();this._removeDomListener();this.commandBar.destroy();this.commandbarTablePicker.el.remove();this._collabSelectionsContainer.remove();this._resizeObserver.disconnect();clearInterval(this._snapshotInterval);this._pluginCall('destroy',[]);}
sanitize(){this.observerFlush();let commonAncestor,record;for(record of this._currentStep.mutations){const node=this.idFind(record.parentId||record.id)||this.editable;commonAncestor=commonAncestor?commonParentGet(commonAncestor,node,this.editable):node;}
if(!commonAncestor){return false;}
sanitize(commonAncestor);this._pluginCall('sanitizeElement',[commonAncestor]);}
addDomListener(element,eventName,callback){const boundCallback=callback.bind(this);this._domListeners.push([element,eventName,boundCallback]);element.addEventListener(eventName,boundCallback);}
_generateId(){return Math.floor(Math.random()*Math.pow(2,52)).toString();}
idSet(node,testunbreak=false){if(!node.oid){node.oid=this._generateId();}
this._idToNodeMap.set(node.oid,node);node.ouid=node.ouid||getOuid(node,true);if(testunbreak&&!(node.nodeType===Node.TEXT_NODE&&!node.length)){const ouid=getOuid(node);if(!this._toRollback&&ouid&&ouid!==node.ouid){this._toRollback=UNBREAKABLE_ROLLBACK_CODE;}}
let childNode=node.firstChild;while(childNode){this.idSet(childNode,testunbreak);childNode=childNode.nextSibling;}}
idFind(id){return this._idToNodeMap.get(id);}
serializeNode(node,mutatedNodes){return this._collabClientId?serializeNode(node,mutatedNodes):node;}
unserializeNode(node){return this._collabClientId?unserializeNode(node):node;}
automaticStepActive(label){this._observerTimeoutUnactive.delete(label);}
automaticStepUnactive(label){this._observerTimeoutUnactive.add(label);}
automaticStepSkipStack(){this.automaticStepUnactive('skipStack');setTimeout(()=>this.automaticStepActive('skipStack'));}
observerUnactive(label){this._observerUnactiveLabels.add(label);if(this.observer){clearTimeout(this.observerTimeout);this.observer.disconnect();this.observerFlush();}}
observerFlush(){this.observerApply(this.observer.takeRecords());}
observerActive(label){this._observerUnactiveLabels.delete(label);if(this._observerUnactiveLabels.size!==0)return;if(!this.observer){this.observer=new MutationObserver(records=>{records=this.filterMutationRecords(records);if(!records.length)return;clearTimeout(this.observerTimeout);if(this._observerTimeoutUnactive.size===0){this.observerTimeout=setTimeout(()=>{this.historyStep();},100);}
this.observerApply(records);});}
this.observer.observe(this.editable,{childList:true,subtree:true,attributes:true,attributeOldValue:true,characterData:true,characterDataOldValue:true,});}
observerApply(records){const mutatedNodes=new Set();for(const record of records){if(record.type==='childList'){for(const node of record.addedNodes){this.idSet(node,this._checkStepUnbreakable);mutatedNodes.add(node.oid);}
for(const node of record.removedNodes){this.idSet(node,this._checkStepUnbreakable);mutatedNodes.delete(node.oid);}}}
for(const record of records){switch(record.type){case'characterData':{this._currentStep.mutations.push({'type':'characterData','id':record.target.oid,'text':record.target.textContent,'oldValue':record.oldValue,});break;}
case'attributes':{this._currentStep.mutations.push({'type':'attributes','id':record.target.oid,'attributeName':record.attributeName,'value':record.target.getAttribute(record.attributeName),'oldValue':record.oldValue,});break;}
case'childList':{record.addedNodes.forEach(added=>{this._toRollback=this._toRollback||(containsUnremovable(added)&&UNREMOVABLE_ROLLBACK_CODE);const mutation={'type':'add',};if(!record.nextSibling&&record.target.oid){mutation.append=record.target.oid;}else if(record.nextSibling&&record.nextSibling.oid){mutation.before=record.nextSibling.oid;}else if(!record.previousSibling&&record.target.oid){mutation.prepend=record.target.oid;}else if(record.previousSibling&&record.previousSibling.oid){mutation.after=record.previousSibling.oid;}else{return false;}
mutation.id=added.oid;mutation.node=this.serializeNode(added,mutatedNodes);this._currentStep.mutations.push(mutation);});record.removedNodes.forEach(removed=>{if(!this._toRollback&&containsUnremovable(removed)){this._toRollback=UNREMOVABLE_ROLLBACK_CODE;}
this._currentStep.mutations.push({'type':'remove','id':removed.oid,'parentId':record.target.oid,'node':this.serializeNode(removed),'nextId':record.nextSibling?record.nextSibling.oid:undefined,'previousId':record.previousSibling?record.previousSibling.oid:undefined,});});break;}}}
if(records.length){this.dispatchEvent(new Event('observerApply'));}}
filterMutationRecords(records){const attributeCache=new Map();const filteredRecords=[];for(const record of records){if(record.type==='attributes'){if(record.target===this.editable)continue;attributeCache.set(record.target,attributeCache.get(record.target)||{});if(typeof attributeCache.get(record.target)[record.attributeName]==='undefined'){const oldValue=record.oldValue===undefined?null:record.oldValue;attributeCache.get(record.target)[record.attributeName]=oldValue!==record.target.getAttribute(record.attributeName);}
if(!attributeCache.get(record.target)[record.attributeName]){continue;}}
filteredRecords.push(record);}
return filteredRecords;}
historyReset(){this._historyClean();const firstStep=this._historyGetSnapshotStep();this._firstStepId=firstStep.id;this._historySnapshots=[{step:firstStep}];this._historySteps.push(firstStep);}
historyGetSnapshotSteps(){if(!this._historySnapshots[0].time){return this._historySteps;}
const steps=[];let snapshot;if(this._historySnapshots[0].time+HISTORY_SNAPSHOT_BUFFER_TIME<Date.now()){snapshot=this._historySnapshots[0];}else{snapshot=this._historySnapshots[1];}
let index=this._historySteps.length-1;while(this._historySteps[index].id!==snapshot.step.id){steps.push(this._historySteps[index]);index--;}
steps.push(snapshot.step);steps.reverse();return steps;}
historyResetFromSteps(steps){this.observerUnactive();for(const node of[...this.editable.childNodes]){node.remove();}
this._historyClean();for(const step of steps){this.historyApply(step.mutations);}
this._historySnapshots=[{step:steps[0]}];this._historySteps=steps;this._handleCommandHint();this.multiselectionRefresh();this.observerActive();}
historyGetMissingSteps({fromStepId,toStepId}){const fromIndex=this._historySteps.findIndex(x=>x.id===fromStepId);const toIndex=this._historySteps.findIndex(x=>x.id===toStepId);if(fromIndex===-1||toIndex===-1){return-1;}
return this._historySteps.slice(fromIndex+1,toIndex);}
historyStep(skipRollback=false){if(!this._historyStepsActive){return;}
this.observerFlush();if(this._toRollback){if(!skipRollback)this.historyRollback();this._toRollback=false;}
const currentStep=this._currentStep;if(!currentStep.mutations.length){return false;}
currentStep.id=this._generateId();const previousStep=peek(this._historySteps);currentStep.clientId=this._collabClientId;currentStep.previousStepId=previousStep.id;this._historySteps.push(currentStep);if(this.options.onHistoryStep){this.options.onHistoryStep(currentStep);}
this._currentStep={selection:{},mutations:[],};this._checkStepUnbreakable=true;this._recordHistorySelection();this.dispatchEvent(new Event('historyStep'));this.multiselectionRefresh();}
historyApply(records){for(const record of records){if(record.type==='characterData'){const node=this.idFind(record.id);if(node){node.textContent=record.text;}}else if(record.type==='attributes'){const node=this.idFind(record.id);if(node){this._safeSetAttribute(node,record.attributeName,record.value);}}else if(record.type==='remove'){const toremove=this.idFind(record.id);if(toremove){toremove.remove();}}else if(record.type==='add'){let node=this.idFind(record.oid)||this.unserializeNode(record.node);const fakeNode=document.createElement('fake-el');fakeNode.appendChild(node);DOMPurify.sanitize(fakeNode,{IN_PLACE:true});node=fakeNode.childNodes[0];if(!node){continue;}
this.idSet(node,true);if(record.append&&this.idFind(record.append)){this.idFind(record.append).append(node);}else if(record.before&&this.idFind(record.before)){this.idFind(record.before).before(node);}else if(record.after&&this.idFind(record.after)){this.idFind(record.after).after(node);}else{continue;}}}}
historyRollback(until=0){const step=this._currentStep;this.observerFlush();this.historyRevert(step,{until});this.observerFlush();step.mutations=step.mutations.slice(0,until);this._toRollback=false;}
historyUndo(){const lastStep=this._currentStep;this.historyRevert(lastStep);lastStep.mutations=[];const pos=this._getNextUndoIndex();if(pos>0){this._historyStepsStates.set(this._historySteps[pos].id,'consumed');this.historyRevert(this._historySteps[pos]);this.historyStep(true);const undoStep=this._historySteps[this._historySteps.length-1];this._historyStepsStates.set(undoStep.id,'undo');this.dispatchEvent(new Event('historyUndo'));}}
historyRedo(){const pos=this._getNextRedoIndex();if(pos>0){this._historyStepsStates.set(this._historySteps[pos].id,'consumed');this.historyRevert(this._historySteps[pos]);this.historySetSelection(this._historySteps[pos]);this.historyStep(true);const lastStep=this._historySteps[this._historySteps.length-1];this._historyStepsStates.set(lastStep.id,'redo');this.dispatchEvent(new Event('historyRedo'));}}
historyCanUndo(){return this._getNextUndoIndex()>0;}
historyCanRedo(){return this._getNextRedoIndex()>0;}
historySize(){return this._historySteps.length;}
historyRevert(step,{until=0,sideEffect=true}={}){for(let i=step.mutations.length-1;i>=until;i--){const mutation=step.mutations[i];if(!mutation){break;}
switch(mutation.type){case'characterData':{const node=this.idFind(mutation.id);if(node)node.textContent=mutation.oldValue;break;}
case'attributes':{const node=this.idFind(mutation.id);if(node){if(mutation.oldValue){this._safeSetAttribute(node,mutation.attributeName,mutation.oldValue);}else{node.removeAttribute(mutation.attributeName);}}
break;}
case'remove':{let nodeToRemove=this.idFind(mutation.id);if(!nodeToRemove){nodeToRemove=this.unserializeNode(mutation.node);const fakeNode=document.createElement('fake-el');fakeNode.appendChild(nodeToRemove);DOMPurify.sanitize(fakeNode,{IN_PLACE:true});nodeToRemove=fakeNode.childNodes[0];if(!nodeToRemove){continue;}
this.idSet(nodeToRemove);}
if(mutation.nextId&&this.idFind(mutation.nextId)){const node=this.idFind(mutation.nextId);node&&node.before(nodeToRemove);}else if(mutation.previousId&&this.idFind(mutation.previousId)){const node=this.idFind(mutation.previousId);node&&node.after(nodeToRemove);}else{const node=this.idFind(mutation.parentId);node&&node.append(nodeToRemove);}
break;}
case'add':{const node=this.idFind(mutation.id);if(node){node.remove();}}}}
if(sideEffect){this._activateContenteditable();this.historySetSelection(step);this.dispatchEvent(new Event('historyRevert'));}}
historyResetLatestComputedSelection(limitToEditable){const computedSelection=limitToEditable?this._latestComputedSelectionInEditable:this._latestComputedSelection;if(computedSelection&&computedSelection.anchorNode){const anchorNode=this.idFind(computedSelection.anchorNode.oid);const focusNode=this.idFind(computedSelection.focusNode.oid)||anchorNode;if(anchorNode){setSelection(anchorNode,computedSelection.anchorOffset,focusNode,computedSelection.focusOffset,);}}}
historySetSelection(step){if(step.selection&&step.selection.anchorNodeOid){const anchorNode=this.idFind(step.selection.anchorNodeOid);const focusNode=this.idFind(step.selection.focusNodeOid)||anchorNode;if(anchorNode){setSelection(anchorNode,step.selection.anchorOffset,focusNode,step.selection.focusOffset!==undefined?step.selection.focusOffset:step.selection.anchorOffset,false,);}}}
unbreakableStepUnactive(){this._toRollback=this._toRollback===UNBREAKABLE_ROLLBACK_CODE?false:this._toRollback;this._checkStepUnbreakable=false;}
historyPauseSteps(){this._historyStepsActive=false;}
historyUnpauseSteps(){this._historyStepsActive=true;}
_historyClean(){this._historySteps=[];this._currentStep={selection:{anchorNodeOid:undefined,anchorOffset:undefined,focusNodeOid:undefined,focusOffset:undefined,},mutations:[],id:undefined,clientId:undefined,};this._historyStepsStates=new Map();}
_historyGetSnapshotStep(){return{selection:{anchorNode:undefined,anchorOffset:undefined,focusNode:undefined,focusOffset:undefined,},mutations:Array.from(this.editable.childNodes).map(node=>({type:'add',append:1,id:node.oid,node:this.serializeNode(node),})),id:this._generateId(),clientId:this.clientId,previousStepId:undefined,};}
_historyMakeSnapshot(){if(!this._lastSnapshotHistoryLength||this._lastSnapshotHistoryLength<this._historySteps.length){this._lastSnapshotHistoryLength=this._historySteps.length;const step=this._historyGetSnapshotStep();step.id=this._historySteps[this._historySteps.length-1].id;const snapshot={time:Date.now(),step:step,};this._historySnapshots=[snapshot,this._historySnapshots[0]];}}
_historyAddExternalStep(newStep){let index=this._historySteps.length-1;while(index>=0&&this._historySteps[index].id!==newStep.previousStepId){if(this._historySteps[index].id===newStep.id){return;}
index--;}
if(index<0){if(this.options.onHistoryMissingParentSteps){const historySteps=this._historySteps;let index=historySteps.length-1;while(index!==0){if(historySteps[index].clientId===newStep.clientId){break;}
index--;}
const fromStepId=historySteps[index].id;this.options.onHistoryMissingParentSteps({step:newStep,fromStepId:fromStepId,});}
return;}
let currentIndex;let concurentSteps=[];index++;while(index<this._historySteps.length){if(this._historySteps[index].previousStepId===newStep.previousStepId){if(this._historySteps[index].id.localeCompare(newStep.id)===1){currentIndex=index;break;}else{concurentSteps=[this._historySteps[index].id];}}else{if(concurentSteps.includes(this._historySteps[index].previousStepId)){concurentSteps.push(this._historySteps[index].id);}else{currentIndex=index;break;}}
index++;}
currentIndex=typeof currentIndex!=='undefined'?currentIndex:index;const stepsAfterNewStep=this._historySteps.slice(index);for(const stepToRevert of stepsAfterNewStep.slice().reverse()){this.historyRevert(stepToRevert,{sideEffect:false});}
this.historyApply(newStep.mutations);this._historySteps.splice(index,0,newStep);for(const stepToApply of stepsAfterNewStep){this.historyApply(stepToApply.mutations);}}
onExternalHistorySteps(newSteps){this.observerUnactive();this._computeHistorySelection();for(const newStep of newSteps){this._historyAddExternalStep(newStep);}
this.observerActive();this.historyResetLatestComputedSelection();this._handleCommandHint();this.multiselectionRefresh();}
onExternalMultiselectionUpdate(selection){this._multiselectionDisplayClient(selection);const{clientId}=selection;if(this._collabSelectionInfos.has(clientId)){this._collabSelectionInfos.get(clientId).selection=selection;}else{this._collabSelectionInfos.set(clientId,{selection});}}
multiselectionRefresh(){this._collabSelectionsContainer.innerHTML='';for(const{selection}of this._collabSelectionInfos.values()){this._multiselectionDisplayClient(selection);}}
_multiselectionDisplayClient({selection,color,clientId,clientName='Anonyme'}){let clientRects;const anchorNode=this.idFind(selection.anchorNodeOid);const focusNode=this.idFind(selection.focusNodeOid);if(!anchorNode||!focusNode){return;}
const direction=getCursorDirection(anchorNode,selection.anchorOffset,focusNode,selection.focusOffset,);const range=new Range();try{if(direction===DIRECTIONS.RIGHT){range.setStart(anchorNode,selection.anchorOffset);range.setEnd(focusNode,selection.focusOffset);}else{range.setStart(focusNode,selection.focusOffset);range.setEnd(anchorNode,selection.anchorOffset);}
clientRects=Array.from(range.getClientRects());}catch(e){clientRects=[];}
if(!clientRects.length){return;}
const containerRect=this._collabSelectionsContainer.getBoundingClientRect();const indicators=clientRects.map(({x,y,width,height})=>{const rectElement=this.document.createElement('div');rectElement.style=`
                position: absolute;
                top: ${y - containerRect.y}px;
                left: ${x - containerRect.x}px;
                width: ${width}px;
                height: ${height}px;
                background-color: ${color};
                opacity: 0.25;
                pointer-events: none;
            `;rectElement.setAttribute('data-selection-client-id',clientId);return rectElement;});const caretElement=this.document.createElement('div');caretElement.style=`border-left: 2px solid ${color}; position: absolute;`;caretElement.setAttribute('data-selection-client-id',clientId);caretElement.className='oe-collaboration-caret';const caretTopSquare=this.document.createElement('div');caretTopSquare.className='oe-collaboration-caret-top-square';caretTopSquare.style['background-color']=color;caretTopSquare.setAttribute('data-client-name',clientName);caretElement.append(caretTopSquare);if(clientRects.length){if(direction===DIRECTIONS.LEFT){const rect=clientRects[0];caretElement.style.height=`${rect.height * 1.2}px`;caretElement.style.top=`${rect.y - containerRect.y}px`;caretElement.style.left=`${rect.x - containerRect.x}px`;}else{const rect=peek(clientRects);caretElement.style.height=`${rect.height * 1.2}px`;caretElement.style.top=`${rect.y - containerRect.y}px`;caretElement.style.left=`${rect.right - containerRect.x}px`;}}
this._multiselectionRemoveClient(clientId);this._collabSelectionsContainer.append(caretElement,...indicators);}
multiselectionRemove(clientId){this._collabSelectionInfos.delete(clientId);this._multiselectionRemoveClient(clientId);}
_multiselectionRemoveClient(clientId){const elements=this._collabSelectionsContainer.querySelectorAll(`[data-selection-client-id="${clientId}"]`,);for(const element of elements){element.remove();}}
execCommand(...args){this._computeHistorySelection();return this._applyCommand(...args);}
bindExecCommand(element){for(const buttonEl of element.querySelectorAll('[data-call]')){buttonEl.addEventListener('mousedown',ev=>{const sel=this.document.getSelection();if(sel.anchorNode&&ancestors(sel.anchorNode).includes(this.editable)){this.execCommand(buttonEl.dataset.call,buttonEl.dataset.arg1);ev.preventDefault();this._updateToolbar();}});}}
_removeDomListener(){for(const[element,eventName,boundCallback]of this._domListeners){element.removeEventListener(eventName,boundCallback);}
this._domListeners=[];}
deleteRange(sel){let range=getDeepRange(this.editable,{sel,splitText:true,select:true,correctTripleClick:true,});if(!range)return;let start=range.startContainer;let end=range.endContainer;const doJoin=closestBlock(start)!==closestBlock(range.commonAncestorContainer);let next=nextLeaf(end,this.editable);const splitEndTd=closestElement(end,'td')&&end.nextSibling;const contents=range.extractContents();setSelection(start,nodeSize(start));range=getDeepRange(this.editable,{sel});[...contents.querySelectorAll('*')].filter(isUnremovable).forEach(n=>{closestBlock(range.endContainer).after(n);n.textContent='';});const tds=[...contents.querySelectorAll('td')].filter(n=>!closestElement(n,'table'));let currentFragmentTr,currentTr;const currentTd=closestElement(range.endContainer,'td');tds.forEach((td,i)=>{const parentFragmentTr=closestElement(td,'tr');if(i&&!(splitEndTd&&i===tds.length-1)){if(parentFragmentTr!==currentFragmentTr){currentTr=currentTr?currentTr.nextElementSibling:closestElement(range.endContainer,'tr').nextElementSibling;}
currentTr?currentTr.prepend(td):currentTd.after(td);}
currentFragmentTr=parentFragmentTr;td.textContent='';});this.observerFlush();this._toRollback=false;const isRemovableInvisible=(node,noBlocks=true)=>!isVisible(node,noBlocks)&&!isUnremovable(node)&&node.nodeName!=='A';const endIsStart=end===start;while(end&&isRemovableInvisible(end,false)&&!end.contains(range.endContainer)){const parent=end.parentNode;end.remove();end=parent;}
while(start&&isRemovableInvisible(start)&&!(endIsStart&&start.contains(range.startContainer))){const parent=start.parentNode;start.remove();start=parent;}
if(start){fillEmpty(closestBlock(start));}
fillEmpty(closestBlock(range.endContainer));const joinWith=range.endContainer;const joinSibling=joinWith&&joinWith.nextSibling;const oldText=joinWith.textContent;const hasSpaceAfter=joinSibling&&joinSibling.textContent.startsWith(' ');const shouldPreserveSpace=(doJoin||hasSpaceAfter)&&joinWith&&oldText.endsWith(' ');if(shouldPreserveSpace){joinWith.textContent=oldText.replace(/ $/,'\u00A0');setSelection(joinWith,nodeSize(joinWith));}
while(doJoin&&next&&!(next.previousSibling&&next.previousSibling===joinWith)&&this.editable.contains(next)){const restore=preserveCursor(this.document);this.observerFlush();const res=this._protect(()=>{next.oDeleteBackward();if(!this.editable.contains(joinWith)){this._toRollback=UNREMOVABLE_ROLLBACK_CODE;}else{next=firstLeaf(next);}},this._currentStep.mutations.length);if([UNBREAKABLE_ROLLBACK_CODE,UNREMOVABLE_ROLLBACK_CODE].includes(res)){restore();break;}}
next=joinWith&&joinWith.nextSibling;if(shouldPreserveSpace&&!(next&&next.nodeType===Node.TEXT_NODE&&next.textContent.startsWith(' '))){joinWith.textContent=oldText;setSelection(joinWith,nodeSize(joinWith));}
if(joinWith){const el=closestElement(joinWith);const{zws}=fillEmpty(el);if(zws){setSelection(zws,0,zws,nodeSize(zws));}}}
updateColorpickerLabels(params={}){function hexFromColor(color){if(isColorGradient(color)){color=color.match(/gradient(.*)/)[0];let r=0,g=0,b=0,count=0;for(const entry of color.matchAll(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)/g)){count++;r+=parseInt(entry[1],10);g+=parseInt(entry[2],10);b+=parseInt(entry[3],10);}
color=`rgb(${Math.round(r / count)}, ${Math.round(g / count)}, ${Math.round(b / count)})`;}
return rgbToHex(color);}
let foreColor=params.foreColor;let hiliteColor=params.hiliteColor;const sel=this.document.getSelection();if(sel.rangeCount&&(!foreColor||!hiliteColor)){const endContainer=closestElement(sel.getRangeAt(0).endContainer);const computedStyle=getComputedStyle(endContainer);const backgroundImage=computedStyle.backgroundImage;const hasGradient=isColorGradient(backgroundImage);const hasTextGradientClass=endContainer.classList.contains('text-gradient');if(!foreColor){if(hasGradient&&hasTextGradientClass){foreColor=backgroundImage;}else{foreColor=document.queryCommandValue('foreColor');}}
if(!hiliteColor){if(hasGradient&&!hasTextGradientClass){hiliteColor=backgroundImage;}else{hiliteColor=computedStyle.backgroundColor;}}}
foreColor=hexFromColor(foreColor);this.toolbar.style.setProperty('--fore-color',foreColor);const foreColorInput=this.toolbar.querySelector('#foreColor input');if(foreColorInput){foreColorInput.value=foreColor;}
hiliteColor=hexFromColor(hiliteColor);this.toolbar.style.setProperty('--hilite-color',hiliteColor);const hiliteColorInput=this.toolbar.querySelector('#hiliteColor input');if(hiliteColorInput){hiliteColorInput.value=hiliteColor.length<=7?hiliteColor:hexFromColor(hiliteColor);}}
_applyRawCommand(method,...args){const sel=this.document.getSelection();if(!this.editable.contains(sel.anchorNode)||(sel.anchorNode!==sel.focusNode&&!this.editable.contains(sel.focusNode))){return false;}
if(!sel.isCollapsed&&BACKSPACE_FIRST_COMMANDS.includes(method)){this.deleteRange(sel);if(BACKSPACE_ONLY_COMMANDS.includes(method)){return true;}}
if(editorCommands[method]){return editorCommands[method](this,...args);}
if(method.startsWith('justify')){const mode=method.split('justify').join('').toLocaleLowerCase();return this._align(mode==='full'?'justify':mode);}
return sel.anchorNode[method](sel.anchorOffset,...args);}
_applyCommand(...args){this._recordHistorySelection(true);const result=this._protect(()=>this._applyRawCommand(...args));this.sanitize();this.historyStep();return result;}
_protect(callback,rollbackCounter){try{const result=callback.call(this);this.observerFlush();if(this._toRollback){const torollbackCode=this._toRollback;this.historyRollback(rollbackCounter);return torollbackCode;}else{return result;}}catch(error){if(error===UNBREAKABLE_ROLLBACK_CODE||error===UNREMOVABLE_ROLLBACK_CODE){this.historyRollback(rollbackCounter);return error;}else{throw error;}}}
_resetContenteditableLinks(){if(this._fixLinkMutatedElements){for(const element of this._fixLinkMutatedElements.wasContenteditableTrue){element.setAttribute('contenteditable','true');}
for(const element of this._fixLinkMutatedElements.wasContenteditableFalse){element.setAttribute('contenteditable','false');}
for(const element of this._fixLinkMutatedElements.wasContenteditableNull){element.removeAttribute('contenteditable');}}}
_activateContenteditable(){this.editable.setAttribute('contenteditable',this.options.isRootEditable);for(const node of this.options.getContentEditableAreas()){if(!node.isContentEditable){node.setAttribute('contenteditable',true);}}}
_stopContenteditable(){if(this.options.isRootEditable){this.editable.setAttribute('contenteditable',!this.options.isRootEditable);}
for(const node of this.options.getContentEditableAreas()){if(node.getAttribute('contenteditable')==='true'){node.setAttribute('contenteditable',false);}}}
_computeHistorySelection(){const sel=this.document.getSelection();if(!sel.anchorNode){return this._latestComputedSelection;}
this._latestComputedSelection={anchorNode:sel.anchorNode,anchorOffset:sel.anchorOffset,focusNode:sel.focusNode,focusOffset:sel.focusOffset,};if(this._isSelectionInEditable(sel)){this._latestComputedSelectionInEditable=this._latestComputedSelection;}
return this._latestComputedSelection;}
_recordHistorySelection(useCache=false){this._currentStep.selection=serializeSelection(useCache?this._latestComputedSelection:this._computeHistorySelection(),)||{};}
_getNextUndoIndex(){for(let index=this._historySteps.length-1;index>=0;index--){if(this._historySteps[index]&&this._historySteps[index].clientId===this._collabClientId){const state=this._historyStepsStates.get(this._historySteps[index].id);if(state==='redo'||!state){return index;}}}
return-1;}
_getNextRedoIndex(){let totalConsumed=0;for(let index=this._historySteps.length-1;index>=0;index--){if(this._historySteps[index]&&this._historySteps[index].clientId===this._collabClientId){const state=this._historyStepsStates.get(this._historySteps[index].id);switch(state){case'undo':return totalConsumed<=0?index:-1;case'redo':totalConsumed-=1;break;case'consumed':totalConsumed+=1;break;default:return-1;}}}
return-1;}
_createCommandBar(){this.options.noScrollSelector=this.options.noScrollSelector||'body';const revertHistoryBeforeCommandbar=()=>{const lastStep=this._currentStep;this.historyRevert(lastStep);let stepIndex=this._historySteps.length-1;while(stepIndex>this._beforeCommandbarStepIndex){const step=this._historySteps[stepIndex];const stepState=this._historyStepsStates.get(step.id);if(step.clientId===this._collabClientId&&stepState!=='consumed'){this.historyRevert(this._historySteps[stepIndex]);this._historyStepsStates.set(step.id,'consumed');}
stepIndex--;}
this.historyStep(true);setTimeout(()=>{this.editable.focus();getDeepRange(this.editable,{select:true});});};this.commandbarTablePicker=new TablePicker({document:this.document,floating:true,});document.body.appendChild(this.commandbarTablePicker.el);this.commandbarTablePicker.addEventListener('cell-selected',ev=>{this.execCommand('insertTable',{rowNumber:ev.detail.rowNumber,colNumber:ev.detail.colNumber,});});const mainCommands=[{groupName:'Basic blocks',title:'Heading 1',description:'Big section heading.',fontawesome:'fa-header',callback:()=>{this.execCommand('setTag','H1');},},{groupName:'Basic blocks',title:'Heading 2',description:'Medium section heading.',fontawesome:'fa-header',callback:()=>{this.execCommand('setTag','H2');},},{groupName:'Basic blocks',title:'Heading 3',description:'Small section heading.',fontawesome:'fa-header',callback:()=>{this.execCommand('setTag','H3');},},{groupName:'Basic blocks',title:'Text',description:'Paragraph block.',fontawesome:'fa-paragraph',callback:()=>{this.execCommand('setTag','P');},},{groupName:'Basic blocks',title:'Bulleted list',description:'Create a simple bulleted list.',fontawesome:'fa-list-ul',callback:()=>{this.execCommand('toggleList','UL');},},{groupName:'Basic blocks',title:'Numbered list',description:'Create a list with numbering.',fontawesome:'fa-list-ol',callback:()=>{this.execCommand('toggleList','OL');},},{groupName:'Basic blocks',title:'Checklist',description:'Track tasks with a checklist.',fontawesome:'fa-check-square-o',callback:()=>{this.execCommand('toggleList','CL');},},{groupName:'Basic blocks',title:'Separator',description:'Insert an horizontal rule separator.',fontawesome:'fa-minus',callback:()=>{this.execCommand('insertHorizontalRule');},},{groupName:'Basic blocks',title:'Table',description:'Insert a table.',fontawesome:'fa-table',callback:()=>{this.commandbarTablePicker.show();},},];for(const command of mainCommands){command.title=this.options._t(command.title);command.description=this.options._t(command.description);}
this.commandBar=new Powerbox({editable:this.editable,document:this.document,getContextFromParentRect:this.options.getContextFromParentRect,_t:this.options._t,onShow:()=>{this.commandbarTablePicker.hide();},shouldActivate:()=>!!this.options.getPowerboxElement(),onActivate:()=>{this._beforeCommandbarStepIndex=this._historySteps.length-1;this.observerUnactive();for(const element of document.querySelectorAll(this.options.noScrollSelector)){element.classList.add('oe-noscroll');}
for(const element of this.document.querySelectorAll(this.options.noScrollSelector,)){element.classList.add('oe-noscroll');}
this.observerActive();},preValidate:()=>{revertHistoryBeforeCommandbar();},postValidate:()=>{this.historyStep(true);},onStop:()=>{this.observerUnactive();for(const element of document.querySelectorAll('.oe-noscroll')){element.classList.remove('oe-noscroll');}
for(const element of this.document.querySelectorAll('.oe-noscroll')){element.classList.remove('oe-noscroll');}
this.observerActive();},commands:[...mainCommands,...(this.options.commands||[])],});}
_updateToolbar(show){if(!this.options.toolbar)return;if(!this.options.autohideToolbar&&this.toolbar.style.visibility!=='visible'){this.toolbar.style.visibility='visible';}
const sel=this.document.getSelection();if(!sel.anchorNode){show=false;}
if(this.options.autohideToolbar){if(show!==undefined&&!this.isMobile){this.toolbar.style.visibility=show?'visible':'hidden';}
if(show===false){return;}}
const paragraphDropdownButton=this.toolbar.querySelector('#paragraphDropdownButton');for(const commandState of['italic','underline','strikeThrough','justifyLeft','justifyRight','justifyCenter','justifyFull',]){const isStateTrue=this.document.queryCommandState(commandState);const button=this.toolbar.querySelector('#'+commandState);if(commandState.startsWith('justify')){if(paragraphDropdownButton){button.classList.toggle('active',isStateTrue);const direction=commandState.replace('justify','').toLowerCase();const newClass=`fa-align-${direction === 'full' ? 'justify' : direction}`;paragraphDropdownButton.classList.toggle(newClass,isStateTrue);}}else if(button){button.classList.toggle('active',isStateTrue);}}
if(sel.rangeCount){const closestStartContainer=closestElement(sel.getRangeAt(0).startContainer,'*');const selectionStartStyle=getComputedStyle(closestStartContainer);const button=this.toolbar.querySelector('#bold');button.classList.toggle('active',isBold(closestStartContainer));const fontSizeValue=this.toolbar.querySelector('#fontSizeCurrentValue');if(fontSizeValue){fontSizeValue.textContent=/\d+/.exec(selectionStartStyle.fontSize).pop();}
const table=getInSelection(this.document,'table');const toolbarButton=this.toolbar.querySelector('.toolbar-edit-table');if(toolbarButton){this.toolbar.querySelector('.toolbar-edit-table').style.display=table?'block':'none';}}
this.updateColorpickerLabels();const listUIClasses={UL:'fa-list-ul',OL:'fa-list-ol',CL:'fa-tasks'};const block=closestBlock(sel.anchorNode);let activeLabel=undefined;for(const[style,tag,isList]of[['paragraph','P',false],['pre','PRE',false],['heading1','H1',false],['heading2','H2',false],['heading3','H3',false],['heading4','H4',false],['heading5','H5',false],['heading6','H6',false],['blockquote','BLOCKQUOTE',false],['unordered','UL',true],['ordered','OL',true],['checklist','CL',true],]){const button=this.toolbar.querySelector('#'+style);if(button&&!block){button.classList.toggle('active',false);}else if(button){const isActive=isList?block.tagName==='LI'&&getListMode(block.parentElement)===tag:block.tagName===tag;button.classList.toggle('active',isActive);if(!isList&&isActive){activeLabel=button.textContent;}}}
if(block){const listMode=getListMode(block.parentElement);const listDropdownButton=this.toolbar.querySelector('#listDropdownButton');if(listDropdownButton){if(listMode){listDropdownButton.classList.remove('fa-list-ul','fa-list-ol','fa-tasks');listDropdownButton.classList.add(listUIClasses[listMode]);}
listDropdownButton.closest('button').classList.toggle('active',block.tagName==='LI');}}
if(!activeLabel){const firstButtonEl=this.toolbar.querySelector('#paragraph');firstButtonEl.classList.add('active');activeLabel=firstButtonEl.textContent;}
this.toolbar.querySelector('#style button span').textContent=activeLabel;const linkNode=getInSelection(this.document,'a');const linkButton=this.toolbar.querySelector('#createLink');linkButton&&linkButton.classList.toggle('active',linkNode);const unlinkButton=this.toolbar.querySelector('#unlink');unlinkButton&&unlinkButton.classList.toggle('d-none',!linkNode);const undoButton=this.toolbar.querySelector('#undo');undoButton&&undoButton.classList.toggle('disabled',!this.historyCanUndo());const redoButton=this.toolbar.querySelector('#redo');redoButton&&redoButton.classList.toggle('disabled',!this.historyCanRedo());if(this.options.autohideToolbar&&!this.isMobile){this._positionToolbar();}}
updateToolbarPosition(){if(this.options.autohideToolbar&&!this.isMobile&&getComputedStyle(this.toolbar).visibility==='visible'){this._positionToolbar();}}
_positionToolbar(){const OFFSET=10;let isBottom=false;this.toolbar.classList.toggle('toolbar-bottom',false);this.toolbar.style.maxWidth=window.innerWidth-OFFSET*2+'px';const sel=this.document.getSelection();const range=sel.getRangeAt(0);const isSelForward=sel.anchorNode===range.startContainer&&sel.anchorOffset===range.startOffset;const selRect=range.getBoundingClientRect();const toolbarWidth=this.toolbar.offsetWidth;const toolbarHeight=this.toolbar.offsetHeight;const editorRect=this.editable.getBoundingClientRect();const parentContextRect=this.options.getContextFromParentRect();const editorTopPos=Math.max(0,editorRect.top);const scrollX=this.document.defaultView.scrollX;const scrollY=this.document.defaultView.scrollY;let left=selRect.left+OFFSET;left=Math.max(OFFSET,left);left=Math.min(window.innerWidth-OFFSET-toolbarWidth,left);left+=parentContextRect.left;this.toolbar.style.left=scrollX+left+'px';let top=selRect.top-toolbarHeight-OFFSET;if(top<editorTopPos){top=selRect.bottom+OFFSET;isBottom=true;}
top=Math.min(window.innerHeight-OFFSET-toolbarHeight,top);top+=parentContextRect.top;this.toolbar.style.top=scrollY+top+'px';let arrowLeftPos=(isSelForward?selRect.right:selRect.left)-left-OFFSET;arrowLeftPos=Math.max(OFFSET,arrowLeftPos);arrowLeftPos=Math.min(toolbarWidth-OFFSET-20,arrowLeftPos);this.toolbar.style.setProperty('--arrow-left-pos',arrowLeftPos+'px');if(isBottom){this.toolbar.classList.toggle('toolbar-bottom',true);this.toolbar.style.setProperty('--arrow-top-pos',-17+'px');}else{this.toolbar.style.setProperty('--arrow-top-pos',toolbarHeight-3+'px');}}
_prepareClipboardData(clipboardData){const container=document.createElement('fake-container');container.innerHTML=clipboardData;for(const child of[...container.childNodes]){this._cleanForPaste(child);}
return container.innerHTML;}
_cleanForPaste(node){if(!this._isWhitelisted(node)||this._isBlacklisted(node)){if(!node.matches||node.matches(CLIPBOARD_BLACKLISTS.remove.join(','))){node.remove();}else{for(const unwrappedNode of unwrapContents(node)){this._cleanForPaste(unwrappedNode);}}}else if(node.nodeType!==Node.TEXT_NODE){for(const attribute of[...node.attributes]){if(!this._isWhitelisted(attribute)){node.removeAttribute(attribute.name);}}
for(const klass of[...node.classList]){if(!this._isWhitelisted(klass)){node.classList.remove(klass);}}
for(const child of[...node.childNodes]){this._cleanForPaste(child);}}}
_isWhitelisted(item){if(item instanceof Attr){return CLIPBOARD_WHITELISTS.attributes.includes(item.name);}else if(typeof item==='string'){return CLIPBOARD_WHITELISTS.classes.some(okClass=>okClass instanceof RegExp?okClass.test(item):okClass===item,);}else{return(item.nodeType===Node.TEXT_NODE||(item.matches&&item.matches(CLIPBOARD_WHITELISTS.nodes.join(','))));}}
_isBlacklisted(node){return(node.nodeType!==Node.TEXT_NODE&&node.matches([].concat(...Object.values(CLIPBOARD_BLACKLISTS)).join(',')));}
_safeSetAttribute(node,attributeName,attributeValue){const parent=node.parentNode;const next=node.nextSibling;this.observerFlush();node.remove();this.observer.takeRecords();node.setAttribute(attributeName,attributeValue);this.observerFlush();DOMPurify.sanitize(node,{IN_PLACE:true});if(next){next.before(node);}else if(parent){parent.append(node);}
this.observer.takeRecords();}
_onBeforeInput(ev){this._lastBeforeInputType=ev.inputType;}
_onInput(ev){this._recordHistorySelection(true);const selection=this._currentStep.selection;const{anchorNodeOid,anchorOffset,focusNodeOid,focusOffset}=selection||{};const wasCollapsed=!selection||(focusNodeOid===anchorNodeOid&&focusOffset===anchorOffset);const isChromeDeleteforward=ev.inputType==='insertText'&&ev.data===null&&this._lastBeforeInputType==='deleteContentForward';const isChromeInsertParagraph=ev.inputType==='insertText'&&ev.data===null&&this._lastBeforeInputType==='insertParagraph';if(this.keyboardType===KEYBOARD_TYPES.PHYSICAL||!wasCollapsed){if(ev.inputType==='deleteContentBackward'){this.historyRollback();ev.preventDefault();this._applyCommand('oDeleteBackward');}else if(ev.inputType==='deleteContentForward'||isChromeDeleteforward){this.historyRollback();ev.preventDefault();this._applyCommand('oDeleteForward');}else if(ev.inputType==='insertParagraph'||isChromeInsertParagraph){this.historyRollback();ev.preventDefault();if(this._applyCommand('oEnter')===UNBREAKABLE_ROLLBACK_CODE){this._applyCommand('oShiftEnter');}}else if(['insertText','insertCompositionText'].includes(ev.inputType)){const selection=this.document.getSelection();if(anchorNodeOid!==focusNodeOid||anchorOffset!==focusOffset){ev.preventDefault();this._applyRawCommand('oDeleteBackward');insertText(selection,ev.data);const range=selection.getRangeAt(0);setSelection(range.endContainer,range.endOffset);}
if(ev.data&&ev.data.includes(' ')&&selection&&selection.anchorNode&&(!this.commandBar._active||this.commandBar._currentOpenOptions.closeOnSpace!==true)){this._convertUrlInElement(closestElement(selection.anchorNode));}
this.sanitize();this.historyStep();}else if(ev.inputType==='insertLineBreak'){this.historyRollback();ev.preventDefault();this._applyCommand('oShiftEnter');}else{this.sanitize();this.historyStep();}}}
_onKeyDown(ev){this.keyboardType=ev.key==='Unidentified'?KEYBOARD_TYPES.VIRTUAL:KEYBOARD_TYPES.PHYSICAL;if(/^.$/u.test(ev.key)&&!ev.ctrlKey&&!ev.metaKey){const selection=this.document.getSelection();if(selection&&!selection.isCollapsed){this.deleteRange(selection);}}
if(ev.key==='Backspace'&&!ev.ctrlKey&&!ev.metaKey){const selection=this.document.getSelection();if(selection.isCollapsed){ev.preventDefault();this._applyCommand('oDeleteBackward');}}else if(ev.key==='Tab'){const sel=this.document.getSelection();const closestTag=(closestElement(sel.anchorNode,'li, table')||{}).tagName;if(closestTag==='LI'){this._applyCommand('indentList',ev.shiftKey?'outdent':'indent');}else if(closestTag==='TABLE'){this._onTabulationInTable(ev);}else if(!ev.shiftKey){this.execCommand('insertText','\u00A0 \u00A0\u00A0');}
ev.preventDefault();ev.stopPropagation();}else if(IS_KEYBOARD_EVENT_UNDO(ev)){ev.preventDefault();ev.stopPropagation();this.historyUndo();}else if(IS_KEYBOARD_EVENT_REDO(ev)){ev.preventDefault();ev.stopPropagation();this.historyRedo();}else if(IS_KEYBOARD_EVENT_BOLD(ev)){ev.preventDefault();ev.stopPropagation();this.execCommand('bold');}}
_onSelectionChange(){this._computeHistorySelection();const selection=this.document.getSelection();this._updateToolbar(this._isSelectionInEditable(selection));if(this._currentMouseState==='mouseup'){this._fixFontAwesomeSelection();}
if(selection.rangeCount&&selection.getRangeAt(0)&&this.options.onCollaborativeSelectionChange){this.options.onCollaborativeSelectionChange(this.getCurrentCollaborativeSelection());}}
_isSelectionInEditable(selection){return!selection.isCollapsed&&this.editable.contains(selection.anchorNode)&&this.editable.contains(selection.focusNode);}
getCurrentCollaborativeSelection(){const selection=this._latestComputedSelection||this._computeHistorySelection();if(!selection)return;return Object.assign({selection:serializeSelection(selection),color:this._collabSelectionColor,clientId:this._collabClientId,});}
clean(){this.observerUnactive();for(const hint of document.querySelectorAll('.oe-hint')){hint.classList.remove('oe-hint','oe-command-temporary-hint');hint.removeAttribute('placeholder');}
this.cleanForSave();this.observerActive();}
cleanForSave(element=this.editable){this._pluginCall('cleanForSave',[element]);}
_handleCommandHint(){const selectors={BLOCKQUOTE:'Empty quote',H1:'Heading 1',H2:'Heading 2',H3:'Heading 3',H4:'Heading 4',H5:'Heading 5',H6:'Heading 6','UL LI':'List','OL LI':'List','CL LI':'To-do',};for(const hint of document.querySelectorAll('.oe-hint')){if(hint.classList.contains('oe-command-temporary-hint')||!isEmptyBlock(hint)){this.observerUnactive();hint.classList.remove('oe-hint','oe-command-temporary-hint');hint.removeAttribute('placeholder');this.observerActive();}}
for(const[selector,text]of Object.entries(selectors)){for(const el of this.editable.querySelectorAll(selector)){if(!this.options.isHintBlacklisted(el)){this._makeHint(el,text);}}}
const block=this.options.getPowerboxElement();if(block){this._makeHint(block,'Type "/" for commands',true);}
if(this.editable.textContent===''&&this.options.placeholder){this._makeHint(this.editable.firstChild,this.options.placeholder,true);}}
_makeHint(block,text,temporary=false){const content=block&&block.innerHTML.trim();if(block&&(content===''||content==='<br>')&&ancestors(block,this.editable).includes(this.editable)){this.observerUnactive();block.setAttribute('placeholder',text);block.classList.add('oe-hint');if(temporary){block.classList.add('oe-command-temporary-hint');}
this.observerActive();}}
_fixSelectionOnContenteditableFalse(){const selection=this.document.getSelection();if(!selection.rangeCount){return;}
const range=selection.getRangeAt(0);const newRange=range.cloneRange();const startContainer=closestElement(range.startContainer);const endContainer=closestElement(range.endContainer);function _getLastNotEditableAncestorOfNotEditable(node,root){let currentNode=node;let lastEditable;if(!ancestors(node,root).includes(root)){return;}
while(currentNode&&currentNode!==root){if(currentNode.isContentEditable){return lastEditable;}else if(currentNode.isContentEditable===false){lastEditable=currentNode;}
currentNode=currentNode.parentElement;}
return lastEditable;}
const startContainerNotEditable=_getLastNotEditableAncestorOfNotEditable(startContainer,this.editable,);const endContainerNotEditable=_getLastNotEditableAncestorOfNotEditable(endContainer,this.editable,);const bothNotEditable=startContainerNotEditable&&endContainerNotEditable;if(startContainerNotEditable){if(startContainerNotEditable.previousSibling){newRange.setStart(startContainerNotEditable.previousSibling,startContainerNotEditable.previousSibling.length,);if(bothNotEditable){newRange.setEnd(startContainerNotEditable.previousSibling,startContainerNotEditable.previousSibling.length,);}}else{newRange.setStart(startContainerNotEditable.parentElement,0);if(bothNotEditable){newRange.setEnd(startContainerNotEditable.parentElement,0);}}}
if(!bothNotEditable&&endContainerNotEditable){if(endContainerNotEditable.nextSibling){newRange.setEnd(endContainerNotEditable.nextSibling,0);}else{newRange.setEnd(...endPos(endContainerNotEditable.parentElement));}}
if(startContainerNotEditable||endContainerNotEditable){selection.removeAllRanges();selection.addRange(newRange);}}
_onMouseup(ev){this._currentMouseState=ev.type;this._fixFontAwesomeSelection();this._fixSelectionOnContenteditableFalse();}
_onMouseDown(ev){this._currentMouseState=ev.type;const link=closestElement(ev.target,'a');this._resetContenteditableLinks();if(link&&!link.querySelector('div')&&!closestElement(ev.target,'.o_not_editable')&&link.getAttribute('contenteditable')!=='false'){const editableChildren=link.querySelectorAll('[contenteditable=true]');this._stopContenteditable();this._fixLinkMutatedElements={wasContenteditableTrue:[...editableChildren],wasContenteditableFalse:[],wasContenteditableNull:[],};const contentEditableAttribute=link.getAttribute('contenteditable');if(contentEditableAttribute==='true'){this._fixLinkMutatedElements.wasContenteditableTrue.push(link);}else if(contentEditableAttribute==='false'){this._fixLinkMutatedElements.wasContenteditableFalse.push(link);}else{this._fixLinkMutatedElements.wasContenteditableNull.push(link);}
[...editableChildren,link].forEach(node=>node.setAttribute('contenteditable',true));}else{this._activateContenteditable();}
this.observer.takeRecords();const node=ev.target;if(node.tagName=='LI'&&getListMode(node.parentElement)=='CL'){if(ev.offsetX<0){toggleClass(node,'o_checked');ev.preventDefault();this.historyStep();}}}
_onDocumentKeydown(ev){const canUndoRedo=!['INPUT','TEXTAREA'].includes(this.document.activeElement.tagName);if(this.options.controlHistoryFromDocument&&canUndoRedo){if(IS_KEYBOARD_EVENT_UNDO(ev)&&canUndoRedo){ev.preventDefault();this.historyUndo();}else if(IS_KEYBOARD_EVENT_REDO(ev)&&canUndoRedo){ev.preventDefault();this.historyRedo();}}else{if(IS_KEYBOARD_EVENT_REDO(ev)||IS_KEYBOARD_EVENT_UNDO(ev)){this._onKeyupResetContenteditableNodes.push(...this.editable.querySelectorAll('[contenteditable=true]'),);if(this.editable.getAttribute('contenteditable')==='true'){this._onKeyupResetContenteditableNodes.push(this.editable);}
for(const node of this._onKeyupResetContenteditableNodes){this.automaticStepSkipStack();node.setAttribute('contenteditable',false);}}}}
_onDocumentKeyup(){if(this._onKeyupResetContenteditableNodes.length){for(const node of this._onKeyupResetContenteditableNodes){this.automaticStepSkipStack();node.setAttribute('contenteditable',true);}
this._onKeyupResetContenteditableNodes=[];}
this._fixSelectionOnContenteditableFalse();}
_onDoumentMousedown(event){if(this.toolbar&&!ancestors(event.target,this.editable).includes(this.toolbar)){this.toolbar.style.pointerEvents='none';}}
_onDoumentMouseup(){if(this.toolbar){this.toolbar.style.pointerEvents='auto';}}
_convertUrlInElement(el){if(el.tagName==='A'){return;}
for(let child of el.childNodes){if(child.nodeType===Node.TEXT_NODE&&child.length>3){const childStr=child.nodeValue;const matches=getUrlsInfosInString(childStr);if(matches.length){this._createLinkWithUrlInTextNode(child,matches[0].url,matches[0].index,matches[0].length,);}}}}
_createLinkWithUrlInTextNode(textNode,url,index,length){const link=this.document.createElement('a');link.setAttribute('href',url);for(const[param,value]of Object.entries(this.options.defaultLinkAttributes)){link.setAttribute(param,`${value}`);}
const range=this.document.createRange();range.setStart(textNode,index);range.setEnd(textNode,index+length);link.appendChild(range.extractContents());range.insertNode(link);}
_onPaste(ev){ev.preventDefault();const clipboardData=ev.clipboardData.getData('text/html');if(clipboardData){this.execCommand('insertHTML',this._prepareClipboardData(clipboardData));}else{const text=ev.clipboardData.getData('text/plain');const splitAroundUrl=text.split(URL_REGEX);const linkAttributes=this.options.defaultLinkAttributes||{};for(let i=0;i<splitAroundUrl.length;i++){if(i%2){const url=/^https?:\/\//gi.test(splitAroundUrl[i])?splitAroundUrl[i]:'https://'+splitAroundUrl[i];const youtubeUrl=YOUTUBE_URL_GET_VIDEO_ID.exec(url);const urlFileExtention=url.split('.').pop();const baseEmbedCommand=[{groupName:'paste',title:'Paste as URL',description:'Create an URL.',fontawesome:'fa-link',callback:()=>{this.historyUndo();const link=document.createElement('A');link.setAttribute('href',url);for(const attribute in linkAttributes){link.setAttribute(attribute,linkAttributes[attribute]);}
link.innerText=splitAroundUrl[i];const sel=this.document.getSelection();if(sel.rangeCount){sel.getRangeAt(0).insertNode(link);sel.collapseToEnd();}},},{groupName:'paste',title:'Paste as text',description:'Simple text paste.',fontawesome:'fa-font',callback:()=>{},},];if(['jpg','jpeg','png','gif'].includes(urlFileExtention)){this.execCommand('insertText',splitAroundUrl[i]);this.commandBar.open({commands:[{groupName:'Embed',title:'Embed Image',description:'Embed the image in the document.',fontawesome:'fa-image',callback:()=>{this.historyUndo();const img=document.createElement('IMG');img.setAttribute('src',url);const sel=this.document.getSelection();if(sel.rangeCount){sel.getRangeAt(0).insertNode(img);sel.collapseToEnd();}},},].concat(baseEmbedCommand),});}else if(youtubeUrl){this.execCommand('insertText',splitAroundUrl[i]);this.commandBar.open({commands:[{groupName:'Embed',title:'Embed Youtube Video',description:'Embed the youtube video in the document.',fontawesome:'fa-youtube-play',callback:()=>{this.historyUndo();const video=document.createElement('iframe');video.setAttribute('width','560');video.setAttribute('height','315');video.setAttribute('src',`https://www.youtube.com/embed/${youtubeUrl[1]}`,);video.setAttribute('title','YouTube video player');video.setAttribute('frameborder','0');video.setAttribute('allow','accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture',);video.setAttribute('allowfullscreen','1');const sel=this.document.getSelection();if(sel.rangeCount){sel.getRangeAt(0).insertNode(video);sel.collapseToEnd();}},},].concat(baseEmbedCommand),});}else{const link=document.createElement('A');link.setAttribute('href',url);for(const attribute in linkAttributes){link.setAttribute(attribute,linkAttributes[attribute]);}
link.innerText=splitAroundUrl[i];const sel=this.document.getSelection();if(sel.rangeCount){sel.getRangeAt(0).insertNode(link);sel.collapseToEnd();}}}else if(splitAroundUrl[i]!==''){const textFragments=splitAroundUrl[i].split('\n');let textIndex=1;for(const textFragment of textFragments){this.execCommand('insertText',textFragment);if(textIndex<textFragments.length){this._applyCommand('oShiftEnter');}
textIndex++;}}}}}
_onDrop(ev){ev.preventDefault();const sel=this.document.getSelection();let isInEditor=false;let ancestor=sel.anchorNode;while(ancestor&&!isInEditor){if(ancestor===this.editable){isInEditor=true;}
ancestor=ancestor.parentNode;}
const transferItem=[...(ev.originalEvent||ev).dataTransfer.items].find(item=>item.type==='text/html',);if(transferItem){transferItem.getAsString(pastedText=>{if(isInEditor&&!sel.isCollapsed){this.deleteRange(sel);}
if(this.document.caretPositionFromPoint){const range=this.document.caretPositionFromPoint(ev.clientX,ev.clientY);setSelection(range.offsetNode,range.offset);}else if(this.document.caretRangeFromPoint){const range=this.document.caretRangeFromPoint(ev.clientX,ev.clientY);setSelection(range.startContainer,range.startOffset);}
this.execCommand('insertHTML',this._prepareClipboardData(pastedText));});}
this.historyStep();}
_onTabulationInTable(ev){const sel=this.document.getSelection();const closestTable=closestElement(sel.anchorNode,'table');if(!closestTable){return;}
const closestTd=closestElement(sel.anchorNode,'td');const tds=[...closestTable.querySelectorAll('td')];const direction=ev.shiftKey?DIRECTIONS.LEFT:DIRECTIONS.RIGHT;const cursorDestination=tds[tds.findIndex(td=>closestTd===td)+(direction===DIRECTIONS.LEFT?-1:1)];if(cursorDestination){setSelection(...startPos(cursorDestination),...endPos(cursorDestination),true);}else if(direction===DIRECTIONS.RIGHT){this._addRowBelow();this._onTabulationInTable(ev);}}
_fixFontAwesomeSelection(){const selection=this.document.getSelection();if(selection.isCollapsed||(selection.anchorNode&&!ancestors(selection.anchorNode,this.editable).includes(this.editable)))
return;let shouldUpdateSelection=false;const fixedSelection={anchorNode:selection.anchorNode,anchorOffset:selection.anchorOffset,focusNode:selection.focusNode,focusOffset:selection.focusOffset,};const selectionDirection=getCursorDirection(selection.anchorNode,selection.anchorOffset,selection.focusNode,selection.focusOffset,);const closestAnchorNodeEl=closestElement(selection.anchorNode);if(isFontAwesome(closestAnchorNodeEl)){shouldUpdateSelection=true;fixedSelection.anchorNode=selectionDirection===DIRECTIONS.RIGHT?closestAnchorNodeEl.previousSibling:closestAnchorNodeEl.nextSibling;if(fixedSelection.anchorNode){fixedSelection.anchorOffset=selectionDirection===DIRECTIONS.RIGHT?fixedSelection.anchorNode.length:0;}else{fixedSelection.anchorNode=closestAnchorNodeEl.parentElement;fixedSelection.anchorOffset=0;}}
const closestFocusNodeEl=closestElement(selection.focusNode);if(isFontAwesome(closestFocusNodeEl)){shouldUpdateSelection=true;fixedSelection.focusNode=selectionDirection===DIRECTIONS.RIGHT?closestFocusNodeEl.nextSibling:closestFocusNodeEl.previousSibling;if(fixedSelection.focusNode){fixedSelection.focusOffset=selectionDirection===DIRECTIONS.RIGHT?0:fixedSelection.focusNode.length;}else{fixedSelection.focusNode=closestFocusNodeEl.parentElement;fixedSelection.focusOffset=0;}}
if(shouldUpdateSelection){setSelection(fixedSelection.anchorNode,fixedSelection.anchorOffset,fixedSelection.focusNode,fixedSelection.focusOffset,false,);}}
_pluginAdd(Plugin){this._plugins.push(new Plugin(this));}
_pluginCall(method,args){for(const plugin of this._plugins){if(plugin[method]){plugin[method](...args);}}}}
return __exports;});;

/* /web_editor/static/lib/odoo-editor/src/utils/constants.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('@web_editor/../lib/odoo-editor/src/utils/constants',async function(require){'use strict';let __exports={};const UNBREAKABLE_ROLLBACK_CODE=__exports.UNBREAKABLE_ROLLBACK_CODE='UNBREAKABLE';const UNREMOVABLE_ROLLBACK_CODE=__exports.UNREMOVABLE_ROLLBACK_CODE='UNREMOVABLE';return __exports;});;

/* /web_editor/static/lib/odoo-editor/src/utils/sanitize.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('@web_editor/../lib/odoo-editor/src/utils/sanitize',async function(require){'use strict';let __exports={};const{closestBlock,endPos,fillEmpty,getListMode,isBlock,isEmptyBlock,isVisibleEmpty,moveNodes,preserveCursor,isFontAwesome,isMediaElement,getDeepRange,isUnbreakable,}=require("@web_editor/../lib/odoo-editor/src/utils/utils");const NOT_A_NUMBER=/[^\d]/g;const areSimilarElements=__exports.areSimilarElements=function areSimilarElements(node,node2){if(!node||!node2||node.nodeType!==Node.ELEMENT_NODE||node2.nodeType!==Node.ELEMENT_NODE){return false;}
if(node.tagName!==node2.tagName){return false;}
for(const att of node.attributes){const att2=node2.attributes[att.name];if((att2&&att2.value)!==att.value){return false;}}
for(const att of node2.attributes){const att2=node.attributes[att.name];if((att2&&att2.value)!==att.value){return false;}}
function isNotNoneValue(value){return value&&value!=='none';}
if(isNotNoneValue(getComputedStyle(node,':before').getPropertyValue('content'))||isNotNoneValue(getComputedStyle(node,':after').getPropertyValue('content'))||isNotNoneValue(getComputedStyle(node2,':before').getPropertyValue('content'))||isNotNoneValue(getComputedStyle(node2,':after').getPropertyValue('content'))){return false;}
if(node.tagName=='LI'&&node.classList.contains('oe-nested')){return(node.lastElementChild&&node2.firstElementChild&&getListMode(node.lastElementChild)==getListMode(node2.firstElementChild));}
if(['UL','OL'].includes(node.tagName)){return!isVisibleEmpty(node)&&!isVisibleEmpty(node2);}
if(isBlock(node)||isVisibleEmpty(node)||isVisibleEmpty(node2)){return false;}
const nodeStyle=getComputedStyle(node);const node2Style=getComputedStyle(node2);return(!+nodeStyle.padding.replace(NOT_A_NUMBER,'')&&!+node2Style.padding.replace(NOT_A_NUMBER,'')&&!+nodeStyle.margin.replace(NOT_A_NUMBER,'')&&!+node2Style.margin.replace(NOT_A_NUMBER,''));}
class Sanitize{constructor(root){this.root=root;this.parse(root);}
parse(node){node=closestBlock(node);if(['UL','OL'].includes(node.tagName)){node=node.parentElement;}
this._parse(node);}
_parse(node){if(!node){return;}
while(areSimilarElements(node,node.previousSibling)&&!isUnbreakable(node)){getDeepRange(this.root,{select:true});const restoreCursor=preserveCursor(this.root.ownerDocument);const nodeP=node.previousSibling;moveNodes(...endPos(node.previousSibling),node);restoreCursor();node=nodeP;}
if(node.nodeName=='P'&&node.parentElement.tagName=='LI'){const next=node.nextSibling;const pnode=node.parentElement;if(isEmptyBlock(node)){const restoreCursor=preserveCursor(this.root.ownerDocument);node.remove();fillEmpty(pnode);this._parse(next);restoreCursor(new Map([[node,pnode]]));return;}}
if(isFontAwesome(node)){if(node.innerHTML!=='\u200B')node.innerHTML='&#x200B;';}
if(isMediaElement(node)){if(node.getAttribute('contenteditable')!=='false'){node.setAttribute('contenteditable','false');}}
this._parse(node.firstChild);this._parse(node.nextSibling);}}
const sanitize=__exports.sanitize=function sanitize(root){new Sanitize(root);return root;}
return __exports;});;

/* /web_editor/static/lib/odoo-editor/src/utils/serialize.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('@web_editor/../lib/odoo-editor/src/utils/serialize',async function(require){'use strict';let __exports={};const serializeNode=__exports.serializeNode=function serializeNode(node,nodesToStripFromChildren=new Set()){let result={nodeType:node.nodeType,oid:node.oid,};if(!node.oid){throw new Error('node.oid can not be falsy.');}
if(node.nodeType===Node.TEXT_NODE){result.textValue=node.nodeValue;}else if(node.nodeType===Node.ELEMENT_NODE){result.tagName=node.tagName;result.children=[];result.attributes={};for(let i=0;i<node.attributes.length;i++){result.attributes[node.attributes[i].name]=node.attributes[i].value;}
let child=node.firstChild;while(child){if(!nodesToStripFromChildren.has(child.oid)){result.children.push(serializeNode(child,nodesToStripFromChildren));}
child=child.nextSibling;}}
return result;}
const unserializeNode=__exports.unserializeNode=function unserializeNode(obj){let result=undefined;if(obj.nodeType===Node.TEXT_NODE){result=document.createTextNode(obj.textValue);}else if(obj.nodeType===Node.ELEMENT_NODE){result=document.createElement(obj.tagName);for(const key in obj.attributes){result.setAttribute(key,obj.attributes[key]);}
obj.children.forEach(child=>result.append(unserializeNode(child)));}else{console.warn('unknown node type');}
result.oid=obj.oid;return result;}
const serializeSelection=__exports.serializeSelection=function serializeSelection(selection){if(selection&&selection.anchorNode&&selection.anchorNode.oid&&typeof selection.anchorOffset!=='undefined'&&selection.focusNode&&selection.anchorNode.oid&&typeof selection.focusOffset!=='undefined'){return{anchorNodeOid:selection.anchorNode.oid,anchorOffset:selection.anchorOffset,focusNodeOid:selection.focusNode.oid,focusOffset:selection.focusOffset,};}else{return{anchorNodeOid:undefined,anchorOffset:undefined,focusNodeOid:undefined,focusOffset:undefined,};}}
return __exports;});;

/* /web_editor/static/lib/odoo-editor/src/utils/utils.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('@web_editor/../lib/odoo-editor/src/utils/utils',async function(require){'use strict';let __exports={};const INVISIBLE_REGEX=/\u200c/g;const DIRECTIONS=__exports.DIRECTIONS={LEFT:false,RIGHT:true,};const CTYPES=__exports.CTYPES={CONTENT:1,SPACE:2,BLOCK_OUTSIDE:4,BLOCK_INSIDE:8,BR:16,};const CTGROUPS=__exports.CTGROUPS={INLINE:CTYPES.CONTENT|CTYPES.SPACE,BLOCK:CTYPES.BLOCK_OUTSIDE|CTYPES.BLOCK_INSIDE,BR:CTYPES.BR,};const URL_REGEX=__exports.URL_REGEX=/((?:(?:https?:\/\/)|(?:[-a-zA-Z0-9@:%._\+~#=]{1,64}\.))[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,63}\b(?:[^\s]*))/gi;const URL_REGEX_WITH_INFOS=__exports.URL_REGEX_WITH_INFOS=/((?:(https?:\/\/)|(?:[-a-zA-Z0-9@:%._\+~#=]{1,64}\.))[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,63}\b(?:[^\s]*))/gi;const YOUTUBE_URL_GET_VIDEO_ID=__exports.YOUTUBE_URL_GET_VIDEO_ID=/^(?:(?:https?:)?\/\/)?(?:(?:www|m)\.)?(?:youtube\.com|youtu\.be)(?:\/(?:[\w-]+\?v=|embed\/|v\/)?)([^\s?&#]+)(?:\S+)?$/i;const leftPos=__exports.leftPos=function leftPos(node){return[node.parentNode,childNodeIndex(node)];}
const rightPos=__exports.rightPos=function rightPos(node){return[node.parentNode,childNodeIndex(node)+1];}
const boundariesOut=__exports.boundariesOut=function boundariesOut(node){const index=childNodeIndex(node);return[node.parentNode,index,node.parentNode,index+1];}
const startPos=__exports.startPos=function startPos(node){return[node,0];}
const endPos=__exports.endPos=function endPos(node){return[node,nodeSize(node)];}
const boundariesIn=__exports.boundariesIn=function boundariesIn(node){return[node,0,node,nodeSize(node)];}
const childNodeIndex=__exports.childNodeIndex=function childNodeIndex(node){let i=0;while(node.previousSibling){i++;node=node.previousSibling;}
return i;}
const nodeSize=__exports.nodeSize=function nodeSize(node){const isTextNode=node.nodeType===Node.TEXT_NODE;return isTextNode?node.length:node.childNodes.length;}
const closestPath=__exports.closestPath=function*(node){while(node){yield node;node=node.parentNode;}};const PATH_END_REASONS={NO_NODE:0,BLOCK_OUT:1,BLOCK_HIT:2,OUT_OF_SCOPE:3,};const createDOMPathGenerator=__exports.createDOMPathGenerator=function createDOMPathGenerator(direction,{leafOnly=false,inScope=false,stopTraverseFunction,stopFunction}={},){const nextDeepest=direction===DIRECTIONS.LEFT?node=>lastLeaf(node.previousSibling,stopTraverseFunction):node=>firstLeaf(node.nextSibling,stopTraverseFunction);const firstNode=direction===DIRECTIONS.LEFT?(node,offset)=>lastLeaf(node.childNodes[offset-1],stopTraverseFunction):(node,offset)=>firstLeaf(node.childNodes[offset],stopTraverseFunction);return function*(node,offset,reasons=[]){let movedUp=false;let currentNode=firstNode(node,offset);if(!currentNode){movedUp=true;currentNode=node;}
while(currentNode){if(stopFunction&&stopFunction(currentNode)){reasons.push(movedUp?PATH_END_REASONS.BLOCK_OUT:PATH_END_REASONS.BLOCK_HIT);break;}
if(inScope&&currentNode===node){reasons.push(PATH_END_REASONS.OUT_OF_SCOPE);break;}
if(!(leafOnly&&movedUp)){yield currentNode;}
movedUp=false;let nextNode=nextDeepest(currentNode);if(!nextNode){movedUp=true;nextNode=currentNode.parentNode;}
currentNode=nextNode;}
reasons.push(PATH_END_REASONS.NO_NODE);};}
const createDOMPathGeneratorBak=__exports.createDOMPathGeneratorBak=function createDOMPathGeneratorBak(direction,deepOnly,inline,inScope=false){const nextDeepest=direction===DIRECTIONS.LEFT?node=>lastLeaf(node.previousSibling,inline?isBlock:undefined):node=>firstLeaf(node.nextSibling,inline?isBlock:undefined);const firstNode=direction===DIRECTIONS.LEFT?(node,offset)=>lastLeaf(node.childNodes[offset-1],inline?isBlock:undefined):(node,offset)=>firstLeaf(node.childNodes[offset],inline?isBlock:undefined);return function*(node,offset,reasons=[]){let movedUp=false;let currentNode=firstNode(node,offset);if(!currentNode){movedUp=true;currentNode=node;}
while(currentNode){if(inline&&isBlock(currentNode)){reasons.push(movedUp?PATH_END_REASONS.BLOCK_OUT:PATH_END_REASONS.BLOCK_HIT);break;}
if(inScope&&currentNode===node){reasons.push(PATH_END_REASONS.OUT_OF_SCOPE);break;}
if(!deepOnly||!movedUp){yield currentNode;}
movedUp=false;let nextNode=nextDeepest(currentNode);if(!nextNode){movedUp=true;nextNode=currentNode.parentNode;}
currentNode=nextNode;}
reasons.push(PATH_END_REASONS.NO_NODE);};}
const findNode=__exports.findNode=function findNode(domPath,findCallback=()=>true,stopCallback=()=>false){for(const node of domPath){if(findCallback(node)){return node;}
if(stopCallback(node)){break;}}
return null;}
const closestElement=__exports.closestElement=function closestElement(node,selector){const element=node.nodeType===Node.TEXT_NODE?node.parentElement:node;return selector&&element?element.closest(selector):element||node;}
const ancestors=__exports.ancestors=function ancestors(node,editable){if(!node||!node.parentElement||node===editable)return[];return[node.parentElement,...ancestors(node.parentElement,editable)];}
const closestBlock=__exports.closestBlock=function closestBlock(node){return findNode(closestPath(node),node=>isBlock(node));}
const lastLeaf=__exports.lastLeaf=function lastLeaf(node,stopTraverseFunction){while(node&&node.lastChild&&!(stopTraverseFunction&&stopTraverseFunction(node))){node=node.lastChild;}
return node;}
const firstLeaf=__exports.firstLeaf=function firstLeaf(node,stopTraverseFunction){while(node&&node.firstChild&&!(stopTraverseFunction&&stopTraverseFunction(node))){node=node.firstChild;}
return node;}
const previousLeaf=__exports.previousLeaf=function previousLeaf(node,editable,skipInvisible=false){let ancestor=node;while(ancestor&&!ancestor.previousSibling&&ancestor!==editable){ancestor=ancestor.parentElement;}
if(ancestor&&ancestor!==editable){if(skipInvisible&&!isVisible(ancestor.previousSibling)){return previousLeaf(ancestor.previousSibling,editable,skipInvisible);}else{const last=lastLeaf(ancestor.previousSibling);if(skipInvisible&&!isVisible(last)){return previousLeaf(last,editable,skipInvisible);}else{return last;}}}}
const nextLeaf=__exports.nextLeaf=function nextLeaf(node,editable,skipInvisible=false){let ancestor=node;while(ancestor&&!ancestor.nextSibling&&ancestor!==editable){ancestor=ancestor.parentElement;}
if(ancestor&&ancestor!==editable){if(skipInvisible&&ancestor.nextSibling&&!isVisible(ancestor.nextSibling)){return nextLeaf(ancestor.nextSibling,editable,skipInvisible);}else{const first=firstLeaf(ancestor.nextSibling);if(skipInvisible&&!isVisible(first)){return nextLeaf(first,editable,skipInvisible);}else{return first;}}}}
const getAdjacentPreviousSiblings=__exports.getAdjacentPreviousSiblings=function getAdjacentPreviousSiblings(node,predicate=n=>!!n){let previous=node.previousSibling;const list=[];while(previous&&predicate(previous)){list.push(previous);previous=previous.previousSibling;}
return list;}
const getAdjacentNextSiblings=__exports.getAdjacentNextSiblings=function getAdjacentNextSiblings(node,predicate=n=>!!n){let next=node.nextSibling;const list=[];while(next&&predicate(next)){list.push(next);next=next.nextSibling;}
return list;}
const getAdjacents=__exports.getAdjacents=function getAdjacents(node,predicate=n=>!!n){const previous=getAdjacentPreviousSiblings(node,predicate);const next=getAdjacentNextSiblings(node,predicate);return predicate(node)?[...previous.reverse(),node,...next]:[];}
const getNormalizedCursorPosition=__exports.getNormalizedCursorPosition=function getNormalizedCursorPosition(node,offset,full=true){if(isVisibleEmpty(node)||!closestElement(node).isContentEditable){[node,offset]=rightPos(node);}
offset=Math.min(Math.max(offset,0),nodeSize(node));if(full){let el;let elOffset;if(node.nodeType===Node.ELEMENT_NODE){el=node;elOffset=offset;}else if(node.nodeType===Node.TEXT_NODE){if(offset===0){el=node.parentNode;elOffset=childNodeIndex(node);}else if(offset===node.length){el=node.parentNode;elOffset=childNodeIndex(node)+1;}}
if(el){const leftInlineNode=leftLeafOnlyInScopeNotBlockNoEditablePath(el,elOffset).next().value;let leftVisibleEmpty=false;if(leftInlineNode){leftVisibleEmpty=isVisibleEmpty(leftInlineNode)||!closestElement(leftInlineNode).isContentEditable;[node,offset]=leftVisibleEmpty?rightPos(leftInlineNode):endPos(leftInlineNode);}
if(!leftInlineNode||leftVisibleEmpty){const rightInlineNode=rightLeafOnlyInScopeNotBlockPath(el,elOffset).next().value;if(rightInlineNode){const rightVisibleEmpty=isVisibleEmpty(rightInlineNode)||!closestElement(rightInlineNode).isContentEditable;if(!(leftVisibleEmpty&&rightVisibleEmpty)){[node,offset]=rightVisibleEmpty?leftPos(rightInlineNode):startPos(rightInlineNode);}}}}}
const prevNode=node.nodeType===Node.ELEMENT_NODE&&node.childNodes[offset-1];if(prevNode&&prevNode.nodeName==='BR'&&isFakeLineBreak(prevNode)){offset--;}
return[node,offset];}
const setSelection=__exports.setSelection=function setSelection(anchorNode,anchorOffset,focusNode=anchorNode,focusOffset=anchorOffset,normalize=true,){if(!anchorNode||!anchorNode.parentNode||!anchorNode.parentNode.closest('body')||!focusNode||!focusNode.parentNode||!focusNode.parentNode.closest('body')){return null;}
const document=anchorNode.ownerDocument;const seemsCollapsed=anchorNode===focusNode&&anchorOffset===focusOffset;[anchorNode,anchorOffset]=getNormalizedCursorPosition(anchorNode,anchorOffset,normalize);[focusNode,focusOffset]=seemsCollapsed?[anchorNode,anchorOffset]:getNormalizedCursorPosition(focusNode,focusOffset,normalize);const direction=getCursorDirection(anchorNode,anchorOffset,focusNode,focusOffset);const sel=document.getSelection();if(!sel){return null;}
const range=new Range();if(direction===DIRECTIONS.RIGHT){range.setStart(anchorNode,anchorOffset);range.collapse(true);}else{range.setEnd(anchorNode,anchorOffset);range.collapse(false);}
sel.removeAllRanges();sel.addRange(range);sel.extend(focusNode,focusOffset);return[anchorNode,anchorOffset,focusNode,focusOffset];}
const setCursorStart=__exports.setCursorStart=function setCursorStart(node,normalize=true){const pos=startPos(node);return setSelection(...pos,...pos,normalize);}
const setCursorEnd=__exports.setCursorEnd=function setCursorEnd(node,normalize=true){const pos=endPos(node);return setSelection(...pos,...pos,normalize);}
const getCursorDirection=__exports.getCursorDirection=function getCursorDirection(anchorNode,anchorOffset,focusNode,focusOffset){if(anchorNode===focusNode){if(anchorOffset===focusOffset)return false;return anchorOffset<focusOffset?DIRECTIONS.RIGHT:DIRECTIONS.LEFT;}
return anchorNode.compareDocumentPosition(focusNode)&Node.DOCUMENT_POSITION_FOLLOWING?DIRECTIONS.RIGHT:DIRECTIONS.LEFT;}
const getTraversedNodes=__exports.getTraversedNodes=function getTraversedNodes(editable){const document=editable.ownerDocument;const range=getDeepRange(editable);if(!range)return[];const iterator=document.createNodeIterator(range.commonAncestorContainer);let node;do{node=iterator.nextNode();}while(node&&node!==range.startContainer);const traversedNodes=[node];while(node&&node!==range.endContainer){node=iterator.nextNode();node&&traversedNodes.push(node);}
return traversedNodes;}
const getSelectedNodes=__exports.getSelectedNodes=function getSelectedNodes(editable){const document=editable.ownerDocument;const sel=document.getSelection();if(!sel.rangeCount){return[];}
const range=sel.getRangeAt(0);return getTraversedNodes(editable).filter(node=>range.isPointInRange(node,0)&&range.isPointInRange(node,nodeSize(node)),);}
const getDeepRange=__exports.getDeepRange=function getDeepRange(editable,{range,sel,splitText,select,correctTripleClick}={}){sel=sel||editable.ownerDocument.getSelection();range=range?range.cloneRange():sel.rangeCount&&sel.getRangeAt(0).cloneRange();if(!range)return;let start=range.startContainer;let startOffset=range.startOffset;let end=range.endContainer;let endOffset=range.endOffset;const isBackwards=!range.collapsed&&start===sel.focusNode&&startOffset===sel.focusOffset;[start,startOffset]=getDeepestPosition(start,startOffset);[end,endOffset]=getDeepestPosition(end,endOffset);if(splitText){const isInSingleContainer=start===end;if(end.nodeType===Node.TEXT_NODE&&endOffset!==0&&endOffset!==end.textContent.length){const endParent=end.parentNode;const splitOffset=splitTextNode(end,endOffset);end=endParent.childNodes[splitOffset-1]||endParent.firstChild;if(isInSingleContainer){start=end;}
endOffset=end.textContent.length;}
if(start.nodeType===Node.TEXT_NODE&&startOffset!==0&&startOffset!==start.textContent.length){splitTextNode(start,startOffset);startOffset=0;if(isInSingleContainer){endOffset=start.textContent.length;}}}
const beforeEnd=end.previousSibling;if(correctTripleClick&&!endOffset&&(!beforeEnd||(beforeEnd.nodeType===Node.TEXT_NODE&&!isVisibleStr(beforeEnd)))){const previous=previousLeaf(end,editable,true);if(previous&&closestElement(previous).isContentEditable){[end,endOffset]=[previous,nodeSize(previous)];}}
if(select){if(isBackwards){[start,end,startOffset,endOffset]=[end,start,endOffset,startOffset];range.setEnd(start,startOffset);range.collapse(false);}else{range.setStart(start,startOffset);range.collapse(true);}
sel.removeAllRanges();sel.addRange(range);try{sel.extend(end,endOffset);}catch(e){}
range=sel.getRangeAt(0);}else{range.setStart(start,startOffset);range.setEnd(end,endOffset);}
return range;}
function getNextVisibleNode(node){while(node&&!isVisible(node)){node=node.nextSibling;}
return node;}
const getDeepestPosition=__exports.getDeepestPosition=function getDeepestPosition(node,offset){let found=false;while(node.hasChildNodes()){let newNode=node.childNodes[offset];if(newNode){newNode=getNextVisibleNode(newNode);if(!newNode||isVisibleEmpty(newNode))break;found=true;node=newNode;offset=0;}else{break;}}
if(!found){while(node.hasChildNodes()){let newNode=node.childNodes[offset-1];newNode=getNextVisibleNode(newNode);if(!newNode||isVisibleEmpty(newNode))break;node=newNode;offset=nodeSize(node);}}
let didMove=false;let reversed=false;while(!isVisible(node)&&(node.previousSibling||(!reversed&&node.nextSibling))){reversed=reversed||!node.nextSibling;node=reversed?node.previousSibling:node.nextSibling;offset=reversed?nodeSize(node):0;didMove=true;}
return didMove&&isVisible(node)?getDeepestPosition(node,offset):[node,offset];}
const getCursors=__exports.getCursors=function getCursors(document){const sel=document.getSelection();if(getCursorDirection(sel.anchorNode,sel.anchorOffset,sel.focusNode,sel.focusOffset)===DIRECTIONS.LEFT)
return[[sel.focusNode,sel.focusOffset],[sel.anchorNode,sel.anchorOffset],];return[[sel.anchorNode,sel.anchorOffset],[sel.focusNode,sel.focusOffset],];}
const preserveCursor=__exports.preserveCursor=function preserveCursor(document){const sel=document.getSelection();const cursorPos=[sel.anchorNode,sel.anchorOffset,sel.focusNode,sel.focusOffset];return replace=>{replace=replace||new Map();cursorPos[0]=replace.get(cursorPos[0])||cursorPos[0];cursorPos[2]=replace.get(cursorPos[2])||cursorPos[2];setSelection(...cursorPos);};}
const blockTagNames=['ADDRESS','ARTICLE','ASIDE','BLOCKQUOTE','DETAILS','DIALOG','DD','DIV','DL','DT','FIELDSET','FIGCAPTION','FIGURE','FOOTER','FORM','H1','H2','H3','H4','H5','H6','HEADER','HGROUP','HR','LI','MAIN','NAV','OL','P','PRE','SECTION','TABLE','UL','SELECT','OPTION','TR','TD','TBODY','THEAD','TH',];const computedStyles=new WeakMap();const isBlock=__exports.isBlock=function isBlock(node){if(node.nodeType!==Node.ELEMENT_NODE){return false;}
const tagName=node.nodeName.toUpperCase();if(tagName.startsWith('JW-')||(tagName==='T'&&node.getAttribute('t-esc')===null&&node.getAttribute('t-out')===null&&node.getAttribute('t-raw')===null)){return true;}
if(tagName==='BR'){return false;}
if(window.document!==node.ownerDocument){return blockTagNames.includes(tagName);}
let style=computedStyles.get(node);if(!style){style=window.getComputedStyle(node);computedStyles.set(node,style);}
if(style.display){return!style.display.includes('inline')&&style.display!=='contents';}
return blockTagNames.includes(tagName);}
const isBold=__exports.isBold=function isBold(node){const fontWeight=+getComputedStyle(closestElement(node)).fontWeight;return fontWeight>500||fontWeight>+getComputedStyle(closestBlock(node)).fontWeight;}
const isUnbreakable=__exports.isUnbreakable=function isUnbreakable(node){if(!node||node.nodeType===Node.TEXT_NODE||!node.isContentEditable){return false;}
if(node.nodeType!==Node.ELEMENT_NODE){return true;}
return(isUnremovable(node)||['THEAD','TBODY','TFOOT','TR','TH','TD','SECTION','DIV'].includes(node.tagName)||node.hasAttribute('t')||(node.nodeType===Node.ELEMENT_NODE&&(node.nodeName==='T'||node.getAttribute('t-if')||node.getAttribute('t-esc')||node.getAttribute('t-elif')||node.getAttribute('t-else')||node.getAttribute('t-foreach')||node.getAttribute('t-value')||node.getAttribute('t-out')||node.getAttribute('t-raw')))||node.classList.contains('oe_unbreakable'));}
const isUnremovable=__exports.isUnremovable=function isUnremovable(node){if(node.nodeType!==Node.ELEMENT_NODE&&node.nodeType!==Node.TEXT_NODE){return true;}
const isEditableRoot=node.isContentEditable&&node.parentElement&&!node.parentElement.isContentEditable&&node.nodeName!=='A';return(isEditableRoot||(node.nodeType===Node.ELEMENT_NODE&&(node.getAttribute('t-set')||node.getAttribute('t-call')))||(node.classList&&node.classList.contains('oe_unremovable')));}
const containsUnbreakable=__exports.containsUnbreakable=function containsUnbreakable(node){if(!node){return false;}
return isUnbreakable(node)||containsUnbreakable(node.firstChild);}
const isFontAwesome=__exports.isFontAwesome=function isFontAwesome(node){return(node&&(node.nodeName==='I'||node.nodeName==='SPAN')&&['fa','fab','fad','far'].some(faClass=>node.classList.contains(faClass)));}
const isMediaElement=__exports.isMediaElement=function isMediaElement(node){return(isFontAwesome(node)||(node.classList&&(node.classList.contains('o_image')||node.classList.contains('media_iframe_video'))));}
const containsUnremovable=__exports.containsUnremovable=function containsUnremovable(node){if(!node){return false;}
return isUnremovable(node)||containsUnremovable(node.firstChild);}
const getInSelection=__exports.getInSelection=function getInSelection(document,selector){const selection=document.getSelection();const range=!!selection.rangeCount&&selection.getRangeAt(0);return(range&&(closestElement(range.startContainer,selector)||[...closestElement(range.commonAncestorContainer).querySelectorAll(selector)].find(node=>range.intersectsNode(node),)));}
const getUrlsInfosInString=__exports.getUrlsInfosInString=function getUrlsInfosInString(string){let infos=[],match;while((match=URL_REGEX_WITH_INFOS.exec(string))){infos.push({url:match[2]?match[0]:'https://'+match[0],label:match[0],index:match.index,length:match[0].length,});}
return infos;}
const getOuid=__exports.getOuid=function getOuid(node,optimize=false){while(node&&!isUnbreakable(node)){if(node.ouid&&optimize)return node.ouid;node=node.parentNode;}
return node&&node.oid;}
const selfClosingElementTags=['BR','IMG','INPUT'];const isVisibleEmpty=__exports.isVisibleEmpty=function isVisibleEmpty(node){return selfClosingElementTags.includes(node.nodeName);}
const isInPre=__exports.isInPre=function isInPre(node){const element=node.nodeType===Node.TEXT_NODE?node.parentElement:node;return(!!element&&(!!element.closest('pre')||getComputedStyle(element).getPropertyValue('white-space')==='pre'));}
const nonWhitespacesRegex=/[\S\u00A0]/;const isVisibleStr=__exports.isVisibleStr=function isVisibleStr(value){const str=typeof value==='string'?value:value.nodeValue;return nonWhitespacesRegex.test(str);}
const isContentTextNode=__exports.isContentTextNode=function isContentTextNode(node){return node.nodeType===Node.TEXT_NODE&&(isVisible(node)||isInPre(node));}
const isVisible=__exports.isVisible=function isVisible(node,areBlocksAlwaysVisible=true){if(!node)return false;if(node.nodeType===Node.TEXT_NODE){return isVisibleTextNode(node);}
if((areBlocksAlwaysVisible&&isBlock(node))||isVisibleEmpty(node)){return true;}
return[...node.childNodes].some(n=>isVisible(n));}
function isVisibleTextNode(testedNode){if(!testedNode.length){return false;}
if(isVisibleStr(testedNode)){return true;}
let preceding;let following;let foundTestedNode;const currentNodeParentBlock=closestBlock(testedNode);const nodeIterator=document.createNodeIterator(currentNodeParentBlock);for(let node=nodeIterator.nextNode();node;node=nodeIterator.nextNode()){if(node.nodeType===Node.TEXT_NODE){if(foundTestedNode){following=node;break;}else if(testedNode===node){foundTestedNode=true;}else{preceding=node;}}else if(isBlock(node)){if(foundTestedNode){break;}else{preceding=null;}}}
while(following&&/^[\n\t ]*$/.test(following.textContent)){following=following.nextSibling;}
if(!(preceding&&following)||currentNodeParentBlock!==closestBlock(preceding)||currentNodeParentBlock!==closestBlock(following)){return false;}
return!/^[\n\t ]*$/.test(preceding.textContent);}
const parentsGet=__exports.parentsGet=function parentsGet(node,root=undefined){const parents=[];while(node){parents.unshift(node);if(node===root){break;}
node=node.parentNode;}
return parents;}
const commonParentGet=__exports.commonParentGet=function commonParentGet(node1,node2,root=undefined){if(!node1||!node2){return null;}
const n1p=parentsGet(node1,root);const n2p=parentsGet(node2,root);while(n1p.length>1&&n1p[1]===n2p[1]){n1p.shift();n2p.shift();}
return n1p[0]===n2p[0]?n1p[0]:null;}
const getListMode=__exports.getListMode=function getListMode(pnode){if(pnode.tagName=='OL')return'OL';return pnode.classList.contains('o_checklist')?'CL':'UL';}
const createList=__exports.createList=function createList(mode){const node=document.createElement(mode=='OL'?'OL':'UL');if(mode=='CL'){node.classList.add('o_checklist');}
return node;}
const insertListAfter=__exports.insertListAfter=function insertListAfter(afterNode,mode,content=[]){const list=createList(mode);afterNode.after(list);list.append(...content.map(c=>{const li=document.createElement('LI');li.append(...[].concat(c));return li;}),);return list;}
const toggleClass=__exports.toggleClass=function toggleClass(node,className){node.classList.toggle(className);if(!node.className){node.removeAttribute('class');}}
const isFakeLineBreak=__exports.isFakeLineBreak=function isFakeLineBreak(brEl){return!(getState(...rightPos(brEl),DIRECTIONS.RIGHT).cType&(CTGROUPS.INLINE|CTGROUPS.BR));}
const isEmptyBlock=__exports.isEmptyBlock=function isEmptyBlock(blockEl){if(blockEl.nodeType!==Node.ELEMENT_NODE){return false;}
if(isVisibleStr(blockEl.textContent)){return false;}
if(blockEl.querySelectorAll('br').length>=2){return false;}
const nodes=blockEl.querySelectorAll('*');for(const node of nodes){if(node.nodeName!='BR'&&isVisibleEmpty(node)){return false;}}
return true;}
const isShrunkBlock=__exports.isShrunkBlock=function isShrunkBlock(blockEl){return(isEmptyBlock(blockEl)&&!blockEl.querySelector('br')&&blockEl.nodeName!=="IMG");}
const isColorGradient=__exports.isColorGradient=function isColorGradient(value){return value&&value.includes('-gradient(');}
const splitTextNode=__exports.splitTextNode=function splitTextNode(textNode,offset,originalNodeSide=DIRECTIONS.RIGHT){let parentOffset=childNodeIndex(textNode);if(offset>0){parentOffset++;if(offset<textNode.length){const left=textNode.nodeValue.substring(0,offset);const right=textNode.nodeValue.substring(offset);if(originalNodeSide===DIRECTIONS.LEFT){const newTextNode=document.createTextNode(right);textNode.after(newTextNode);textNode.nodeValue=left;}else{const newTextNode=document.createTextNode(left);textNode.before(newTextNode);textNode.nodeValue=right;}}}
return parentOffset;}
const splitElement=__exports.splitElement=function splitElement(element,offset){const before=element.cloneNode();const after=element.cloneNode();let index=0;for(const child of[...element.childNodes]){index<offset?before.appendChild(child):after.appendChild(child);index++;}
element.before(before);element.after(after);element.remove();return[before,after];}
const insertText=__exports.insertText=function insertText(sel,content){if(sel.anchorNode.nodeType==Node.TEXT_NODE){const pos=[sel.anchorNode.parentElement,splitTextNode(sel.anchorNode,sel.anchorOffset)];setSelection(...pos,...pos,false);}
const txt=document.createTextNode(content||'#');const restore=prepareUpdate(sel.anchorNode,sel.anchorOffset);sel.getRangeAt(0).insertNode(txt);restore();setSelection(...boundariesOut(txt),false);}
const unwrapContents=__exports.unwrapContents=function unwrapContents(node){const contents=[...node.childNodes];for(const child of contents){node.parentNode.insertBefore(child,node);}
node.parentNode.removeChild(node);return contents;}
const fillEmpty=__exports.fillEmpty=function fillEmpty(el){const fillers={};const blockEl=closestBlock(el);if(isShrunkBlock(blockEl)){const br=document.createElement('br');blockEl.appendChild(br);fillers.br=br;}
if(!el.textContent.length&&isUnremovable(el)&&!isBlock(el)){const zws=document.createTextNode('\u200B');el.appendChild(zws);fillers.zws=zws;}
return fillers;}
const clearEmpty=__exports.clearEmpty=function clearEmpty(node){while(!isVisible(node)){const toRemove=node;node=node.parentNode;toRemove.remove();}
return node;}
const setTagName=__exports.setTagName=function setTagName(el,newTagName){if(el.tagName==newTagName){return el;}
var n=document.createElement(newTagName);var attr=el.attributes;for(var i=0,len=attr.length;i<len;++i){n.setAttribute(attr[i].name,attr[i].value);}
while(el.firstChild){n.append(el.firstChild);}
if(el.tagName==='LI'){el.append(n);}else{el.parentNode.replaceChild(n,el);}
return n;}
const moveNodes=__exports.moveNodes=function moveNodes(destinationEl,destinationOffset,sourceEl,startIndex=0,endIndex=sourceEl.childNodes.length,){if(selfClosingElementTags.includes(destinationEl.nodeName)){throw new Error(`moveNodes: Invalid destination element ${destinationEl.nodeName}`);}
const nodes=[];for(let i=startIndex;i<endIndex;i++){nodes.push(sourceEl.childNodes[i]);}
if(nodes.length){const restoreDestination=prepareUpdate(destinationEl,destinationOffset);const restoreMoved=prepareUpdate(...leftPos(sourceEl.childNodes[startIndex]),...rightPos(sourceEl.childNodes[endIndex-1]),);const fragment=document.createDocumentFragment();nodes.forEach(node=>fragment.appendChild(node));const posRightNode=destinationEl.childNodes[destinationOffset];if(posRightNode){destinationEl.insertBefore(fragment,posRightNode);}else{destinationEl.appendChild(fragment);}
restoreDestination();restoreMoved();}
if(!nodeSize(sourceEl)){const restoreOrigin=prepareUpdate(...boundariesOut(sourceEl));sourceEl.remove();restoreOrigin();}
const firstNode=nodes.find(node=>!!node.parentNode);return firstNode?leftPos(firstNode):[destinationEl,destinationOffset];}
const prepareUpdate=__exports.prepareUpdate=function prepareUpdate(...args){const positions=[...args];const restoreData=[];let el,offset;while(positions.length){offset=positions.pop();el=positions.pop();const left=getState(el,offset,DIRECTIONS.LEFT);restoreData.push(left);restoreData.push(getState(el,offset,DIRECTIONS.RIGHT,left.cType));}
return function restoreStates(){for(const data of restoreData){restoreState(data);}};}
const getState=__exports.getState=function getState(el,offset,direction,leftCType){const leftDOMPath=leftLeafOnlyNotBlockPath;const rightDOMPath=rightLeafOnlyNotBlockPath;let domPath;let inverseDOMPath;let expr;const reasons=[];if(direction===DIRECTIONS.LEFT){domPath=leftDOMPath(el,offset,reasons);inverseDOMPath=rightDOMPath(el,offset);expr=/[^\S\u00A0]$/;}else{domPath=rightDOMPath(el,offset,reasons);inverseDOMPath=leftDOMPath(el,offset);expr=/^[^\S\u00A0]/;}
const boundaryNode=inverseDOMPath.next().value;let cType=undefined;let lastSpace=null;for(const node of domPath){if(node.nodeType===Node.TEXT_NODE){const value=node.nodeValue.replace(INVISIBLE_REGEX,'');if(direction===DIRECTIONS.LEFT){if(isVisibleStr(value)){cType=lastSpace||expr.test(value)?CTYPES.SPACE:CTYPES.CONTENT;break;}
if(value.length){lastSpace=node;}}else{leftCType=leftCType||getState(el,offset,DIRECTIONS.LEFT).cType;if(expr.test(value)){const rct=isVisibleStr(value)?CTYPES.CONTENT:getState(...rightPos(node),DIRECTIONS.RIGHT).cType;cType=leftCType&CTYPES.CONTENT&&rct&(CTYPES.CONTENT|CTYPES.BR)?CTYPES.SPACE:rct;break;}
if(isVisibleStr(value)){cType=CTYPES.CONTENT;break;}}}else if(node.nodeName==='BR'){cType=CTYPES.BR;break;}else if(isVisible(node)){cType=CTYPES.CONTENT;break;}}
if(cType===undefined){cType=reasons.includes(PATH_END_REASONS.BLOCK_HIT)?CTYPES.BLOCK_OUTSIDE:CTYPES.BLOCK_INSIDE;}
return{node:boundaryNode,direction:direction,cType:cType,};}
const priorityRestoreStateRules=[[{cType1:CTYPES.CONTENT,cType2:CTYPES.SPACE|CTGROUPS.BLOCK},{spaceVisibility:true},],[{direction:DIRECTIONS.LEFT,cType1:CTGROUPS.INLINE,cType2:CTGROUPS.BR},{spaceVisibility:true},],[{direction:DIRECTIONS.RIGHT,cType1:CTGROUPS.BR,cType2:CTYPES.SPACE|CTGROUPS.BLOCK},{spaceVisibility:true},],[{cType1:CTYPES.SPACE},{spaceVisibility:false},],[{direction:DIRECTIONS.LEFT,cType1:CTGROUPS.BR},{spaceVisibility:false},],[{cType1:CTGROUPS.BLOCK,cType2:CTGROUPS.INLINE|CTGROUPS.BR},{spaceVisibility:false},],[{direction:DIRECTIONS.RIGHT,cType1:CTGROUPS.INLINE,cType2:CTGROUPS.BLOCK},{brVisibility:true},],[{direction:DIRECTIONS.RIGHT,cType1:CTGROUPS.BLOCK,cType2:CTGROUPS.INLINE|CTGROUPS.BR,},{brVisibility:false},],[{direction:DIRECTIONS.LEFT,cType1:CTGROUPS.BR|CTGROUPS.BLOCK,cType2:CTGROUPS.INLINE,},{brVisibility:false,extraBRRemovalCondition:brNode=>isFakeLineBreak(brNode)},],];function restoreStateRuleHashCode(direction,cType1,cType2){return`${direction}-${cType1}-${cType2}`;}
const allRestoreStateRules=(function(){const map=new Map();const keys=['direction','cType1','cType2'];for(const direction of Object.values(DIRECTIONS)){for(const cType1 of Object.values(CTYPES)){for(const cType2 of Object.values(CTYPES)){const rule={direction:direction,cType1:cType1,cType2:cType2};const matchedRules=[];for(const entry of priorityRestoreStateRules){let priority=0;for(const key of keys){const entryKeyValue=entry[0][key];if(entryKeyValue!==undefined){if(typeof entryKeyValue==='boolean'?rule[key]===entryKeyValue:rule[key]&entryKeyValue){priority++;}else{priority=-1;break;}}}
if(priority>=0){matchedRules.push([priority,entry[1]]);}}
const finalRule={};for(let p=0;p<=keys.length;p++){for(const entry of matchedRules){if(entry[0]===p){Object.assign(finalRule,entry[1]);}}}
const hashCode=restoreStateRuleHashCode(direction,cType1,cType2);map.set(hashCode,finalRule);}}}
return map;})();const restoreState=__exports.restoreState=function restoreState(prevStateData){const{node,direction,cType:cType1}=prevStateData;if(!node||!node.parentNode){return;}
const[el,offset]=direction===DIRECTIONS.LEFT?leftPos(node):rightPos(node);const{cType:cType2}=getState(el,offset,direction);const ruleHashCode=restoreStateRuleHashCode(direction,cType1,cType2);const rule=allRestoreStateRules.get(ruleHashCode);if(Object.values(rule).filter(x=>x!==undefined).length){const inverseDirection=direction===DIRECTIONS.LEFT?DIRECTIONS.RIGHT:DIRECTIONS.LEFT;enforceWhitespace(el,offset,inverseDirection,rule);}}
const enforceWhitespace=__exports.enforceWhitespace=function enforceWhitespace(el,offset,direction,rule){let domPath;let expr;if(direction===DIRECTIONS.LEFT){domPath=leftLeafOnlyNotBlockPath(el,offset);expr=/[^\S\u00A0]+$/;}else{domPath=rightLeafOnlyNotBlockPath(el,offset);expr=/^[^\S\u00A0]+/;}
const invisibleSpaceTextNodes=[];let foundVisibleSpaceTextNode=null;for(const node of domPath){if(node.nodeName==='BR'){if(rule.brVisibility===undefined){break;}
if(rule.brVisibility){node.before(document.createElement('br'));}else{if(!rule.extraBRRemovalCondition||rule.extraBRRemovalCondition(node)){node.remove();}}
break;}else if(node.nodeType===Node.TEXT_NODE&&!isInPre(node)){if(expr.test(node.nodeValue)){if(isVisibleStr(node)){foundVisibleSpaceTextNode=node;break;}else{invisibleSpaceTextNodes.push(node);}}else if(isVisibleStr(node)){break;}}}
if(rule.spaceVisibility===undefined){return;}
if(!rule.spaceVisibility){for(const node of invisibleSpaceTextNodes){node.nodeValue='';const ancestorPath=closestPath(node.parentNode);let toRemove=null;for(const pNode of ancestorPath){if(toRemove){toRemove.remove();}
if(pNode.childNodes.length===1&&!isBlock(pNode)){pNode.after(node);toRemove=pNode;}else{break;}}}}
const spaceNode=foundVisibleSpaceTextNode||invisibleSpaceTextNodes[0];if(spaceNode){let spaceVisibility=rule.spaceVisibility;if(spaceVisibility&&!foundVisibleSpaceTextNode&&getState(...rightPos(spaceNode),DIRECTIONS.RIGHT).cType&CTGROUPS.BLOCK){spaceVisibility=false;}
spaceNode.nodeValue=spaceNode.nodeValue.replace(expr,spaceVisibility?'\u00A0':'');}}
const rgbToHex=__exports.rgbToHex=function rgbToHex(rgb=''){return('#'+
(rgb.match(/\d{1,3}/g)||[]).map(x=>{x=parseInt(x).toString(16);return x.length===1?'0'+x:x;}).join(''));}
const getRangePosition=__exports.getRangePosition=function getRangePosition(el,document,options={}){const selection=document.getSelection();if(!selection.isCollapsed||!selection.rangeCount)return;const range=selection.getRangeAt(0);const marginRight=options.marginRight||20;const marginBottom=options.marginBottom||20;const marginTop=options.marginTop||10;const marginLeft=options.marginLeft||10;let offset;if(range.endOffset-1>0){const clonedRange=range.cloneRange();clonedRange.setStart(range.endContainer,range.endOffset-1);clonedRange.setEnd(range.endContainer,range.endOffset);const rect=clonedRange.getBoundingClientRect();offset={height:rect.height,left:rect.left+rect.width,top:rect.top};clonedRange.detach();}
if(!offset||offset.heigh===0){const clonedRange=range.cloneRange();const shadowCaret=document.createTextNode('|');clonedRange.insertNode(shadowCaret);clonedRange.selectNode(shadowCaret);const rect=clonedRange.getBoundingClientRect();offset={height:rect.height,left:rect.left,top:rect.top};shadowCaret.remove();clonedRange.detach();}
const leftMove=Math.max(0,offset.left+el.offsetWidth+marginRight-window.innerWidth);if(leftMove&&offset.left-leftMove>marginLeft){offset.left-=leftMove;}else if(offset.left-leftMove<marginLeft){offset.left=marginLeft;}
if(offset.top-marginTop+offset.height+el.offsetHeight>window.innerHeight&&offset.top-el.offsetHeight-marginBottom>0){offset.top-=el.offsetHeight;}else{offset.top+=offset.height;}
if(offset){offset.top+=window.scrollY;offset.left+=window.scrollX;}
return offset;}
const isNotEditableNode=__exports.isNotEditableNode=node=>node.getAttribute&&node.getAttribute('contenteditable')&&node.getAttribute('contenteditable').toLowerCase()==='false';const leftLeafFirstPath=__exports.leftLeafFirstPath=createDOMPathGenerator(DIRECTIONS.LEFT);const leftLeafOnlyNotBlockPath=__exports.leftLeafOnlyNotBlockPath=createDOMPathGenerator(DIRECTIONS.LEFT,{leafOnly:true,stopTraverseFunction:isBlock,stopFunction:isBlock,});const leftLeafOnlyInScopeNotBlockNoEditablePath=__exports.leftLeafOnlyInScopeNotBlockNoEditablePath=createDOMPathGenerator(DIRECTIONS.LEFT,{leafOnly:true,inScope:true,stopTraverseFunction:node=>isNotEditableNode(node)||isBlock(node),stopFunction:node=>isNotEditableNode(node)||isBlock(node),});const rightLeafOnlyNotBlockPath=__exports.rightLeafOnlyNotBlockPath=createDOMPathGenerator(DIRECTIONS.RIGHT,{leafOnly:true,stopTraverseFunction:isBlock,stopFunction:isBlock,});const rightLeafOnlyPathNotBlockNotEditablePath=__exports.rightLeafOnlyPathNotBlockNotEditablePath=createDOMPathGenerator(DIRECTIONS.RIGHT,{leafOnly:true,});const rightLeafOnlyInScopeNotBlockPath=__exports.rightLeafOnlyInScopeNotBlockPath=createDOMPathGenerator(DIRECTIONS.RIGHT,{leafOnly:true,inScope:true,stopTraverseFunction:isBlock,stopFunction:isBlock,});const rightLeafOnlyNotBlockNotEditablePath=__exports.rightLeafOnlyNotBlockNotEditablePath=createDOMPathGenerator(DIRECTIONS.RIGHT,{leafOnly:true,stopTraverseFunction:node=>isNotEditableNode(node)||isBlock(node),stopFunction:node=>isBlock(node)&&!isNotEditableNode(node),});const peek=__exports.peek=function peek(arr){return arr[arr.length-1];}
return __exports;});;

/* /web_editor/static/lib/odoo-editor/src/utils/DOMPurify.js defined in bundle 'web_editor.assets_wysiwyg' */
(function(global,factory){typeof exports==='object'&&typeof module!=='undefined'?module.exports=factory():typeof define==='function'&&define.amd?define(factory):(global=global||self,global.DOMPurify=factory());}(this,function(){'use strict';function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i];}return arr2;}else{return Array.from(arr);}}
var hasOwnProperty=Object.hasOwnProperty,setPrototypeOf=Object.setPrototypeOf,isFrozen=Object.isFrozen,getPrototypeOf=Object.getPrototypeOf,getOwnPropertyDescriptor=Object.getOwnPropertyDescriptor;var freeze=Object.freeze,seal=Object.seal,create=Object.create;var _ref=typeof Reflect!=='undefined'&&Reflect,apply=_ref.apply,construct=_ref.construct;if(!apply){apply=function apply(fun,thisValue,args){return fun.apply(thisValue,args);};}
if(!freeze){freeze=function freeze(x){return x;};}
if(!seal){seal=function seal(x){return x;};}
if(!construct){construct=function construct(Func,args){return new(Function.prototype.bind.apply(Func,[null].concat(_toConsumableArray(args))))();};}
var arrayForEach=unapply(Array.prototype.forEach);var arrayPop=unapply(Array.prototype.pop);var arrayPush=unapply(Array.prototype.push);var stringToLowerCase=unapply(String.prototype.toLowerCase);var stringMatch=unapply(String.prototype.match);var stringReplace=unapply(String.prototype.replace);var stringIndexOf=unapply(String.prototype.indexOf);var stringTrim=unapply(String.prototype.trim);var regExpTest=unapply(RegExp.prototype.test);var typeErrorCreate=unconstruct(TypeError);function unapply(func){return function(thisArg){for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key];}
return apply(func,thisArg,args);};}
function unconstruct(func){return function(){for(var _len2=arguments.length,args=Array(_len2),_key2=0;_key2<_len2;_key2++){args[_key2]=arguments[_key2];}
return construct(func,args);};}
function addToSet(set,array){if(setPrototypeOf){setPrototypeOf(set,null);}
var l=array.length;while(l--){var element=array[l];if(typeof element==='string'){var lcElement=stringToLowerCase(element);if(lcElement!==element){if(!isFrozen(array)){array[l]=lcElement;}
element=lcElement;}}
set[element]=true;}
return set;}
function clone(object){var newObject=create(null);var property=void 0;for(property in object){if(apply(hasOwnProperty,object,[property])){newObject[property]=object[property];}}
return newObject;}
function lookupGetter(object,prop){while(object!==null){var desc=getOwnPropertyDescriptor(object,prop);if(desc){if(desc.get){return unapply(desc.get);}
if(typeof desc.value==='function'){return unapply(desc.value);}}
object=getPrototypeOf(object);}
function fallbackValue(element){console.warn('fallback value for',element);return null;}
return fallbackValue;}
var html=freeze(['a','abbr','acronym','address','area','article','aside','audio','b','bdi','bdo','big','blink','blockquote','body','br','button','canvas','caption','center','cite','code','col','colgroup','content','data','datalist','dd','decorator','del','details','dfn','dialog','dir','div','dl','dt','element','em','fieldset','figcaption','figure','font','footer','form','h1','h2','h3','h4','h5','h6','head','header','hgroup','hr','html','i','img','input','ins','kbd','label','legend','li','main','map','mark','marquee','menu','menuitem','meter','nav','nobr','ol','optgroup','option','output','p','picture','pre','progress','q','rp','rt','ruby','s','samp','section','select','shadow','small','source','spacer','span','strike','strong','style','sub','summary','sup','table','tbody','td','template','textarea','tfoot','th','thead','time','tr','track','tt','u','ul','var','video','wbr']);var svg=freeze(['svg','a','altglyph','altglyphdef','altglyphitem','animatecolor','animatemotion','animatetransform','circle','clippath','defs','desc','ellipse','filter','font','g','glyph','glyphref','hkern','image','line','lineargradient','marker','mask','metadata','mpath','path','pattern','polygon','polyline','radialgradient','rect','stop','style','switch','symbol','text','textpath','title','tref','tspan','view','vkern']);var svgFilters=freeze(['feBlend','feColorMatrix','feComponentTransfer','feComposite','feConvolveMatrix','feDiffuseLighting','feDisplacementMap','feDistantLight','feFlood','feFuncA','feFuncB','feFuncG','feFuncR','feGaussianBlur','feMerge','feMergeNode','feMorphology','feOffset','fePointLight','feSpecularLighting','feSpotLight','feTile','feTurbulence']);var svgDisallowed=freeze(['animate','color-profile','cursor','discard','fedropshadow','feimage','font-face','font-face-format','font-face-name','font-face-src','font-face-uri','foreignobject','hatch','hatchpath','mesh','meshgradient','meshpatch','meshrow','missing-glyph','script','set','solidcolor','unknown','use']);var mathMl=freeze(['math','menclose','merror','mfenced','mfrac','mglyph','mi','mlabeledtr','mmultiscripts','mn','mo','mover','mpadded','mphantom','mroot','mrow','ms','mspace','msqrt','mstyle','msub','msup','msubsup','mtable','mtd','mtext','mtr','munder','munderover']);var mathMlDisallowed=freeze(['maction','maligngroup','malignmark','mlongdiv','mscarries','mscarry','msgroup','mstack','msline','msrow','semantics','annotation','annotation-xml','mprescripts','none']);var text=freeze(['#text']);var html$1=freeze(['accept','action','align','alt','autocapitalize','autocomplete','autopictureinpicture','autoplay','background','bgcolor','border','capture','cellpadding','cellspacing','checked','cite','class','clear','color','cols','colspan','controls','controlslist','coords','crossorigin','datetime','decoding','default','dir','disabled','disablepictureinpicture','disableremoteplayback','download','draggable','enctype','enterkeyhint','face','for','headers','height','hidden','high','href','hreflang','id','inputmode','integrity','ismap','kind','label','lang','list','loading','loop','low','max','maxlength','media','method','min','minlength','multiple','muted','name','noshade','novalidate','nowrap','open','optimum','pattern','placeholder','playsinline','poster','preload','pubdate','radiogroup','readonly','rel','required','rev','reversed','role','rows','rowspan','spellcheck','scope','selected','shape','size','sizes','span','srclang','start','src','srcset','step','style','summary','tabindex','title','translate','type','usemap','valign','value','width','xmlns','slot']);var svg$1=freeze(['accent-height','accumulate','additive','alignment-baseline','ascent','attributename','attributetype','azimuth','basefrequency','baseline-shift','begin','bias','by','class','clip','clippathunits','clip-path','clip-rule','color','color-interpolation','color-interpolation-filters','color-profile','color-rendering','cx','cy','d','dx','dy','diffuseconstant','direction','display','divisor','dur','edgemode','elevation','end','fill','fill-opacity','fill-rule','filter','filterunits','flood-color','flood-opacity','font-family','font-size','font-size-adjust','font-stretch','font-style','font-variant','font-weight','fx','fy','g1','g2','glyph-name','glyphref','gradientunits','gradienttransform','height','href','id','image-rendering','in','in2','k','k1','k2','k3','k4','kerning','keypoints','keysplines','keytimes','lang','lengthadjust','letter-spacing','kernelmatrix','kernelunitlength','lighting-color','local','marker-end','marker-mid','marker-start','markerheight','markerunits','markerwidth','maskcontentunits','maskunits','max','mask','media','method','mode','min','name','numoctaves','offset','operator','opacity','order','orient','orientation','origin','overflow','paint-order','path','pathlength','patterncontentunits','patterntransform','patternunits','points','preservealpha','preserveaspectratio','primitiveunits','r','rx','ry','radius','refx','refy','repeatcount','repeatdur','restart','result','rotate','scale','seed','shape-rendering','specularconstant','specularexponent','spreadmethod','startoffset','stddeviation','stitchtiles','stop-color','stop-opacity','stroke-dasharray','stroke-dashoffset','stroke-linecap','stroke-linejoin','stroke-miterlimit','stroke-opacity','stroke','stroke-width','style','surfacescale','systemlanguage','tabindex','targetx','targety','transform','text-anchor','text-decoration','text-rendering','textlength','type','u1','u2','unicode','values','viewbox','visibility','version','vert-adv-y','vert-origin-x','vert-origin-y','width','word-spacing','wrap','writing-mode','xchannelselector','ychannelselector','x','x1','x2','xmlns','y','y1','y2','z','zoomandpan']);var mathMl$1=freeze(['accent','accentunder','align','bevelled','close','columnsalign','columnlines','columnspan','denomalign','depth','dir','display','displaystyle','encoding','fence','frame','height','href','id','largeop','length','linethickness','lspace','lquote','mathbackground','mathcolor','mathsize','mathvariant','maxsize','minsize','movablelimits','notation','numalign','open','rowalign','rowlines','rowspacing','rowspan','rspace','rquote','scriptlevel','scriptminsize','scriptsizemultiplier','selection','separator','separators','stretchy','subscriptshift','supscriptshift','symmetric','voffset','width','xmlns']);var xml=freeze(['xlink:href','xml:id','xlink:title','xml:space','xmlns:xlink']);var MUSTACHE_EXPR=seal(/\{\{[\s\S]*|[\s\S]*\}\}/gm);var ERB_EXPR=seal(/<%[\s\S]*|[\s\S]*%>/gm);var DATA_ATTR=seal(/^data-[\-\w.\u00B7-\uFFFF]/);var ARIA_ATTR=seal(/^aria-[\-\w]+$/);var IS_ALLOWED_URI=seal(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i);var IS_SCRIPT_OR_DATA=seal(/^(?:\w+script|data):/i);var ATTR_WHITESPACE=seal(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g);var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};function _toConsumableArray$1(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i];}return arr2;}else{return Array.from(arr);}}
var getGlobal=function getGlobal(){return typeof window==='undefined'?null:window;};var _createTrustedTypesPolicy=function _createTrustedTypesPolicy(trustedTypes,document){if((typeof trustedTypes==='undefined'?'undefined':_typeof(trustedTypes))!=='object'||typeof trustedTypes.createPolicy!=='function'){return null;}
var suffix=null;var ATTR_NAME='data-tt-policy-suffix';if(document.currentScript&&document.currentScript.hasAttribute(ATTR_NAME)){suffix=document.currentScript.getAttribute(ATTR_NAME);}
var policyName='dompurify'+(suffix?'#'+suffix:'');try{return trustedTypes.createPolicy(policyName,{createHTML:function createHTML(html$$1){return html$$1;}});}catch(_){console.warn('TrustedTypes policy '+policyName+' could not be created.');return null;}};function createDOMPurify(){var window=arguments.length>0&&arguments[0]!==undefined?arguments[0]:getGlobal();var DOMPurify=function DOMPurify(root){return createDOMPurify(root);};DOMPurify.version='2.3.1';DOMPurify.removed=[];if(!window||!window.document||window.document.nodeType!==9){DOMPurify.isSupported=false;return DOMPurify;}
var originalDocument=window.document;var document=window.document;var DocumentFragment=window.DocumentFragment,HTMLTemplateElement=window.HTMLTemplateElement,Node=window.Node,Element=window.Element,NodeFilter=window.NodeFilter,_window$NamedNodeMap=window.NamedNodeMap,NamedNodeMap=_window$NamedNodeMap===undefined?window.NamedNodeMap||window.MozNamedAttrMap:_window$NamedNodeMap,Text=window.Text,Comment=window.Comment,DOMParser=window.DOMParser,trustedTypes=window.trustedTypes;var ElementPrototype=Element.prototype;var cloneNode=lookupGetter(ElementPrototype,'cloneNode');var getNextSibling=lookupGetter(ElementPrototype,'nextSibling');var getChildNodes=lookupGetter(ElementPrototype,'childNodes');var getParentNode=lookupGetter(ElementPrototype,'parentNode');if(typeof HTMLTemplateElement==='function'){var template=document.createElement('template');if(template.content&&template.content.ownerDocument){document=template.content.ownerDocument;}}
var trustedTypesPolicy=_createTrustedTypesPolicy(trustedTypes,originalDocument);var emptyHTML=trustedTypesPolicy&&RETURN_TRUSTED_TYPE?trustedTypesPolicy.createHTML(''):'';var _document=document,implementation=_document.implementation,createNodeIterator=_document.createNodeIterator,createDocumentFragment=_document.createDocumentFragment,getElementsByTagName=_document.getElementsByTagName;var importNode=originalDocument.importNode;var documentMode={};try{documentMode=clone(document).documentMode?document.documentMode:{};}catch(_){}
var hooks={};DOMPurify.isSupported=typeof getParentNode==='function'&&implementation&&typeof implementation.createHTMLDocument!=='undefined'&&documentMode!==9;var MUSTACHE_EXPR$$1=MUSTACHE_EXPR,ERB_EXPR$$1=ERB_EXPR,DATA_ATTR$$1=DATA_ATTR,ARIA_ATTR$$1=ARIA_ATTR,IS_SCRIPT_OR_DATA$$1=IS_SCRIPT_OR_DATA,ATTR_WHITESPACE$$1=ATTR_WHITESPACE;var IS_ALLOWED_URI$$1=IS_ALLOWED_URI;var ALLOWED_TAGS=null;var DEFAULT_ALLOWED_TAGS=addToSet({},[].concat(_toConsumableArray$1(html),_toConsumableArray$1(svg),_toConsumableArray$1(svgFilters),_toConsumableArray$1(mathMl),_toConsumableArray$1(text)));var ALLOWED_ATTR=null;var DEFAULT_ALLOWED_ATTR=addToSet({},[].concat(_toConsumableArray$1(html$1),_toConsumableArray$1(svg$1),_toConsumableArray$1(mathMl$1),_toConsumableArray$1(xml)));var FORBID_TAGS=null;var FORBID_ATTR=null;var ALLOW_ARIA_ATTR=true;var ALLOW_DATA_ATTR=true;var ALLOW_UNKNOWN_PROTOCOLS=false;var SAFE_FOR_TEMPLATES=false;var WHOLE_DOCUMENT=false;var SET_CONFIG=false;var FORCE_BODY=false;var RETURN_DOM=false;var RETURN_DOM_FRAGMENT=false;var RETURN_DOM_IMPORT=true;var RETURN_TRUSTED_TYPE=false;var SANITIZE_DOM=true;var KEEP_CONTENT=true;var IN_PLACE=false;var USE_PROFILES={};var FORBID_CONTENTS=null;var DEFAULT_FORBID_CONTENTS=addToSet({},['annotation-xml','audio','colgroup','desc','foreignobject','head','iframe','math','mi','mn','mo','ms','mtext','noembed','noframes','noscript','plaintext','script','style','svg','template','thead','title','video','xmp']);var DATA_URI_TAGS=null;var DEFAULT_DATA_URI_TAGS=addToSet({},['audio','video','img','source','image','track']);var URI_SAFE_ATTRIBUTES=null;var DEFAULT_URI_SAFE_ATTRIBUTES=addToSet({},['alt','class','for','id','label','name','pattern','placeholder','role','summary','title','value','style','xmlns']);var MATHML_NAMESPACE='http://www.w3.org/1998/Math/MathML';var SVG_NAMESPACE='http://www.w3.org/2000/svg';var HTML_NAMESPACE='http://www.w3.org/1999/xhtml';var NAMESPACE=HTML_NAMESPACE;var IS_EMPTY_INPUT=false;var CONFIG=null;var formElement=document.createElement('form');var _parseConfig=function _parseConfig(cfg){if(CONFIG&&CONFIG===cfg){return;}
if(!cfg||(typeof cfg==='undefined'?'undefined':_typeof(cfg))!=='object'){cfg={};}
cfg=clone(cfg);ALLOWED_TAGS='ALLOWED_TAGS'in cfg?addToSet({},cfg.ALLOWED_TAGS):DEFAULT_ALLOWED_TAGS;ALLOWED_ATTR='ALLOWED_ATTR'in cfg?addToSet({},cfg.ALLOWED_ATTR):DEFAULT_ALLOWED_ATTR;URI_SAFE_ATTRIBUTES='ADD_URI_SAFE_ATTR'in cfg?addToSet(clone(DEFAULT_URI_SAFE_ATTRIBUTES),cfg.ADD_URI_SAFE_ATTR):DEFAULT_URI_SAFE_ATTRIBUTES;DATA_URI_TAGS='ADD_DATA_URI_TAGS'in cfg?addToSet(clone(DEFAULT_DATA_URI_TAGS),cfg.ADD_DATA_URI_TAGS):DEFAULT_DATA_URI_TAGS;FORBID_CONTENTS='FORBID_CONTENTS'in cfg?addToSet({},cfg.FORBID_CONTENTS):DEFAULT_FORBID_CONTENTS;FORBID_TAGS='FORBID_TAGS'in cfg?addToSet({},cfg.FORBID_TAGS):{};FORBID_ATTR='FORBID_ATTR'in cfg?addToSet({},cfg.FORBID_ATTR):{};USE_PROFILES='USE_PROFILES'in cfg?cfg.USE_PROFILES:false;ALLOW_ARIA_ATTR=cfg.ALLOW_ARIA_ATTR!==false;ALLOW_DATA_ATTR=cfg.ALLOW_DATA_ATTR!==false;ALLOW_UNKNOWN_PROTOCOLS=cfg.ALLOW_UNKNOWN_PROTOCOLS||false;SAFE_FOR_TEMPLATES=cfg.SAFE_FOR_TEMPLATES||false;WHOLE_DOCUMENT=cfg.WHOLE_DOCUMENT||false;RETURN_DOM=cfg.RETURN_DOM||false;RETURN_DOM_FRAGMENT=cfg.RETURN_DOM_FRAGMENT||false;RETURN_DOM_IMPORT=cfg.RETURN_DOM_IMPORT!==false;RETURN_TRUSTED_TYPE=cfg.RETURN_TRUSTED_TYPE||false;FORCE_BODY=cfg.FORCE_BODY||false;SANITIZE_DOM=cfg.SANITIZE_DOM!==false;KEEP_CONTENT=cfg.KEEP_CONTENT!==false;IN_PLACE=cfg.IN_PLACE||false;IS_ALLOWED_URI$$1=cfg.ALLOWED_URI_REGEXP||IS_ALLOWED_URI$$1;NAMESPACE=cfg.NAMESPACE||HTML_NAMESPACE;if(SAFE_FOR_TEMPLATES){ALLOW_DATA_ATTR=false;}
if(RETURN_DOM_FRAGMENT){RETURN_DOM=true;}
if(USE_PROFILES){ALLOWED_TAGS=addToSet({},[].concat(_toConsumableArray$1(text)));ALLOWED_ATTR=[];if(USE_PROFILES.html===true){addToSet(ALLOWED_TAGS,html);addToSet(ALLOWED_ATTR,html$1);}
if(USE_PROFILES.svg===true){addToSet(ALLOWED_TAGS,svg);addToSet(ALLOWED_ATTR,svg$1);addToSet(ALLOWED_ATTR,xml);}
if(USE_PROFILES.svgFilters===true){addToSet(ALLOWED_TAGS,svgFilters);addToSet(ALLOWED_ATTR,svg$1);addToSet(ALLOWED_ATTR,xml);}
if(USE_PROFILES.mathMl===true){addToSet(ALLOWED_TAGS,mathMl);addToSet(ALLOWED_ATTR,mathMl$1);addToSet(ALLOWED_ATTR,xml);}}
if(cfg.ADD_TAGS){if(ALLOWED_TAGS===DEFAULT_ALLOWED_TAGS){ALLOWED_TAGS=clone(ALLOWED_TAGS);}
addToSet(ALLOWED_TAGS,cfg.ADD_TAGS);}
if(cfg.ADD_ATTR){if(ALLOWED_ATTR===DEFAULT_ALLOWED_ATTR){ALLOWED_ATTR=clone(ALLOWED_ATTR);}
addToSet(ALLOWED_ATTR,cfg.ADD_ATTR);}
if(cfg.ADD_URI_SAFE_ATTR){addToSet(URI_SAFE_ATTRIBUTES,cfg.ADD_URI_SAFE_ATTR);}
if(cfg.FORBID_CONTENTS){if(FORBID_CONTENTS===DEFAULT_FORBID_CONTENTS){FORBID_CONTENTS=clone(FORBID_CONTENTS);}
addToSet(FORBID_CONTENTS,cfg.FORBID_CONTENTS);}
if(KEEP_CONTENT){ALLOWED_TAGS['#text']=true;}
if(WHOLE_DOCUMENT){addToSet(ALLOWED_TAGS,['html','head','body']);}
if(ALLOWED_TAGS.table){addToSet(ALLOWED_TAGS,['tbody']);delete FORBID_TAGS.tbody;}
if(freeze){freeze(cfg);}
CONFIG=cfg;};var MATHML_TEXT_INTEGRATION_POINTS=addToSet({},['mi','mo','mn','ms','mtext']);var HTML_INTEGRATION_POINTS=addToSet({},['foreignobject','desc','title','annotation-xml']);var ALL_SVG_TAGS=addToSet({},svg);addToSet(ALL_SVG_TAGS,svgFilters);addToSet(ALL_SVG_TAGS,svgDisallowed);var ALL_MATHML_TAGS=addToSet({},mathMl);addToSet(ALL_MATHML_TAGS,mathMlDisallowed);var _checkValidNamespace=function _checkValidNamespace(element){var parent=getParentNode(element);if(!parent||!parent.tagName){parent={namespaceURI:HTML_NAMESPACE,tagName:'template'};}
var tagName=stringToLowerCase(element.tagName);var parentTagName=stringToLowerCase(parent.tagName);if(element.namespaceURI===SVG_NAMESPACE){if(parent.namespaceURI===HTML_NAMESPACE){return tagName==='svg';}
if(parent.namespaceURI===MATHML_NAMESPACE){return tagName==='svg'&&(parentTagName==='annotation-xml'||MATHML_TEXT_INTEGRATION_POINTS[parentTagName]);}
return Boolean(ALL_SVG_TAGS[tagName]);}
if(element.namespaceURI===MATHML_NAMESPACE){if(parent.namespaceURI===HTML_NAMESPACE){return tagName==='math';}
if(parent.namespaceURI===SVG_NAMESPACE){return tagName==='math'&&HTML_INTEGRATION_POINTS[parentTagName];}
return Boolean(ALL_MATHML_TAGS[tagName]);}
if(element.namespaceURI===HTML_NAMESPACE){if(parent.namespaceURI===SVG_NAMESPACE&&!HTML_INTEGRATION_POINTS[parentTagName]){return false;}
if(parent.namespaceURI===MATHML_NAMESPACE&&!MATHML_TEXT_INTEGRATION_POINTS[parentTagName]){return false;}
var commonSvgAndHTMLElements=addToSet({},['title','style','font','a','script']);return!ALL_MATHML_TAGS[tagName]&&(commonSvgAndHTMLElements[tagName]||!ALL_SVG_TAGS[tagName]);}
return false;};var _forceRemove=function _forceRemove(node){arrayPush(DOMPurify.removed,{element:node});try{node.parentNode.removeChild(node);}catch(_){try{node.outerHTML=emptyHTML;}catch(_){node.remove();}}};var _removeAttribute=function _removeAttribute(name,node){try{arrayPush(DOMPurify.removed,{attribute:node.getAttributeNode(name),from:node});}catch(_){arrayPush(DOMPurify.removed,{attribute:null,from:node});}
node.removeAttribute(name);if(name==='is'&&!ALLOWED_ATTR[name]){if(RETURN_DOM||RETURN_DOM_FRAGMENT){try{_forceRemove(node);}catch(_){}}else{try{node.setAttribute(name,'');}catch(_){}}}};var _initDocument=function _initDocument(dirty){var doc=void 0;var leadingWhitespace=void 0;if(FORCE_BODY){dirty='<remove></remove>'+dirty;}else{var matches=stringMatch(dirty,/^[\r\n\t ]+/);leadingWhitespace=matches&&matches[0];}
var dirtyPayload=trustedTypesPolicy?trustedTypesPolicy.createHTML(dirty):dirty;if(NAMESPACE===HTML_NAMESPACE){try{doc=new DOMParser().parseFromString(dirtyPayload,'text/html');}catch(_){}}
if(!doc||!doc.documentElement){doc=implementation.createDocument(NAMESPACE,'template',null);try{doc.documentElement.innerHTML=IS_EMPTY_INPUT?'':dirtyPayload;}catch(_){}}
var body=doc.body||doc.documentElement;if(dirty&&leadingWhitespace){body.insertBefore(document.createTextNode(leadingWhitespace),body.childNodes[0]||null);}
if(NAMESPACE===HTML_NAMESPACE){return getElementsByTagName.call(doc,WHOLE_DOCUMENT?'html':'body')[0];}
return WHOLE_DOCUMENT?doc.documentElement:body;};var _createIterator=function _createIterator(root){return createNodeIterator.call(root.ownerDocument||root,root,NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_COMMENT|NodeFilter.SHOW_TEXT,null,false);};var _isClobbered=function _isClobbered(elm){if(elm instanceof Text||elm instanceof Comment){return false;}
if(typeof elm.nodeName!=='string'||typeof elm.textContent!=='string'||typeof elm.removeChild!=='function'||!(elm.attributes instanceof NamedNodeMap)||typeof elm.removeAttribute!=='function'||typeof elm.setAttribute!=='function'||typeof elm.namespaceURI!=='string'||typeof elm.insertBefore!=='function'){return true;}
return false;};var _isNode=function _isNode(object){return(typeof Node==='undefined'?'undefined':_typeof(Node))==='object'?object instanceof Node:object&&(typeof object==='undefined'?'undefined':_typeof(object))==='object'&&typeof object.nodeType==='number'&&typeof object.nodeName==='string';};var _executeHook=function _executeHook(entryPoint,currentNode,data){if(!hooks[entryPoint]){return;}
arrayForEach(hooks[entryPoint],function(hook){hook.call(DOMPurify,currentNode,data,CONFIG);});};var _sanitizeElements=function _sanitizeElements(currentNode){var content=void 0;_executeHook('beforeSanitizeElements',currentNode,null);if(_isClobbered(currentNode)){_forceRemove(currentNode);return true;}
if(stringMatch(currentNode.nodeName,/[\u0080-\uFFFF]/)){_forceRemove(currentNode);return true;}
var tagName=stringToLowerCase(currentNode.nodeName);_executeHook('uponSanitizeElement',currentNode,{tagName:tagName,allowedTags:ALLOWED_TAGS});if(!_isNode(currentNode.firstElementChild)&&(!_isNode(currentNode.content)||!_isNode(currentNode.content.firstElementChild))&&regExpTest(/<[/\w]/g,currentNode.innerHTML)&&regExpTest(/<[/\w]/g,currentNode.textContent)){_forceRemove(currentNode);return true;}
if(tagName==='select'&&regExpTest(/<template/i,currentNode.innerHTML)){_forceRemove(currentNode);return true;}
if(!ALLOWED_TAGS[tagName]||FORBID_TAGS[tagName]){if(KEEP_CONTENT&&!FORBID_CONTENTS[tagName]){var parentNode=getParentNode(currentNode)||currentNode.parentNode;var childNodes=getChildNodes(currentNode)||currentNode.childNodes;if(childNodes&&parentNode){var childCount=childNodes.length;for(var i=childCount-1;i>=0;--i){parentNode.insertBefore(cloneNode(childNodes[i],true),getNextSibling(currentNode));}}}
_forceRemove(currentNode);return true;}
if(currentNode instanceof Element&&!_checkValidNamespace(currentNode)){_forceRemove(currentNode);return true;}
if((tagName==='noscript'||tagName==='noembed')&&regExpTest(/<\/no(script|embed)/i,currentNode.innerHTML)){_forceRemove(currentNode);return true;}
if(SAFE_FOR_TEMPLATES&&currentNode.nodeType===3){content=currentNode.textContent;content=stringReplace(content,MUSTACHE_EXPR$$1,' ');content=stringReplace(content,ERB_EXPR$$1,' ');if(currentNode.textContent!==content){arrayPush(DOMPurify.removed,{element:currentNode.cloneNode()});currentNode.textContent=content;}}
_executeHook('afterSanitizeElements',currentNode,null);return false;};var _isValidAttribute=function _isValidAttribute(lcTag,lcName,value){if(SANITIZE_DOM&&(lcName==='id'||lcName==='name')&&(value in document||value in formElement)){return false;}
if(ALLOW_DATA_ATTR&&!FORBID_ATTR[lcName]&&regExpTest(DATA_ATTR$$1,lcName));else if(ALLOW_ARIA_ATTR&&regExpTest(ARIA_ATTR$$1,lcName));else if(!ALLOWED_ATTR[lcName]||FORBID_ATTR[lcName]){return false;}else if(URI_SAFE_ATTRIBUTES[lcName]);else if(regExpTest(IS_ALLOWED_URI$$1,stringReplace(value,ATTR_WHITESPACE$$1,'')));else if((lcName==='src'||lcName==='xlink:href'||lcName==='href')&&lcTag!=='script'&&stringIndexOf(value,'data:')===0&&DATA_URI_TAGS[lcTag]);else if(ALLOW_UNKNOWN_PROTOCOLS&&!regExpTest(IS_SCRIPT_OR_DATA$$1,stringReplace(value,ATTR_WHITESPACE$$1,'')));else if(!value);else{return false;}
return true;};var _sanitizeAttributes=function _sanitizeAttributes(currentNode){var attr=void 0;var value=void 0;var lcName=void 0;var l=void 0;_executeHook('beforeSanitizeAttributes',currentNode,null);var attributes=currentNode.attributes;if(!attributes){return;}
var hookEvent={attrName:'',attrValue:'',keepAttr:true,allowedAttributes:ALLOWED_ATTR};l=attributes.length;while(l--){attr=attributes[l];var _attr=attr,name=_attr.name,namespaceURI=_attr.namespaceURI;value=stringTrim(attr.value);lcName=stringToLowerCase(name);hookEvent.attrName=lcName;hookEvent.attrValue=value;hookEvent.keepAttr=true;hookEvent.forceKeepAttr=undefined;_executeHook('uponSanitizeAttribute',currentNode,hookEvent);value=hookEvent.attrValue;if(hookEvent.forceKeepAttr){continue;}
_removeAttribute(name,currentNode);if(!hookEvent.keepAttr){continue;}
if(regExpTest(/\/>/i,value)){_removeAttribute(name,currentNode);continue;}
if(SAFE_FOR_TEMPLATES){value=stringReplace(value,MUSTACHE_EXPR$$1,' ');value=stringReplace(value,ERB_EXPR$$1,' ');}
var lcTag=currentNode.nodeName.toLowerCase();if(!_isValidAttribute(lcTag,lcName,value)){continue;}
try{if(namespaceURI){currentNode.setAttributeNS(namespaceURI,name,value);}else{currentNode.setAttribute(name,value);}
arrayPop(DOMPurify.removed);}catch(_){}}
_executeHook('afterSanitizeAttributes',currentNode,null);};var _sanitizeShadowDOM=function _sanitizeShadowDOM(fragment){var shadowNode=void 0;var shadowIterator=_createIterator(fragment);_executeHook('beforeSanitizeShadowDOM',fragment,null);while(shadowNode=shadowIterator.nextNode()){_executeHook('uponSanitizeShadowNode',shadowNode,null);if(_sanitizeElements(shadowNode)){continue;}
if(shadowNode.content instanceof DocumentFragment){_sanitizeShadowDOM(shadowNode.content);}
_sanitizeAttributes(shadowNode);}
_executeHook('afterSanitizeShadowDOM',fragment,null);};DOMPurify.sanitize=function(dirty,cfg){var body=void 0;var importedNode=void 0;var currentNode=void 0;var oldNode=void 0;var returnNode=void 0;IS_EMPTY_INPUT=!dirty;if(IS_EMPTY_INPUT){dirty='<!-->';}
if(typeof dirty!=='string'&&!_isNode(dirty)){if(typeof dirty.toString!=='function'){throw typeErrorCreate('toString is not a function');}else{dirty=dirty.toString();if(typeof dirty!=='string'){throw typeErrorCreate('dirty is not a string, aborting');}}}
if(!DOMPurify.isSupported){if(_typeof(window.toStaticHTML)==='object'||typeof window.toStaticHTML==='function'){if(typeof dirty==='string'){return window.toStaticHTML(dirty);}
if(_isNode(dirty)){return window.toStaticHTML(dirty.outerHTML);}}
return dirty;}
if(!SET_CONFIG){_parseConfig(cfg);}
DOMPurify.removed=[];if(typeof dirty==='string'){IN_PLACE=false;}
if(IN_PLACE);else if(dirty instanceof Node){body=_initDocument('<!---->');importedNode=body.ownerDocument.importNode(dirty,true);if(importedNode.nodeType===1&&importedNode.nodeName==='BODY'){body=importedNode;}else if(importedNode.nodeName==='HTML'){body=importedNode;}else{body.appendChild(importedNode);}}else{if(!RETURN_DOM&&!SAFE_FOR_TEMPLATES&&!WHOLE_DOCUMENT&&dirty.indexOf('<')===-1){return trustedTypesPolicy&&RETURN_TRUSTED_TYPE?trustedTypesPolicy.createHTML(dirty):dirty;}
body=_initDocument(dirty);if(!body){return RETURN_DOM?null:emptyHTML;}}
if(body&&FORCE_BODY){_forceRemove(body.firstChild);}
var nodeIterator=_createIterator(IN_PLACE?dirty:body);while(currentNode=nodeIterator.nextNode()){if(currentNode.nodeType===3&&currentNode===oldNode){continue;}
if(_sanitizeElements(currentNode)){continue;}
if(currentNode.content instanceof DocumentFragment){_sanitizeShadowDOM(currentNode.content);}
_sanitizeAttributes(currentNode);oldNode=currentNode;}
oldNode=null;if(IN_PLACE){return dirty;}
if(RETURN_DOM){if(RETURN_DOM_FRAGMENT){returnNode=createDocumentFragment.call(body.ownerDocument);while(body.firstChild){returnNode.appendChild(body.firstChild);}}else{returnNode=body;}
if(RETURN_DOM_IMPORT){returnNode=importNode.call(originalDocument,returnNode,true);}
return returnNode;}
var serializedHTML=WHOLE_DOCUMENT?body.outerHTML:body.innerHTML;if(SAFE_FOR_TEMPLATES){serializedHTML=stringReplace(serializedHTML,MUSTACHE_EXPR$$1,' ');serializedHTML=stringReplace(serializedHTML,ERB_EXPR$$1,' ');}
return trustedTypesPolicy&&RETURN_TRUSTED_TYPE?trustedTypesPolicy.createHTML(serializedHTML):serializedHTML;};DOMPurify.setConfig=function(cfg){_parseConfig(cfg);SET_CONFIG=true;};DOMPurify.clearConfig=function(){CONFIG=null;SET_CONFIG=false;};DOMPurify.isValidAttribute=function(tag,attr,value){if(!CONFIG){_parseConfig({});}
var lcTag=stringToLowerCase(tag);var lcName=stringToLowerCase(attr);return _isValidAttribute(lcTag,lcName,value);};DOMPurify.addHook=function(entryPoint,hookFunction){if(typeof hookFunction!=='function'){return;}
hooks[entryPoint]=hooks[entryPoint]||[];arrayPush(hooks[entryPoint],hookFunction);};DOMPurify.removeHook=function(entryPoint){if(hooks[entryPoint]){arrayPop(hooks[entryPoint]);}};DOMPurify.removeHooks=function(entryPoint){if(hooks[entryPoint]){hooks[entryPoint]=[];}};DOMPurify.removeAllHooks=function(){hooks={};};return DOMPurify;}
var purify=createDOMPurify();return purify;}));;

/* /web_editor/static/lib/odoo-editor/src/tablepicker/TablePicker.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('@web_editor/../lib/odoo-editor/src/tablepicker/TablePicker',async function(require){'use strict';let __exports={};const{getRangePosition}=require("@web_editor/../lib/odoo-editor/src/utils/utils");const TablePicker=__exports.TablePicker=class TablePicker extends EventTarget{constructor(options={}){super();this.options=options;this.options.minRowCount=this.options.minRowCount||3;this.options.minColCount=this.options.minColCount||3;this.rowNumber=this.options.minRowCount;this.colNumber=this.options.minColCount;this.tablePickerWrapper=document.createElement('div');this.tablePickerWrapper.classList.add('oe-tablepicker-wrapper');this.tablePickerWrapper.innerHTML=`
            <div class="oe-tablepicker"></div>
            <div class="oe-tablepicker-size"></div>
        `;if(this.options.floating){this.tablePickerWrapper.style.position='absolute';this.tablePickerWrapper.classList.add('oe-floating');}
this.tablePickerElement=this.tablePickerWrapper.querySelector('.oe-tablepicker');this.tablePickerSizeViewElement=this.tablePickerWrapper.querySelector('.oe-tablepicker-size');this.el=this.tablePickerWrapper;this.hide();}
render(){this.tablePickerElement.innerHTML='';const colCount=Math.max(this.colNumber,this.options.minRowCount);const rowCount=Math.max(this.rowNumber,this.options.minRowCount);const extraCol=1;const extraRow=1;for(let rowNumber=1;rowNumber<=rowCount+extraRow;rowNumber++){const rowElement=this.options.document.createElement('div');rowElement.classList.add('oe-tablepicker-row');this.tablePickerElement.appendChild(rowElement);for(let colNumber=1;colNumber<=colCount+extraCol;colNumber++){const cell=this.options.document.createElement('div');cell.classList.add('oe-tablepicker-cell','btn');rowElement.appendChild(cell);if(rowNumber<=this.rowNumber&&colNumber<=this.colNumber){cell.classList.add('active');}
const bindMouseMove=()=>{cell.addEventListener('mouseover',()=>{if(this.colNumber!==colNumber||this.rowNumber!=rowNumber){this.colNumber=colNumber;this.rowNumber=rowNumber;this.render();}});this.options.document.removeEventListener('mousemove',bindMouseMove);};this.options.document.addEventListener('mousemove',bindMouseMove);cell.addEventListener('mousedown',this.selectCell.bind(this));}}
this.tablePickerSizeViewElement.textContent=`${this.colNumber}x${this.rowNumber}`;}
show(){this.reset();this.el.style.display='block';if(this.options.floating){this._showFloating();}}
hide(){this.el.style.display='none';}
reset(){this.rowNumber=this.options.minRowCount;this.colNumber=this.options.minColCount;this.render();}
selectCell(){this.dispatchEvent(new CustomEvent('cell-selected',{detail:{colNumber:this.colNumber,rowNumber:this.rowNumber},}),);}
_showFloating(){const keydown=e=>{const actions={ArrowRight:{colNumber:this.colNumber+1,rowNumber:this.rowNumber,},ArrowLeft:{colNumber:this.colNumber-1||1,rowNumber:this.rowNumber,},ArrowUp:{colNumber:this.colNumber,rowNumber:this.rowNumber-1||1,},ArrowDown:{colNumber:this.colNumber,rowNumber:this.rowNumber+1,},};const action=actions[e.key];if(action){this.rowNumber=action.rowNumber||this.rowNumber;this.colNumber=action.colNumber||this.colNumber;this.render();e.preventDefault();}else if(e.key==='Enter'){this.selectCell();e.preventDefault();}else if(e.key==='Escape'){stop();e.preventDefault();}};const offset=getRangePosition(this.el,this.options.document);this.el.style.left=`${offset.left}px`;this.el.style.top=`${offset.top}px`;const stop=()=>{this.hide();this.options.document.removeEventListener('mousedown',stop);this.removeEventListener('cell-selected',stop);this.options.document.removeEventListener('keydown',keydown,true);};setTimeout(()=>{this.options.document.addEventListener('mousedown',stop);});this.options.document.addEventListener('keydown',keydown,true);this.addEventListener('cell-selected',stop);}}
return __exports;});;

/* /web_editor/static/lib/odoo-editor/src/powerbox/patienceDiff.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('@web_editor/../lib/odoo-editor/src/powerbox/patienceDiff',async function(require){'use strict';let __exports={};const patienceDiff=__exports.patienceDiff=function patienceDiff(aLines,bLines,diffPlusFlag){function findUnique(arr,lo,hi){var lineMap=new Map();for(let i=lo;i<=hi;i++){let line=arr[i];if(lineMap.has(line)){lineMap.get(line).count++;lineMap.get(line).index=i;}else{lineMap.set(line,{count:1,index:i});}}
lineMap.forEach((val,key,map)=>{if(val.count!==1){map.delete(key);}else{map.set(key,val.index);}});return lineMap;}
function uniqueCommon(aArray,aLo,aHi,bArray,bLo,bHi){let ma=findUnique(aArray,aLo,aHi);let mb=findUnique(bArray,bLo,bHi);ma.forEach((val,key,map)=>{if(mb.has(key)){map.set(key,{indexA:val,indexB:mb.get(key)});}else{map.delete(key);}});return ma;}
function longestCommonSubsequence(abMap){var ja=[];abMap.forEach((val,key,map)=>{let i=0;while(ja[i]&&ja[i][ja[i].length-1].indexB<val.indexB){i++;}
if(!ja[i]){ja[i]=[];}
if(0<i){val.prev=ja[i-1][ja[i-1].length-1];}
ja[i].push(val);});var lcs=[];if(0<ja.length){let n=ja.length-1;var lcs=[ja[n][ja[n].length-1]];while(lcs[lcs.length-1].prev){lcs.push(lcs[lcs.length-1].prev);}}
return lcs.reverse();}
let result=[];let deleted=0;let inserted=0;let aMove=[];let aMoveIndex=[];let bMove=[];let bMoveIndex=[];function addToResult(aIndex,bIndex){if(bIndex<0){aMove.push(aLines[aIndex]);aMoveIndex.push(result.length);deleted++;}else if(aIndex<0){bMove.push(bLines[bIndex]);bMoveIndex.push(result.length);inserted++;}
result.push({line:0<=aIndex?aLines[aIndex]:bLines[bIndex],aIndex:aIndex,bIndex:bIndex,});}
function addSubMatch(aLo,aHi,bLo,bHi){while(aLo<=aHi&&bLo<=bHi&&aLines[aLo]===bLines[bLo]){addToResult(aLo++,bLo++);}
let aHiTemp=aHi;while(aLo<=aHi&&bLo<=bHi&&aLines[aHi]===bLines[bHi]){aHi--;bHi--;}
let uniqueCommonMap=uniqueCommon(aLines,aLo,aHi,bLines,bLo,bHi);if(uniqueCommonMap.size===0){while(aLo<=aHi){addToResult(aLo++,-1);}
while(bLo<=bHi){addToResult(-1,bLo++);}}else{recurseLCS(aLo,aHi,bLo,bHi,uniqueCommonMap);}
while(aHi<aHiTemp){addToResult(++aHi,++bHi);}}
function recurseLCS(aLo,aHi,bLo,bHi,uniqueCommonMap){var x=longestCommonSubsequence(uniqueCommonMap||uniqueCommon(aLines,aLo,aHi,bLines,bLo,bHi),);if(x.length===0){addSubMatch(aLo,aHi,bLo,bHi);}else{if(aLo<x[0].indexA||bLo<x[0].indexB){addSubMatch(aLo,x[0].indexA-1,bLo,x[0].indexB-1);}
let i;for(i=0;i<x.length-1;i++){addSubMatch(x[i].indexA,x[i+1].indexA-1,x[i].indexB,x[i+1].indexB-1);}
if(x[i].indexA<=aHi||x[i].indexB<=bHi){addSubMatch(x[i].indexA,aHi,x[i].indexB,bHi);}}}
recurseLCS(0,aLines.length-1,0,bLines.length-1);if(diffPlusFlag){return{lines:result,lineCountDeleted:deleted,lineCountInserted:inserted,lineCountMoved:0,aMove:aMove,aMoveIndex:aMoveIndex,bMove:bMove,bMoveIndex:bMoveIndex,};}
return{lines:result,lineCountDeleted:deleted,lineCountInserted:inserted,lineCountMoved:0,};}
return __exports;});;

/* /web_editor/static/lib/odoo-editor/src/powerbox/Powerbox.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('@web_editor/../lib/odoo-editor/src/powerbox/Powerbox',async function(require){'use strict';let __exports={};const{patienceDiff}=require("@web_editor/../lib/odoo-editor/src/powerbox/patienceDiff");const{getRangePosition}=require("@web_editor/../lib/odoo-editor/src/utils/utils");function cycle(num,max){const y=max+1;return((num%y)+y)%y;}
const Powerbox=__exports.Powerbox=class Powerbox{constructor(options={}){this.options=options;this.options.width=this.options.width||340;if(!this.options._t)this.options._t=string=>string;this.el=document.createElement('div');this.el.className='oe-commandbar-wrapper';this.el.style.display='none';this.el.style.width=`${this.options.width}px`;document.body.append(this.el);this.addKeydownTrigger('/',{commands:this.options.commands});this._mainWrapperElement=document.createElement('div');this._mainWrapperElement.className='oe-commandbar-mainWrapper';this.el.append(this._mainWrapperElement);this.el.addEventListener('mousedown',event=>{event.stopPropagation();});}
destroy(){this.el.remove();}
render(commands){this._mainWrapperElement.innerHTML='';clearTimeout(this._renderingTimeout);this._hoverActive=false;if(commands.length===0){const groupWrapperEl=document.createElement('div');groupWrapperEl.className='oe-commandbar-groupWrapper';const groupNameEl=document.createElement('div');groupNameEl.className='oe-commandbar-noResult';groupWrapperEl.append(groupNameEl);this._mainWrapperElement.append(groupWrapperEl);groupNameEl.innerText=this.options._t('No results');return;}
this._currentSelectedCommand=commands.find(c=>c===this._currentSelectedCommand)||commands[0];const groups={};for(const command of commands){groups[command.groupName]=groups[command.groupName]||[];groups[command.groupName].push(command);}
for(const[groupName,commands]of Object.entries(groups)){const groupWrapperEl=document.createElement('div');groupWrapperEl.className='oe-commandbar-groupWrapper';const groupNameEl=document.createElement('div');groupNameEl.className='oe-commandbar-groupName';groupWrapperEl.append(groupNameEl);this._mainWrapperElement.append(groupWrapperEl);groupNameEl.innerText=groupName;for(const command of commands){const commandElWrapper=document.createElement('div');commandElWrapper.className='oe-commandbar-commandWrapper';if(this._currentSelectedCommand===command){commandElWrapper.classList.add('active');this._renderingTimeout=setTimeout(()=>{commandElWrapper.scrollIntoView({block:'nearest',inline:'nearest',});});}
let commandImgEl,commandTitleEl,commandDescriptionEl;switch(command.style){case'small':commandTitleEl=document.createElement('div');commandTitleEl.setAttribute('class','oe-commandbar-commandSmall');commandTitleEl.setAttribute('title',command.description);commandTitleEl.innerText=command.title;commandElWrapper.append(commandTitleEl);break;default:commandElWrapper.innerHTML=`
                    <div class="oe-commandbar-commandLeftCol">
                        <i class="oe-commandbar-commandImg fa"></i>
                    </div>
                    <div class="oe-commandbar-commandRightCol">
                        <div class="oe-commandbar-commandTitle">
                        </div>
                        <div class="oe-commandbar-commandDescription">
                        </div>
                    </div>`;commandImgEl=commandElWrapper.querySelector('.oe-commandbar-commandImg');commandTitleEl=commandElWrapper.querySelector('.oe-commandbar-commandTitle',);commandDescriptionEl=commandElWrapper.querySelector('.oe-commandbar-commandDescription',);commandTitleEl.innerText=command.title;commandDescriptionEl.innerText=command.description;commandImgEl.classList.add(command.fontawesome);}
groupWrapperEl.append(commandElWrapper);const commandElWrapperMouseMove=()=>{if(!this._hoverActive||commandElWrapper.classList.contains('active')){return;}
this.el.querySelector('.oe-commandbar-commandWrapper.active').classList.remove('active');this._currentSelectedCommand=command;commandElWrapper.classList.add('active');};commandElWrapper.addEventListener('mousemove',commandElWrapperMouseMove);commandElWrapper.addEventListener('mousedown',ev=>{ev.preventDefault();ev.stopImmediatePropagation();this._currentValidate();},true,);}}
this._resetPosition();}
addKeydownTrigger(triggerKey,options){this.options.editable.addEventListener('keydown',ev=>{const selection=this.options.document.getSelection();if(!selection.isCollapsed||!selection.rangeCount)return;if(ev.key===triggerKey&&!this._active&&(!this.options.shouldActivate||this.options.shouldActivate())){this.open({...options,openOnKeyupTarget:ev.target});}},true,);}
open(openOptions){this.options.onActivate&&this.options.onActivate();this._currentOpenOptions=openOptions;console.log('op',openOptions);const openOnKeyupTarget=this._currentOpenOptions.openOnKeyupTarget||this.options.editable;const onValueChangeFunction=term=>this._currentOpenOptions.valueChangeFunction?this._currentOpenOptions.valueChangeFunction(term):this._filter(term,this._currentOpenOptions.commands);const showOnceOnKeyup=()=>{this.show();openOnKeyupTarget.removeEventListener('keyup',showOnceOnKeyup,true);initialTarget=openOnKeyupTarget;this._initialValue=openOnKeyupTarget.textContent;};openOnKeyupTarget.addEventListener('keyup',showOnceOnKeyup,true);this._active=true;this._currentFilteredCommands=this._currentOpenOptions.commands;this.render(this._currentOpenOptions.commands);let initialTarget;const keyup=async ev=>{if(ev.key==='ArrowDown'||ev.key==='ArrowUp'){ev.preventDefault();return;}
if(!initialTarget)return;const diff=patienceDiff(this._initialValue.split(''),initialTarget.textContent.split(''),true,);this._lastText=diff.bMove.join('');if(this._lastText.match(/\s/)&&this._currentOpenOptions.closeOnSpace!==false){this._stop();return;}
const term=this._lastText;this._currentFilteredCommands=term===''?this._currentOpenOptions.commands:await onValueChangeFunction(term);this.render(this._currentFilteredCommands);};const keydown=ev=>{if(ev.key==='Enter'){ev.stopImmediatePropagation();this._currentValidate();ev.preventDefault();}else if(ev.key==='Escape'){ev.stopImmediatePropagation();this._stop();ev.preventDefault();}else if(ev.key==='Backspace'&&!this._lastText){this._stop();}else if(ev.key==='ArrowDown'||ev.key==='ArrowUp'){ev.preventDefault();ev.stopImmediatePropagation();const index=this._currentFilteredCommands.findIndex(c=>c===this._currentSelectedCommand,);if(!this._currentFilteredCommands.length||index===-1){this._currentSelectedCommand=undefined;}else{const n=ev.key==='ArrowDown'?1:-1;const newIndex=cycle(index+n,this._currentFilteredCommands.length-1);this._currentSelectedCommand=this._currentFilteredCommands[newIndex];}
ev.preventDefault();this.render(this._currentFilteredCommands);}};const mousemove=()=>{this._hoverActive=true;};this._stop=()=>{this._active=false;this.hide();this._currentSelectedCommand=undefined;this.options.document.removeEventListener('keyup',keyup);this.options.document.removeEventListener('keydown',keydown,true);this.options.document.removeEventListener('mousemove',mousemove);this.options.document.removeEventListener('mousedown',this._stop);if(document!==this.options.document){document.removeEventListener('mousemove',mousemove);document.removeEventListener('mousedown',this._stop);}
this.options.onStop&&this.options.onStop();};this._currentValidate=()=>{const command=this._currentFilteredCommands.find(c=>c===this._currentSelectedCommand,);if(command){!command.isIntermediateStep&&this.options.preValidate&&this.options.preValidate();command.callback();!command.isIntermediateStep&&this.options.postValidate&&this.options.postValidate();}
if(!command||!command.isIntermediateStep){this._stop();}};this.options.document.addEventListener('keyup',keyup);this.options.document.addEventListener('keydown',keydown,true);this.options.document.addEventListener('mousemove',mousemove);this.options.document.addEventListener('mousedown',this._stop);if(document!==this.options.document){document.addEventListener('mousemove',mousemove);document.addEventListener('mousedown',this._stop);}}
nextOpenOptions(openOptions){this._currentOpenOptions=openOptions;this._initialValue=(this._currentOpenOptions.openOnKeyupTarget||this.options.editable).textContent;this._currentFilteredCommands=this._currentOpenOptions.commands;this.render(this._currentOpenOptions.commands);}
show(){this.options.onShow&&this.options.onShow();this.el.style.display='flex';this._resetPosition();}
hide(){this.el.style.display='none';if(this._active)this._stop();}
_filter(term,commands){const initalCommands=commands;term=term.toLowerCase();term=term.replaceAll(/\s/g,'\\s');const regex=new RegExp(term.split('').map(c=>c.replace(/[\\^$.*+?()[\]{}|]/g,'\\$&')).join('.*'),);if(term.length){commands=initalCommands.filter(command=>{const commandText=(command.groupName+' '+command.title).toLowerCase();return commandText.match(regex);});}
return commands;}
_resetPosition(){const position=getRangePosition(this.el,this.options.document);if(!position){this.hide();return;}
let{left,top}=position;if(this.options.getContextFromParentRect){const parentContextRect=this.options.getContextFromParentRect();left+=parentContextRect.left;top+=parentContextRect.top;}
this.el.style.left=`${left}px`;this.el.style.top=`${top}px`;}}
return __exports;});;

/* /web_editor/static/lib/odoo-editor/src/commands/align.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('@web_editor/../lib/odoo-editor/src/commands/align',async function(require){'use strict';let __exports={};const{childNodeIndex,isBlock}=require("@web_editor/../lib/odoo-editor/src/utils/utils");Text.prototype.oAlign=function(offset,mode){this.parentElement.oAlign(childNodeIndex(this),mode);};HTMLElement.prototype.oAlign=function(offset,mode){if(!isBlock(this)){return this.parentElement.oAlign(childNodeIndex(this),mode);}
const{textAlign}=getComputedStyle(this);const alreadyAlignedLeft=textAlign==='start'||textAlign==='left';const shouldApplyStyle=!(alreadyAlignedLeft&&mode==='left');if(shouldApplyStyle){this.style.textAlign=mode;}};return __exports;});;

/* /web_editor/static/lib/odoo-editor/src/commands/commands.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('@web_editor/../lib/odoo-editor/src/commands/commands',async function(require){'use strict';let __exports={};const{ancestors,childNodeIndex,closestBlock,closestElement,closestPath,DIRECTIONS,findNode,getCursorDirection,getCursors,getDeepRange,getInSelection,getListMode,getNormalizedCursorPosition,getSelectedNodes,getTraversedNodes,insertText,isBlock,isBold,isColorGradient,isContentTextNode,isShrunkBlock,isVisible,isVisibleStr,leftLeafFirstPath,preserveCursor,rightPos,setSelection,setCursorStart,setTagName,splitElement,splitTextNode,startPos,nodeSize,}=require("@web_editor/../lib/odoo-editor/src/utils/utils");const TEXT_CLASSES_REGEX=/\btext-[^\s]*\b/g;const BG_CLASSES_REGEX=/\bbg-[^\s]*\b/g;function insert(editor,data,isText=true){const selection=editor.document.getSelection();const range=selection.getRangeAt(0);let startNode;let insertBefore=false;if(selection.isCollapsed){if(range.startContainer.nodeType===Node.TEXT_NODE){insertBefore=!range.startOffset;splitTextNode(range.startContainer,range.startOffset,DIRECTIONS.LEFT);startNode=range.startContainer;}}else{editor.deleteRange(selection);}
startNode=startNode||editor.document.getSelection().anchorNode;if(startNode.nodeType===Node.ELEMENT_NODE){if(selection.anchorOffset===0){startNode.prepend(editor.document.createTextNode(''));startNode=startNode.firstChild;}else{startNode=startNode.childNodes[selection.anchorOffset-1];}}
const fakeEl=document.createElement('fake-element');if(isText){fakeEl.innerText=data;}else{fakeEl.innerHTML=data;}
let nodeToInsert;const insertedNodes=[...fakeEl.childNodes];while((nodeToInsert=fakeEl.childNodes[0])){if(isBlock(nodeToInsert)&&!isBlock(startNode)){while(startNode.parentElement!==editor.editable&&!isBlock(startNode.parentElement)){let offset=childNodeIndex(startNode);if(!insertBefore){offset+=1;}
if(offset){const[left,right]=splitElement(startNode.parentElement,offset);startNode=insertBefore?right:left;}else{startNode=startNode.parentElement;}}}
if(insertBefore){startNode.before(nodeToInsert);insertBefore=false;}else{startNode.after(nodeToInsert);}
if(startNode.tagName!=='BR'&&isShrunkBlock(startNode)){startNode.remove();}
startNode=nodeToInsert;}
selection.removeAllRanges();const newRange=new Range();const lastPosition=rightPos(startNode);newRange.setStart(lastPosition[0],lastPosition[1]);newRange.setEnd(lastPosition[0],lastPosition[1]);selection.addRange(newRange);return insertedNodes;}
function align(editor,mode){const sel=editor.document.getSelection();const visitedBlocks=new Set();const traversedNode=getTraversedNodes(editor.editable);for(const node of traversedNode){if(isContentTextNode(node)&&isVisible(node)){const block=closestBlock(node);if(!visitedBlocks.has(block)){const hasModifier=getComputedStyle(block).textAlign===mode;if(!hasModifier&&block.isContentEditable){block.oAlign(sel.anchorOffset,mode);}
visitedBlocks.add(block);}}}}
function colorElement(element,color,mode){const newClassName=element.className.replace(mode==='color'?TEXT_CLASSES_REGEX:BG_CLASSES_REGEX,'').replace(/\btext-gradient\b/g,'').replace(/\s+/,' ');element.className!==newClassName&&(element.className=newClassName);element.style['background-image']='';if(mode==='backgroundColor'){element.style['background']='';}
if(color.startsWith('text')||color.startsWith('bg-')){element.style[mode]='';element.classList.add(color);}else if(isColorGradient(color)){element.style[mode]='';if(mode==='color'){element.style['background']='';element.style['background-image']=color;element.classList.add('text-gradient');}else{element.style['background-image']=color;}}else{element.style[mode]=color;}}
function hasColor(element,mode){const style=element.style;const parent=element.parentNode;const classRegex=mode==='color'?TEXT_CLASSES_REGEX:BG_CLASSES_REGEX;if(isColorGradient(style['background-image'])){if(element.classList.contains('text-gradient')){if(mode==='color'){return true;}}else{if(mode!=='color'){return true;}}}
return((style[mode]&&style[mode]!=='inherit'&&style[mode]!==parent.style[mode])||(classRegex.test(element.className)&&getComputedStyle(element)[mode]!==getComputedStyle(parent)[mode]));}
const applyInlineStyle=__exports.applyInlineStyle=function applyInlineStyle(editor,applyStyle){const sel=editor.document.getSelection();const{startContainer,startOffset,endContainer,endOffset}=sel.getRangeAt(0);const{anchorNode,anchorOffset,focusNode,focusOffset}=sel;const direction=getCursorDirection(anchorNode,anchorOffset,focusNode,focusOffset);const[normalizedStartContainer,normalizedStartOffset]=getNormalizedCursorPosition(startContainer,startOffset)
const[normalizedEndContainer,normalizedEndOffset]=getNormalizedCursorPosition(endContainer,endOffset)
const selectedTextNodes=getTraversedNodes(editor.editable).filter(node=>{const atLeastOneCharFromNodeInSelection=!((node===normalizedEndContainer&&normalizedEndOffset===0)||(node===normalizedStartContainer&&normalizedStartOffset===node.textContent.length));return isContentTextNode(node)&&atLeastOneCharFromNodeInSelection;});for(const textNode of selectedTextNodes){if(endContainer===textNode&&endOffset<textNode.textContent.length){splitTextNode(textNode,endOffset,DIRECTIONS.LEFT);}
if(startContainer===textNode&&startOffset>0){splitTextNode(textNode,startOffset,DIRECTIONS.RIGHT);}
const siblings=[...textNode.parentElement.childNodes];if(isBlock(textNode.parentElement)||!(selectedTextNodes.includes(siblings[0])&&selectedTextNodes.includes(siblings[siblings.length-1]))||textNode.parentElement.tagName==='A'){const newParent=document.createElement('span');textNode.after(newParent);newParent.appendChild(textNode);}
applyStyle(textNode.parentElement);}
const firstNode=selectedTextNodes[0];const lastNode=selectedTextNodes[selectedTextNodes.length-1];if(direction===DIRECTIONS.RIGHT){setSelection(firstNode,0,lastNode,lastNode.length);}else{setSelection(lastNode,lastNode.length,firstNode,0);}}
function addColumn(editor,beforeOrAfter){getDeepRange(editor.editable,{select:true});const c=getInSelection(editor.document,'td');if(!c)return;const i=[...closestElement(c,'tr').querySelectorAll('th, td')].findIndex(td=>td===c);const column=closestElement(c,'table').querySelectorAll(`tr td:nth-of-type(${i + 1})`);column.forEach(row=>row[beforeOrAfter](document.createElement('td')));}
function addRow(editor,beforeOrAfter){getDeepRange(editor.editable,{select:true});const row=getInSelection(editor.document,'tr');if(!row)return;const newRow=document.createElement('tr');const cells=row.querySelectorAll('td');newRow.append(...Array.from(Array(cells.length)).map(()=>document.createElement('td')));row[beforeOrAfter](newRow);}
function deleteTable(editor,table){table=table||getInSelection(editor.document,'table');if(!table)return;const p=document.createElement('p');p.appendChild(document.createElement('br'));table.before(p);table.remove();setSelection(p,0);}
const editorCommands=__exports.editorCommands={insertHTML:(editor,data)=>{return insert(editor,data,false);},insertText:(editor,data)=>{return insert(editor,data);},insertFontAwesome:(editor,faClass='fa fa-star')=>{const insertedNode=editorCommands.insertHTML(editor,'<i></i>')[0];insertedNode.className=faClass;const position=rightPos(insertedNode);setSelection(...position,...position,false);},undo:editor=>editor.historyUndo(),redo:editor=>editor.historyRedo(),setTag(editor,tagName){const restoreCursor=preserveCursor(editor.document);const selectedBlocks=[...new Set(getTraversedNodes(editor.editable).map(closestBlock))];for(const block of selectedBlocks){if(['P','PRE','H1','H2','H3','H4','H5','H6','BLOCKQUOTE'].includes(block.nodeName,)){setSelection(block,0,block,nodeSize(block));editor.historyPauseSteps();editor.document.execCommand('removeFormat');editor.historyUnpauseSteps();setTagName(block,tagName);}else{const newBlock=editor.document.createElement(tagName);const children=[...block.childNodes];block.insertBefore(newBlock,block.firstChild);children.forEach(child=>newBlock.appendChild(child));}}
restoreCursor();editor.historyStep();},bold:editor=>{const selection=editor.document.getSelection();if(!selection.rangeCount||selection.getRangeAt(0).collapsed)return;getDeepRange(editor.editable,{splitText:true,select:true,correctTripleClick:true});const isAlreadyBold=getSelectedNodes(editor.editable).filter(n=>n.nodeType===Node.TEXT_NODE&&n.nodeValue.trim().length).find(n=>isBold(n.parentElement));applyInlineStyle(editor,el=>{if(isAlreadyBold){const block=closestBlock(el);el.style.fontWeight=isBold(block)?'normal':getComputedStyle(block).fontWeight;}else{el.style.fontWeight='bolder';}});},italic:editor=>editor.document.execCommand('italic'),underline:editor=>editor.document.execCommand('underline'),strikeThrough:editor=>editor.document.execCommand('strikeThrough'),removeFormat:editor=>editor.document.execCommand('removeFormat'),justifyLeft:editor=>align(editor,'left'),justifyRight:editor=>align(editor,'right'),justifyCenter:editor=>align(editor,'center'),justifyFull:editor=>align(editor,'justify'),setFontSize:(editor,size)=>{const selection=editor.document.getSelection();if(!selection.rangeCount||selection.getRangeAt(0).collapsed)return;applyInlineStyle(editor,element=>{element.style.fontSize=size;});},createLink:(editor,link,content)=>{const sel=editor.document.getSelection();if(content&&!sel.isCollapsed){editor.deleteRange(sel);}
if(sel.isCollapsed){insertText(sel,content||'link');}
const currentLink=closestElement(sel.focusNode,'a');link=link||prompt('URL or Email',(currentLink&&currentLink.href)||'http://');const res=editor.document.execCommand('createLink',false,link);if(res){setSelection(sel.anchorNode,sel.anchorOffset,sel.focusNode,sel.focusOffset);const node=findNode(closestPath(sel.focusNode),node=>node.tagName==='A');for(const[param,value]of Object.entries(editor.options.defaultLinkAttributes)){node.setAttribute(param,`${value}`);}
const pos=[node.parentElement,childNodeIndex(node)+1];setSelection(...pos,...pos,false);}},unlink:editor=>{const sel=editor.document.getSelection();const closestEl=closestElement(sel.focusNode);if(closestEl.tagName==='A'&&closestEl.getAttribute('contenteditable')==='true'){editor._activateContenteditable();}
if(sel.isCollapsed){const cr=preserveCursor(editor.document);const node=closestElement(sel.focusNode,'a');setSelection(node,0,node,node.childNodes.length,false);editor.document.execCommand('unlink');cr();}else{editor.document.execCommand('unlink');setSelection(sel.anchorNode,sel.anchorOffset,sel.focusNode,sel.focusOffset);}},indentList:(editor,mode='indent')=>{const[pos1,pos2]=getCursors(editor.document);const end=leftLeafFirstPath(...pos1).next().value;const li=new Set();for(const node of leftLeafFirstPath(...pos2)){const cli=closestBlock(node);if(cli&&cli.tagName=='LI'&&!li.has(cli)&&!cli.classList.contains('oe-nested')){li.add(cli);}
if(node==end)break;}
for(const node of li){if(mode=='indent'){node.oTab(0);}else{node.oShiftTab(0);}}
return true;},toggleList:(editor,mode)=>{const li=new Set();const blocks=new Set();for(const node of getTraversedNodes(editor.editable)){if(node.nodeType===Node.TEXT_NODE&&!isVisibleStr(node)){node.remove();}else{const block=closestBlock(node);if(!['OL','UL'].includes(block.tagName)){const ublock=block.closest('ol, ul');ublock&&getListMode(ublock)==mode?li.add(block):blocks.add(block);}}}
let target=[...(blocks.size?blocks:li)];while(target.length){const node=target.pop();if(!node.oToggleList(0,mode)){target=target.filter(li=>li.parentNode!=node.parentNode||li.tagName!='LI',);}}},applyColor:(editor,color,mode,element)=>{if(element){colorElement(element,color,mode);return;}
const range=getDeepRange(editor.editable,{splitText:true,select:true});if(!range)return;const restoreCursor=preserveCursor(editor.document);const selectedNodes=getSelectedNodes(editor.editable);const fonts=selectedNodes.flatMap(node=>{let font=closestElement(node,'font');const children=font&&[...font.childNodes];if(font&&font.nodeName==='FONT'){const selectedChildren=children.filter(child=>selectedNodes.includes(child));if(selectedChildren.length){const after=selectedChildren[selectedChildren.length-1].nextSibling;font=after?splitElement(font,childNodeIndex(after))[0]:font;const before=selectedChildren[0].previousSibling;font=before?splitElement(font,childNodeIndex(before)+1)[1]:font;}}else if(node.nodeType===Node.TEXT_NODE&&isVisibleStr(node)){const previous=node.previousSibling;const classRegex=mode==='color'?BG_CLASSES_REGEX:TEXT_CLASSES_REGEX;if(previous&&previous.nodeName==='FONT'&&!previous.style[mode==='color'?'backgroundColor':'color']&&!classRegex.test(previous.className)&&selectedNodes.includes(previous.firstChild)&&selectedNodes.includes(previous.lastChild)){font=previous;}else{font=document.createElement('font');node.parentNode.insertBefore(font,node);}
font.appendChild(node);}else{font=[];}
return font;});for(const font of new Set(fonts)){colorElement(font,color,mode);if(!hasColor(font,mode)&&!font.hasAttribute('style')){for(const child of[...font.childNodes]){font.parentNode.insertBefore(child,font);}
font.parentNode.removeChild(font);}}
restoreCursor();},insertTable:(editor,{rowNumber=2,colNumber=2}={})=>{const tdsHtml=new Array(colNumber).fill('<td><br></td>').join('');const trsHtml=new Array(rowNumber).fill(`<tr>${tdsHtml}</tr>`).join('');const tableHtml=`<table class="table table-bordered"><tbody>${trsHtml}</tbody></table>`;const sel=editor.document.getSelection();if(!sel.isCollapsed){editor.deleteRange(sel);}
while(!isBlock(sel.anchorNode)){const anchorNode=sel.anchorNode;const isTextNode=anchorNode.nodeType===Node.TEXT_NODE;const newAnchorNode=isTextNode?splitTextNode(anchorNode,sel.anchorOffset,DIRECTIONS.LEFT)+1&&anchorNode:splitElement(anchorNode,sel.anchorOffset).shift();const newPosition=rightPos(newAnchorNode);setSelection(...newPosition,...newPosition,false);}
const[table]=editorCommands.insertHTML(editor,tableHtml);setCursorStart(table.querySelector('td'));},addColumnLeft:editor=>{addColumn(editor,'before');},addColumnRight:editor=>{addColumn(editor,'after');},addRowAbove:editor=>{addRow(editor,'before');},addRowBelow:editor=>{addRow(editor,'after');},removeColumn:editor=>{getDeepRange(editor.editable,{select:true});const cell=getInSelection(editor.document,'td');if(!cell)return;const table=closestElement(cell,'table');const cells=[...closestElement(cell,'tr').querySelectorAll('th, td')];const index=cells.findIndex(td=>td===cell);const siblingCell=cells[index-1]||cells[index+1];table.querySelectorAll(`tr td:nth-of-type(${index + 1})`).forEach(td=>td.remove());siblingCell?setSelection(...startPos(siblingCell)):deleteTable(editor,table);},removeRow:editor=>{getDeepRange(editor.editable,{select:true});const row=getInSelection(editor.document,'tr');if(!row)return;const table=closestElement(row,'table');const rows=[...table.querySelectorAll('tr')];const rowIndex=rows.findIndex(tr=>tr===row);const siblingRow=rows[rowIndex-1]||rows[rowIndex+1];row.remove();siblingRow?setSelection(...startPos(siblingRow)):deleteTable(editor,table);},deleteTable:(editor,table)=>deleteTable(editor,table),insertHorizontalRule(editor){const selection=editor.document.getSelection();const range=selection.getRangeAt(0);const element=closestElement(range.startContainer,'P, PRE, H1, H2, H3, H4, H5, H6, BLOCKQUOTE',);if(element&&ancestors(element).includes(editor.editable)){element.before(editor.document.createElement('hr'));}},};return __exports;});;

/* /web_editor/static/lib/odoo-editor/src/commands/deleteBackward.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('@web_editor/../lib/odoo-editor/src/commands/deleteBackward',async function(require){'use strict';let __exports={};const{UNBREAKABLE_ROLLBACK_CODE,UNREMOVABLE_ROLLBACK_CODE}=require("@web_editor/../lib/odoo-editor/src/utils/constants");const{boundariesOut,childNodeIndex,CTGROUPS,CTYPES,DIRECTIONS,endPos,fillEmpty,getState,isBlock,isInPre,isUnremovable,isVisible,isVisibleStr,leftPos,moveNodes,nodeSize,prepareUpdate,setSelection,splitTextNode,isUnbreakable,isMediaElement,isVisibleEmpty,}=require("@web_editor/../lib/odoo-editor/src/utils/utils");Text.prototype.oDeleteBackward=function(offset,alreadyMoved=false){const parentNode=this.parentNode;if(!offset){HTMLElement.prototype.oDeleteBackward.call(this,offset,alreadyMoved);return;}
const firstSplitOffset=splitTextNode(this,offset-1);const secondSplitOffset=splitTextNode(parentNode.childNodes[firstSplitOffset],1);const middleNode=parentNode.childNodes[firstSplitOffset];const restore=prepareUpdate(parentNode,firstSplitOffset,parentNode,secondSplitOffset);const isSpace=!isVisibleStr(middleNode)&&!isInPre(middleNode);middleNode.remove();restore();if(isSpace&&getState(parentNode,firstSplitOffset,DIRECTIONS.LEFT).cType!==CTYPES.CONTENT){parentNode.oDeleteBackward(firstSplitOffset,alreadyMoved);return;}
fillEmpty(parentNode);setSelection(parentNode,firstSplitOffset);};HTMLElement.prototype.oDeleteBackward=function(offset,alreadyMoved=false){let moveDest;if(offset){const leftNode=this.childNodes[offset-1];if(isUnremovable(leftNode)){throw UNREMOVABLE_ROLLBACK_CODE;}
if(isMediaElement(leftNode)||(leftNode.getAttribute&&typeof leftNode.getAttribute('contenteditable')==='string'&&leftNode.getAttribute('contenteditable').toLowerCase()==='false')){leftNode.remove();return;}
if(leftNode.getAttribute&&leftNode.getAttribute('contenteditable')==='false'){leftNode.remove();return;}
if(!isBlock(leftNode)||isVisibleEmpty(leftNode)){leftNode.oDeleteBackward(nodeSize(leftNode),alreadyMoved);return;}
alreadyMoved=true;moveDest=endPos(leftNode);}else{if(isUnremovable(this)){throw UNREMOVABLE_ROLLBACK_CODE;}
const parentEl=this.parentNode;if(!isBlock(this)||isVisibleEmpty(this)){const parentOffset=childNodeIndex(this);if(!nodeSize(this)){const visible=isVisible(this);const restore=prepareUpdate(...boundariesOut(this));this.remove();restore();fillEmpty(parentEl);if(visible){setSelection(parentEl,parentOffset);return;}}
parentEl.oDeleteBackward(parentOffset,alreadyMoved);return;}
moveDest=leftPos(this);}
let node=this.childNodes[offset];let firstBlockIndex=offset;while(node&&!isBlock(node)){node=node.nextSibling;firstBlockIndex++;}
let[cursorNode,cursorOffset]=moveNodes(...moveDest,this,offset,firstBlockIndex);setSelection(cursorNode,cursorOffset);if(cursorNode.nodeType===Node.TEXT_NODE&&(cursorOffset===0||cursorOffset===cursorNode.length)){cursorOffset=childNodeIndex(cursorNode)+(cursorOffset===0?0:1);cursorNode=cursorNode.parentNode;}
if(cursorNode.nodeType!==Node.TEXT_NODE){const{cType}=getState(cursorNode,cursorOffset,DIRECTIONS.LEFT);if(cType&CTGROUPS.BLOCK&&(!alreadyMoved||cType===CTYPES.BLOCK_OUTSIDE)){cursorNode.oDeleteBackward(cursorOffset,alreadyMoved);}}};HTMLLIElement.prototype.oDeleteBackward=function(offset,alreadyMoved=false){if(offset>0||this.previousElementSibling){HTMLElement.prototype.oDeleteBackward.call(this,offset,alreadyMoved);return;}
this.oShiftTab(offset);};HTMLBRElement.prototype.oDeleteBackward=function(offset,alreadyMoved=false){const parentOffset=childNodeIndex(this);const rightState=getState(this.parentElement,parentOffset+1,DIRECTIONS.RIGHT).cType;if(rightState&CTYPES.BLOCK_INSIDE){this.parentElement.oDeleteBackward(parentOffset,alreadyMoved);}else{HTMLElement.prototype.oDeleteBackward.call(this,offset,alreadyMoved);}};return __exports;});;

/* /web_editor/static/lib/odoo-editor/src/commands/deleteForward.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('@web_editor/../lib/odoo-editor/src/commands/deleteForward',async function(require){'use strict';let __exports={};const{childNodeIndex,findNode,isContentTextNode,isVisibleEmpty,nodeSize,rightPos,getState,DIRECTIONS,CTYPES,leftPos,isFontAwesome,rightLeafOnlyNotBlockNotEditablePath,rightLeafOnlyPathNotBlockNotEditablePath,isNotEditableNode,}=require("@web_editor/../lib/odoo-editor/src/utils/utils");Text.prototype.oDeleteForward=function(offset){if(offset<this.length){this.oDeleteBackward(offset+1);}else{HTMLElement.prototype.oDeleteForward.call(this.parentNode,childNodeIndex(this)+1);}};HTMLElement.prototype.oDeleteForward=function(offset){const filterFunc=node=>isVisibleEmpty(node)||isContentTextNode(node)||isNotEditableNode(node);const firstLeafNode=findNode(rightLeafOnlyNotBlockNotEditablePath(this,offset),filterFunc);if(firstLeafNode&&(isFontAwesome(firstLeafNode)||isNotEditableNode(firstLeafNode))){firstLeafNode.remove();return;}
if(firstLeafNode&&(firstLeafNode.nodeName!=='BR'||getState(...rightPos(firstLeafNode),DIRECTIONS.RIGHT).cType!==CTYPES.BLOCK_INSIDE)){firstLeafNode.oDeleteBackward(Math.min(1,nodeSize(firstLeafNode)));return;}
const firstOutNode=findNode(rightLeafOnlyPathNotBlockNotEditablePath(...(firstLeafNode?rightPos(firstLeafNode):[this,offset]),),filterFunc,);if(firstOutNode){const[node,offset]=leftPos(firstOutNode);node.oDeleteBackward(offset);return;}};return __exports;});;

/* /web_editor/static/lib/odoo-editor/src/commands/enter.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('@web_editor/../lib/odoo-editor/src/commands/enter',async function(require){'use strict';let __exports={};const{UNBREAKABLE_ROLLBACK_CODE}=require("@web_editor/../lib/odoo-editor/src/utils/constants");const{childNodeIndex,clearEmpty,fillEmpty,isBlock,isUnbreakable,prepareUpdate,setCursorStart,setCursorEnd,setTagName,splitTextNode,toggleClass,isVisible,}=require("@web_editor/../lib/odoo-editor/src/utils/utils");Text.prototype.oEnter=function(offset){this.parentElement.oEnter(splitTextNode(this,offset),true);};HTMLElement.prototype.oEnter=function(offset,firstSplit=true){let didSplit=false;if(isUnbreakable(this)){throw UNBREAKABLE_ROLLBACK_CODE;}
let restore;if(firstSplit){restore=prepareUpdate(this,offset);}
const splitEl=this.cloneNode(false);while(offset<this.childNodes.length){splitEl.appendChild(this.childNodes[offset]);}
if(isBlock(this)||splitEl.hasChildNodes()){this.after(splitEl);if(isVisible(splitEl)){didSplit=true;}else{splitEl.remove();}}
if(!isBlock(this)||(this.nodeName!=='LI'&&this.closest('LI'))){if(this.parentElement){this.parentElement.oEnter(childNodeIndex(this)+1,!didSplit);}else{throw UNBREAKABLE_ROLLBACK_CODE;}}
if(firstSplit&&didSplit){restore();fillEmpty(clearEmpty(this));fillEmpty(splitEl);const focusToElement=splitEl.nodeType===Node.ELEMENT_NODE&&splitEl.tagName==='A'?clearEmpty(splitEl):splitEl;setCursorStart(focusToElement);}
return splitEl;};HTMLHeadingElement.prototype.oEnter=function(){const newEl=HTMLElement.prototype.oEnter.call(this,...arguments);if(!newEl.textContent){const node=setTagName(newEl,'P');setCursorStart(node);}};HTMLQuoteElement.prototype.oEnter=HTMLHeadingElement.prototype.oEnter;HTMLLIElement.prototype.oEnter=function(){if(this.textContent){const node=HTMLElement.prototype.oEnter.call(this,...arguments);if(node.classList.contains('o_checked')){toggleClass(node,'o_checked');}
return node;}
this.oShiftTab();};HTMLPreElement.prototype.oEnter=function(offset){if(offset<this.childNodes.length){const lineBreak=document.createElement('br');this.insertBefore(lineBreak,this.childNodes[offset]);setCursorEnd(lineBreak);}else{const node=document.createElement('p');this.parentNode.insertBefore(node,this.nextSibling);fillEmpty(node);setCursorStart(node);}};return __exports;});;

/* /web_editor/static/lib/odoo-editor/src/commands/shiftEnter.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('@web_editor/../lib/odoo-editor/src/commands/shiftEnter',async function(require){'use strict';let __exports={};const{CTYPES,DIRECTIONS,isFakeLineBreak,prepareUpdate,rightPos,setSelection,getState,leftPos,splitTextNode,}=require("@web_editor/../lib/odoo-editor/src/utils/utils");Text.prototype.oShiftEnter=function(offset){this.parentElement.oShiftEnter(splitTextNode(this,offset));};HTMLElement.prototype.oShiftEnter=function(offset){const restore=prepareUpdate(this,offset);const brEl=document.createElement('br');const brEls=[brEl];if(offset>=this.childNodes.length){this.appendChild(brEl);}else{this.insertBefore(brEl,this.childNodes[offset]);}
if(isFakeLineBreak(brEl)&&getState(...leftPos(brEl),DIRECTIONS.LEFT).cType!==CTYPES.BR){const brEl2=document.createElement('br');brEl.before(brEl2);brEls.unshift(brEl2);}
restore();for(const el of brEls){if(el.parentNode){setSelection(...rightPos(el));break;}}};return __exports;});;

/* /web_editor/static/lib/odoo-editor/src/commands/shiftTab.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('@web_editor/../lib/odoo-editor/src/commands/shiftTab',async function(require){'use strict';let __exports={};const{isUnbreakable,preserveCursor,toggleClass,isBlock,isVisible}=require("@web_editor/../lib/odoo-editor/src/utils/utils");Text.prototype.oShiftTab=function(){return this.parentElement.oShiftTab(0);};HTMLElement.prototype.oShiftTab=function(offset=undefined){if(!isUnbreakable(this)){return this.parentElement.oShiftTab(offset);}
return false;};HTMLLIElement.prototype.oShiftTab=function(){const li=this;if(li.nextElementSibling){const ul=li.parentElement.cloneNode(false);while(li.nextSibling){ul.append(li.nextSibling);}
if(li.parentNode.parentNode.tagName==='LI'){const lip=document.createElement('li');toggleClass(lip,'oe-nested');lip.append(ul);li.parentNode.parentNode.after(lip);}else{li.parentNode.after(ul);}}
const restoreCursor=preserveCursor(this.ownerDocument);if(li.parentNode.parentNode.tagName==='LI'){const ul=li.parentNode;const shouldRemoveParentLi=!li.previousElementSibling&&!ul.previousElementSibling;const toremove=shouldRemoveParentLi?ul.parentNode:null;ul.parentNode.after(li);if(toremove){if(toremove.classList.contains('oe-nested')){toremove.remove();}else{ul.remove();}}
restoreCursor();return li;}else{const ul=li.parentNode;let p;while(li.firstChild){if(isBlock(li.firstChild)){p=isVisible(p)&&ul.after(p)&&undefined;ul.after(li.firstChild);}else{p=p||document.createElement('P');p.append(li.firstChild);}}
if(isVisible(p))ul.after(p);restoreCursor(new Map([[li,ul.nextSibling]]));li.remove();if(!ul.firstElementChild){ul.remove();}}
return false;};return __exports;});;

/* /web_editor/static/lib/odoo-editor/src/commands/tab.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('@web_editor/../lib/odoo-editor/src/commands/tab',async function(require){'use strict';let __exports={};const{createList,getListMode,isBlock,preserveCursor,toggleClass}=require("@web_editor/../lib/odoo-editor/src/utils/utils");Text.prototype.oTab=function(){return this.parentElement.oTab(0);};HTMLElement.prototype.oTab=function(offset){if(!isBlock(this)){return this.parentElement.oTab(offset);}
return false;};HTMLLIElement.prototype.oTab=function(){const lip=document.createElement('li');const destul=(this.previousElementSibling&&this.previousElementSibling.querySelector('ol, ul'))||(this.nextElementSibling&&this.nextElementSibling.querySelector('ol, ul'))||this.closest('ul, ol');const ul=createList(getListMode(destul));lip.append(ul);const cr=preserveCursor(this.ownerDocument);toggleClass(lip,'oe-nested');this.before(lip);ul.append(this);cr();return true;};return __exports;});;

/* /web_editor/static/lib/odoo-editor/src/commands/toggleList.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('@web_editor/../lib/odoo-editor/src/commands/toggleList',async function(require){'use strict';let __exports={};const{childNodeIndex,getListMode,isBlock,preserveCursor,setTagName,toggleClass,insertListAfter,getAdjacents,}=require("@web_editor/../lib/odoo-editor/src/utils/utils");Text.prototype.oToggleList=function(offset,mode){this.parentElement.oToggleList(childNodeIndex(this),mode);};HTMLElement.prototype.oToggleList=function(offset,mode='UL'){if(!isBlock(this)){return this.parentElement.oToggleList(childNodeIndex(this));}
const inLI=this.closest('li');if(inLI){return inLI.oToggleList(0,mode);}
const restoreCursor=preserveCursor(this.ownerDocument);if(this.oid==='root'){const callingNode=this.childNodes[offset];const group=getAdjacents(callingNode,n=>!isBlock(n));insertListAfter(callingNode,mode,[group]);restoreCursor();}else{const list=insertListAfter(this,mode,[this]);restoreCursor(new Map([[this,list.firstElementChild]]));}};HTMLParagraphElement.prototype.oToggleList=function(offset,mode='UL'){const restoreCursor=preserveCursor(this.ownerDocument);const list=insertListAfter(this,mode,[[...this.childNodes]]);this.remove();restoreCursor(new Map([[this,list.firstChild]]));return true;};HTMLLIElement.prototype.oToggleList=function(offset,mode){const pnode=this.closest('ul, ol');if(!pnode)return;const restoreCursor=preserveCursor(this.ownerDocument);const listMode=getListMode(pnode)+mode;if(['OLCL','ULCL'].includes(listMode)){pnode.classList.add('o_checklist');for(let li=pnode.firstElementChild;li!==null;li=li.nextElementSibling){if(li.style.listStyle!='none'){li.style.listStyle=null;if(!li.style.all)li.removeAttribute('style');}}
setTagName(pnode,'UL');}else if(['CLOL','CLUL'].includes(listMode)){toggleClass(pnode,'o_checklist');setTagName(pnode,mode);}else if(['OLUL','ULOL'].includes(listMode)){setTagName(pnode,mode);}else{let node=this;while(node){node=node.oShiftTab(offset);}}
restoreCursor();return false;};HTMLTableCellElement.prototype.oToggleList=function(offset,mode){const restoreCursor=preserveCursor(this.ownerDocument);const callingNode=this.childNodes[offset];const group=getAdjacents(callingNode,n=>!isBlock(n));insertListAfter(callingNode,mode,[group]);restoreCursor();};return __exports;});;

/* /web_editor/static/src/js/wysiwyg/wysiwyg_utils.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('@web_editor/js/wysiwyg/wysiwyg_utils',async function(require){'use strict';let __exports={};const isImg=__exports.isImg=function isImg(node){return(node&&(node.nodeName==="IMG"||(node.className&&node.className.match(/(^|\s)(media_iframe_video|o_image|fa)(\s|$)/i))));}
return __exports;});;

/* /web_editor/static/src/js/wysiwyg/PeerToPeer.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('@web_editor/js/wysiwyg/PeerToPeer',async function(require){'use strict';let __exports={};const urlParams=new URLSearchParams(window.location.search);const collaborationDebug=urlParams.get('collaborationDebug');const COLLABORATION_LOCALSTORAGE_KEY='odoo_editor_collaboration_debug';if(typeof collaborationDebug==='string'){if(collaborationDebug==='false'){localStorage.removeItem(COLLABORATION_LOCALSTORAGE_KEY,urlParams.get('collaborationDebug'),);}else{localStorage.setItem(COLLABORATION_LOCALSTORAGE_KEY,urlParams.get('collaborationDebug'));}}
const debugValue=localStorage.getItem(COLLABORATION_LOCALSTORAGE_KEY);const debugShowLog=['','true','all'].includes(debugValue);const debugShowNotifications=debugValue==='all';const baseNotificationMethods={ptp_request:async function(notification){const{requestId,requestName,requestPayload,requestTransport}=notification.notificationPayload;this._onRequest(notification.fromClientId,requestId,requestName,requestPayload,requestTransport,);},ptp_request_result:function(notification){const{requestId,result}=notification.notificationPayload;if(this._pendingRequestResolver[requestId]){clearTimeout(this._pendingRequestResolver[requestId].rejectTimeout);this._pendingRequestResolver[requestId].resolve(result);delete this._pendingRequestResolver[requestId];}},ptp_join:async function(notification){this._createClient(notification.fromClientId);},rtc_signal_icecandidate:async function(notification){if(debugShowLog)console.log(`%creceive candidate`,'background: darkgreen; color: white;');const clientInfos=this.clientsInfos[notification.fromClientId];if(!clientInfos||!clientInfos.peerConnection||clientInfos.peerConnection.connectionState==='closed'){console.groupCollapsed('=== ERROR: Handle Ice Candidate from undefined|closed ===');console.trace(clientInfos);console.groupEnd();return;}
if(!clientInfos.peerConnection.remoteDescription){clientInfos.iceCandidateBuffer.push(notification.notificationPayload);}else{this._addIceCandidate(clientInfos,notification.notificationPayload);}},rtc_signal_description:async function(notification){const description=notification.notificationPayload;if(debugShowLog)
console.log(`%cdescription received:`,'background: blueviolet; color: white;',description,);const clientInfos=this.clientsInfos[notification.fromClientId]||this._createClient(notification.fromClientId);const pc=clientInfos.peerConnection;if(!pc||pc.connectionState==='closed'){if(debugShowLog){console.groupCollapsed('=== ERROR: handle offer ===');console.log('An offer has been received for a non-existent peer connection - client: '+
notification.fromClientId,);console.trace(pc.connectionState);console.groupEnd();}
return;}
if(pc.signalingState==='have-remote-offer'){return;}
const isPolite=(''+notification.fromClientId).localeCompare(''+this._currentClientId)===1;if(debugShowLog)
console.log(`%cisPolite: %c${isPolite}`,'background: deepskyblue;',`background:${isPolite ? 'green' : 'red'}`,);const isOfferRacing=description.type==='offer'&&(clientInfos.makingOffer||pc.signalingState!=='stable');if(isOfferRacing&&!isPolite){if(debugShowLog)
console.log(`%creturn because isOfferRacing && !isPolite. pc.signalingState: ${pc.signalingState}`,'background: red;',);return;}
if(debugShowLog)console.log(`%cisOfferRacing: ${isOfferRacing}`,'background: red;');if(isOfferRacing){if(debugShowLog)
console.log(`%c SETREMOTEDESCRIPTION 1`,'background: navy; color:white;');await Promise.all([pc.setLocalDescription({type:'rollback'}),pc.setRemoteDescription(description),]);}else{if(debugShowLog)
console.log(`%c SETREMOTEDESCRIPTION 2`,'background: navy; color:white;');await pc.setRemoteDescription(description);}
if(clientInfos.iceCandidateBuffer.length){for(const candidate of clientInfos.iceCandidateBuffer){await this._addIceCandidate(clientInfos,candidate);clientInfos.iceCandidateBuffer.splice(0);}}
if(description.type==='offer'){const answerDescription=await pc.createAnswer();await pc.setLocalDescription(answerDescription);this.notifyClient(notification.fromClientId,'rtc_signal_description',pc.localDescription,);}},};const PeerToPeer=__exports.PeerToPeer=class PeerToPeer{constructor(options){this.options=options;this._currentClientId=this.options.currentClientId;if(debugShowLog)
console.log(`%c currentClientId:${this._currentClientId}`,'background: blue; color: white;',);this.clientsInfos={};this._lastRequestId=-1;this._pendingRequestResolver={};}
getConnectedClientIds(){return Object.entries(this.clientsInfos).filter(([id,infos])=>infos.peerConnection.iceConnectionState==='connected'&&infos.dataChannel.readyState==='open',).map(([id])=>id);}
removeClient(clientId){if(debugShowLog)console.log(`%c REMOVE CLIENT ${clientId}`,'background: chocolate;');this.notifySelf('ptp_remove',clientId);const clientInfos=this.clientsInfos[clientId];if(!clientInfos)return;clearTimeout(clientInfos.fallbackTimeout);clearTimeout(clientInfos.zombieTimeout);clientInfos.dataChannel.close();clientInfos.peerConnection.close();delete this.clientsInfos[clientId];}
async closeAllConnections(){for(const clientId of Object.keys(this.clientsInfos)){this.notifyAllClients('ptp_disconnect');this.removeClient(clientId);}}
async notifyAllClients(notificationName,notificationPayload,{transport='server'}={}){const transportPayload={fromClientId:this._currentClientId,notificationName,notificationPayload,};if(transport==='server'){await this.options.broadcastAll(transportPayload);}else if(transport==='rtc'){for(const cliendId of Object.keys(this.clientsInfos)){this._channelNotify(cliendId,transportPayload);}}else{throw new Error(`Transport "${transport}" is not supported. Use "server" or "rtc" transport.`,);}}
notifyClient(clientId,notificationName,notificationPayload,{transport='server'}={}){if(debugShowNotifications){if(notificationName==='ptp_request_result'){console.log(`%c${Date.now()} - REQUEST RESULT SEND: %c${transport}:${
                        notificationPayload.requestId
                    }:${this._currentClientId.slice('-5')}:${clientId.slice('-5')}`,'color: #aaa;font-weight:bold;','color: #aaa;font-weight:normal',);}else if(notificationName==='ptp_request'){console.log(`%c${Date.now()} - REQUEST SEND: %c${transport}:${
                        notificationPayload.requestName
                    }|${notificationPayload.requestId}:${this._currentClientId.slice(
                        '-5',
                    )}:${clientId.slice('-5')}`,'color: #aaa;font-weight:bold;','color: #aaa;font-weight:normal',);}else{console.log(`%c${Date.now()} - NOTIFICATION SEND: %c${transport}:${notificationName}:${this._currentClientId.slice(
                        '-5',
                    )}:${clientId.slice('-5')}`,'color: #aaa;font-weight:bold;','color: #aaa;font-weight:normal',);}}
const transportPayload={fromClientId:this._currentClientId,toClientId:clientId,notificationName,notificationPayload,};if(transport==='server'){this.options.broadcastAll(transportPayload);}else if(transport==='rtc'){this._channelNotify(clientId,transportPayload);}else{throw new Error(`Transport "${transport}" is not supported. Use "server" or "rtc" transport.`,);}}
notifySelf(notificationName,notificationPayload){this.handleNotification({notificationName,notificationPayload});}
handleNotification(notification){const isInternalNotification=typeof notification.fromClientId==='undefined'&&typeof notification.toClientId==='undefined';if(isInternalNotification||(notification.fromClientId!==this._currentClientId&&!notification.toClientId)||notification.toClientId===this._currentClientId){if(debugShowNotifications){if(notification.notificationName==='ptp_request_result'){console.log(`%c${Date.now()} - REQUEST RESULT RECEIVE: %c${
                            notification.notificationPayload.requestId
                        }:${notification.fromClientId.slice('-5')}:${notification.toClientId.slice(
                            '-5',
                        )}`,'color: #aaa;font-weight:bold;','color: #aaa;font-weight:normal',);}else if(notification.notificationName==='ptp_request'){console.log(`%c${Date.now()} - REQUEST RECEIVE: %c${
                            notification.notificationPayload.requestName
                        }|${
                            notification.notificationPayload.requestId
                        }:${notification.fromClientId.slice('-5')}:${notification.toClientId.slice(
                            '-5',
                        )}`,'color: #aaa;font-weight:bold;','color: #aaa;font-weight:normal',);}else{console.log(`%c${Date.now()} - NOTIFICATION RECEIVE: %c${
                            notification.notificationName
                        }:${notification.fromClientId}:${notification.toClientId}`,'color: #aaa;font-weight:bold;','color: #aaa;font-weight:normal',);}}
const baseMethod=baseNotificationMethods[notification.notificationName];if(baseMethod){baseMethod.call(this,notification);}
if(this.options.onNotification){this.options.onNotification(notification);}}}
requestClient(clientId,requestName,requestPayload,{transport='server'}={}){return new Promise((resolve,reject)=>{const requestId=this._getRequestId();const rejectTimeout=setTimeout(()=>{reject('Request took too long (more than 10 seconds).');delete this._pendingRequestResolver[requestId];},10000);this._pendingRequestResolver[requestId]={resolve,rejectTimeout,};this.notifyClient(clientId,'ptp_request',{requestId,requestName,requestPayload,requestTransport:transport,},{transport},);});}
_createClient(clientId,{makeOffer=true}={}){if(debugShowLog)console.log('CREATE CONNECTION with client id:',clientId);this.clientsInfos[clientId]={makingOffer:false,iceCandidateBuffer:[],};const pc=new RTCPeerConnection(this.options.peerConnectionConfig);if(makeOffer){pc.onnegotiationneeded=async()=>{if(debugShowLog)
console.log(`%c NEGONATION NEEDED: ${pc.connectionState}`,'background: deeppink;',);try{this.clientsInfos[clientId].makingOffer=true;if(debugShowLog)
console.log(`%ccreating and sending an offer`,'background: darkmagenta; color: white;',);const offer=await pc.createOffer();if(pc.signalingState!=='stable'){return;}
await pc.setLocalDescription(offer);this.notifyClient(clientId,'rtc_signal_description',pc.localDescription);}catch(err){console.error(err);}finally{this.clientsInfos[clientId].makingOffer=false;}};}
pc.onicecandidate=async event=>{if(event.candidate){this.notifyClient(clientId,'rtc_signal_icecandidate',event.candidate);}};pc.oniceconnectionstatechange=async()=>{if(debugShowLog)console.log('ICE STATE UPDATE: '+pc.iceConnectionState);switch(pc.iceConnectionState){case'failed':case'closed':this.removeClient(clientId);break;case'disconnected':await this._recoverConnection(clientId,{delay:1000,reason:'ice connection disconnected',});break;}};pc.onconnectionstatechange=async()=>{if(debugShowLog)console.log('CONNECTION STATE UPDATE:'+pc.connectionState);switch(pc.connectionState){case'failed':case'closed':this.removeClient(clientId);break;case'disconnected':await this._recoverConnection(clientId,{delay:500,reason:'connection disconnected',});break;}};pc.onicecandidateerror=async error=>{if(debugShowLog){console.groupCollapsed('=== ERROR: onIceCandidate ===');console.log('connectionState: '+
pc.connectionState+' - iceState: '+
pc.iceConnectionState,);console.trace(error);console.groupEnd();}
this._recoverConnection(clientId,{delay:15000,reason:'ice candidate error'});};const dataChannel=pc.createDataChannel('notifications',{negotiated:true,id:1});let message=[];dataChannel.onmessage=event=>{if(event.data!=='-'){message.push(event.data);}else{this.handleNotification(JSON.parse(message.join('')));message=[];}};dataChannel.onopen=event=>{this.notifySelf('rtc_data_channel_open',{connectionClientId:clientId,});};this.clientsInfos[clientId].peerConnection=pc;this.clientsInfos[clientId].dataChannel=dataChannel;return this.clientsInfos[clientId];}
async _addIceCandidate(clientInfos,candidate){const rtcIceCandidate=new RTCIceCandidate(candidate);try{await clientInfos.peerConnection.addIceCandidate(rtcIceCandidate);}catch(error){console.groupCollapsed('=== ERROR: ADD ICE CANDIDATE ===');console.trace(error);console.groupEnd();}}
_channelNotify(clientId,transportPayload){const clientInfo=this.clientsInfos[clientId];const dataChannel=clientInfo&&clientInfo.dataChannel;if(!dataChannel||dataChannel.readyState!=='open'){if(clientInfo&&!clientInfo.zombieTimeout){if(debugShowLog)console.warn(`Impossible to communicate with client ${clientId}. The connection be killed in 10 seconds if the datachannel state has not changed.`,);this._killPotentialZombie(clientId);}}else{const str=JSON.stringify(transportPayload);const size=str.length;const maxStringLength=5000;let from=0;let to=maxStringLength;while(from<size){dataChannel.send(str.slice(from,to));from=to;to=to+=maxStringLength;}
dataChannel.send('-');}}
_getRequestId(){this._lastRequestId++;return this._lastRequestId;}
async _onRequest(fromClientId,requestId,requestName,requestPayload,requestTransport){const requestFunction=this.options.onRequest&&this.options.onRequest[requestName];const result=await requestFunction({fromClientId,requestId,requestName,requestPayload,});this.notifyClient(fromClientId,'ptp_request_result',{requestId,result},{transport:requestTransport},);}
_recoverConnection(clientId,{delay=0,reason=''}={}){const clientInfos=this.clientsInfos[clientId];if(!clientInfos||clientInfos.fallbackTimeout)return;clientInfos.fallbackTimeout=setTimeout(async()=>{clientInfos.fallbackTimeout=undefined;const pc=clientInfos.peerConnection;if(!pc||pc.iceConnectionState==='connected'){return;}
if(['connected','closed'].includes(pc.connectionState)){return;}
if(debugShowLog)
console.log(`%c RTC RECOVERY: calling back client ${clientId} to salvage the connection ${pc.iceConnectionState}, reason: ${reason}`,'background: darkorange; color: white;',);this.removeClient(clientId);await this._createClient(clientId);},delay);}
_killPotentialZombie(clientId){const clientInfos=this.clientsInfos[clientId];if(!clientInfos||clientInfos.zombieTimeout){return;}
clientInfos.zombieTimeout=setTimeout(()=>{if(clientInfos&&clientInfos.dataChannel.readyState!=='open'){if(debugShowLog)console.log(`%c KILL ZOMBIE ${clientId}`,'background: red;');this.removeClient(clientId);}else{if(debugShowLog)console.log(`%c NOT A ZOMBIE ${clientId}`,'background: green;');}},10000);}}
return __exports;});;

/* /web_editor/static/src/js/wysiwyg/fonts.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('wysiwyg.fonts',function(require){'use strict';return{cacheCssSelectors:{},getCssSelectors:function(filter){if(this.cacheCssSelectors[filter]){return this.cacheCssSelectors[filter];}
this.cacheCssSelectors[filter]=[];var sheets=document.styleSheets;for(var i=0;i<sheets.length;i++){var rules;try{rules=sheets[i].rules||sheets[i].cssRules;}catch(e){continue;}
if(!rules){continue;}
for(var r=0;r<rules.length;r++){var selectorText=rules[r].selectorText;if(!selectorText){continue;}
var selectors=selectorText.split(/\s*,\s*/);var data=null;for(var s=0;s<selectors.length;s++){var match=selectors[s].trim().match(filter);if(!match){continue;}
if(!data){data={selector:match[0],css:rules[r].cssText.replace(/(^.*\{\s*)|(\s*\}\s*$)/g,''),names:[match[1]]};}else{data.selector+=(', '+match[0]);data.names.push(match[1]);}}
if(data){this.cacheCssSelectors[filter].push(data);}}}
return this.cacheCssSelectors[filter];},fontIcons:[{base:'fa',parser:/\.(fa-(?:\w|-)+)::?before/i}],computeFonts:_.once(function(){var self=this;_.each(this.fontIcons,function(data){data.cssData=self.getCssSelectors(data.parser);data.alias=_.flatten(_.map(data.cssData,_.property('names')));});}),};});;

/* /web_editor/static/src/js/base.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('web_editor.base',function(require){'use strict';var ajax=require('web.ajax');var session=require('web.session');var domReady=new Promise(function(resolve){$(resolve);});return{cacheCssSelectors:{},getCssSelectors:function(filter){if(this.cacheCssSelectors[filter]){return this.cacheCssSelectors[filter];}
this.cacheCssSelectors[filter]=[];var sheets=document.styleSheets;for(var i=0;i<sheets.length;i++){var rules;try{rules=sheets[i].rules||sheets[i].cssRules;}catch(e){console.warn("Can't read the css rules of: "+sheets[i].href,e);continue;}
if(!rules){continue;}
for(var r=0;r<rules.length;r++){var selectorText=rules[r].selectorText;if(!selectorText){continue;}
var selectors=selectorText.split(/\s*,\s*/);var data=null;for(var s=0;s<selectors.length;s++){var match=selectors[s].trim().match(filter);if(!match){continue;}
if(!data){data={selector:match[0],css:rules[r].cssText.replace(/(^.*\{\s*)|(\s*\}\s*$)/g,''),names:[match[1]]};}else{data.selector+=(', '+match[0]);data.names.push(match[1]);}}
if(data){this.cacheCssSelectors[filter].push(data);}}}
return this.cacheCssSelectors[filter];},fontIcons:[{base:'fa',parser:/\.(fa-(?:\w|-)+)::?before/i}],computeFonts:_.once(function(){var self=this;_.each(this.fontIcons,function(data){data.cssData=self.getCssSelectors(data.parser);data.alias=_.flatten(_.map(data.cssData,_.property('names')));});}),ready:function(){return Promise.all([domReady,session.is_bound,ajax.loadXML()]);},};});odoo.define('web_editor.context',function(require){'use strict';function getContext(context){var html=document.documentElement;return _.extend({lang:(html.getAttribute('lang')||'en_US').replace('-','_'),'website_id':html.getAttribute('data-website-id')|0,},context||{});}
function getExtraContext(context){var html=document.documentElement;return _.extend(getContext(),{editable:!!(html.dataset.editable||$('[data-oe-model]').length),translatable:!!html.dataset.translatable,edit_translations:!!html.dataset.edit_translations,},context||{});}
return{get:getContext,getExtra:getExtraContext,};});odoo.define('web_editor.ready',function(require){'use strict';var base=require('web_editor.base');return base.ready();});;

/* /web_editor/static/src/js/editor/image_processing.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('web_editor.image_processing',function(require){'use strict';const cropperDataFields=['x','y','width','height','rotate','scaleX','scaleY'];const modifierFields=['filter','quality','mimetype','glFilter','originalId','originalSrc','resizeWidth','aspectRatio',];const _applyAll=(result,filter,filters)=>{filters.forEach(f=>{if(f[0]==='blend'){const cv=f[1];const ctx=result.getContext('2d');ctx.globalCompositeOperation=f[2];ctx.globalAlpha=f[3];ctx.drawImage(cv,0,0);ctx.globalCompositeOperation='source-over';ctx.globalAlpha=1.0;}else{filter.addFilter(...f);}});};let applyAll;const glFilters={blur:filter=>filter.addFilter('blur',10),'1977':(filter,cv)=>{const ctx=cv.getContext('2d');ctx.fillStyle='rgb(243, 106, 188)';ctx.fillRect(0,0,cv.width,cv.height);applyAll(filter,[['blend',cv,'screen',.3],['brightness',.1],['contrast',.1],['saturation',.3],]);},aden:(filter,cv)=>{const ctx=cv.getContext('2d');ctx.fillStyle='rgb(66, 10, 14)';ctx.fillRect(0,0,cv.width,cv.height);applyAll(filter,[['blend',cv,'darken',.2],['brightness',.2],['contrast',-.1],['saturation',-.15],['hue',20],]);},brannan:(filter,cv)=>{const ctx=cv.getContext('2d');ctx.fillStyle='rgb(161, 44, 191)';ctx.fillRect(0,0,cv.width,cv.height);applyAll(filter,[['blend',cv,'lighten',.31],['sepia',.5],['contrast',.4],]);},earlybird:(filter,cv)=>{const ctx=cv.getContext('2d');const gradient=ctx.createRadialGradient(cv.width/2,cv.height/2,0,cv.width/2,cv.height/2,Math.hypot(cv.width,cv.height)/2);gradient.addColorStop(.2,'#D0BA8E');gradient.addColorStop(1,'#1D0210');ctx.fillStyle=gradient;ctx.fillRect(0,0,cv.width,cv.height);applyAll(filter,[['blend',cv,'overlay',.2],['sepia',.2],['contrast',-.1],]);},inkwell:(filter,cv)=>{applyAll(filter,[['sepia',.3],['brightness',.1],['contrast',-.1],['desaturateLuminance'],]);},maven:(filter,cv)=>{applyAll(filter,[['sepia',.25],['brightness',-.05],['contrast',-.05],['saturation',.5],]);},toaster:(filter,cv)=>{const ctx=cv.getContext('2d');const gradient=ctx.createRadialGradient(cv.width/2,cv.height/2,0,cv.width/2,cv.height/2,Math.hypot(cv.width,cv.height)/2);gradient.addColorStop(0,'#0F4E80');gradient.addColorStop(1,'#3B003B');ctx.fillStyle=gradient;ctx.fillRect(0,0,cv.width,cv.height);applyAll(filter,[['blend',cv,'screen',.5],['brightness',-.1],['contrast',.5],]);},walden:(filter,cv)=>{const ctx=cv.getContext('2d');ctx.fillStyle='#CC4400';ctx.fillRect(0,0,cv.width,cv.height);applyAll(filter,[['blend',cv,'screen',.3],['sepia',.3],['brightness',.1],['saturation',.6],['hue',350],]);},valencia:(filter,cv)=>{const ctx=cv.getContext('2d');ctx.fillStyle='#3A0339';ctx.fillRect(0,0,cv.width,cv.height);applyAll(filter,[['blend',cv,'exclusion',.5],['sepia',.08],['brightness',.08],['contrast',.08],]);},xpro:(filter,cv)=>{const ctx=cv.getContext('2d');const gradient=ctx.createRadialGradient(cv.width/2,cv.height/2,0,cv.width/2,cv.height/2,Math.hypot(cv.width,cv.height)/2);gradient.addColorStop(.4,'#E0E7E6');gradient.addColorStop(1,'#2B2AA1');ctx.fillStyle=gradient;ctx.fillRect(0,0,cv.width,cv.height);applyAll(filter,[['blend',cv,'color-burn',.7],['sepia',.3],]);},custom:(filter,cv,filterOptions)=>{const options=Object.assign({blend:'normal',filterColor:'',blur:'0',desaturateLuminance:'0',saturation:'0',contrast:'0',brightness:'0',sepia:'0',},JSON.parse(filterOptions||"{}"));const filters=[];if(options.filterColor){const ctx=cv.getContext('2d');ctx.fillStyle=options.filterColor;ctx.fillRect(0,0,cv.width,cv.height);filters.push(['blend',cv,options.blend,1]);}
delete options.blend;delete options.filterColor;filters.push(...Object.entries(options).map(([filter,amount])=>[filter,parseInt(amount)/100]));applyAll(filter,filters);},};async function applyModifications(img,dataOptions={}){const data=Object.assign({glFilter:'',filter:'#0000',quality:'75',},img.dataset,dataOptions);let{width,height,resizeWidth,quality,filter,mimetype,originalSrc,glFilter,filterOptions,}=data;[width,height,resizeWidth]=[width,height,resizeWidth].map(s=>parseFloat(s));quality=parseInt(quality);const container=document.createElement('div');const original=await loadImage(originalSrc);container.appendChild(original);await activateCropper(original,0,data);const croppedImg=$(original).cropper('getCroppedCanvas',{width,height});$(original).cropper('destroy');const result=document.createElement('canvas');result.width=resizeWidth||croppedImg.width;result.height=croppedImg.height*result.width/croppedImg.width;const ctx=result.getContext('2d');ctx.drawImage(croppedImg,0,0,croppedImg.width,croppedImg.height,0,0,result.width,result.height);if(glFilter){const glf=new window.WebGLImageFilter();const cv=document.createElement('canvas');cv.width=result.width;cv.height=result.height;applyAll=_applyAll.bind(null,result);glFilters[glFilter](glf,cv,filterOptions);const filtered=glf.apply(result);ctx.drawImage(filtered,0,0,filtered.width,filtered.height,0,0,result.width,result.height);}
ctx.fillStyle=filter||'#0000';ctx.fillRect(0,0,result.width,result.height);return result.toDataURL(mimetype,quality/100);}
function loadImage(src,img=new Image()){return new Promise((resolve,reject)=>{img.addEventListener('load',()=>resolve(img),{once:true});img.addEventListener('error',reject,{once:true});img.src=src;});}
const imageCache=new Map();async function activateCropper(image,aspectRatio,dataset){const src=image.getAttribute('src');if(!imageCache.has(src)){const res=await fetch(src);imageCache.set(src,URL.createObjectURL(await res.blob()));}
image.src=imageCache.get(src);$(image).cropper({viewMode:2,dragMode:'move',autoCropArea:1.0,aspectRatio:aspectRatio,data:_.mapObject(_.pick(dataset,...cropperDataFields),value=>parseFloat(value)),minContainerWidth:1,minContainerHeight:1,});return new Promise(resolve=>image.addEventListener('ready',resolve,{once:true}));}
async function loadImageInfo(img,rpc,attachmentSrc=''){const src=attachmentSrc||img.getAttribute('src');if(img.dataset.originalSrc||!src){return;}
const{original}=await rpc({route:'/web_editor/get_image_info',params:{src:src.split(/[?#]/)[0]},});const isLocal=original&&new URL(original.image_src,window.location.origin).origin===window.location.origin;if(isLocal&&original.image_src){img.dataset.originalId=original.id;img.dataset.originalSrc=original.image_src;img.dataset.mimetype=original.mimetype;}}
function isImageSupportedForProcessing(mimetype){return['image/jpeg','image/png'].includes(mimetype);}
return{applyModifications,cropperDataFields,activateCropper,loadImageInfo,loadImage,removeOnImageChangeAttrs:[...cropperDataFields,...modifierFields,'aspectRatio'],isImageSupportedForProcessing,};});;

/* /web_editor/static/src/js/editor/custom_colors.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('web_editor.custom_colors',function(require){'use strict';return[['#000000','#424242','#636363','#9C9C94','#CEC6CE','#EFEFEF','#F7F7F7','#FFFFFF'],['#FF0000','#FF9C00','#FFFF00','#00FF00','#00FFFF','#0000FF','#9C00FF','#FF00FF'],['#F7C6CE','#FFE7CE','#FFEFC6','#D6EFD6','#CEDEE7','#CEE7F7','#D6D6E7','#E7D6DE'],['#E79C9C','#FFC69C','#FFE79C','#B5D6A5','#A5C6CE','#9CC6EF','#B5A5D6','#D6A5BD'],['#E76363','#F7AD6B','#FFD663','#94BD7B','#73A5AD','#6BADDE','#8C7BC6','#C67BA5'],['#CE0000','#E79439','#EFC631','#6BA54A','#4A7B8C','#3984C6','#634AA5','#A54A7B'],['#9C0000','#B56308','#BD9400','#397B21','#104A5A','#085294','#311873','#731842'],['#630000','#7B3900','#846300','#295218','#083139','#003163','#21104A','#4A1031']];});;

/* /web_editor/static/src/js/wysiwyg/widgets/alt_dialog.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('wysiwyg.widgets.AltDialog',function(require){'use strict';var core=require('web.core');var Dialog=require('wysiwyg.widgets.Dialog');var _t=core._t;var AltDialog=Dialog.extend({template:'wysiwyg.widgets.alt',xmlDependencies:Dialog.prototype.xmlDependencies.concat(['/web_editor/static/src/xml/wysiwyg.xml']),init:function(parent,options,media){options=options||{};this._super(parent,_.extend({},{title:_t("Change media description and tooltip")},options));this.media=media;var allEscQuots=/&quot;/g;this.alt=($(this.media).attr('alt')||"").replace(allEscQuots,'"');var title=$(this.media).attr('title')||$(this.media).data('original-title')||"";this.tag_title=(title).replace(allEscQuots,'"');},save:function(){var alt=this.$('#alt').val();var title=this.$('#title').val();var allNonEscQuots=/"/g;$(this.media).attr('alt',alt?alt.replace(allNonEscQuots,"&quot;"):null).attr('title',title?title.replace(allNonEscQuots,"&quot;"):null);$(this.media).trigger('content_changed');this.final_data=this.media;return this._super.apply(this,arguments);},});return AltDialog;});;

/* /web_editor/static/src/js/wysiwyg/widgets/color_palette.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('web_editor.ColorPalette',function(require){'use strict';const ajax=require('web.ajax');const core=require('web.core');const session=require('web.session');const{ColorpickerWidget}=require('web.Colorpicker');const Widget=require('web.Widget');const customColors=require('web_editor.custom_colors');const weUtils=require('web_editor.utils');const qweb=core.qweb;let colorpickerArch;const ColorPaletteWidget=Widget.extend({template:'web_editor.snippet.option.colorpicker',events:{'click .o_we_color_btn':'_onColorButtonClick','mouseenter .o_we_color_btn':'_onColorButtonEnter','mouseleave .o_we_color_btn':'_onColorButtonLeave','click .o_we_colorpicker_switch_pane_btn':'_onSwitchPaneButtonClick','click .o_custom_gradient_editor .o_custom_gradient_btn':'_onGradientCustomButtonClick','click .o_custom_gradient_editor':'_onPanelClick','change .o_custom_gradient_editor input[type="text"]':'_onGradientInputChange','keypress .o_custom_gradient_editor input[type="text"]':'_onGradientInputKeyPress','click .o_custom_gradient_editor we-button:not(.o_remove_color)':'_onGradientButtonClick','mouseenter .o_custom_gradient_editor we-button:not(.o_remove_color)':'_onGradientButtonEnter','mouseleave .o_custom_gradient_editor we-button:not(.o_remove_color)':'_onGradientButtonLeave','click .o_custom_gradient_scale':'_onGradientPreviewClick','click .o_custom_gradient_editor .o_remove_color':'_onGradientDeleteClick',},custom_events:{'colorpicker_select':'_onColorPickerSelect','colorpicker_preview':'_onColorPickerPreview',},init:function(parent,options){this._super.apply(this,arguments);this.style=window.getComputedStyle(document.documentElement);this.options=_.extend({selectedColor:false,resetButton:true,excluded:[],excludeSectionOf:null,$editable:$(),withCombinations:false,noTransparency:false,opacity:1,selectedTab:'theme-colors',withGradients:false,},options||{});this.selectedColor='';this.resetButton=this.options.resetButton;this.withCombinations=this.options.withCombinations;this.trigger_up('request_editable',{callback:val=>this.options.$editable=val});this.tabs=[{id:'theme-colors',pickers:['theme','common',],},{id:'custom-colors',pickers:['custom','transparent_grayscale','common_grays',],},{id:'gradients',pickers:this.options.withGradients?['predefined_gradients','custom_gradient',]:[],}];this.sections={};this.pickers={};},willStart:async function(){await this._super(...arguments);await ColorPaletteWidget.loadDependencies(this);},start:async function(){const res=this._super.apply(this,arguments);const switchPaneButtons=this.el.querySelectorAll('.o_we_colorpicker_switch_pane_btn');let colorpickerEl;if(colorpickerArch){colorpickerEl=$(colorpickerArch)[0];}else{colorpickerEl=document.createElement("colorpicker");const sectionEl=document.createElement('DIV');sectionEl.classList.add('o_colorpicker_section');sectionEl.dataset.name='common';colorpickerEl.appendChild(sectionEl);}
colorpickerEl.querySelectorAll('button').forEach(el=>el.classList.add('o_we_color_btn'));_.each(this.tabs,(tab,index)=>{const sectionEl=this.el.querySelector(`.o_colorpicker_sections[data-color-tab="${tab.id}"]`);let sectionIsEmpty=true;_.each(tab.pickers,pickerId=>{let pickerEl;switch(pickerId){case'common_grays':pickerEl=colorpickerEl.querySelector('[data-name="common"]').cloneNode(true);break;case'custom':pickerEl=document.createElement('DIV');pickerEl.classList.add("o_colorpicker_section");pickerEl.dataset.name='custom';break;default:pickerEl=colorpickerEl.querySelector(`[data-name="${pickerId}"]`);pickerEl=pickerEl&&pickerEl.cloneNode(true);}
if(pickerEl){sectionEl.appendChild(pickerEl);if(!this.options.excluded.includes(pickerId)){sectionIsEmpty=false;}
this.pickers[pickerId]=pickerEl;}});if(sectionIsEmpty){sectionEl.classList.add('d-none');switchPaneButtons[index].classList.add('d-none');if(this.options.selectedTab===tab.id){this.options.selectedTab=this.tabs[(index+1)%this.tabs.length].id;}}
this.sections[tab.id]=sectionEl;});if(this.options.withGradients&&this.options.opacity!==1){this.pickers['predefined_gradients'].querySelectorAll('button').forEach(elem=>{let gradient=elem.dataset.color;gradient=gradient.replaceAll(/rgba?(\(\s*\d+\s*,\s*\d+\s*,\s*\d+)(?:\s*,.+?)?\)/g,`rgba$1, ${this.options.opacity})`);elem.dataset.color=gradient.replaceAll(/\s+/g,'');});}
if(this.pickers['custom_gradient']){this.gradientColorPicker=new ColorpickerWidget(this,{stopClickPropagation:true,});await this.gradientColorPicker.appendTo(this.sections['gradients']);const editor=this.pickers['custom_gradient'];this.gradientEditorParts={'customButton':editor.querySelector('.o_custom_gradient_btn'),'customContent':editor.querySelector('.o_color_picker_inputs'),'linearButton':editor.querySelector('we-button[data-gradient-type="linear-gradient"]'),'angleRow':editor.querySelector('.o_angle_row'),'angle':editor.querySelector('input[data-name="angle"]'),'radialButton':editor.querySelector('we-button[data-gradient-type="radial-gradient"]'),'positionRow':editor.querySelector('.o_position_row'),'positionX':editor.querySelector('input[data-name="positionX"]'),'positionY':editor.querySelector('input[data-name="positionY"]'),'sizeRow':editor.querySelector('.o_size_row'),'scale':editor.querySelector('.o_custom_gradient_scale div'),'sliders':editor.querySelector('.o_slider_multi'),'deleteButton':editor.querySelector('.o_remove_color'),};const gradient=weUtils.isColorGradient(this.options.selectedColor)&&this.options.selectedColor;this._selectGradient(gradient);const resizeObserver=new window.ResizeObserver(()=>{this._adjustActiveSliderDelete();});resizeObserver.observe(this.gradientEditorParts.sliders);}
const selectedButtonIndex=this.tabs.map(tab=>tab.id).indexOf(this.options.selectedTab);this._selectTabFromButton(this.el.querySelectorAll('button')[selectedButtonIndex]);const visibleButtons=Array.from(switchPaneButtons).filter(button=>!button.classList.contains('d-none'));if(visibleButtons.length===1){visibleButtons[0].classList.add('d-none');}
_.each(this.options.excluded,exc=>{this.$('[data-name="'+exc+'"]').addClass('d-none');});if(this.options.excludeSectionOf){this.$('[data-name]:has([data-color="'+this.options.excludeSectionOf+'"])').addClass('d-none');}
this.el.querySelectorAll('.o_colorpicker_section').forEach(elem=>{$(elem).prepend('<div>'+(elem.dataset.display||'')+'</div>');});if(!this.options.excluded.includes('common')){customColors.forEach((colorRow,i)=>{if(i===0){return;}
const $div=$('<div/>',{class:'clearfix'}).appendTo(this.pickers['common']);colorRow.forEach(color=>{$div.append(this._createColorButton(color,['o_common_color']));});});}
const compatibilityColorNames=['primary','secondary','alpha','beta','gamma','delta','epsilon','success','info','warning','danger'];this.colorNames=[...compatibilityColorNames];this.colorToColorNames={};this.el.querySelectorAll('button[data-color]').forEach(elem=>{const colorName=elem.dataset.color;if(weUtils.isColorGradient(colorName)){return;}
const $color=$(elem);const isCCName=weUtils.isColorCombinationName(colorName);if(isCCName){$color.find('.o_we_cc_preview_wrapper').addClass(`o_cc o_cc${colorName}`);}else{$color.addClass(`bg-${colorName}`);}
this.colorNames.push(colorName);if(!isCCName&&!elem.classList.contains('d-none')){const color=weUtils.getCSSVariableValue(colorName,this.style);this.colorToColorNames[color]=colorName;}});if(this.options.selectedCC){this.selectedCC=this.options.selectedCC;}
if(this.options.selectedColor){let selectedColor=this.options.selectedColor;if(compatibilityColorNames.includes(selectedColor)){selectedColor=weUtils.getCSSVariableValue(selectedColor,this.style)||selectedColor;}
selectedColor=ColorpickerWidget.normalizeCSSColor(selectedColor);if(selectedColor!=='rgba(0, 0, 0, 0)'){this.selectedColor=this.colorToColorNames[selectedColor]||selectedColor;}}
this._buildCustomColors();this._markSelectedColor();if(!this.options.excluded.includes('custom')){let defaultColor=this.selectedColor;if(defaultColor&&!ColorpickerWidget.isCSSColor(defaultColor)){defaultColor=weUtils.getCSSVariableValue(defaultColor,this.style);}
if(!defaultColor&&this.options.opacity!==1){defaultColor='rgba(0, 0, 0, '+this.options.opacity+')';}
this.colorPicker=new ColorpickerWidget(this,{defaultColor:defaultColor,noTransparency:!!this.options.noTransparency,});await this.colorPicker.appendTo(this.sections['custom-colors']);}
return res;},getColorNames:function(){return this.colorNames;},getSelectedColors(){return{ccValue:this.selectedCC,color:this.selectedColor,};},setSelectedColor:function(ccValue,color,selectTab=true){if(color==='rgba(0, 0, 0, 0)'&&this.options.opacity!==1){color='rgba(0, 0, 0, '+this.options.opacity+')';}
this._selectColor({ccValue:ccValue,color:color,});if(selectTab){const selectedButtonIndex=this.tabs.map(tab=>tab.id).indexOf(this.options.selectedTab);this._selectTabFromButton(this.el.querySelectorAll('button')[selectedButtonIndex]);}},_buildCustomColors:function(){if(this.options.excluded.includes('custom')){return;}
this.el.querySelectorAll('.o_custom_color').forEach(el=>el.remove());const existingColors=new Set(Object.keys(this.colorToColorNames));this.trigger_up('get_custom_colors',{onSuccess:(colors)=>{colors.forEach(color=>{this._addCustomColor(existingColors,color);});},});weUtils.getCSSVariableValue('custom-colors',this.style).split(' ').forEach(v=>{const color=weUtils.getCSSVariableValue(v.substring(1,v.length-1),this.style);if(ColorpickerWidget.isCSSColor(color)){this._addCustomColor(existingColors,color);}});_.each(this.options.$editable.find('[style*="color"]'),el=>{for(const colorProp of['color','backgroundColor']){this._addCustomColor(existingColors,el.style[colorProp]);}});if(this.selectedColor){this._addCustomColor(existingColors,this.selectedColor);}},_addCustomColor:function(existingColors,color){if(!color){return;}
if(!ColorpickerWidget.isCSSColor(color)){color=weUtils.getCSSVariableValue(color,this.style);}
const normColor=ColorpickerWidget.normalizeCSSColor(color);if(!existingColors.has(normColor)){this._addCustomColorButton(normColor);existingColors.add(normColor);}},_addCustomColorButton:function(color,classes=[]){classes.push('o_custom_color');const $button=this._createColorButton(color,classes);return $button.appendTo(this.pickers['custom']);},_createColorButton:function(color,classes){return $('<button/>',{class:'o_we_color_btn '+classes.join(' '),style:'background-color:'+color+';',});},_getButtonInfo:function(buttonEl){const bgColor=buttonEl.style.backgroundColor;const value=buttonEl.dataset.color||(bgColor&&bgColor!=='initial'?ColorpickerWidget.normalizeCSSColor(bgColor):'')||'';const info={target:buttonEl,};if(!value){info.ccValue='';info.color='';}else if(weUtils.isColorCombinationName(value)){info.ccValue=value;}else{info.color=value;}
return info;},_selectColor:function(colorInfo,eventName){this.selectedCC=colorInfo.ccValue;this.selectedColor=colorInfo.color=this.colorToColorNames[colorInfo.color]||colorInfo.color;if(eventName){this.trigger_up(eventName,colorInfo);}
this._buildCustomColors();if(this.colorPicker){this.colorPicker.setSelectedColor(colorInfo.color);}
if(this.gradientColorPicker){const customGradient=weUtils.isColorGradient(colorInfo.color)?colorInfo.color:false;this._selectGradient(customGradient);}
this._markSelectedColor();},_selectGradient:function(gradient){const editor=this.gradientEditorParts;if(this.gradientColorPicker.$el){this.gradientColorPicker.do_hide();}
const colorSplits=[];if(gradient){gradient=gradient.toLowerCase();for(const entry of gradient.matchAll(/(#[0-9a-f]{6}|rgba?\(\s*[0-9]+\s*,\s*[0-9]+\s*,\s*[0-9]+\s*[,\s*[0-9.]*]?\s*\))\s*([[0-9]+%]?)/g)){colorSplits.push([entry[1],entry[2].replace('%','')]);}}
if(!gradient||colorSplits.length<2){$(editor.customContent).addClass('d-none');editor.customButton.style['background-image']='';editor.customButton.dataset.color=false;return;}
$(editor.customContent).removeClass('d-none');editor.customButton.style['background-image']=gradient;editor.customButton.dataset.color=gradient;const scaleGradient=gradient.replace(/[^,]+,/,'linear-gradient(90deg,');editor.scale.style['background-image']=scaleGradient;const isLinear=gradient.startsWith('linear-gradient(');let lastSliderPosition;const activeSlider=editor.sliders.querySelector('input.active');if(activeSlider){lastSliderPosition=activeSlider.value;}
let $lastSlider;editor.sliders.replaceChildren();for(const index in colorSplits){const colorSplit=colorSplits[index];let color=colorSplit[0];const position=colorSplit[1]||100*index/colorSplits.length;const $slider=this._createGradientSlider(position,color);if(position===lastSliderPosition){$lastSlider=$slider;}}
editor.deleteButton.classList.add('d-none');if(isLinear){editor.linearButton.classList.add('active');editor.radialButton.classList.remove('active');let angle=gradient.match(/([0-9]+)deg/);angle=angle?angle[1]:0;editor.angle.value=angle;}else{editor.linearButton.classList.remove('active');editor.radialButton.classList.add('active');const sizeMatch=gradient.match(/(closest|farthest)-(side|corner)/);const size=sizeMatch?sizeMatch[0]:'farthest-corner';const $buttons=$(editor.sizeRow).find('we-button');$buttons.removeClass('active');$(editor.sizeRow).find("we-button[data-gradient-size='"+size+"']").addClass('active');const position=gradient.match(/ at ([0-9]+)% ([0-9]+)%/)||['','50','50'];editor.positionX.value=position[1];editor.positionY.value=position[2];}
this._updateGradientVisibility(isLinear);this._activateGradientSlider($lastSlider||$(this.pickers['custom_gradient'].querySelector('.o_slider_multi input')));},_updateGradientVisibility:function(isLinear){const editor=this.gradientEditorParts;if(isLinear){editor.angleRow.classList.remove('d-none');editor.angleRow.classList.add('d-flex');editor.positionRow.classList.add('d-none');editor.positionRow.classList.remove('d-flex');editor.sizeRow.classList.add('d-none');editor.sizeRow.classList.remove('d-flex');}else{editor.angleRow.classList.add('d-none');editor.angleRow.classList.remove('d-flex');editor.positionRow.classList.remove('d-none');editor.positionRow.classList.add('d-flex');editor.sizeRow.classList.remove('d-none');editor.sizeRow.classList.add('d-flex');}},_opacifyColor:function(color){if(color.startsWith('rgba')){return color.replace('rgba','rgb').replace(/,\s*[0-9.]+\s*\)/,')');}
return color;},_createGradientSlider:function(position,color){const $slider=$('<input class="w-100" type="range" min="0" max="100"/>');$slider.attr('value',position);$slider.attr('data-color',color);$slider.css('color',this._opacifyColor(color));$slider.on('click',this._onGradientSliderClick.bind(this));$slider.appendTo(this.gradientEditorParts.sliders);this._sortGradientSliders();return $slider;},_activateGradientSlider:function($slider){const $sliders=$(this.gradientEditorParts.sliders).find('input');$sliders.removeClass('active');$slider.addClass('active');const color=$slider.data('color');this.gradientColorPicker.do_show();this.gradientColorPicker.setSelectedColor(color);this._sortGradientSliders();this._adjustActiveSliderDelete();},_adjustActiveSliderDelete:function(){const $sliders=$(this.gradientEditorParts.sliders).find('input');const $activeSlider=$(this.gradientEditorParts.sliders).find('input.active');if($sliders.length>2&&$activeSlider.length){this.gradientEditorParts.deleteButton.classList.remove('d-none');const sliderWidth=$activeSlider.width();const thumbWidth=12;const deleteWidth=$(this.gradientEditorParts.deleteButton).width();const pixelOffset=(sliderWidth-thumbWidth)*$activeSlider[0].value/100+(thumbWidth-deleteWidth)/2;this.gradientEditorParts.deleteButton.style['margin-left']=`${pixelOffset}px`;this.gradientEditorParts.deleteButton.style['margin-right']=`-${deleteWidth / 2}px`;}else{this.gradientEditorParts.deleteButton.classList.add('d-none');}},_sortGradientSliders:function(){const $sliderInputs=$(this.gradientEditorParts.sliders).find('input');for(const slider of $sliderInputs.sort((a,b)=>parseInt(a.value,10)-parseInt(b.value,10))){this.gradientEditorParts.sliders.appendChild(slider);}},_computeGradient:function(){const editor=this.gradientEditorParts;const $picker=$(this.pickers['custom_gradient']);const colors=[];for(const slider of $(editor.sliders).find('input')){const color=ColorpickerWidget.convertCSSColorToRgba($(slider).data('color'));const colorText=color.opacity!==100?`rgba(${color.red}, ${color.green}, ${color.blue}, ${color.opacity / 100})`:`rgb(${color.red}, ${color.green}, ${color.blue})`;const position=slider.value;colors.push(`${colorText} ${position}%`);}
const type=$picker.find('.o_type_row we-button.active').data('gradientType');const isLinear=type==='linear-gradient';let typeParam;if(isLinear){const angle=editor.angle.value||0;typeParam=`${angle}deg`;}else{const positionX=editor.positionX.value||50;const positionY=editor.positionY.value||50;const size=$picker.find('.o_size_row we-button.active').data('gradientSize');typeParam=`circle ${size} at ${positionX}% ${positionY}%`;}
return`${type}(${typeParam}, ${colors.join(', ')})`;},_updateGradient:function(isPreview){const gradient=this._computeGradient();if(weUtils.areCssValuesEqual(gradient,this.selectedColor)&&!isPreview){return;}
this.trigger_up(isPreview?'color_hover':'color_picked',Object.assign(this.getSelectedColors(),{color:gradient,target:this.colorPicker.el,}));},_markSelectedColor:function(){for(const buttonEl of this.el.querySelectorAll('button')){const value=buttonEl.dataset.color||buttonEl.style.backgroundColor;buttonEl.classList.toggle('selected',value&&(this.selectedCC===value||weUtils.areCssValuesEqual(this.selectedColor,value)));}},_selectTabFromButton(buttonEl){this.el.querySelectorAll('.o_we_colorpicker_switch_pane_btn').forEach(el=>{el.classList.remove('active');});buttonEl.classList.add('active');this.el.querySelectorAll('.o_colorpicker_sections').forEach(el=>{el.classList.toggle('d-none',el.dataset.colorTab!==buttonEl.dataset.target);});},_updateGradientColor(ev,isPreview){ev.stopPropagation();const $slider=$(this.gradientEditorParts.sliders).find('input.active');const color=ev.data.cssColor;if(!weUtils.areCssValuesEqual(color,$slider.data('color'))){const previousColor=$slider.data('color');$slider.data('color',color);this._updateGradient(isPreview);if(isPreview){$slider.data('color',previousColor);}}},_onColorButtonClick:function(ev){const buttonEl=ev.currentTarget;const colorInfo=Object.assign(this.getSelectedColors(),this._getButtonInfo(buttonEl));this._selectColor(colorInfo,'color_picked');},_onColorButtonEnter:function(ev){ev.stopPropagation();this.trigger_up('color_hover',Object.assign(this.getSelectedColors(),this._getButtonInfo(ev.currentTarget)));},_onColorButtonLeave:function(ev){ev.stopPropagation();this.trigger_up('color_leave',Object.assign(this.getSelectedColors(),{target:ev.target,}));},_onColorPickerPreview:function(ev){if(ev.target===this.gradientColorPicker){this._updateGradientColor(ev,true);}else{this.trigger_up('color_hover',Object.assign(this.getSelectedColors(),{color:ev.data.cssColor,target:this.colorPicker.el,}));}},_onColorPickerSelect:function(ev){if(ev.target===this.gradientColorPicker){this._updateGradientColor(ev);}else{this._selectColor(Object.assign(this.getSelectedColors(),{color:ev.data.cssColor,target:this.colorPicker.el,}),'custom_color_picked');}},_onSwitchPaneButtonClick(ev){ev.stopPropagation();this._selectTabFromButton(ev.currentTarget);},_onGradientSliderClick(ev){ev.stopPropagation();this._activateGradientSlider($(ev.target));this._updateGradient();},_onGradientPreviewClick(ev){ev.stopPropagation();const offset=ev.offsetX;const width=parseInt(window.getComputedStyle(ev.target).width,10);const position=100*offset/width;let previousColor;let nextColor;let previousPosition;let nextPosition;for(const slider of $(this.gradientEditorParts.sliders).find('input')){if(slider.value<position){previousColor=slider.dataset.color;previousPosition=slider.value;}else{nextColor=slider.dataset.color;nextPosition=slider.value;break;}}
let color;if(previousColor&&nextColor){previousColor=ColorpickerWidget.convertCSSColorToRgba(previousColor);nextColor=ColorpickerWidget.convertCSSColorToRgba(nextColor);const previousRatio=(nextPosition-position)/(nextPosition-previousPosition);const nextRatio=1-previousRatio;const red=Math.round(previousRatio*previousColor.red+nextRatio*nextColor.red);const green=Math.round(previousRatio*previousColor.green+nextRatio*nextColor.green);const blue=Math.round(previousRatio*previousColor.blue+nextRatio*nextColor.blue);const opacity=Math.round(previousRatio*previousColor.opacity+nextRatio*nextColor.opacity);color=`rgba(${red}, ${green}, ${blue}, ${opacity / 100})`;}else{color=nextColor||previousColor||'rgba(128, 128, 128, 0.5)';}
const $slider=this._createGradientSlider(position,color);this._activateGradientSlider($slider);this._updateGradient();},_onPanelClick(ev){ev.stopPropagation();},_onGradientInputChange(ev){this._updateGradient();},_onGradientInputKeyPress:function(ev){if(ev.charCode===$.ui.keyCode.ENTER){ev.preventDefault();this._onGradientInputChange();}},_onGradientButtonClick(ev){const $buttons=$(ev.target).closest('span').find('we-button');$buttons.removeClass('active');$(ev.target).closest('we-button').addClass('active');this._updateGradient();},_onGradientButtonEnter(ev){ev.stopPropagation();const $activeButton=$(ev.target).closest('span').find('we-button.active');const $buttons=$(ev.target).closest('span').find('we-button');$buttons.removeClass('active');$(ev.target).closest('we-button').addClass('active');this._updateGradient(true);$buttons.removeClass('active');$activeButton.addClass('active');},_onGradientButtonLeave(ev){ev.stopPropagation();this.trigger_up('color_leave',Object.assign(this.getSelectedColors(),{target:ev.target,}));},_onGradientCustomButtonClick(ev){let gradient=this.gradientEditorParts.customButton.style['backgroundImage'];if(!gradient){gradient=this.pickers['predefined_gradients'].querySelector('button').dataset.color;}
this._selectColor(Object.assign(this.getSelectedColors(),{color:gradient,target:this.gradientEditorParts.customButton,}),'custom_color_picked');this._updateGradient();},_onGradientDeleteClick(ev){ev.stopPropagation();const $activeSlider=$(this.pickers['custom_gradient'].querySelector('.o_slider_multi input.active'));$activeSlider.off();$activeSlider.remove();this.gradientEditorParts.deleteButton.classList.add('d-none');this.gradientEditorParts.deleteButton.classList.remove('active');this._updateGradient();this._activateGradientSlider($(this.pickers['custom_gradient'].querySelector('.o_slider_multi input')));},});let colorpickerTemplateProm;ColorPaletteWidget.loadDependencies=async function(rpcCapableObj){const proms=[ajax.loadXML('/web_editor/static/src/xml/snippets.xml',qweb)];if(!session.is_website_user){if(!colorpickerTemplateProm&&!colorpickerArch){colorpickerTemplateProm=rpcCapableObj._rpc({model:'ir.ui.view',method:'render_public_asset',args:['web_editor.colorpicker',{}],}).then(arch=>colorpickerArch=arch);}
proms.push(colorpickerTemplateProm);}
return Promise.all(proms);};return{ColorPaletteWidget:ColorPaletteWidget,};});;

/* /web_editor/static/src/js/wysiwyg/widgets/image_crop_widget.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('wysiwyg.widgets.ImageCropWidget',function(require){'use strict';const core=require('web.core');const Widget=require('web.Widget');const{applyModifications,cropperDataFields,activateCropper,loadImage,loadImageInfo}=require('web_editor.image_processing');const _t=core._t;const ImageCropWidget=Widget.extend({template:['wysiwyg.widgets.crop'],xmlDependencies:['/web_editor/static/src/xml/wysiwyg.xml'],events:{'click.crop_options [data-action]':'_onCropOptionClick','zoom':'_onCropZoom',},init(parent,media){this._super(...arguments);this.media=media;this.$media=$(media);this.document=media.ownerDocument;this.aspectRatios={"0/0":{label:_t("Flexible"),value:0},"16/9":{label:"16:9",value:16/9},"4/3":{label:"4:3",value:4/3},"1/1":{label:"1:1",value:1},"2/3":{label:"2:3",value:2/3},};const src=this.media.getAttribute('src');const data=Object.assign({},media.dataset);this.initialSrc=src;this.aspectRatio=data.aspectRatio||"0/0";this.mimetype=data.mimetype||src.endsWith('.png')?'image/png':'image/jpeg';},async willStart(){await this._super.apply(this,arguments);await loadImageInfo(this.media,this._rpc.bind(this));if(this.media.dataset.originalSrc){this.originalSrc=this.media.dataset.originalSrc;this.originalId=this.media.dataset.originalId;return;}
this.uncroppable=true;},async start(){if(this.uncroppable){this.displayNotification({type:'warning',title:_t("This image is an external image"),message:_t("This type of image is not supported for cropping.<br/>If you want to crop it, please first download it from the original source and upload it in Odoo."),});return this.destroy();}
const _super=this._super.bind(this);const $cropperWrapper=this.$('.o_we_cropper_wrapper');await loadImage(this.originalSrc,this.media);this.$cropperImage=this.$('.o_we_cropper_img');const cropperImage=this.$cropperImage[0];[cropperImage.style.width,cropperImage.style.height]=[this.$media.width()+'px',this.$media.height()+'px'];const offset=this.$media.offset();offset.left+=parseInt(this.$media.css('padding-left'));offset.top+=parseInt(this.$media.css('padding-right'));$cropperWrapper.offset(offset);await loadImage(this.originalSrc,cropperImage);await activateCropper(cropperImage,this.aspectRatios[this.aspectRatio].value,this.media.dataset);this._onDocumentMousedown=this._onDocumentMousedown.bind(this);this.document.addEventListener('mousedown',this._onDocumentMousedown,{capture:true});return _super(...arguments);},destroy(){if(this.$cropperImage){this.$cropperImage.cropper('destroy');this.document.removeEventListener('mousedown',this._onDocumentMousedown,{capture:true});}
this.media.setAttribute('src',this.initialSrc);this.$media.trigger('image_cropper_destroyed');return this._super(...arguments);},async reset(){if(this.$cropperImage){this.$cropperImage.cropper('reset');if(this.aspectRatio!=='0/0'){this.aspectRatio='0/0';this.$cropperImage.cropper('setAspectRatio',this.aspectRatios[this.aspectRatio].value);}
await this._save(false);}},async _save(cropped=true){this.media.classList.add('o_modified_image_to_save');[...cropperDataFields,'aspectRatio'].forEach(attr=>{delete this.media.dataset[attr];const value=this._getAttributeValue(attr);if(value){this.media.dataset[attr]=value;}});delete this.media.dataset.resizeWidth;this.initialSrc=await applyModifications(this.media);this.media.classList.toggle('o_we_image_cropped',cropped);this.$media.trigger('image_cropped');this.destroy();},_getAttributeValue(attr){if(cropperDataFields.includes(attr)){return this.$cropperImage.cropper('getData')[attr];}
return this[attr];},_resetCropBox(){this.$cropperImage.cropper('clear');this.$cropperImage.cropper('crop');},_onCropOptionClick(ev){const{action,value,scaleDirection}=ev.currentTarget.dataset;switch(action){case'ratio':this.$cropperImage.cropper('reset');this.aspectRatio=value;this.$cropperImage.cropper('setAspectRatio',this.aspectRatios[this.aspectRatio].value);break;case'zoom':case'reset':this.$cropperImage.cropper(action,value);break;case'rotate':this.$cropperImage.cropper(action,value);this._resetCropBox();break;case'flip':{const amount=this.$cropperImage.cropper('getData')[scaleDirection]*-1;return this.$cropperImage.cropper(scaleDirection,amount);}
case'apply':return this._save();case'discard':return this.destroy();}},_onDocumentMousedown(ev){if(document.body.contains(ev.target)&&this.$(ev.target).length===0){return this.destroy();}},async _onCropZoom(){await new Promise(res=>setTimeout(res,0));this._resetCropBox();},});return ImageCropWidget;});;

/* /web_editor/static/src/js/wysiwyg/widgets/link.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('wysiwyg.widgets.Link',function(require){'use strict';const core=require('web.core');const OdooEditorLib=require('@web_editor/../lib/odoo-editor/src/OdooEditor');const wysiwygUtils=require('@web_editor/js/wysiwyg/wysiwyg_utils');const Widget=require('web.Widget');const getDeepRange=OdooEditorLib.getDeepRange;const getInSelection=OdooEditorLib.getInSelection;const _t=core._t;const Link=Widget.extend({xmlDependencies:['/web_editor/static/src/xml/wysiwyg.xml'],events:{'input':'_onAnyChange','change':'_onAnyChange','input input[name="url"]':'_onURLInput',},init:function(parent,options,editable,data,$button,link){this.options=options||{};this._super(parent,_.extend({title:_t("Link to"),},this.options));this.data=data||{};this.isButton=this.data.isButton;this.$button=$button;this.data.className=this.data.className||"";this.data.iniClassName=this.data.iniClassName||"";this.needLabel=this.data.needLabel||false;this.colorsData=[{type:this.isButton?'link':'',label:_t("Link"),btnPreview:'link'},{type:'primary',label:_t("Primary"),btnPreview:'primary'},{type:'secondary',label:_t("Secondary"),btnPreview:'secondary'},{type:'custom',label:_t("Custom"),btnPreview:'custom'},];this.editable=editable;this.$editable=$(editable);if(link){const range=document.createRange();range.selectNodeContents(link);this.data.range=range;this.$link=$(link);this.linkEl=link;}else{const selection=editable&&editable.ownerDocument.getSelection();this.data.range=selection&&selection.rangeCount&&selection.getRangeAt(0);}
if(this.data.range){this.$link=this.$link||$(OdooEditorLib.getInSelection(this.editable.ownerDocument,'a'));this.linkEl=this.$link[0];this.data.iniClassName=this.$link.attr('class')||'';this.colorCombinationClass=false;let $node=this.$link;while($node.length&&!$node.is('body')){const className=$node.attr('class')||'';const m=className.match(/\b(o_cc\d+)\b/g);if(m){this.colorCombinationClass=m[0];break;}
$node=$node.parent();}
const linkNode=this.$link[0]||this.data.range.cloneContents();const linkText=linkNode.innerHTML||linkNode.textContent;this.data.content=linkText.replace(/[ \t\r\n]+/g,' ');this.data.originalText=this.data.content;this.data.url=this.$link.attr('href')||'';}else{this.data.content=this.data.content?this.data.content.replace(/[ \t\r\n]+/g,' '):'';}
if(this.linkEl){this.data.isNewWindow=this.data.isNewWindow||this.linkEl.target==='_blank';}
const allBtnClassSuffixes=/(^|\s+)btn(-[a-z0-9_-]*)?/gi;const allBtnShapes=/\s*(rounded-circle|flat)\s*/gi;this.data.className=this.data.iniClassName.replace(allBtnClassSuffixes,' ').replace(allBtnShapes,' ');if(/(?:s_website_form_send|o_submit)/.test(this.data.className)){this.isButton=true;}},start:function(){for(const option of this._getLinkOptions()){const $option=$(option);const value=$option.is('input')?$option.val():$option.data('value');let active=false;if(value){const subValues=value.split(',');let subActive=true;for(let subValue of subValues){const classPrefix=new RegExp('(^|btn-| |btn-outline-|btn-fill-)'+subValue);subActive=subActive&&classPrefix.test(this.data.iniClassName);}
active=subActive;}else{active=!this.data.iniClassName||this.data.iniClassName.includes('btn-link')||!this.data.iniClassName.includes('btn-');}
this._setSelectOption($option,active);}
if(this.data.url){var match=/mailto:(.+)/.exec(this.data.url);this.$('input[name="url"]').val(match?match[1]:this.data.url);this._onURLInput();}
this._updateOptionsUI();this._adaptPreview();if(!this.options.noFocusUrl){setTimeout(()=>{const firstInput=this.$('input:visible:first');firstInput.focus();firstInput.select();},0);}
return this._super.apply(this,arguments);},applyLinkToDom:function(data){if(!data.classes.includes('btn')&&this.data.iniClassName.includes("btn-link")){data.classes+=" btn btn-link";}
if(!['btn-custom','btn-outline-custom','btn-fill-custom'].some(className=>data.classes.includes(className))){this.$link.css('color','');this.$link.css('background-color','');this.$link.css('background-image','');this.$link.css('border-width','');this.$link.css('border-style','');this.$link.css('border-color','');}
const attrs=Object.assign({},this.data.oldAttributes,{href:data.url,target:data.isNewWindow?'_blank':'',});if(data.classes){attrs.class=`${data.classes}`;}
if(data.rel){attrs.rel=`${data.rel}`;}
this.$link.attr(attrs);if(!this.$link.attr('target')){this.$link[0].removeAttribute('target');}
if(data.content!==this.data.originalText||data.url!==this.data.url){const content=(data.content&&data.content.length)?data.content:data.url;if(this.data.originalText){this.$link.html(content);}else{this.$link.text(content);}}},getOrCreateLink:function(editable){const doc=editable.ownerDocument;this.needLabel=this.needLabel||false;let link=getInSelection(doc,'a');const $link=$(link);const range=getDeepRange(editable,{splitText:true,select:true,correctTripleClick:true});if(link&&(!$link.has(range.startContainer).length||!$link.has(range.endContainer).length)){let before=link.previousSibling;while(before!==null&&range.intersectsNode(before)){link.insertBefore(before,link.firstChild);before=link.previousSibling;}
let after=link.nextSibling;while(after!==null&&range.intersectsNode(after)){link.appendChild(after);after=link.nextSibling;}}else if(!link){link=document.createElement('a');if(range.collapsed){range.insertNode(link);this.needLabel=true;}else{link.appendChild(range.extractContents());range.insertNode(link);}}
return link;},_adaptPreview:function(){},_correctLink:function(url){if(url.indexOf('mailto:')===0||url.indexOf('tel:')===0){url=url.replace(/^tel:([0-9]+)$/,'tel://$1');}else if(url.indexOf('@')!==-1&&url.indexOf(':')===-1){url='mailto:'+url;}else if(url.indexOf('://')===-1&&url[0]!=='/'&&url[0]!=='#'&&url.slice(0,2)!=='${'){url='http://'+url;}
return url;},_doStripDomain:function(){},_getData:function(){var $url=this.$('input[name="url"]');var url=$url.val();var content=this.$('input[name="label"]').val()||url;if(!this.isButton&&$url.prop('required')&&(!url||!$url[0].checkValidity())){return null;}
const type=this._getLinkType();const customTextColor=this._getLinkCustomTextColor();const customFill=this._getLinkCustomFill();const customBorder=this._getLinkCustomBorder();const customBorderWidth=this._getLinkCustomBorderWidth();const customBorderStyle=this._getLinkCustomBorderStyle();const size=this._getLinkSize();const shape=this._getLinkShape();const shapes=shape?shape.split(','):[];const style=['outline','fill'].includes(shapes[0])?`${shapes[0]}-`:'';const shapeClasses=shapes.slice(style?1:0).join(' ');const classes=(this.data.className||'')+
(type?(` btn btn-${style}${type}`):'')+
(type&&shapeClasses?(` ${shapeClasses}`):'')+
(type&&size?(' btn-'+size):'');var isNewWindow=this._isNewWindow(url);var doStripDomain=this._doStripDomain();if(url.indexOf('@')>=0&&url.indexOf('mailto:')<0&&!url.match(/^http[s]?/i)){url=('mailto:'+url);}else if(url.indexOf(location.origin)===0&&doStripDomain){url=url.slice(location.origin.length);}
var allWhitespace=/\s+/gi;var allStartAndEndSpace=/^\s+|\s+$/gi;return{content:content,url:this._correctLink(url),classes:classes.replace(allWhitespace,' ').replace(allStartAndEndSpace,''),customTextColor:customTextColor,customFill:customFill,customBorder:customBorder,customBorderWidth:customBorderWidth,customBorderStyle:customBorderStyle,oldAttributes:this.data.oldAttributes,isNewWindow:isNewWindow,doStripDomain:doStripDomain,};},_getDescendants:function(rootNode){const nodes=[];for(const node of rootNode.childNodes){nodes.push(node);nodes.push(...this._getDescendants(node));}
return nodes;},_getLinkOptions:function(){},_getLinkShape:function(){},_getLinkSize:function(){},_getLinkType:function(){},_getLinkCustomTextColor:function(){},_getLinkCustomBorder:function(){},_getLinkCustomBorderWidth:function(){},_getLinkCustomBorderStyle:function(){},_getLinkCustomFill:function(){},_isNewWindow:function(url){},_setSelectOption:function($option,active){},_updateOptionsUI:function(){},_onAnyChange:function(){this._adaptPreview();},_onURLInput:function(){var $linkUrlInput=this.$('#o_link_dialog_url_input');let value=$linkUrlInput.val();let isLink=value.indexOf('@')<0;this.$('input[name="is_new_window"]').closest('.form-group').toggleClass('d-none',!isLink);this.$('.o_strip_domain').toggleClass('d-none',value.indexOf(window.location.origin)!==0);},});return Link;});;

/* /web_editor/static/src/js/wysiwyg/widgets/link_dialog.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('wysiwyg.widgets.LinkDialog',function(require){'use strict';const Dialog=require('wysiwyg.widgets.Dialog');const Link=require('wysiwyg.widgets.Link');const _DialogLinkWidget=Link.extend({template:'wysiwyg.widgets.link',events:_.extend({},Link.prototype.events||{},{'change [name="link_style_color"]':'_onTypeChange',}),start:function(){this.buttonOptsCollapseEl=this.el.querySelector('#o_link_dialog_button_opts_collapse');this.$styleInputs=this.$('input.link-style');this.$styleInputs.prop('checked',false).filter('[value=""]').prop('checked',true);if(this.data.isNewWindow){this.$('we-button.o_we_checkbox_wrapper').toggleClass('active',true);}
return this._super.apply(this,arguments);},save:function(){var data=this._getData();if(data===null){var $url=this.$('input[name="url"]');$url.closest('.form-group').addClass('o_has_error').find('.form-control, .custom-select').addClass('is-invalid');$url.focus();return Promise.reject();}
this.data.content=data.content;this.data.url=data.url;var allWhitespace=/\s+/gi;var allStartAndEndSpace=/^\s+|\s+$/gi;var allBtnTypes=/(^|[ ])(btn-secondary|btn-success|btn-primary|btn-info|btn-warning|btn-danger)([ ]|$)/gi;this.data.classes=data.classes.replace(allWhitespace,' ').replace(allStartAndEndSpace,'');if(data.classes.replace(allBtnTypes,' ')){this.data.style={'background-color':'','color':'',};}
this.data.isNewWindow=data.isNewWindow;this.final_data=this.data;},_adaptPreview:function(){var data=this._getData();if(data===null){return;}
const attrs={target:'_blank',href:data.url&&data.url.length?data.url:'#',class:`${data.classes.replace(/float-\w+/, '')} o_btn_preview`,};this.$("#link-preview").attr(attrs).html((data.content&&data.content.length)?data.content:data.url);},_doStripDomain:function(){return this.$('#o_link_dialog_url_strip_domain').prop('checked');},_getLinkOptions:function(){const options=['input[name="link_style_color"]','select[name="link_style_size"] > option','select[name="link_style_shape"] > option',];return this.$(options.join(','));},_getLinkShape:function(){return this.$('select[name="link_style_shape"]').val()||'';},_getLinkSize:function(){return this.$('select[name="link_style_size"]').val()||'';},_getLinkType:function(){return this.$('input[name="link_style_color"]:checked').val()||'';},_isFromAnotherHostName:function(url){if(url.includes(window.location.hostname)){return false;}
try{const Url=URL||window.URL||window.webkitURL;const urlObj=url.startsWith('/')?new Url(url,window.location.origin):new Url(url);return(urlObj.origin!==window.location.origin);}catch(ignored){return true;}},_isNewWindow:function(url){if(this.options.forceNewWindow){return this._isFromAnotherHostName(url);}else{return this.$('input[name="is_new_window"]').prop('checked');}},_setSelectOption:function($option,active){if($option.is("input")){$option.prop("checked",active);}else if(active){$option.parent().find('option').removeAttr('selected').removeProp('selected');$option.parent().val($option.val());$option.attr('selected','selected').prop('selected','selected');}},_updateOptionsUI:function(){const el=this.el.querySelector('[name="link_style_color"]:checked');$(this.buttonOptsCollapseEl).collapse(el&&el.value?'show':'hide');},_onTypeChange(){this._updateOptionsUI();},_onURLInput:function(){this._super(...arguments);this.$('#o_link_dialog_url_input').closest('.form-group').removeClass('o_has_error').find('.form-control, .custom-select').removeClass('is-invalid');},});const LinkDialog=Dialog.extend({init:function(parent,...args){this._super(...arguments);this.linkWidget=new _DialogLinkWidget(this,...args);},start:async function(){const res=await this._super(...arguments);await this.linkWidget.appendTo(this.$el);return res;},save:function(){this.linkWidget.save();this.final_data=this.linkWidget.final_data;return this._super(...arguments);},});return LinkDialog;});;

/* /web_editor/static/src/js/wysiwyg/widgets/link_popover_widget.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('@web_editor/js/wysiwyg/widgets/link_popover_widget',async function(require){'use strict';let __exports={};const Widget=require('web.Widget');const{_t}=require('web.core');const{DropPrevious}=require('web.concurrency');const LinkPopoverWidget=Widget.extend({template:'wysiwyg.widgets.link.edit.tooltip',xmlDependencies:['/web_editor/static/src/xml/wysiwyg.xml'],events:{'click .o_we_remove_link':'_onRemoveLinkClick','click .o_we_edit_link':'_onEditLinkClick',},init(parent,target){this._super(...arguments);this.target=target;this.$target=$(target);this.href=this.$target.attr('href');this._dp=new DropPrevious();},start(){this.$urlLink=this.$('.o_we_url_link');this.$previewFaviconImg=this.$('.o_we_preview_favicon img');this.$previewFaviconFa=this.$('.o_we_preview_favicon .fa');this.$copyLink=this.$('.o_we_copy_link');this.$fullUrl=this.$('.o_we_full_url');const clipboard=new ClipboardJS(this.$copyLink[0],{text:()=>this.target.href});clipboard.on('success',()=>{this.$copyLink.tooltip('hide');this.displayNotification({type:'success',message:_t("Link copied to clipboard."),});});this.$('[data-toggle="tooltip"]').tooltip({delay:0,placement:'bottom'});this.$target.popover({html:true,content:this.$el,placement:'bottom',trigger:'focus',boundary:'viewport',}).on('show.bs.popover.link_popover',()=>{this._loadAsyncLinkPreview();}).popover('show').data('bs.popover').tip.classList.add('o_edit_menu_popover');return this._super(...arguments);},destroy(){this.$target.off('.link_popover');this.$target.popover('dispose');return this._super(...arguments);},async _loadAsyncLinkPreview(){let url;try{url=new URL(this.target.href);}catch(e){this.displayNotification({type:'danger',message:_t("This URL is invalid. Preview couldn't be updated."),});return;}
this._resetPreview(url);const protocol=url.protocol;if(!protocol.startsWith('http')){const faMap={'mailto:':'fa-envelope-o','tel:':'fa-phone'};const icon=faMap[protocol];if(icon){this.$previewFaviconFa.toggleClass(`fa-globe ${icon}`);}}else if(window.location.hostname!==url.hostname){this.$previewFaviconImg.attr({'src':`https://www.google.com/s2/favicons?sz=16&domain=${url}`}).removeClass('d-none');this.$previewFaviconFa.addClass('d-none');}else{await this._dp.add($.get(this.target.href)).then(content=>{const parser=new window.DOMParser();const doc=parser.parseFromString(content,"text/html");const favicon=doc.querySelector("link[rel~='icon']");const ogTitle=doc.querySelector("[property='og:title']");const title=doc.querySelector("title");if(favicon){this.$previewFaviconImg.attr({'src':favicon.href}).removeClass('d-none');this.$previewFaviconFa.addClass('d-none');}
if(ogTitle||title){this.$urlLink.text(ogTitle?ogTitle.getAttribute('content'):title.text.trim());}
this.$fullUrl.removeClass('d-none').addClass('o_we_webkit_box');this.$target.popover('update');});}},_resetPreview(url){this.$previewFaviconImg.addClass('d-none');this.$previewFaviconFa.removeClass('d-none').addClass('fa-globe');this.$urlLink.text(url).attr('href',url);this.$fullUrl.text(url).addClass('d-none').removeClass('o_we_webkit_box');},_onEditLinkClick(ev){$('#wrapwrap').data('wysiwyg').toggleLinkTools({forceOpen:true,link:this.$target[0],});ev.stopImmediatePropagation();},_onRemoveLinkClick(ev){$('#wrapwrap').data('wysiwyg').odooEditor.execCommand('unlink');ev.stopImmediatePropagation();},});LinkPopoverWidget.createFor=async function(parent,targetEl){const noLinkPopoverClass=".o_no_link_popover, .carousel-control-prev, .carousel-control-next, .dropdown-toggle";const alreadyPopover=$(targetEl).data('bs.popover');if(alreadyPopover||$(targetEl).is(noLinkPopoverClass)||!!$(targetEl).parents(noLinkPopoverClass).length){return null;}
const popoverWidget=new this(parent,targetEl);return popoverWidget.appendTo(targetEl).then(()=>popoverWidget);};__exports[Symbol.for("default")]=LinkPopoverWidget;return __exports;});;

/* /web_editor/static/src/js/wysiwyg/widgets/link_tools.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('wysiwyg.widgets.LinkTools',function(require){'use strict';const Link=require('wysiwyg.widgets.Link');const{ColorPaletteWidget}=require('web_editor.ColorPalette');const OdooEditorLib=require('@web_editor/../lib/odoo-editor/src/OdooEditor');const dom=require('web.dom');const{getNumericAndUnit,isColorGradient}=require('web_editor.utils');const setSelection=OdooEditorLib.setSelection;const LinkTools=Link.extend({template:'wysiwyg.widgets.linkTools',events:_.extend({},Link.prototype.events,{'click we-select we-button':'_onPickSelectOption','click we-checkbox':'_onClickCheckbox','click .link-custom-color span[data-toggle]':'_onClickCustomColor','change .link-custom-color-border input':'_onChangeCustomBorderWidth','keypress .link-custom-color-border input':'_onKeyPressCustomBorderWidth','click we-select [name="link_border_style"] we-button':'_onBorderStyleSelectOption',}),init:function(parent,options,editable,data,$button,node){if(node&&!$(node).is('a')){$(node).wrap('<a href="#"/>');node=node.parentElement;}
const link=node||this.getOrCreateLink(editable);this._super(parent,options,editable,data,$button,link);this.colorpickers={};},start:function(){this.options.wysiwyg.odooEditor.observerUnactive();this.$link.addClass('oe_edited_link');this.$button.addClass('active');return this._super(...arguments).then(()=>{if(!this.options.noFocusUrl){dom.scrollTo(this.$(':visible:last')[0],{duration:0});}});},destroy:function(){if(!this.el){return this._super(...arguments);}
$('.oe_edited_link').removeClass('oe_edited_link');const $contents=this.$link.contents();if(!this.$link.attr('href')&&!this.colorCombinationClass){$contents.unwrap();}
this.$button.removeClass('active');this.options.wysiwyg.odooEditor.observerActive();this.applyLinkToDom(this._getData());setSelection(this.$link[0],0,this.$link[0],1);this.options.wysiwyg.odooEditor.historyStep();this._super(...arguments);},_adaptPreview:function(){var data=this._getData();if(data===null){return;}
data.classes+=' oe_edited_link';this.applyLinkToDom(data);},_doStripDomain:function(){return this.$('we-checkbox[name="do_strip_domain"]').closest('we-button.o_we_checkbox_wrapper').hasClass('active');},_getLinkOptions:function(){const options=['we-selection-items[name="link_style_color"] > we-button','we-selection-items[name="link_style_size"] > we-button','we-selection-items[name="link_style_shape"] > we-button',];return this.$(options.join(','));},_getLinkShape:function(){return this.$('we-selection-items[name="link_style_shape"] we-button.active').data('value')||'';},_getLinkSize:function(){return this.$('we-selection-items[name="link_style_size"] we-button.active').data('value')||'';},_getLinkType:function(){return this.$('we-selection-items[name="link_style_color"] we-button.active').data('value')||'';},_getLinkCustomTextColor:function(){return this.$('we-selection-items[name="link-custom-color-text"] .o_we_color_preview').css('background-color')||'';},_getLinkCustomBorder:function(){return this.$('we-selection-items[name="link_border_color"] .o_we_color_preview').css('background-color')||'';},_getLinkCustomBorderWidth:function(){return this.$('we-selection-items[name="link_border_color"] input').val()||'';},_getLinkCustomBorderStyle:function(){return this.$('we-selection-items[name="link_border_style"] we-button.active').data('value')||'';},_getLinkCustomFill:function(){const $colorPreview=this.$('we-selection-items[name="link-custom-color-fill"] .o_we_color_preview');return $colorPreview.css('background-image')||$colorPreview.css('background-color')||'';},_isNewWindow:function(){return this.$('we-checkbox[name="is_new_window"]').closest('we-button.o_we_checkbox_wrapper').hasClass('active');},_setSelectOption:function($option,active){$option.toggleClass('active',active);if(active){$option.closest('we-select').find('we-toggler').text($option.text());$option.siblings('we-button').removeClass("active");}},_updateOptionsUI:function(){const el=this.el.querySelector('[name="link_style_color"] we-button.active');if(el){this.colorCombinationClass=el.dataset.value;this.$('.link-size-row, .link-shape-row').toggleClass('d-none',!this.colorCombinationClass);this.$('.link-custom-color').toggleClass('d-none',el.dataset.value!=='custom');if(el.dataset.value==='custom'){const textColor=this.$link[0].style['color'];this.$('.link-custom-color-text .o_we_color_preview').css('background-color',textColor);if(this.colorpickers['color']&&textColor&&textColor!=='false'){this.colorpickers['color'].setSelectedColor(null,textColor,false);}
const backgroundColor=this.$link[0].style['background-color'];this.$('.link-custom-color-fill .o_we_color_preview').css('background-color',backgroundColor);const backgroundImage=this.$link[0].style['background-image'];this.$('.link-custom-color-fill .o_we_color_preview').css('background-image',backgroundImage);const backgroundFill=(backgroundImage!=='false'&&backgroundImage)||backgroundColor;if(this.colorpickers['background-color']&&backgroundFill&&backgroundFill!=='false'){this.colorpickers['background-color'].setSelectedColor(null,backgroundFill,false);}
const borderWidth=this.$link[0].style['border-width'];const numberAndUnit=getNumericAndUnit(borderWidth);this.$('.link-custom-color-border input').val(numberAndUnit?numberAndUnit[0]:"1");let borderStyle=this.$link[0].style['border-style'];if(!borderStyle||borderStyle==='none'){borderStyle='solid';}
const $activeBorderStyleButton=this.$(`.link-custom-color-border [name="link_border_style"] we-button[data-value="${borderStyle}"]`);$activeBorderStyleButton.addClass('active');$activeBorderStyleButton.siblings('we-button').removeClass("active");const $activeBorderStyleToggler=$activeBorderStyleButton.closest('we-select').find('we-toggler');$activeBorderStyleToggler.empty();$activeBorderStyleButton.find('div').clone().appendTo($activeBorderStyleToggler);const borderColor=this.$link[0].style['border-color'];this.$('.link-custom-color-border .o_we_color_preview').css('background-color',borderColor);if(this.colorpickers['border-color']&&borderColor&&borderColor!=='false'){this.colorpickers['border-color'].setSelectedColor(null,borderColor,false);}}}},_onClickCheckbox:function(ev){const $target=$(ev.target);$target.closest('we-button.o_we_checkbox_wrapper').toggleClass('active');this._adaptPreview();},_onPickSelectOption:function(ev){const $target=$(ev.target);if($target.closest('[name="link_border_style"]').length){return;}
const $select=$target.closest('we-select');$select.find('we-selection-items we-button').toggleClass('active',false);this._setSelectOption($target,true);this._updateOptionsUI();this._adaptPreview();},_onClickCustomColor:function(ev){const cssProperty=ev.target.dataset.cssProperty;let color=this.$link.css(cssProperty);if(cssProperty==='background-color'){const gradientColor=this.$link.css('background-image');if(isColorGradient(gradientColor)){color=gradientColor;}}
const colorpicker=new ColorPaletteWidget(this,{excluded:['transparent_grayscale'],$editable:$(this.options.wysiwyg.odooEditor.editable),selectedColor:color,withGradients:cssProperty==='background-color',});this.colorpickers[cssProperty]=colorpicker;colorpicker.appendTo($(ev.target).closest('.dropdown').find('.dropdown-menu'));colorpicker.on('custom_color_picked color_picked color_hover color_leave',this,(ev)=>{let color=ev.data.color;let gradientColor='';if(cssProperty==='background-color'){if(isColorGradient(color)){gradientColor=color;color='rgba(0, 0, 0, 0)';}
this.$link.css('background-image',gradientColor);}
this.$link.css(cssProperty,color);if(['custom_color_picked','color_picked'].includes(ev.name)){const $colorPreview=this.$('.link-custom-color-'+(cssProperty==='border-color'?'border':cssProperty==='color'?'text':'fill')+' .o_we_color_preview');$colorPreview.css('background-color',color);$colorPreview.css('background-image',gradientColor);this.options.wysiwyg.odooEditor.historyStep();this._updateOptionsUI();}});},_onChangeCustomBorderWidth:function(ev){const value=ev.target.value;if(parseInt(value)>=0){this.$link.css('border-width',value+'px');}},_onKeyPressCustomBorderWidth:function(ev){if(ev.keyCode===$.ui.keyCode.ENTER){this._onChangeCustomBorderWidth(ev);}},_onBorderStyleSelectOption:function(ev){const value=ev.currentTarget.dataset.value;if(value){this.$link.css('border-style',value);const $target=$(ev.currentTarget);const $activeBorderStyleToggler=$target.closest('we-select').find('we-toggler');$activeBorderStyleToggler.empty();$target.find('div').clone().appendTo($activeBorderStyleToggler);$target.addClass('active');$target.siblings('we-button').removeClass("active");this.options.wysiwyg.odooEditor.historyStep();}},});return LinkTools;});;

/* /web_editor/static/src/js/wysiwyg/widgets/media.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('wysiwyg.widgets.media',function(require){'use strict';var concurrency=require('web.concurrency');var core=require('web.core');var Dialog=require('web.Dialog');var dom=require('web.dom');var fonts=require('wysiwyg.fonts');var utils=require('web.utils');var Widget=require('web.Widget');var session=require('web.session');const{removeOnImageChangeAttrs}=require('web_editor.image_processing');const{getCSSVariableValue,DEFAULT_PALETTE}=require('web_editor.utils');const{UploadProgressToast}=require('@web_editor/js/wysiwyg/widgets/upload_progress_toast');var QWeb=core.qweb;var _t=core._t;var MediaWidget=Widget.extend({xmlDependencies:['/web_editor/static/src/xml/wysiwyg.xml'],init:function(parent,media,options){this._super.apply(this,arguments);this.media=media;this.$media=$(media);},clear:function(){if(!this.media){return;}
this._clear();},save:function(){},_clear:function(){},});var SearchableMediaWidget=MediaWidget.extend({events:_.extend({},MediaWidget.prototype.events||{},{'input .o_we_search':'_onSearchInput',}),init:function(){this._super.apply(this,arguments);this._onSearchInput=_.debounce(this._onSearchInput,500);},search:function(needle){},_renderThumbnails:function(){},_onSearchInput:function(ev){this.attachments=[];this.search($(ev.currentTarget).val()||'').then(()=>this._renderThumbnails());this.hasSearched=true;},});var FileWidget=SearchableMediaWidget.extend({events:_.extend({},SearchableMediaWidget.prototype.events||{},{'click .o_upload_media_button':'_onUploadButtonClick','change .o_file_input':'_onFileInputChange','click .o_upload_media_url_button':'_onUploadURLButtonClick','input .o_we_url_input':'_onURLInputChange','click .o_existing_attachment_cell':'_onAttachmentClick','click .o_existing_attachment_remove':'_onRemoveClick','click .o_load_more':'_onLoadMoreClick',}),existingAttachmentsTemplate:undefined,IMAGE_MIMETYPES:['image/jpg','image/jpeg','image/jpe','image/png','image/svg+xml','image/gif'],IMAGE_EXTENSIONS:['.jpg','.jpeg','.jpe','.png','.svg','.gif'],NUMBER_OF_ATTACHMENTS_TO_DISPLAY:30,MAX_DB_ATTACHMENTS:5,init:function(parent,media,options){this._super.apply(this,arguments);this._mutex=new concurrency.Mutex();this.numberOfAttachmentsToDisplay=this.NUMBER_OF_ATTACHMENTS_TO_DISPLAY;this.options=_.extend({mediaWidth:media&&media.parentElement&&$(media.parentElement).width(),useMediaLibrary:true,},options||{});this.attachments=[];this.selectedAttachments=[];this.libraryMedia=[];this.selectedMedia=[];this._onUploadURLButtonClick=dom.makeAsyncHandler(this._onUploadURLButtonClick);},start:function(){var def=this._super.apply(this,arguments);var self=this;this.$urlInput=this.$('.o_we_url_input');this.$form=this.$('form');this.$fileInput=this.$('.o_file_input');this.$uploadButton=this.$('.o_upload_media_button');this.$addUrlButton=this.$('.o_upload_media_url_button');this.$urlSuccess=this.$('.o_we_url_success');this.$urlWarning=this.$('.o_we_url_warning');this.$urlError=this.$('.o_we_url_error');this.$errorText=this.$('.o_we_error_text');var o={url:null,alt:null,};if(this.$media.is('img')){o.url=this.$media.attr('src');}else if(this.$media.is('a.o_image')){o.url=this.$media.attr('href').replace(/[?].*/,'');o.id=+o.url.match(/\/web\/content\/(\d+)/,'')[1];}
return this.search('').then(async()=>{await this._renderThumbnails();if(o.url){self._selectAttachement(_.find(self.attachments,function(attachment){return o.url===attachment.image_src;})||o);}
return def;});},destroy(){if(this.uploader){this.uploader.setParent(null);this.uploader.close(2000);}
this._super(...arguments);},save:function(){return this._mutex.exec(this._save.bind(this));},search:function(needle){this.needle=needle;return this.fetchAttachments(this.NUMBER_OF_ATTACHMENTS_TO_DISPLAY,0);},fetchAttachments:function(number,offset){return this._rpc({model:'ir.attachment',method:'search_read',args:[],kwargs:{domain:this._getAttachmentsDomain(this.needle),fields:['name','mimetype','description','checksum','url','type','res_id','res_model','public','access_token','image_src','image_width','image_height','original_id'],order:[{name:'id',asc:false}],context:this.options.context,limit:number+1,offset:offset,},}).then(attachments=>{this.attachments=this.attachments.slice();Array.prototype.splice.apply(this.attachments,[offset,attachments.length].concat(attachments));});},hasContent(){return this.attachments.length;},_clear:function(){this.media.className=this.media.className&&this.media.className.replace(/(^|\s+)(o_image)(?=\s|$)/g,' ');},_getAttachmentsDomain:function(needle){var domain=this.options.attachmentIDs&&this.options.attachmentIDs.length?['|',['id','in',this.options.attachmentIDs]]:[];var attachedDocumentDomain=['&',['res_model','=',this.options.res_model],['res_id','=',this.options.res_id|0]];if(!this.options.res_id){attachedDocumentDomain.unshift('&');attachedDocumentDomain.push(['create_uid','=',this.options.user_id]);}
if(this.options.data_res_model){var relatedDomain=['&',['res_model','=',this.options.data_res_model],['res_id','=',this.options.data_res_id|0]];if(!this.options.data_res_id){relatedDomain.unshift('&');relatedDomain.push(['create_uid','=',session.uid]);}
domain=domain.concat(['|'],attachedDocumentDomain,relatedDomain);}else{domain=domain.concat(attachedDocumentDomain);}
domain=['|',['public','=',true]].concat(domain);domain=domain.concat(this.options.mimetypeDomain);if(needle&&needle.length){domain.push(['name','ilike',needle]);}
if(!this.options.useMediaLibrary){domain.push('|',['url','=',false],'!',['url','=ilike','/web_editor/shape/%']);}
domain.push('!',['name','=like','%.crop']);domain.push('|',['type','=','binary'],'!',['url','=like','/%/static/%']);return domain;},_highlightSelected:function(){var self=this;this.$('.o_existing_attachment_cell.o_we_attachment_selected').removeClass("o_we_attachment_selected");_.each(this.selectedAttachments,function(attachment){self.$('.o_existing_attachment_cell[data-id='+attachment.id+']').addClass("o_we_attachment_selected").css('display','');});},_handleNewAttachment:function(attachment){this.attachments=this.attachments.filter(att=>att.id!==attachment.id);this.attachments.unshift(attachment);this._renderThumbnails();this._selectAttachement(attachment);},_loadMoreImages:function(forceSearch){return this.fetchAttachments(10,this.numberOfAttachmentsToDisplay).then(()=>{this.numberOfAttachmentsToDisplay+=10;if(!forceSearch){this._renderThumbnails();return Promise.resolve();}else{return this.search(this.$('.o_we_search').val()||'');}});},_renderExisting:function(attachments){return QWeb.render(this.existingAttachmentsTemplate,{attachments:attachments,widget:this,});},_renderThumbnails:function(){var attachments=this.attachments.slice(0,this.numberOfAttachmentsToDisplay);this.$('.o_we_existing_attachments').replaceWith(this._renderExisting(attachments));this._highlightSelected();this.$('.o_we_load_more').toggleClass('d-none',!this.hasContent());var noLoadMoreButton=this.NUMBER_OF_ATTACHMENTS_TO_DISPLAY>=this.attachments.length;var noMoreImgToLoad=this.numberOfAttachmentsToDisplay>=this.attachments.length;this.$('.o_load_done_msg').toggleClass('d-none',noLoadMoreButton||!noMoreImgToLoad);this.$('.o_load_more').toggleClass('d-none',noMoreImgToLoad);},_save:async function(){const toSave=Object.fromEntries(this.selectedMedia.map(media=>[media.id,{query:media.query||'',is_dynamic_svg:!!media.isDynamicSVG,dynamic_colors:media.dynamicColors,}]));let mediaAttachments=[];if(Object.keys(toSave).length!==0){mediaAttachments=await this._rpc({route:'/web_editor/save_library_media',params:{media:toSave,},});}
const selected=this.selectedAttachments.concat(mediaAttachments).map(attachment=>{if(attachment.image_src&&attachment.image_src.startsWith('/web_editor/shape/')){const colorCustomizedURL=new URL(attachment.image_src,window.location.origin);colorCustomizedURL.searchParams.forEach((value,key)=>{const match=key.match(/^c([1-5])$/);if(match){colorCustomizedURL.searchParams.set(key,getCSSVariableValue(`o-color-${match[1]}`))}})
attachment.image_src=colorCustomizedURL.pathname+colorCustomizedURL.search;}
return attachment;});if(this.options.multiImages){return selected;}
const img=selected[0];if(!img||!img.id||this.$media.attr('src')===img.image_src){return this.media;}
if(!img.public&&!img.access_token){await this._rpc({model:'ir.attachment',method:'generate_access_token',args:[[img.id]]}).then(function(access_token){img.access_token=access_token[0];});}
if(img.image_src){var src=img.image_src;if(!img.public&&img.access_token){src+=_.str.sprintf('?access_token=%s',img.access_token);}
if(!this.$media.is('img')){this.$media=$('<img/>',{class:'img-fluid o_we_custom_image'});this.media=this.$media[0];}
this.$media.attr('src',src);}else{if(!this.$media.is('a')){$('.note-control-selection').hide();this.$media=$('<a/>');this.media=this.$media[0];}
var href='/web/content/'+img.id+'?';if(!img.public&&img.access_token){href+=_.str.sprintf('access_token=%s&',img.access_token);}
href+='unique='+img.checksum+'&download=true';this.$media.attr('href',href);this.$media.addClass('o_image').attr('title',img.name);}
this.$media.attr('alt',img.alt||img.description||'');var style=this.style;if(style){this.$media.css(style);}
removeOnImageChangeAttrs.forEach(attr=>{delete this.media.dataset[attr];});if(!img.image_src){this.media.dataset.mimetype=img.mimetype;}
this.media.classList.remove('o_modified_image_to_save');this.$media.trigger('image_changed');return this.media;},_selectAttachement:function(attachment,save,{type='attachment'}={}){const possibleProps={'attachment':'selectedAttachments','media':'selectedMedia'};const prop=possibleProps[type];if(this.options.multiImages){const index=this[prop].indexOf(attachment);if(index!==-1){if(!save){this[prop].splice(index,1);}}else{this[prop].push(attachment);}}else{Object.values(possibleProps).forEach(prop=>{this[prop]=[];});this[prop]=[attachment];}
this._highlightSelected();if(save){this.trigger_up('save_request');}},_updateAddUrlUi:function(emptyValue,isURL,isImage){this.$addUrlButton.toggleClass('btn-secondary',emptyValue).toggleClass('btn-primary',!emptyValue).prop('disabled',!isURL);this.$urlSuccess.toggleClass('d-none',!isURL);this.$urlError.toggleClass('d-none',emptyValue||isURL);},_onAttachmentClick:function(ev){const attachment=ev.currentTarget;const{id:attachmentID,mediaId}=attachment.dataset;if(attachmentID){const attachment=this.attachments.find(attachment=>attachment.id===parseInt(attachmentID));this._selectAttachement(attachment,!this.options.multiImages);}else if(mediaId){const media=this.libraryMedia.find(media=>media.id===parseInt(mediaId));this._selectAttachement(media,!this.options.multiImages,{type:'media'});}},_onFileInputChange:function(){return this._mutex.exec(this._addData.bind(this));},async _addData(){let files=this.$fileInput[0].files;if(!files.length){return;}
const uploadMutex=new concurrency.Mutex();files=_.sortBy(files,'size');await this._setUpProgressToast(files);_.each(files,(file,index)=>{uploadMutex.exec(async()=>{const dataURL=await utils.getDataURLFromFile(file);const attachment=await this.uploader.rpcShowProgress({route:'/web_editor/attachment/add_data',params:{'name':file.name,'data':dataURL.split(',')[1],'res_id':this.options.res_id,'res_model':this.options.res_model,'is_image':this.widgetType==='image','width':0,'quality':0,}},index);if(!attachment.error){this._handleNewAttachment(attachment);}});});return uploadMutex.getUnlockedDef().then(()=>{if(!this.uploader.hasError){this.uploader.close(3000);}
if(!this.options.multiImages&&!this.noSave){this.trigger_up('save_request');}
this.noSave=false;});},_onRemoveClick:function(ev){var self=this;ev.stopPropagation();Dialog.confirm(this,_t("Are you sure you want to delete this file ?"),{confirm_callback:function(){var $a=$(ev.currentTarget).closest('.o_existing_attachment_cell');var id=parseInt($a.data('id'),10);var attachment=_.findWhere(self.attachments,{id:id});return self._rpc({route:'/web_editor/attachment/remove',params:{ids:[id],},}).then(function(prevented){if(_.isEmpty(prevented)){self.attachments=_.without(self.attachments,attachment);self.attachments.filter(at=>at.original_id[0]===attachment.id).forEach(at=>delete at.original_id);if(!self.attachments.length){self._renderThumbnails();}else{$a.closest('.o_existing_attachment_cell').remove();}
return;}
self.$errorText.replaceWith(QWeb.render('wysiwyg.widgets.image.existing.error',{views:prevented[id],widget:self,}));});}});},_onURLInputChange:function(){const inputValue=this.$urlInput.val().split('?')[0];var emptyValue=(inputValue==='');var isURL=/^.+\..+$/.test(inputValue);var isImage=_.any(this.IMAGE_EXTENSIONS,function(format){return inputValue.endsWith(format);});this._updateAddUrlUi(emptyValue,isURL,isImage);},_onUploadButtonClick:function(){this.$fileInput.click();},_onUploadURLButtonClick:function(){if(this.$urlInput.is('.o_we_horizontal_collapse')){this.$urlInput.removeClass('o_we_horizontal_collapse');this.$addUrlButton.attr('disabled','disabled');return;}
return this._mutex.exec(this._addUrl.bind(this));},_addUrl:function(){var self=this;return this._rpc({route:'/web_editor/attachment/add_url',params:{'url':this.$urlInput.val(),'res_id':this.options.res_id,'res_model':this.options.res_model,},}).then(function(attachment){self.$urlInput.val('');self._onURLInputChange();self._handleNewAttachment(attachment);if(!self.options.multiImages){self.trigger_up('save_request');}});},_onLoadMoreClick:function(){this._loadMoreImages();},_onSearchInput:function(){this.attachments=[];this.numberOfAttachmentsToDisplay=this.NUMBER_OF_ATTACHMENTS_TO_DISPLAY;this._super.apply(this,arguments);},_setUpProgressToast:async function(files){this.uploader=new UploadProgressToast(this,files);await this.uploader.appendTo(document.body);},});var ImageWidget=FileWidget.extend({template:'wysiwyg.widgets.image',existingAttachmentsTemplate:'wysiwyg.widgets.image.existing.attachments',events:Object.assign({},FileWidget.prototype.events,{'change input.o_we_show_optimized':'_onShowOptimizedChange','change .o_we_search_select':'_onSearchSelect',}),MIN_ROW_HEIGHT:128,init:function(parent,media,options){this.searchService='all';this.widgetType='image';options=_.extend({accept:'image/*',mimetypeDomain:[['mimetype','in',this.IMAGE_MIMETYPES]],},options||{});this._onAttachmentImageLoad=this._onAttachmentImageLoad.bind(this);this._super(parent,media,options);},start:async function(){await this._super(...arguments);this.el.addEventListener('load',this._onAttachmentImageLoad,true);},destroy:function(){this.el.removeEventListener('load',this._onAttachmentImageLoad,true);return this._super(...arguments);},async fetchAttachments(number,offset){if(this.needle&&this.searchService!=='database'){number=this.MAX_DB_ATTACHMENTS;offset=0;}
const result=await this._super(number,offset);const primaryColors={};for(let color=1;color<=5;color++){primaryColors[color]=getCSSVariableValue('o-color-'+color);}
this.attachments.forEach(attachment=>{if(attachment.image_src.startsWith('/')){const newURL=new URL(attachment.image_src,window.location.origin);if(attachment.image_src.startsWith('/web_editor/shape/')){newURL.searchParams.forEach((value,key)=>{const match=key.match(/^c([1-5])$/);if(match){newURL.searchParams.set(key,primaryColors[match[1]]);}})}else{newURL.searchParams.set('height',2*this.MIN_ROW_HEIGHT);}
attachment.thumbnail_src=newURL.pathname+newURL.search;}});if(this.needle&&this.options.useMediaLibrary){try{const response=await this._rpc({route:'/web_editor/media_library_search',params:{'query':this.needle,'offset':this.libraryMedia.length,},});const newMedia=response.media;this.nbMediaResults=response.results;this.libraryMedia.push(...newMedia);}catch(e){console.error(`Couldn't reach API endpoint.`);}}
return result;},hasContent(){if(this.searchService==='all'){return this._super(...arguments)||this.libraryMedia.length;}else if(this.searchService==='media-library'){return!!this.libraryMedia.length;}
return this._super(...arguments);},_updateAddUrlUi:function(emptyValue,isURL,isImage){this._super.apply(this,arguments);const warning=isURL&&!isImage;this.$urlWarning.toggleClass('d-none',!warning);this.$addUrlButton.prop('disabled',warning||!isURL);this.$urlSuccess.toggleClass('d-none',warning||!isURL);},_renderThumbnails:function(){const alreadyLoaded=this.$('.o_existing_attachment_cell[data-loaded="true"]');this._super(...arguments);this.$('.o_existing_attachment_cell').addClass('d-none');alreadyLoaded.each((index,el)=>{const toReplace=this.$(`.o_existing_attachment_cell[data-id="${el.dataset.id}"], .o_existing_attachment_cell[data-media-id="${el.dataset.mediaId}"]`);if(toReplace.length){toReplace.replaceWith(el);}});this._toggleOptimized(this.$('input.o_we_show_optimized')[0].checked);const placeholderWidth=3/2*this.MIN_ROW_HEIGHT;this.$('.o_we_attachment_placeholder').css({flexGrow:placeholderWidth,flexBasis:placeholderWidth,});if(this.needle&&['media-library','all'].includes(this.searchService)){const noMoreImgToLoad=this.libraryMedia.length===this.nbMediaResults;const noLoadMoreButton=noMoreImgToLoad&&this.libraryMedia.length<=15;this.$('.o_load_done_msg').toggleClass('d-none',noLoadMoreButton||!noMoreImgToLoad);this.$('.o_load_more').toggleClass('d-none',noMoreImgToLoad);}},_renderExisting:function(attachments){if(this.needle&&this.searchService!=='database'){attachments=attachments.slice(0,this.MAX_DB_ATTACHMENTS);}
return QWeb.render(this.existingAttachmentsTemplate,{attachments:attachments,libraryMedia:this.libraryMedia,widget:this,});},_toggleOptimized:function(value){this.$('.o_we_attachment_optimized').each((i,cell)=>cell.style.setProperty('display',value?null:'none','important'));},_highlightSelected:function(){this._super(...arguments);this.selectedMedia.forEach(media=>{this.$(`.o_existing_attachment_cell[data-media-id=${media.id}]`).addClass("o_we_attachment_selected");});},_onAttachmentImageLoad:async function(ev){const img=ev.target;const cell=img.closest('.o_existing_attachment_cell');if(!cell){return;}
if(cell.dataset.mediaId&&!img.src.startsWith('blob')){const mediaUrl=img.src;try{const response=await fetch(mediaUrl);if(response.headers.get('content-type')==='image/svg+xml'){let svg=await response.text();const fileName=mediaUrl.split('/').pop();const dynamicColors={};const combinedColorsRegex=new RegExp(Object.values(DEFAULT_PALETTE).join('|'),'gi');svg=svg.replace(combinedColorsRegex,match=>{const colorId=Object.keys(DEFAULT_PALETTE).find(key=>DEFAULT_PALETTE[key]===match.toUpperCase());const colorKey='c'+colorId
dynamicColors[colorKey]=getCSSVariableValue('o-color-'+colorId);return dynamicColors[colorKey];});if(Object.keys(dynamicColors).length){const file=new File([svg],fileName,{type:"image/svg+xml",});img.src=URL.createObjectURL(file);const media=this.libraryMedia.find(media=>media.id===parseInt(cell.dataset.mediaId));if(media){media.isDynamicSVG=true;media.dynamicColors=dynamicColors;}
return;}}}catch(e){console.error('CORS is misconfigured on the API server, image will be treated as non-dynamic.');}}
let aspectRatio=img.naturalWidth/img.naturalHeight;if(img.naturalHeight===0){img.width=1000;img.style.position='fixed';img.style.opacity='0';const originalParent=img.parentElement;document.body.appendChild(img);aspectRatio=img.width/img.height;originalParent.appendChild(img);img.removeAttribute('width');img.style.removeProperty('position');img.style.removeProperty('opacity');}
const width=aspectRatio*this.MIN_ROW_HEIGHT;cell.style.flexGrow=width;cell.style.flexBasis=`${width}px`;cell.classList.remove('d-none');cell.classList.add('d-flex');cell.dataset.loaded='true';},_onShowOptimizedChange:function(ev){this._toggleOptimized(ev.target.checked);},_onSearchSelect:function(ev){const{value}=ev.target;this.searchService=value;this.$('.o_we_search').trigger('input');},_onSearchInput:function(ev){this.libraryMedia=[];this._super(...arguments);this.$('.o_we_search_select').removeClass('d-none');},_clear:function(type){var allImgClasses=/(^|\s+)(img|img-\S*|o_we_custom_image|rounded-circle|rounded|thumbnail|shadow)(?=\s|$)/g;this.media.className=this.media.className&&this.media.className.replace(allImgClasses,' ');},});var DocumentWidget=FileWidget.extend({template:'wysiwyg.widgets.document',existingAttachmentsTemplate:'wysiwyg.widgets.document.existing.attachments',init:function(parent,media,options){options=_.extend({accept:'*/*',mimetypeDomain:[['mimetype','not in',this.IMAGE_MIMETYPES]],},options||{});this._super(parent,media,options);},_getAttachmentsDomain:function(needle){var domain=this._super.apply(this,arguments);return domain.concat('!',utils.assetsDomain());},});var IconWidget=SearchableMediaWidget.extend({template:'wysiwyg.widgets.font-icons',events:_.extend({},SearchableMediaWidget.prototype.events||{},{'click .font-icons-icon':'_onIconClick',}),init:function(parent,media){this._super.apply(this,arguments);fonts.computeFonts();this.iconsParser=fonts.fontIcons;this.alias=_.flatten(_.map(this.iconsParser,function(data){return data.alias;}));},start:function(){this.$icons=this.$('.font-icons-icon');var classes=(this.media&&this.media.className||'').split(/\s+/);for(var i=0;i<classes.length;i++){var cls=classes[i];if(_.contains(this.alias,cls)){this.selectedIcon=cls;this.initialIcon=cls;this._highlightSelectedIcon();}}
return this._super.apply(this,arguments);},save:function(){var style=this.$media.attr('style')||'';var iconFont=this._getFont(this.selectedIcon)||{base:'fa',font:''};if(!this.$media.is('span, i')){var $span=$('<span/>');$span.data(this.$media.data());this.$media=$span;this.media=this.$media[0];style=style.replace(/\s*width:[^;]+/,'');}
this.$media.removeClass(this.initialIcon).addClass([iconFont.base,iconFont.font]);this.$media.attr('style',style||null);return Promise.resolve(this.media);},search:function(needle){var iconsParser=this.iconsParser;if(needle&&needle.length){iconsParser=[];_.filter(this.iconsParser,function(data){var cssData=_.filter(data.cssData,function(cssData){return _.find(cssData.names,function(alias){return alias.indexOf(needle)>=0;});});if(cssData.length){iconsParser.push({base:data.base,cssData:cssData,});}});}
this.$('div.font-icons-icons').html(QWeb.render('wysiwyg.widgets.font-icons.icons',{iconsParser:iconsParser,widget:this}));return Promise.resolve();},_clear:function(){var allFaClasses=/(^|\s)(fa|(text-|bg-|fa-)\S*|rounded-circle|rounded|thumbnail|shadow)(?=\s|$)/g;this.media.className=this.media.className&&this.media.className.replace(allFaClasses,' ');},_getFont:function(classNames){if(!(classNames instanceof Array)){classNames=(classNames||"").split(/\s+/);}
var fontIcon,cssData;for(var k=0;k<this.iconsParser.length;k++){fontIcon=this.iconsParser[k];for(var s=0;s<fontIcon.cssData.length;s++){cssData=fontIcon.cssData[s];if(_.intersection(classNames,cssData.names).length){return{base:fontIcon.base,parser:fontIcon.parser,font:cssData.names[0],};}}}
return null;},_highlightSelectedIcon:function(){var self=this;this.$icons.removeClass('o_we_attachment_selected');this.$icons.filter(function(i,el){return _.contains($(el).data('alias').split(','),self.selectedIcon);}).addClass('o_we_attachment_selected');},_onIconClick:function(ev){ev.preventDefault();ev.stopPropagation();this.selectedIcon=$(ev.currentTarget).data('id');this._highlightSelectedIcon();this.trigger_up('save_request');},});var VideoWidget=MediaWidget.extend({template:'wysiwyg.widgets.video',events:_.extend({},MediaWidget.prototype.events||{},{'change .o_video_dialog_options input':'_onUpdateVideoOption','input textarea#o_video_text':'_onVideoCodeInput','change textarea#o_video_text':'_onVideoCodeChange','click .o_sample_video':'_onSampleVideoClick',}),init:function(parent,media,options){this._super.apply(this,arguments);this.isForBgVideo=!!options.isForBgVideo;this._onVideoCodeInput=_.debounce(this._onVideoCodeInput,1000);this._vimeoPreviewIds=options.vimeoPreviewIds;},start:function(){this.$content=this.$('.o_video_dialog_iframe');if(this.media){var $media=$(this.media);var src=$media.data('oe-expression')||$media.data('src')||($media.is('iframe')?$media.attr('src'):'')||'';this.$('textarea#o_video_text').val(src);this.$('input#o_video_autoplay').prop('checked',src.indexOf('autoplay=1')>=0);this.$('input#o_video_hide_controls').prop('checked',src.indexOf('controls=0')>=0);this.$('input#o_video_loop').prop('checked',src.indexOf('loop=1')>=0);this.$('input#o_video_hide_fullscreen').prop('checked',src.indexOf('fs=0')>=0);this.$('input#o_video_hide_yt_logo').prop('checked',src.indexOf('modestbranding=1')>=0);this.$('input#o_video_hide_dm_logo').prop('checked',src.indexOf('ui-logo=0')>=0);this.$('input#o_video_hide_dm_share').prop('checked',src.indexOf('sharing-enable=0')>=0);this._updateVideo();}
this.$('.o_sample_video').each((index,node)=>{const $node=$(node);const videoId=$node.attr('data-vimeo');if(!videoId){return;}
fetch(`https://vimeo.com/api/oembed.json?url=http%3A//vimeo.com/${videoId}`).then(response=>response.json()).then((response)=>{$node.append($('<img>',{src:response.thumbnail_url,class:'mw-100 mh-100 p-1',}));});});return this._super.apply(this,arguments);},save:function(){this._updateVideo();if(this.isForBgVideo){return Promise.resolve({bgVideoSrc:this.$content.attr('src')});}
if(this.$('.o_video_dialog_iframe').is('iframe')){this.$media=$('<div class="media_iframe_video" data-oe-expression="'+this.$content.attr('src')+'">'+'<div class="css_editable_mode_display">&nbsp;</div>'+'<div class="media_iframe_video_size" contenteditable="false">&nbsp;</div>'+'<iframe src="'+this.$content.attr('src')+'" frameborder="0" contenteditable="false" allowfullscreen="allowfullscreen"></iframe>'+'</div>');this.media=this.$media[0];}
return Promise.resolve(this.media);},_clear:function(){if(this.media.dataset.src){try{delete this.media.dataset.src;}catch(e){this.media.dataset.src=undefined;}}
var allVideoClasses=/(^|\s)media_iframe_video(\s|$)/g;var isVideo=this.media.className&&this.media.className.match(allVideoClasses);if(isVideo){this.media.className=this.media.className.replace(allVideoClasses,' ');this.media.innerHTML='';}},_createVideoNode:function(url,options){options=options||{};const videoData=this._getVideoURLData(url,options);if(videoData.error){return{errorCode:0};}
if(!videoData.type){return{errorCode:1};}
const $video=$('<iframe>').width(1280).height(720).attr('frameborder',0).attr('src',videoData.embedURL).addClass('o_video_dialog_iframe');return{$video:$video,type:videoData.type};},_updateVideo:function(){this.$content.empty();this.$('#o_video_form_group').removeClass('o_has_error o_has_success').find('.form-control, .custom-select').removeClass('is-invalid is-valid');this.$('.o_video_dialog_options div').addClass('d-none');var $textarea=this.$('textarea#o_video_text');var code=$textarea.val().trim();if(!code){return;}
var embedMatch=code.match(/(src|href)=["']?([^"']+)?/);if(embedMatch&&embedMatch[2].length>0&&embedMatch[2].indexOf('instagram')){embedMatch[1]=embedMatch[2];}
var url=embedMatch?embedMatch[1]:code;var query=this._createVideoNode(url,{'autoplay':this.isForBgVideo||this.$('input#o_video_autoplay').is(':checked'),'hide_controls':this.isForBgVideo||this.$('input#o_video_hide_controls').is(':checked'),'loop':this.isForBgVideo||this.$('input#o_video_loop').is(':checked'),'hide_fullscreen':this.isForBgVideo||this.$('input#o_video_hide_fullscreen').is(':checked'),'hide_yt_logo':this.isForBgVideo||this.$('input#o_video_hide_yt_logo').is(':checked'),'hide_dm_logo':this.isForBgVideo||this.$('input#o_video_hide_dm_logo').is(':checked'),'hide_dm_share':this.isForBgVideo||this.$('input#o_video_hide_dm_share').is(':checked'),});var $optBox=this.$('.o_video_dialog_options');this.$el.find('.o_video_dialog_preview_text, .media_iframe_video_size').add($optBox).toggleClass('d-none',!query.$video);this.$el.find('#o_video_form_group').toggleClass('o_has_error',!query.$video).find('.form-control, .custom-select').toggleClass('is-invalid',!query.$video).end().toggleClass('o_has_success',!!query.$video).find('.form-control, .custom-select').toggleClass('is-valid',!!query.$video);$optBox.find('div.o_'+query.type+'_option').removeClass('d-none');$optBox.toggleClass('d-none',this.isForBgVideo||$optBox.find('div:not(.d-none)').length===0);if(query.type==='youtube'){this.$('input#o_video_hide_fullscreen, input#o_video_hide_yt_logo').closest('div').toggleClass('d-none',this.$('input#o_video_hide_controls').is(':checked'));}
var $content=query.$video;if(!$content){switch(query.errorCode){case 0:$content=$('<div/>',{class:'alert alert-danger o_video_dialog_iframe mb-2 mt-2',text:_t("The provided url is not valid"),});break;case 1:$content=$('<div/>',{class:'alert alert-warning o_video_dialog_iframe mb-2 mt-2',text:_t("The provided url does not reference any supported video"),});break;}}
this.$content.replaceWith($content);this.$content=$content;},_onUpdateVideoOption:function(){this._updateVideo();},_onSampleVideoClick(ev){const vimeoId=ev.currentTarget.getAttribute('data-vimeo');if(vimeoId){this.$('#o_video_text').val(`https://player.vimeo.com/video/${vimeoId}`);this._updateVideo();}},_onVideoCodeChange:function(){this._updateVideo();},_onVideoCodeInput:function(){this._updateVideo();},_getVideoURLData:function(url,options){if(!url.match(/^(http:\/\/|https:\/\/|\/\/)[a-z0-9]+([-.]{1}[a-z0-9]+)*\.[a-z]{2,5}(:[0-9]{1,5})?(\/.*)?$/i)){return{error:true,message:'The provided url is invalid',};}
const regexes={youtube:/^(?:(?:https?:)?\/\/)?(?:www\.)?(?:youtu\.be\/|youtube(-nocookie)?\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((?:\w|-){11})(?:\S+)?$/,instagram:/(.*)instagram.com\/p\/(.[a-zA-Z0-9]*)/,vine:/\/\/vine.co\/v\/(.[a-zA-Z0-9]*)/,vimeo:/\/\/(player.)?vimeo.com\/([a-z]*\/)*([0-9]{6,11})[?]?.*/,dailymotion:/.+dailymotion.com\/(video|hub|embed)\/([^_?]+)[^#]*(#video=([^_&]+))?/,youku:/(.*).youku\.com\/(v_show\/id_|embed\/)(.+)/,};const matches=_.mapObject(regexes,regex=>url.match(regex));const autoplay=options.autoplay?'?autoplay=1&mute=1':'?autoplay=0';const controls=options.hide_controls?'&controls=0':'';const loop=options.loop?'&loop=1':'';let embedURL;let type;if(matches.youtube&&matches.youtube[2].length===11){const fullscreen=options.hide_fullscreen?'&fs=0':'';const ytLoop=loop?loop+`&playlist=${matches.youtube[2]}`:'';const logo=options.hide_yt_logo?'&modestbranding=1':'';embedURL=`//www.youtube${matches.youtube[1] || ''}.com/embed/${matches.youtube[2]}${autoplay}&rel=0${ytLoop}${controls}${fullscreen}${logo}`;type='youtube';}else if(matches.instagram&&matches.instagram[2].length){embedURL=`//www.instagram.com/p/${matches.instagram[2]}/embed/`;type='instagram';}else if(matches.vine&&matches.vine[0].length){embedURL=`${matches.vine[0]}/embed/simple`;type='vine';}else if(matches.vimeo&&matches.vimeo[3].length){const vimeoAutoplay=autoplay.replace('mute','muted');embedURL=`//player.vimeo.com/video/${matches.vimeo[3]}${vimeoAutoplay}${loop}`;type='vimeo';}else if(matches.dailymotion&&matches.dailymotion[2].length){const videoId=matches.dailymotion[2].replace('video/','');const logo=options.hide_dm_logo?'&ui-logo=0':'';const share=options.hide_dm_share?'&sharing-enable=0':'';embedURL=`//www.dailymotion.com/embed/video/${videoId}${autoplay}${controls}${logo}${share}`;type='dailymotion';}else if(matches.youku&&matches.youku[3].length){const videoId=matches.youku[3].indexOf('.html?')>=0?matches.youku[3].substring(0,matches.youku[3].indexOf('.html?')):matches.youku[3];embedURL=`//player.youku.com/embed/${videoId}`;type='youku';}
return{type:type,embedURL:embedURL};},});return{MediaWidget:MediaWidget,SearchableMediaWidget:SearchableMediaWidget,FileWidget:FileWidget,ImageWidget:ImageWidget,DocumentWidget:DocumentWidget,IconWidget:IconWidget,VideoWidget:VideoWidget,};});;

/* /web_editor/static/src/js/wysiwyg/widgets/media_dialog.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('wysiwyg.widgets.MediaDialog',function(require){'use strict';var core=require('web.core');var MediaModules=require('wysiwyg.widgets.media');var Dialog=require('wysiwyg.widgets.Dialog');var _t=core._t;var MediaDialog=Dialog.extend({template:'wysiwyg.widgets.media',xmlDependencies:Dialog.prototype.xmlDependencies.concat(['/web_editor/static/src/xml/wysiwyg.xml']),events:_.extend({},Dialog.prototype.events,{'click #editor-media-image-tab':'_onClickImageTab','click #editor-media-document-tab':'_onClickDocumentTab','click #editor-media-icon-tab':'_onClickIconTab','click #editor-media-video-tab':'_onClickVideoTab',}),custom_events:_.extend({},Dialog.prototype.custom_events||{},{save_request:'_onSaveRequest',show_parent_dialog_request:'_onShowRequest',hide_parent_dialog_request:'_onHideRequest',}),init:function(parent,options,media){var $media=$(media);media=$media[0];this.media=media;options=_.extend({},options);var onlyImages=options.onlyImages||this.multiImages||(media&&($media.parent().data('oeField')==='image'||$media.parent().data('oeType')==='image'));options.noDocuments=onlyImages||options.noDocuments;options.noIcons=onlyImages||options.noIcons;options.noVideos=onlyImages||options.noVideos;this._super(parent,_.extend({},{title:_t("Select a Media"),save_text:_t("Add"),},options));if(!options.noImages){this.imageWidget=new MediaModules.ImageWidget(this,media,options);}
if(!options.noDocuments){this.documentWidget=new MediaModules.DocumentWidget(this,media,options);}
if(!options.noIcons){this.iconWidget=new MediaModules.IconWidget(this,media,options);}
if(!options.noVideos){this.videoWidget=new MediaModules.VideoWidget(this,media,options);}
if(this.imageWidget&&$media.is('img')){this.activeWidget=this.imageWidget;}else if(this.documentWidget&&$media.is('a.o_image')){this.activeWidget=this.documentWidget;}else if(this.videoWidget&&$media.is('.media_iframe_video, .o_bg_video_iframe')){this.activeWidget=this.videoWidget;}else if(this.iconWidget&&$media.is('span, i')){this.activeWidget=this.iconWidget;}else{this.activeWidget=[this.imageWidget,this.documentWidget,this.videoWidget,this.iconWidget].find(w=>!!w);}
this.initiallyActiveWidget=this.activeWidget;},start:function(){var promises=[this._super.apply(this,arguments)];this.$modal.find('.modal-dialog').addClass('o_select_media_dialog');if(this.imageWidget){promises.push(this.imageWidget.appendTo(this.$("#editor-media-image")));}
if(this.documentWidget){promises.push(this.documentWidget.appendTo(this.$("#editor-media-document")));}
if(this.iconWidget){promises.push(this.iconWidget.appendTo(this.$("#editor-media-icon")));}
if(this.videoWidget){promises.push(this.videoWidget.appendTo(this.$("#editor-media-video")));}
this.opened(()=>this.$('input.o_we_search:visible:first').focus());return Promise.all(promises);},isDocumentActive:function(){return this.activeWidget===this.documentWidget;},isIconActive:function(){return this.activeWidget===this.iconWidget;},isImageActive:function(){return this.activeWidget===this.imageWidget;},isVideoActive:function(){return this.activeWidget===this.videoWidget;},save:function(){var self=this;var _super=this._super;var args=arguments;return this.activeWidget.save().then(function(data){if(self.activeWidget!==self.initiallyActiveWidget){self._clearWidgets();}
if(self.media!==data){var oldClasses=self.media&&_.toArray(self.media.classList);if(oldClasses){data.className=_.union(_.toArray(data.classList),oldClasses).join(' ');}}
self.final_data=data;_super.apply(self,args);$(data).trigger('content_changed');});},_clearWidgets:function(){[this.imageWidget,this.documentWidget,this.iconWidget,this.videoWidget].forEach((widget)=>{if(widget!==this.activeWidget){widget&&widget.clear();}});},_onClickDocumentTab:function(){this.activeWidget=this.documentWidget;},_onClickIconTab:function(){this.activeWidget=this.iconWidget;},_onClickImageTab:function(){this.activeWidget=this.imageWidget;},_onClickVideoTab:function(){this.activeWidget=this.videoWidget;},_onHideRequest:function(ev){this.$modal.addClass('d-none');},_onSaveRequest:function(ev){ev.stopPropagation();this.save();},_onShowRequest:function(ev){this.$modal.removeClass('d-none');},});return MediaDialog;});;

/* /web_editor/static/src/js/wysiwyg/widgets/upload_progress_toast.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('@web_editor/js/wysiwyg/widgets/upload_progress_toast',async function(require){'use strict';let __exports={};const Widget=require("web.Widget");const{qweb}=require('web.core');const UploadProgressToast=__exports.UploadProgressToast=Widget.extend({xmlDependencies:['/web_editor/static/src/xml/wysiwyg.xml'],template:'wysiwyg.widgets.upload.progress_toast',events:{'click .o_notification_close':'_onCloseClick',},init(parent,files){this._super(...arguments);this.files=files;},start(){this.$progress=$('<div/>');_.each(this.files,(file,index)=>{let fileSize=file.size;if(!fileSize){fileSize=null;}else if(fileSize<1024){fileSize=fileSize.toFixed(2)+" bytes";}else if(fileSize<1048576){fileSize=(fileSize/1024).toFixed(2)+" KB";}else{fileSize=(fileSize/1048576).toFixed(2)+" MB";}
this.$progress.append(qweb.render('wysiwyg.widgets.upload.progressbar',{fileId:index,fileName:file.name,fileSize:fileSize,}));});this.$el.find('.o_notification_content').append(this.$progress);},close(delay=0){window.setTimeout(()=>{this.el.querySelector('.fade').classList.remove('show');window.setTimeout(()=>{this.destroy();},150);},delay);},async rpcShowProgress(params,index){let $progressBar=this.$el.find(`.js_progressbar_${index}`);try{const xhr=new XMLHttpRequest();xhr.upload.addEventListener('progress',ev=>{const prcComplete=ev.loaded/ev.total*100;$progressBar.find('.progress-bar').css({width:Math.floor(prcComplete)+'%',}).text(prcComplete.toFixed(2)+'%');});xhr.upload.addEventListener('load',function(){$progressBar.find('.progress-bar').css({width:'100%'}).text('100%');});const attachment=await this._rpc(params,{xhr});$progressBar.find('.fa-spinner, .progress').addClass('d-none');if(attachment.error){this.hasError=true;$progressBar.find('.js_progressbar_txt .text-danger').removeClass('d-none');$progressBar.find('.js_progressbar_txt .text-danger .o_we_error_text').text(attachment.error);}else{$progressBar.find('.js_progressbar_txt .text-success').removeClass('d-none');}
return attachment;}catch(error){this.hasError=true;$progressBar.find('.fa-spinner, .progress').addClass('d-none');$progressBar.find('.js_progressbar_txt .text-danger').removeClass('d-none');throw error;}},_onCloseClick(){this.close();},});return __exports;});;

/* /web_editor/static/src/js/wysiwyg/widgets/widgets.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('wysiwyg.widgets',function(require){'use strict';var Dialog=require('wysiwyg.widgets.Dialog');var AltDialog=require('wysiwyg.widgets.AltDialog');var MediaDialog=require('wysiwyg.widgets.MediaDialog');var LinkDialog=require('wysiwyg.widgets.LinkDialog');var LinkTools=require('wysiwyg.widgets.LinkTools');var ImageCropWidget=require('wysiwyg.widgets.ImageCropWidget');const LinkPopoverWidget=require('@web_editor/js/wysiwyg/widgets/link_popover_widget')[Symbol.for("default")];const{ColorpickerDialog}=require('web.Colorpicker');var media=require('wysiwyg.widgets.media');return{Dialog:Dialog,AltDialog:AltDialog,MediaDialog:MediaDialog,LinkDialog:LinkDialog,LinkTools:LinkTools,ImageCropWidget:ImageCropWidget,LinkPopoverWidget:LinkPopoverWidget,ColorpickerDialog:ColorpickerDialog,MediaWidget:media.MediaWidget,SearchableMediaWidget:media.SearchableMediaWidget,FileWidget:media.FileWidget,ImageWidget:media.ImageWidget,DocumentWidget:media.DocumentWidget,IconWidget:media.IconWidget,VideoWidget:media.VideoWidget,};});;

/* /web_editor/static/src/js/editor/snippets.editor.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('web_editor.snippet.editor',function(require){'use strict';var concurrency=require('web.concurrency');var core=require('web.core');var Dialog=require('web.Dialog');var dom=require('web.dom');var Widget=require('web.Widget');var options=require('web_editor.snippets.options');const{ColorPaletteWidget}=require('web_editor.ColorPalette');const SmoothScrollOnDrag=require('web/static/src/js/core/smooth_scroll_on_drag.js');const{getCSSVariableValue}=require('web_editor.utils');const QWeb=core.qweb;var _t=core._t;$.extend($.expr[':'],{o_editable:function(node,i,m){while(node){if(node.className&&_.isString(node.className)){if(node.className.indexOf('o_not_editable')!==-1){return false;}
if(node.className.indexOf('o_editable')!==-1){return true;}}
node=node.parentNode;}
return false;},});function firstChild(node){while(node.firstChild){node=node.firstChild;}
return node;}
function lastChild(node){while(node.lastChild){node=node.lastChild;}
return node;}
function nodeLength(node){if(node.nodeType===Node.TEXT_NODE){return node.nodeValue.length;}else{return node.childNodes.length;}}
$.fn.extend({focusIn:function(){if(this.length){const selection=document.getSelection();selection.removeAllRanges();const range=new Range();const node=firstChild(this[0]);range.setStart(node,0);range.setEnd(node,0);selection.addRange(range);}
return this;},focusInEnd:function(){if(this.length){const selection=document.getSelection();selection.removeAllRanges();const range=new Range();const node=lastChild(this[0]);const length=nodeLength(node);range.setStart(node,length);range.setEnd(node,length);selection.addRange(range);}
return this;},selectContent:function(){if(this.length&&!this[0].hasChildNodes()){return this.selectElement();}
if(this.length){const selection=document.getSelection();selection.removeAllRanges();const range=new Range();range.setStart(this[0].firstChild,0);range.setEnd(this[0].lastChild,this[0].lastChild.length);selection.addRange(range);}
return this;},selectElement:function(){if(this.length){const selection=document.getSelection();selection.removeAllRanges();const element=this[0];const parent=element.parentNode;const offsetStart=Array.from(parent.childNodes).indexOf(element);const range=new Range();range.setStart(parent,offsetStart);range.setEnd(parent,offsetStart+1);selection.addRange(range);}
return this;},});var globalSelector={closest:()=>$(),all:()=>$(),is:()=>false,};var SnippetEditor=Widget.extend({template:'web_editor.snippet_overlay',xmlDependencies:['/web_editor/static/src/xml/snippets.xml'],events:{'click .oe_snippet_remove':'_onRemoveClick','wheel':'_onMouseWheel',},custom_events:{'option_update':'_onOptionUpdate','user_value_widget_request':'_onUserValueWidgetRequest','snippet_option_visibility_update':'_onSnippetOptionVisibilityUpdate',},layoutElementsSelector:['.o_we_shape','.o_we_bg_filter',].join(','),init:function(parent,target,templateOptions,$editable,options){this._super.apply(this,arguments);this.options=options;this.$editable=$editable;this.ownerDocument=this.$editable[0].ownerDocument;this.$body=$(this.ownerDocument.body);this.$target=$(target);this.$target.data('snippet-editor',this);this.templateOptions=templateOptions;this.isTargetParentEditable=false;this.isTargetMovable=false;this.$scrollingElement=$().getScrollingElement(this.ownerDocument);if(!this.$scrollingElement[0]){this.$scrollingElement=$(this.ownerDocument).find('.o_editable');}
this.displayOverlayOptions=false;this.__isStarted=new Promise(resolve=>{this.__isStartedResolveFunc=resolve;});},start:function(){var defs=[this._super.apply(this,arguments)];defs.push(this._initializeOptions());var $customize=this._customize$Elements[this._customize$Elements.length-1];this.isTargetParentEditable=this.$target.parent().is(':o_editable');this.isTargetMovable=this.isTargetParentEditable&&this.isTargetMovable&&!this.$target.hasClass('oe_unmovable');this.isTargetRemovable=this.isTargetParentEditable&&!this.$target.parent().is('[data-oe-type="image"]')&&!this.$target.hasClass('oe_unremovable');this.displayOverlayOptions=this.displayOverlayOptions||this.isTargetMovable||!this.isTargetParentEditable;if(this.isTargetMovable){this.dropped=false;const smoothScrollOptions=this.options.getScrollOptions({jQueryDraggableOptions:{cursorAt:{left:10,top:10},handle:'.o_move_handle',helper:()=>{var $clone=this.$el.clone().css({width:'24px',height:'24px',border:0});$clone.appendTo(this.$body).removeClass('d-none');return $clone;},start:this._onDragAndDropStart.bind(this),stop:(...args)=>{setTimeout(()=>{this._onDragAndDropStop(...args);},0);},},});const $scrollable=(this.options.wysiwyg.snippetsMenu&&this.options.wysiwyg.snippetsMenu.$scrollable)||(this.$scrollingElement.length&&this.$scrollingElement)||$().getScrollingElement(this.ownerDocument);this.draggableComponent=new SmoothScrollOnDrag(this,this.$el,$scrollable,smoothScrollOptions);}else{this.$('.o_overlay_move_options').addClass('d-none');$customize.find('.oe_snippet_clone').addClass('d-none');}
if(!this.isTargetRemovable){this.$el.add($customize).find('.oe_snippet_remove').addClass('d-none');}
var _animationsCount=0;var postAnimationCover=_.throttle(()=>{this.trigger_up('cover_update',{overlayVisible:true,});},100);this.$target.on('transitionstart.snippet_editor, animationstart.snippet_editor',()=>{_animationsCount++;setTimeout(()=>{if(!--_animationsCount){postAnimationCover();}},500);});this.$target.on('transitionend.snippet_editor, animationend.snippet_editor',postAnimationCover);return Promise.all(defs).then(()=>{this.__isStartedResolveFunc(this);});},destroy:function(){this.trigger_up('snippet_editor_destroyed');if(this.$optionsSection){this.$optionsSection.remove();}
this._super(...arguments);this.$target.removeData('snippet-editor');this.$target.off('.snippet_editor');},areOptionsShown:function(){const lastIndex=this._customize$Elements.length-1;return!!this._customize$Elements[lastIndex].parent().length;},buildSnippet:async function(){for(var i in this.styles){this.styles[i].onBuilt();}
await this.toggleTargetVisibility(true);},cleanForSave:async function(){if(this.isDestroyed()){return;}
await this.toggleTargetVisibility(!this.$target.hasClass('o_snippet_invisible'));const proms=_.map(this.styles,option=>{return option.cleanForSave();});await Promise.all(proms);},closeWidgets:function(){if(!this.styles||!this.areOptionsShown()){return;}
Object.keys(this.styles).forEach(key=>{this.styles[key].closeWidgets();});},cover:function(){if(!this.isShown()||!this.$target.length){return;}
const $modal=this.$target.find('.modal');const $target=$modal.length?$modal:this.$target;const targetEl=$target[0];const rect=targetEl.getBoundingClientRect();const vpWidth=targetEl.ownerDocument.defaultView.innerWidth||document.documentElement.clientWidth;const vpHeight=targetEl.ownerDocument.defaultView.innerHeight||document.documentElement.clientHeight;const isInViewport=(rect.bottom>-0.1&&rect.right>-0.1&&(vpHeight-rect.top)>-0.1&&(vpWidth-rect.left)>-0.1);const hasSize=(Math.abs(rect.bottom-rect.top)>0.01&&Math.abs(rect.right-rect.left)>0.01);if(!isInViewport||!hasSize||!this.$target.is(`:visible`)){this.toggleOverlayVisibility(false);return;}
const transform=window.getComputedStyle(targetEl).getPropertyValue('transform');const transformOrigin=window.getComputedStyle(targetEl).getPropertyValue('transform-origin');targetEl.classList.add('o_transform_removal');const offset=$target.offset();var manipulatorOffset=this.$el.parent().offset();offset.top-=manipulatorOffset.top;offset.left-=manipulatorOffset.left;this.$el.css({width:$target.outerWidth(),height:$target.outerHeight(),left:offset.left,top:offset.top,transform,'transform-origin':transformOrigin,});this.$('.o_handles').css('height',$target.outerHeight());targetEl.classList.remove('o_transform_removal');const editableOffsetTop=this.$editable.offset().top-manipulatorOffset.top;this.$el.toggleClass('o_top_cover',offset.top-editableOffsetTop<25);},getName:function(){if(this.$target.data('name')!==undefined){return this.$target.data('name');}
if(this.$target.is('img')){return _t("Image");}
if(this.$target.is('.fa')){return _t("Icon");}
if(this.$target.is('.media_iframe_video')){return _t("Video");}
if(this.$target.parent('.row').length){return _t("Column");}
return _t("Block");},isShown:function(){return this.$el&&this.$el.parent().length&&this.$el.hasClass('oe_active');},isSticky:function(){return this.$el&&this.$el.hasClass('o_we_overlay_sticky');},isTargetVisible:function(){return(this.$target[0].dataset.invisible!=='1');},removeSnippet:async function(shouldRecordUndo=true){this.options.wysiwyg.odooEditor.unbreakableStepUnactive();this.toggleOverlay(false);await this.toggleOptions(false);await this.toggleTargetVisibility(!this.$target.hasClass('o_snippet_invisible'));await new Promise(resolve=>{this.trigger_up('call_for_each_child_snippet',{$snippet:this.$target,callback:async function(editor,$snippet){for(var i in editor.styles){await editor.styles[i].onRemove();}},onSuccess:resolve,});});const parent=this.$target[0].parentElement;const nextSibling=this.$target[0].nextElementSibling;const previousSibling=this.$target[0].previousElementSibling;this.trigger_up('activate_snippet',{$snippet:$(previousSibling||nextSibling||parent)});var $parent=this.$target.parent();this.$target.find('*').addBack().tooltip('dispose');this.$target.remove();this.$el.remove();var node=$parent[0];if(node&&node.firstChild){if(!node.firstChild.tagName&&node.firstChild.textContent===' '){node.removeChild(node.firstChild);}}
if($parent.closest(':data("snippet-editor")').length){const isEmptyAndRemovable=($el,editor)=>{editor=editor||$el.data('snippet-editor');const isEmpty=$el.text().trim()===''&&$el.children().toArray().every(el=>{return el.matches(this.layoutElementsSelector);});return isEmpty&&!$el.hasClass('oe_structure')&&!$el.hasClass('oe_unremovable')&&(!editor||editor.isTargetParentEditable);};var editor=$parent.data('snippet-editor');while(!editor){var $nextParent=$parent.parent();if(isEmptyAndRemovable($parent)){$parent.remove();}
$parent=$nextParent;editor=$parent.data('snippet-editor');}
if(isEmptyAndRemovable($parent,editor)){setTimeout(()=>editor.removeSnippet());}}
this.$body.find('.note-control-selection').hide();this.$body.find('.o_table_handler').remove();this.trigger_up('snippet_removed');this.destroy();$parent.trigger('content_changed');$(window).trigger('resize');if(shouldRecordUndo){this.options.wysiwyg.odooEditor.historyStep();}},toggleOverlay:function(show,previewMode){if(!this.$el){return;}
if(previewMode){this.$el.toggleClass('o_we_overlay_preview',show);this.$el.find('.o_handle').removeClass('d-none');}else{this.$el.removeClass('o_we_overlay_preview');this.$el.toggleClass('o_we_overlay_sticky',show);if(!this.displayOverlayOptions){this.$el.find('.o_overlay_options_wrap').addClass('o_we_hidden_overlay_options');}}
this.$el.toggleClass('oe_active',show);this.cover();this.toggleOverlayVisibility(show);},async toggleOptions(show){if(!this.$el){return[];}
if(this.areOptionsShown()===show){return this._customize$Elements;}
const editorUIsToUpdate=[];const focusOrBlur=show?async(editor,options)=>{for(const opt of options){await opt.onFocus();}
editorUIsToUpdate.push(editor);}:async(editor,options)=>{for(const opt of options){await opt.onBlur();}};for(const $el of this._customize$Elements){const editor=$el.data('editor');const styles=_.chain(editor.styles).values().sortBy('__order').value();await focusOrBlur(editor,styles);}
await Promise.all(editorUIsToUpdate.map(editor=>editor.updateOptionsUI()));await Promise.all(editorUIsToUpdate.map(editor=>editor.updateOptionsUIVisibility()));return this._customize$Elements;},toggleTargetVisibility:async function(show){show=this._toggleVisibilityStatus(show);var styles=_.values(this.styles);const proms=_.sortBy(styles,'__order').map(style=>{return show?style.onTargetShow():style.onTargetHide();});await Promise.all(proms);return show;},toggleOverlayVisibility:function(show){if(this.$el&&!this.scrollingTimeout){this.$el.toggleClass('o_overlay_hidden',!show&&this.isShown());}},async updateOptionsUI(){const proms=Object.values(this.styles).map(opt=>{return opt.updateUI({noVisibility:true});});return Promise.all(proms);},async updateOptionsUIVisibility(){const proms=Object.values(this.styles).map(opt=>{return opt.updateUIVisibility();});return Promise.all(proms);},clone:async function(recordUndo){this.trigger_up('snippet_will_be_cloned',{$target:this.$target});var $clone=this.$target.clone(false);this.$target.after($clone);if(recordUndo){this.options.wysiwyg.odooEditor.historyStep(true);}
await new Promise(resolve=>{this.trigger_up('call_for_each_child_snippet',{$snippet:$clone,callback:function(editor,$snippet){for(var i in editor.styles){editor.styles[i].onClone({isCurrent:($snippet.is($clone)),});}},onSuccess:resolve,});});this.trigger_up('snippet_cloned',{$target:$clone,$origin:this.$target});$clone.trigger('content_changed');},_initializeOptions:function(){this._customize$Elements=[];this.styles={};this.selectorSiblings=[];this.selectorChildren=[];var $element=this.$target.parent();while($element.length){var parentEditor=$element.data('snippet-editor');if(parentEditor){this._customize$Elements=this._customize$Elements.concat(parentEditor._customize$Elements);break;}
$element=$element.parent();}
var $optionsSection=$(core.qweb.render('web_editor.customize_block_options_section',{name:this.getName(),})).data('editor',this);const $optionsSectionBtnGroup=$optionsSection.find('we-top-button-group');$optionsSectionBtnGroup.contents().each((i,node)=>{if(node.nodeType===Node.TEXT_NODE){node.parentNode.removeChild(node);}});this.$optionsSection=$optionsSection;$optionsSection.on('mouseenter',this._onOptionsSectionMouseEnter.bind(this));$optionsSection.on('mouseleave',this._onOptionsSectionMouseLeave.bind(this));$optionsSection.on('click','we-title > span',this._onOptionsSectionClick.bind(this));$optionsSection.on('click','.oe_snippet_clone',this._onCloneClick.bind(this));$optionsSection.on('click','.oe_snippet_remove',this._onRemoveClick.bind(this));this._customize$Elements.push($optionsSection);this.$el.data('$optionsSection',$optionsSection);var i=0;var defs=_.map(this.templateOptions,val=>{if(!val.selector.is(this.$target)){return;}
if(val['drop-near']){this.selectorSiblings.push(val['drop-near']);}
if(val['drop-in']){this.selectorChildren.push(val['drop-in']);}
var optionName=val.option;var option=new(options.registry[optionName]||options.Class)(this,val.$el.children(),val.base_target?this.$target.find(val.base_target).eq(0):this.$target,this.$el,_.extend({optionName:optionName,snippetName:this.getName(),},val.data),this.options);var key=optionName||_.uniqueId('option');if(this.styles[key]){key=_.uniqueId(key);}
this.styles[key]=option;option.__order=i++;if(option.forceNoDeleteButton){this.$el.add($optionsSection).find('.oe_snippet_remove').addClass('d-none');}
if(option.displayOverlayOptions){this.displayOverlayOptions=true;}
return option.appendTo(document.createDocumentFragment());});this.isTargetMovable=(this.selectorSiblings.length>0||this.selectorChildren.length>0);this.$el.find('[data-toggle="dropdown"]').dropdown();return Promise.all(defs).then(()=>{const options=_.sortBy(this.styles,'__order');const firstOptions=[];options.forEach(option=>{if(option.isTopOption){if(option.isTopFirstOption){firstOptions.push(option);}else{$optionsSectionBtnGroup.prepend(option.$el);}}else{$optionsSection.append(option.$el);}});firstOptions.forEach(option=>{$optionsSectionBtnGroup.prepend(option.$el);});$optionsSection.toggleClass('d-none',options.length===0);});},_toggleVisibilityStatus:function(show){if(show===undefined){show=!this.isTargetVisible();}
if(show){delete this.$target[0].dataset.invisible;}else{this.$target[0].dataset.invisible='1';}
return show;},_onCloneClick:function(ev){ev.preventDefault();this.clone(true);},_onDragAndDropStart:function(){this.trigger_up('drag_and_drop_start');this.options.wysiwyg.odooEditor.automaticStepUnactive();var self=this;this.dropped=false;this._dropSiblings={prev:self.$target.prev()[0],next:self.$target.next()[0],};self.size={width:self.$target.width(),height:self.$target.height()};self.$target.after('<div class="oe_drop_clone" style="display: none;"/>');self.$target.detach();self.$el.addClass('d-none');var $selectorSiblings;for(var i=0;i<self.selectorSiblings.length;i++){if(!$selectorSiblings){$selectorSiblings=self.selectorSiblings[i].all();}else{$selectorSiblings=$selectorSiblings.add(self.selectorSiblings[i].all());}}
var $selectorChildren;for(i=0;i<self.selectorChildren.length;i++){if(!$selectorChildren){$selectorChildren=self.selectorChildren[i].all();}else{$selectorChildren=$selectorChildren.add(self.selectorChildren[i].all());}}
this.trigger_up('activate_snippet',{$snippet:this.$target.parent()});this.trigger_up('activate_insertion_zones',{$selectorSiblings:$selectorSiblings,$selectorChildren:$selectorChildren,});this.$body.addClass('move-important');this.$editable.find('.oe_drop_zone').droppable({over:function(){if(self.dropped){self.$target.detach();$('.oe_drop_zone').removeClass('invisible');}
self.dropped=true;$(this).first().after(self.$target).addClass('invisible');},out:function(){var prev=self.$target.prev();if(this===prev[0]){self.dropped=false;self.$target.detach();$(this).removeClass('invisible');}},});const $openModal=self.$editable.find('.modal:visible');if($openModal.length){self.draggableComponent.$scrollTarget=$openModal;}
self.draggableComponent.$scrollTarget.on('scroll.scrolling_element',function(){self.$el.trigger('scroll');});},_onDragAndDropStop:function(ev,ui){this.options.wysiwyg.odooEditor.automaticStepActive();this.options.wysiwyg.odooEditor.automaticStepSkipStack();this.options.wysiwyg.odooEditor.unbreakableStepUnactive();if(!this.dropped){var $el=$.nearest({x:ui.position.left,y:ui.position.top},'.oe_drop_zone',{container:document.body}).first();if($el.length){$el.after(this.$target);this.dropped=true;}}
this.$editable.find('.oe_drop_zone').droppable('destroy').remove();var prev=this.$target.first()[0].previousSibling;var next=this.$target.last()[0].nextSibling;var $parent=this.$target.parent();var $clone=this.$editable.find('.oe_drop_clone');if(prev===$clone[0]){prev=$clone[0].previousSibling;}else if(next===$clone[0]){next=$clone[0].nextSibling;}
$clone.after(this.$target);var $from=$clone.parent();this.$el.removeClass('d-none');this.$body.removeClass('move-important');$clone.remove();if(this.dropped){if(prev){this.$target.insertAfter(prev);}else if(next){this.$target.insertBefore(next);}else{$parent.prepend(this.$target);}
for(var i in this.styles){this.styles[i].onMove();}
this.$target.trigger('content_changed');$from.trigger('content_changed');}
this.trigger_up('drag_and_drop_stop',{$snippet:this.$target,});this.draggableComponent.$scrollTarget.off('scroll.scrolling_element');const samePositionAsStart=this._dropSiblings.prev===this.$target.prev()[0]&&this._dropSiblings.next===this.$target.next()[0];if(!samePositionAsStart){this.options.wysiwyg.odooEditor.historyStep();}},_onOptionsSectionMouseEnter:function(ev){if(!this.$target.is(':visible')){return;}
this.trigger_up('activate_snippet',{$snippet:this.$target,previewMode:true,});},_onOptionsSectionMouseLeave:function(ev){this.trigger_up('activate_snippet',{$snippet:false,previewMode:true,});},_onOptionsSectionClick:function(ev){this.trigger_up('activate_snippet',{$snippet:this.$target,previewMode:false,});},_onOptionUpdate:function(ev){var self=this;if(ev.data.optionNames){ev.stopPropagation();_.each(ev.data.optionNames,function(name){notifyForEachMatchedOption(name);});}
if(ev.data.optionName){if(notifyForEachMatchedOption(ev.data.optionName)){ev.stopPropagation();}}
function notifyForEachMatchedOption(name){var regex=new RegExp('^'+name+'\\d+$');var hasOption=false;for(var key in self.styles){if(key===name||regex.test(key)){self.styles[key].notify(ev.data.name,ev.data.data);hasOption=true;}}
return hasOption;}},_onRemoveClick:function(ev){ev.preventDefault();ev.stopPropagation();this.removeSnippet();},_onSnippetOptionVisibilityUpdate:function(ev){ev.data.show=this._toggleVisibilityStatus(ev.data.show);},_onUserValueWidgetRequest:function(ev){for(const key of Object.keys(this.styles)){const widget=this.styles[key].findWidget(ev.data.name);if(widget){ev.stopPropagation();ev.data.onSuccess(widget);return;}}
if(!ev.data.allowParentOption){ev.stopPropagation();}},_onMouseWheel:function(ev){ev.stopPropagation();this.$el.css('pointer-events','none');clearTimeout(this.wheelTimeout);this.wheelTimeout=setTimeout(()=>{this.$el.css('pointer-events','');},250);},});var SnippetsMenu=Widget.extend({id:'oe_snippets',cacheSnippetTemplate:{},events:{'click .oe_snippet':'_onSnippetClick','click .o_install_btn':'_onInstallBtnClick','click .o_we_add_snippet_btn':'_onBlocksTabClick','click .o_we_customize_snippet_btn':'_onOptionsTabClick','click .o_we_invisible_entry':'_onInvisibleEntryClick','click #snippet_custom .o_rename_btn':'_onRenameBtnClick','click #snippet_custom .o_delete_btn':'_onDeleteBtnClick','mousedown':'_onMouseDown','input .o_snippet_search_filter_input':'_onSnippetSearchInput','click .o_snippet_search_filter_reset':'_onSnippetSearchResetClick','click .o_we_website_top_actions button[data-action=save]':'_onSaveRequest','click .o_we_website_top_actions button[data-action=cancel]':'_onDiscardClick','click .o_we_website_top_actions button[data-action=mobile]':'_onMobilePreviewClick','click .o_we_website_top_actions button[data-action=undo]':'_onUndo','click .o_we_website_top_actions button[data-action=redo]':'_onRedo',},custom_events:{'activate_insertion_zones':'_onActivateInsertionZones','activate_snippet':'_onActivateSnippet','call_for_each_child_snippet':'_onCallForEachChildSnippet','clone_snippet':'_onCloneSnippet','cover_update':'_onOverlaysCoverUpdate','deactivate_snippet':'_onDeactivateSnippet','drag_and_drop_stop':'_onSnippetDragAndDropStop','drag_and_drop_start':'_onSnippetDragAndDropStart','get_snippet_versions':'_onGetSnippetVersions','remove_snippet':'_onRemoveSnippet','snippet_edition_request':'_onSnippetEditionRequest','snippet_editor_destroyed':'_onSnippetEditorDestroyed','snippet_removed':'_onSnippetRemoved','snippet_cloned':'_onSnippetCloned','snippet_option_update':'_onSnippetOptionUpdate','snippet_option_visibility_update':'_onSnippetOptionVisibilityUpdate','snippet_thumbnail_url_request':'_onSnippetThumbnailURLRequest','reload_snippet_dropzones':'_disableUndroppableSnippets','request_save':'_onSaveRequest','hide_overlay':'_onHideOverlay','block_preview_overlays':'_onBlockPreviewOverlays','unblock_preview_overlays':'_onUnblockPreviewOverlays','user_value_widget_opening':'_onUserValueWidgetOpening','user_value_widget_closing':'_onUserValueWidgetClosing','reload_snippet_template':'_onReloadSnippetTemplate','request_editable':'_onRequestEditable','disable_loading_effect':'_onDisableLoadingEffect','enable_loading_effect':'_onEnableLoadingEffect',},tabs:{BLOCKS:'blocks',OPTIONS:'options',CUSTOM:'custom',},init:function(parent,options){this._super.apply(this,arguments);options=options||{};this.$body=$((options.document||document).body);this.options=options;if(!this.options.snippets){this.options.snippets='web_editor.snippets';}
this.snippetEditors=[];this._enabledEditorHierarchy=[];this._mutex=new concurrency.Mutex();this._notActivableElementsSelector=['#web_editor-top-edit','.o_we_website_top_actions','#oe_snippets','#oe_manipulators','.o_technical_modal','.oe_drop_zone','.o_notification_manager','.o_we_no_overlay','.ui-autocomplete','.modal .close','.o_we_crop_widget','.transfo-container',].join(', ');this.loadingTimers={};this.loadingElements={};this._loadingEffectDisabled=false;},willStart:function(){ColorPaletteWidget.loadDependencies(this);return this._super(...arguments);},async start(){var defs=[this._super.apply(this,arguments)];this.ownerDocument=this.$el[0].ownerDocument;this.$document=$(this.ownerDocument);this.window=this.ownerDocument.defaultView;this.$window=$(this.window);this.$el=this.window.$(this.$el);this.$el.data('snippetMenu',this);this.customizePanel=document.createElement('div');this.customizePanel.classList.add('o_we_customize_panel','d-none');this._addToolbar();this._checkEditorToolbarVisibilityCallback=this._checkEditorToolbarVisibility.bind(this);$(this.options.wysiwyg.odooEditor.document.body).on('click',this._checkEditorToolbarVisibilityCallback);if(this.options.enableTranslation){await this._loadSnippetsTemplates();this.$el.find('.o_we_website_top_actions').removeClass('d-none');this.$('.o_snippet_search_filter').addClass('d-none');this.$('#o_scroll').addClass('d-none');this.$('button[data-action="mobilePreview"]').addClass('d-none');this.$('#snippets_menu button').removeClass('active').prop('disabled',true);this.$('.o_we_customize_snippet_btn').addClass('active').prop('disabled',false);this.$('o_we_ui_loading').addClass('d-none');$(this.customizePanel).removeClass('d-none');return Promise.all(defs).then(this._addToolbar.bind(this));}
this.invisibleDOMPanelEl=document.createElement('div');this.invisibleDOMPanelEl.classList.add('o_we_invisible_el_panel');this.invisibleDOMPanelEl.appendChild($('<div/>',{text:_t('Invisible Elements'),class:'o_panel_header',})[0]);this.emptyOptionsTabContent=document.createElement('div');this.emptyOptionsTabContent.classList.add('text-center','pt-5');this.emptyOptionsTabContent.append(_t("Select a block on your page to style it."));this.options.getScrollOptions=this._getScrollOptions.bind(this);defs.push((async()=>{await this._loadSnippetsTemplates();await this._updateInvisibleDOM();})());this.$snippetEditorArea=$('<div/>',{id:'oe_manipulators',}).insertAfter(this.$el);var lastElement;const onClick=ev=>{var srcElement=ev.target||(ev.originalEvent&&(ev.originalEvent.target||ev.originalEvent.originalTarget))||ev.srcElement;if(!srcElement||lastElement===srcElement){return;}
var $target=$(srcElement);if($target.parents('.o_edit_menu_popover').length&&!$target.parent('a').addBack('a').length){return;}
lastElement=srcElement;_.defer(function(){lastElement=false;});if(!$target.closest('we-button, we-toggler, we-select, .o_we_color_preview').length){this._closeWidgets();}
if(!$target.closest('body > *').length){return;}
if($target.closest(this._notActivableElementsSelector).length){return;}
this._activateSnippet($target);};this.$document.on('click.snippets_menu','*',onClick);this.$document.on('mouseup.snippets_menu','.dropdown-toggle',onClick);core.bus.on('deactivate_snippet',this,this._onDeactivateSnippet);var debouncedCoverUpdate=_.throttle(()=>{this.updateCurrentSnippetEditorOverlay();},50);this.$window.on('resize.snippets_menu',debouncedCoverUpdate);this.$window.on('content_changed.snippets_menu',debouncedCoverUpdate);this.$document.on('keydown.snippets_menu',()=>{this.__overlayKeyWasDown=true;this.snippetEditors.forEach(editor=>{editor.toggleOverlayVisibility(false);});});this.$document.on('mousemove.snippets_menu, mousedown.snippets_menu',_.throttle(()=>{if(!this.__overlayKeyWasDown){return;}
this.__overlayKeyWasDown=false;this.snippetEditors.forEach(editor=>{editor.toggleOverlayVisibility(true);editor.cover();});},250));this.$scrollingElement=$().getScrollingElement(this.ownerDocument);if(!this.$scrollingElement[0]){this.$scrollingElement=$(this.ownerDocument).find('.o_editable');}
this._onScrollingElementScroll=_.throttle(()=>{for(const editor of this.snippetEditors){editor.toggleOverlayVisibility(false);}
clearTimeout(this.scrollingTimeout);this.scrollingTimeout=setTimeout(()=>{this._scrollingTimeout=null;for(const editor of this.snippetEditors){editor.toggleOverlayVisibility(true);editor.cover();}},250);},50);this.$scrollingElement[0].addEventListener('scroll',this._onScrollingElementScroll,{capture:true});this.$document.on('click.snippets_menu','.o_default_snippet_text',function(ev){$(ev.target).closest('.o_default_snippet_text').removeClass('o_default_snippet_text');$(ev.target).selectContent();$(ev.target).removeClass('o_default_snippet_text');});this.$document.on('keyup.snippets_menu',function(){const selection=document.getSelection();if(!Selection.rangeCount){return;}
const range=selection.getRangeAt(0);$(range.startContainer).closest('.o_default_snippet_text').removeClass('o_default_snippet_text');});const refreshSnippetEditors=_.debounce(()=>{for(const snippetEditor of this.snippetEditors){this._mutex.exec(()=>snippetEditor.destroy());}
const selection=this.$document[0].getSelection();if(selection.rangeCount){const target=selection.getRangeAt(0).startContainer.parentElement;this._activateSnippet($(target));}},500);this.options.wysiwyg.odooEditor.addEventListener('historyUndo',refreshSnippetEditors);this.options.wysiwyg.odooEditor.addEventListener('historyRedo',refreshSnippetEditors);const $autoFocusEls=$('.o_we_snippet_autofocus');this._activateSnippet($autoFocusEls.length?$autoFocusEls.first():false);this.$el.tooltip({selector:'we-title, [data-tooltip="true"]',placement:'bottom',delay:100,title:function(){const el=this;if(el.tagName!=='WE-TITLE'){return el.title;}
el.style.setProperty('overflow','scroll','important');const tipContent=el.scrollWidth>el.clientWidth?el.innerHTML:'';el.style.removeProperty('overflow');return tipContent;},});return Promise.all(defs).then(()=>{const $undoButton=this.$('.o_we_external_history_buttons button[data-action="undo"]');const $redoButton=this.$('.o_we_external_history_buttons button[data-action="redo"]');if($undoButton.length){const updateHistoryButtons=()=>{$undoButton.attr('disabled',!this.options.wysiwyg.odooEditor.historyCanUndo());$redoButton.attr('disabled',!this.options.wysiwyg.odooEditor.historyCanRedo());};this.options.wysiwyg.odooEditor.addEventListener('historyStep',updateHistoryButtons);this.options.wysiwyg.odooEditor.addEventListener('observerApply',()=>{$(this.options.wysiwyg.odooEditor.editable).trigger('content_changed');});this.options.wysiwyg.odooEditor.addEventListener('historyRevert',_.debounce(()=>{this.trigger_up('widgets_start_request',{$target:this.options.wysiwyg.$editable,editableMode:true,});},50));}
setTimeout(()=>{this.$window.trigger('resize');},1000);});},destroy:function(){this._super.apply(this,arguments);if(this.$window){if(this.$snippetEditorArea){this.$snippetEditorArea.remove();}
this.$window.off('.snippets_menu');this.$document.off('.snippets_menu');if(this.$scrollingElement){this.$scrollingElement[0].removeEventListener('scroll',this._onScrollingElementScroll,{capture:true});}}
core.bus.off('deactivate_snippet',this,this._onDeactivateSnippet);$(document.body).off('click',this._checkEditorToolbarVisibilityCallback);delete this.cacheSnippetTemplate[this.options.snippets];},cleanForSave:async function(){await this._activateSnippet(false);this.trigger_up('ready_to_clean_for_save');await this._destroyEditors();this.getEditableArea().find('[contentEditable]').removeAttr('contentEditable').removeProp('contentEditable');this.getEditableArea().find('.o_we_selected_image').removeClass('o_we_selected_image');},loadSnippets:function(invalidateCache){if(!invalidateCache&&this.cacheSnippetTemplate[this.options.snippets]){this._defLoadSnippets=this.cacheSnippetTemplate[this.options.snippets];return this._defLoadSnippets;}
this._defLoadSnippets=this._rpc({model:'ir.ui.view',method:'render_public_asset',args:[this.options.snippets,{}],kwargs:{context:this.options.context,},});this.cacheSnippetTemplate[this.options.snippets]=this._defLoadSnippets;return this._defLoadSnippets;},getEditableArea:function(){return this.options.wysiwyg.$editable.find(this.options.selectorEditableArea).add(this.options.wysiwyg.$editable.filter(this.options.selectorEditableArea));},updateCurrentSnippetEditorOverlay:function(){if(this.snippetEditorDragging){return;}
for(const snippetEditor of this.snippetEditors){if(snippetEditor.$target.closest('body').length){snippetEditor.cover();continue;}
this._mutex.exec(()=>{snippetEditor.destroy();const index=this.snippetEditors.indexOf(snippetEditor);if(index!==-1){this.snippetEditors.splice(index,1);}});}
this._mutex.exec(()=>{if(this._currentTab===this.tabs.OPTIONS&&!this.snippetEditors.length){this._activateEmptyOptionsTab();}});},activateCustomTab:function(content){this._updateRightPanelContent({content:content,tab:this.tabs.CUSTOM});},activateSnippet:async function($snippet){return this._activateSnippet($snippet);},_activateInsertionZones:function($selectorSiblings,$selectorChildren){var self=this;const $openModal=self.getEditableArea().find('.modal:visible');if($openModal.length){$selectorSiblings=$openModal.find($selectorSiblings);$selectorChildren=$openModal.find($selectorChildren);}
function setDropZoneDirection($elem,$parent,$sibling){var vertical=false;var style={};$sibling=$sibling||$elem;var css=window.getComputedStyle($elem[0]);var parentCss=window.getComputedStyle($parent[0]);var float=css.float||css.cssFloat;var display=parentCss.display;var flex=parentCss.flexDirection;if(float==='left'||float==='right'||(display==='flex'&&flex==='row')){style['float']=float;if($sibling.parent().width()!==$sibling.outerWidth(true)){vertical=true;style['height']=Math.max($sibling.outerHeight(),30)+'px';}}
return{vertical:vertical,style:style,};}
function testPreviousSibling(node,$zone){if(!node||((node.tagName||!node.textContent.match(/\S/))&&node.tagName!=='BR')){return false;}
return{vertical:true,style:{'float':'none','display':'inline-block','height':parseInt(self.window.getComputedStyle($zone[0]).lineHeight)+'px',},};}
var $clone=$('.oe_drop_clone');if($clone.length){var $neighbor=$clone.prev();if(!$neighbor.length){$neighbor=$clone.next();}
var data;if($neighbor.length){data=setDropZoneDirection($neighbor,$neighbor.parent());}else{data={vertical:false,style:{},};}
self._insertDropzone($('<we-hook/>').insertAfter($clone),data.vertical,data.style);}
if($selectorChildren){$selectorChildren.each(function(){var data;var $zone=$(this);var $children=$zone.find('> :not(.oe_drop_zone, .oe_drop_clone)');if(!$zone.children().last().is('.oe_drop_zone')){data=testPreviousSibling($zone[0].lastChild,$zone)||setDropZoneDirection($zone,$zone,$children.last());self._insertDropzone($('<we-hook/>').appendTo($zone),data.vertical,data.style);}
if(!$zone.children().first().is('.oe_drop_clone')){data=testPreviousSibling($zone[0].firstChild,$zone)||setDropZoneDirection($zone,$zone,$children.first());self._insertDropzone($('<we-hook/>').prependTo($zone),data.vertical,data.style);}});$selectorSiblings=$(_.uniq(($selectorSiblings||$()).add($selectorChildren.children()).get()));}
var noDropZonesSelector='[data-invisible="1"], .o_we_no_overlay, :not(:visible)';if($selectorSiblings){$selectorSiblings.not(`.oe_drop_zone, .oe_drop_clone, ${noDropZonesSelector}`).each(function(){var data;var $zone=$(this);var $zoneToCheck=$zone;while($zoneToCheck.prev(noDropZonesSelector).length){$zoneToCheck=$zoneToCheck.prev();}
if(!$zoneToCheck.prev('.oe_drop_zone:visible, .oe_drop_clone').length){data=setDropZoneDirection($zone,$zone.parent());self._insertDropzone($('<we-hook/>').insertBefore($zone),data.vertical,data.style);}
$zoneToCheck=$zone;while($zoneToCheck.next(noDropZonesSelector).length){$zoneToCheck=$zoneToCheck.next();}
if(!$zoneToCheck.next('.oe_drop_zone:visible, .oe_drop_clone').length){data=setDropZoneDirection($zone,$zone.parent());self._insertDropzone($('<we-hook/>').insertAfter($zone),data.vertical,data.style);}});}
var count;var $zones;do{count=0;$zones=this.getEditableArea().find('.oe_drop_zone > .oe_drop_zone').remove();count+=$zones.length;$zones.remove();}while(count>0);$zones=this.getEditableArea().find('.oe_drop_zone:not(.oe_vertical)');$zones.each(function(){var zone=$(this);var prev=zone.prev();var next=zone.next();if(prev.is('.oe_drop_zone')||next.is('.oe_drop_zone')){zone.remove();return;}
var floatPrev=prev.css('float')||'none';var floatNext=next.css('float')||'none';var dispPrev=prev.css('display')||null;var dispNext=next.css('display')||null;if((floatPrev==='left'||floatPrev==='right')&&(floatNext==='left'||floatNext==='right')){zone.remove();}else if(dispPrev!==null&&dispNext!==null&&dispPrev.indexOf('inline')>=0&&dispNext.indexOf('inline')>=0){zone.remove();}});},_updateInvisibleDOM:function(){return this._execWithLoadingEffect(()=>{this.options.wysiwyg.odooEditor.automaticStepSkipStack();this.invisibleDOMMap=new Map();const $invisibleDOMPanelEl=$(this.invisibleDOMPanelEl);$invisibleDOMPanelEl.find('.o_we_invisible_entry').remove();const $invisibleSnippets=globalSelector.all().find('.o_snippet_invisible').addBack('.o_snippet_invisible');$invisibleDOMPanelEl.toggleClass('d-none',!$invisibleSnippets.length);const proms=_.map($invisibleSnippets,async el=>{const editor=await this._createSnippetEditor($(el));const $invisEntry=$('<div/>',{class:'o_we_invisible_entry d-flex align-items-center justify-content-between',text:editor.getName(),}).append($('<i/>',{class:`fa ${editor.isTargetVisible() ? 'fa-eye' : 'fa-eye-slash'} ml-2`}));$invisibleDOMPanelEl.append($invisEntry);this.invisibleDOMMap.set($invisEntry[0],el);});return Promise.all(proms);},false);},_activateSnippet:async function($snippet,previewMode,ifInactiveOptions){if(this._blockPreviewOverlays&&previewMode){return;}
if($snippet&&!$snippet.is(':visible')){return;}
if($snippet&&$snippet.length){const $globalSnippet=globalSelector.closest($snippet);if(!$globalSnippet.length){$snippet=$snippet.closest('[data-oe-model="ir.ui.view"]:not([data-oe-type]):not(.oe_structure), [data-oe-type="html"]:not(.oe_structure)');}else{$snippet=$globalSnippet;}}
const exec=previewMode?action=>this._mutex.exec(action):action=>this._execWithLoadingEffect(action,false);return exec(()=>{return new Promise(resolve=>{if($snippet&&$snippet.length){return this._createSnippetEditor($snippet).then(resolve);}
resolve(null);}).then(async editorToEnable=>{if(ifInactiveOptions&&this._enabledEditorHierarchy.includes(editorToEnable)){return editorToEnable;}
if(!previewMode){this._enabledEditorHierarchy=[];let current=editorToEnable;while(current&&current.$target){this._enabledEditorHierarchy.push(current);current=current.getParent();}}
for(let i=this.snippetEditors.length;i--;){const editor=this.snippetEditors[i];editor.toggleOverlay(false,previewMode);if(!previewMode&&!this._enabledEditorHierarchy.includes(editor)){await editor.toggleOptions(false);}}
let customize$Elements;if(editorToEnable){editorToEnable.toggleOverlay(true,previewMode);if(!previewMode&&!editorToEnable.displayOverlayOptions){const parentEditor=this._enabledEditorHierarchy.find(ed=>ed.displayOverlayOptions);if(parentEditor){parentEditor.toggleOverlay(true,previewMode);}}
customize$Elements=await editorToEnable.toggleOptions(true);}else{for(const editor of this.snippetEditors){if(editor.isSticky()){editor.toggleOverlay(true,false);customize$Elements=await editor.toggleOptions(true);break;}}}
if(!previewMode){this._updateRightPanelContent({content:customize$Elements||[],tab:customize$Elements?this.tabs.OPTIONS:this.tabs.BLOCKS,});}
return editorToEnable;});});},_loadSnippetsTemplates:async function(invalidateCache){return this._execWithLoadingEffect(async()=>{await this._destroyEditors();const html=await this.loadSnippets(invalidateCache);await this._computeSnippetTemplates(html);},false);},_destroyEditors:async function($el){const proms=_.map(this.snippetEditors,async function(snippetEditor){if($el&&!$el.has(snippetEditor.$target).length){return;}
await snippetEditor.cleanForSave();snippetEditor.destroy();});await Promise.all(proms);this.snippetEditors.splice(0);},_callForEachChildSnippet:function($snippet,callback){var self=this;var defs=_.map($snippet.add(globalSelector.all($snippet)),function(el){var $snippet=$(el);return self._createSnippetEditor($snippet).then(function(editor){if(editor){return callback.call(self,editor,$snippet);}});});return Promise.all(defs);},_closeWidgets:function(){this.snippetEditors.forEach(editor=>editor.closeWidgets());},_computeSelectorFunctions:function(selector,exclude,target,noCheck,isChildren){var self=this;exclude+=`${exclude && ', '}.o_snippet_not_selectable`;let filterFunc=function(){return!$(this).is(exclude);};if(target){const oldFilter=filterFunc;filterFunc=function(){return oldFilter.apply(this)&&$(this).find(target).length!==0;};}
var functions={is:function($from){return $from.is(selector)&&$from.filter(filterFunc).length!==0;},};if(noCheck){functions.closest=function($from,parentNode){return $from.closest(selector,parentNode).filter(filterFunc);};functions.all=function($from){return($from?dom.cssFind($from,selector):$(selector)).filter(filterFunc);};}else{functions.closest=function($from,parentNode){var parents=self.getEditableArea().get();return $from.closest(selector,parentNode).filter(function(){var node=this;while(node.parentNode){if(parents.indexOf(node)!==-1){return true;}
node=node.parentNode;}
return false;}).filter(filterFunc);};functions.all=isChildren?function($from){return dom.cssFind($from||self.getEditableArea(),selector).filter(filterFunc);}:function($from){$from=$from||self.getEditableArea();return $from.filter(selector).add(dom.cssFind($from,selector)).filter(filterFunc);};}
return functions;},_computeSnippetTemplates:function(html){var self=this;var $html=$(html);var $scroll=$html.siblings('#o_scroll');this.templateOptions=[];var selectors=[];var $styles=$html.find('[data-selector]');$styles.each(function(){var $style=$(this);var selector=$style.data('selector');var exclude=$style.data('exclude')||'';var target=$style.data('target');var noCheck=$style.data('no-check');var optionID=$style.data('js')||$style.data('option-name');var option={'option':optionID,'base_selector':selector,'base_exclude':exclude,'base_target':target,'selector':self._computeSelectorFunctions(selector,exclude,target,noCheck),'$el':$style,'drop-near':$style.data('drop-near')&&self._computeSelectorFunctions($style.data('drop-near'),'',false,noCheck,true),'drop-in':$style.data('drop-in')&&self._computeSelectorFunctions($style.data('drop-in'),'',false,noCheck),'data':_.extend({string:$style.attr('string')},$style.data()),};self.templateOptions.push(option);selectors.push(option.selector);});$styles.addClass('d-none');globalSelector.closest=function($from){var $temp;var $target;for(var i=0,len=selectors.length;i<len;i++){$temp=selectors[i].closest($from,$target&&$target[0]);if($temp.length){$target=$temp;}}
return $target||$();};globalSelector.all=function($from){var $target=$();for(var i=0,len=selectors.length;i<len;i++){$target=$target.add(selectors[i].all($from));}
return $target;};globalSelector.is=function($from){for(var i=0,len=selectors.length;i<len;i++){if(selectors[i].is($from)){return true;}}
return false;};this.$snippets=$scroll.find('.o_panel_body').children().addClass('oe_snippet').each((i,el)=>{const $snippet=$(el);const name=_.escape(el.getAttribute('name'));const thumbnailSrc=_.escape(el.dataset.oeThumbnail);const $sbody=$snippet.children().addClass('oe_snippet_body');const isCustomSnippet=!!el.closest('#snippet_custom');let snippetClasses=$sbody.attr('class').match(/s_[^ ]+/g);if(snippetClasses&&snippetClasses.length){snippetClasses='.'+snippetClasses.join('.');}
const $els=$(snippetClasses).not('[data-name]').add($sbody);$els.attr('data-name',name).data('name',name);const $thumbnail=$(`
                    <div class="oe_snippet_thumbnail">
                        <div class="oe_snippet_thumbnail_img" style="background-image: url(${thumbnailSrc});"/>
                        <span class="oe_snippet_thumbnail_title">${name}</span>
                    </div>
                `);$snippet.prepend($thumbnail);const moduleID=$snippet.data('moduleId');if(moduleID){el.classList.add('o_snippet_install');$thumbnail.append($('<button/>',{class:'btn btn-primary o_install_btn w-100',type:'button',text:_t("Install"),}));}
if(isCustomSnippet){const btnRenameEl=document.createElement('we-button');btnRenameEl.dataset.snippetId=$snippet.data('oeSnippetId');btnRenameEl.classList.add('o_rename_btn','fa','fa-pencil','btn','o_we_hover_success');btnRenameEl.title=_.str.sprintf(_t("Rename %s"),name);$snippet.append(btnRenameEl);const btnEl=document.createElement('we-button');btnEl.dataset.snippetId=$snippet.data('oeSnippetId');btnEl.classList.add('o_delete_btn','fa','fa-trash','btn','o_we_hover_danger');btnEl.title=_.str.sprintf(_t("Delete %s"),name);$snippet.append(btnEl);}}).not('[data-module-id]');if(!this.$snippets.length){this.$el.detach();}
this._registerDefaultTexts();$html.find('.o_not_editable').attr('contentEditable',false);this.$el.html($html);this.$el.append(this.customizePanel);this.$el.append(this.invisibleDOMPanelEl);this._makeSnippetDraggable(this.$snippets);this._disableUndroppableSnippets();this.$el.addClass('o_loaded');this.trigger_up('snippets_loaded',self.$el);$(this.el.ownerDocument.body).addClass('editor_has_snippets');},_createSnippetEditor:function($snippet){var self=this;var snippetEditor=$snippet.data('snippet-editor');if(snippetEditor){return snippetEditor.__isStarted;}
var def;if(!$snippet[0].classList.contains('o_no_parent_editor')){var $parent=globalSelector.closest($snippet.parent());if($parent.length){def=this._createSnippetEditor($parent);}}
return Promise.resolve(def).then(function(parentEditor){snippetEditor=$snippet.data('snippet-editor');if(snippetEditor){return snippetEditor.__isStarted;}
let editableArea=self.getEditableArea();snippetEditor=new SnippetEditor(parentEditor||self,$snippet,self.templateOptions,$snippet.closest('[data-oe-type="html"], .oe_structure').add(editableArea),self.options);self.snippetEditors.push(snippetEditor);return snippetEditor.prependTo(self.$snippetEditorArea);}).then(function(){return snippetEditor;});},_disableUndroppableSnippets:function(){var self=this;var cache={};this.$snippets.each(function(){var $snippet=$(this);var $snippetBody=$snippet.find('.oe_snippet_body');var check=false;_.each(self.templateOptions,function(option,k){if(check||!($snippetBody.is(option.base_selector)&&!$snippetBody.is(option.base_exclude))){return;}
cache[k]=cache[k]||{'drop-near':option['drop-near']?option['drop-near'].all().length:0,'drop-in':option['drop-in']?option['drop-in'].all().length:0};check=(cache[k]['drop-near']||cache[k]['drop-in']);});$snippet.toggleClass('o_disabled',!check);$snippet.attr('title',check?'':_t("No location to drop in"));const $icon=$snippet.find('.o_snippet_undroppable').remove();if(check){$icon.remove();}else if(!$icon.length){const imgEl=document.createElement('img');imgEl.classList.add('o_snippet_undroppable');imgEl.src='/web_editor/static/src/img/snippet_disabled.svg';$snippet.append(imgEl);}});},_filterSnippets(search){const searchInputEl=this.el.querySelector('.o_snippet_search_filter_input');const searchInputReset=this.el.querySelector('.o_snippet_search_filter_reset');if(search!==undefined){searchInputEl.value=search;}else{search=searchInputEl.value;}
search=search.toLowerCase();searchInputReset.classList.toggle('d-none',!search);const strMatches=str=>!search||str.toLowerCase().includes(search);for(const panelEl of this.el.querySelectorAll('.o_panel')){let hasVisibleSnippet=false;const panelTitle=panelEl.querySelector('.o_panel_header').textContent;const isPanelTitleMatch=strMatches(panelTitle);for(const snippetEl of panelEl.querySelectorAll('.oe_snippet')){const matches=(isPanelTitleMatch||strMatches(snippetEl.getAttribute('name'))||strMatches(snippetEl.dataset.oeKeywords||''));if(matches){hasVisibleSnippet=true;}
snippetEl.classList.toggle('d-none',!matches);}
panelEl.classList.toggle('d-none',!hasVisibleSnippet);}},_getScrollOptions(options={}){return Object.assign({},options,{scrollBoundaries:Object.assign({right:false,},options.scrollBoundaries),jQueryDraggableOptions:Object.assign({appendTo:this.$body,cursor:'move',greedy:true,scroll:false,},options.jQueryDraggableOptions),disableHorizontalScroll:true,});},_insertDropzone:function($hook,vertical,style){var $dropzone=$('<div/>',{'class':'oe_drop_zone oe_insert'+(vertical?' oe_vertical':''),});if(style){$dropzone.css(style);}
$hook.replaceWith($dropzone);return $dropzone;},_makeSnippetDraggable:function($snippets){var self=this;var $toInsert,dropped,$snippet;let dragAndDropResolve;let $scrollingElement=$().getScrollingElement(this.ownerDocument);if(!$scrollingElement[0]){$scrollingElement=$(this.ownerDocument).find('.o_editable');}
const smoothScrollOptions=this._getScrollOptions({jQueryDraggableOptions:{handle:'.oe_snippet_thumbnail:not(.o_we_already_dragging)',helper:function(){const dragSnip=this.cloneNode(true);dragSnip.querySelectorAll('.o_delete_btn').forEach(el=>el.remove());return dragSnip;},start:function(){self.options.wysiwyg.odooEditor.automaticStepUnactive();self.$el.find('.oe_snippet_thumbnail').addClass('o_we_already_dragging');dropped=false;$snippet=$(this);var $baseBody=$snippet.find('.oe_snippet_body');var $selectorSiblings=$();var $selectorChildren=$();var temp=self.templateOptions;for(var k in temp){if($baseBody.is(temp[k].base_selector)&&!$baseBody.is(temp[k].base_exclude)){if(temp[k]['drop-near']){$selectorSiblings=$selectorSiblings.add(temp[k]['drop-near'].all());}
if(temp[k]['drop-in']){$selectorChildren=$selectorChildren.add(temp[k]['drop-in'].all());}}}
$toInsert=$baseBody.clone();[...$toInsert.find('img[src^="/web_editor/shape/"]')].forEach(dynamicSvg=>{const colorCustomizedURL=new URL(dynamicSvg.getAttribute('src'),window.location.origin);colorCustomizedURL.searchParams.forEach((value,key)=>{const match=key.match(/^c([1-5])$/);if(match){colorCustomizedURL.searchParams.set(key,getCSSVariableValue(`o-color-${match[1]}`));}});dynamicSvg.src=colorCustomizedURL.pathname+colorCustomizedURL.search;});if(!$selectorSiblings.length&&!$selectorChildren.length){console.warn($snippet.find('.oe_snippet_thumbnail_title').text()+" have not insert action: data-drop-near or data-drop-in");return;}
self._activateInsertionZones($selectorSiblings,$selectorChildren);self.getEditableArea().find('.oe_drop_zone').droppable({over:function(){if(dropped){$toInsert.detach();$toInsert.addClass('oe_snippet_body');$('.oe_drop_zone').removeClass('invisible');}
dropped=true;$(this).first().after($toInsert).addClass('invisible');$toInsert.removeClass('oe_snippet_body');},out:function(){var prev=$toInsert.prev();if(this===prev[0]){dropped=false;$toInsert.detach();$(this).removeClass('invisible');$toInsert.addClass('oe_snippet_body');}},});const $openModal=self.getEditableArea().find('.modal:visible');if($openModal.length){self.draggableComponent.$scrollTarget=$openModal;}
self.draggableComponent.$scrollTarget.on('scroll.scrolling_element',function(){self.$el.trigger('scroll');});const prom=new Promise(resolve=>dragAndDropResolve=()=>resolve());self._mutex.exec(()=>prom);},stop:async function(ev,ui){const doc=self.options.wysiwyg.odooEditor.document;self.options.wysiwyg.odooEditor.automaticStepUnactive();self.options.wysiwyg.odooEditor.automaticStepSkipStack();$toInsert.removeClass('oe_snippet_body');self.draggableComponent.$scrollTarget.off('scroll.scrolling_element');if(!dropped&&ui.position.top>3&&ui.position.left+ui.helper.outerHeight()<self.el.getBoundingClientRect().left){const point={x:ui.position.left,y:ui.position.top};const container={container:doc.body};let droppedOnNotNearest=doc.defaultView.$.touching(point,'.oe_structure_not_nearest',container).first();const selector=droppedOnNotNearest.length?'.oe_drop_zone':':not(.oe_structure_not_nearest) > .oe_drop_zone';let $el=doc.defaultView.$.nearest(point,selector,container).first();if($el.length){$el.after($toInsert);dropped=true;}}
self.getEditableArea().find('.oe_drop_zone').droppable('destroy').remove();if(dropped){var prev=$toInsert.first()[0].previousSibling;var next=$toInsert.last()[0].nextSibling;if(prev){$toInsert.detach();$toInsert.insertAfter(prev);}else if(next){$toInsert.detach();$toInsert.insertBefore(next);}else{var $parent=$toInsert.parent();$toInsert.detach();$parent.prepend($toInsert);}
var $target=$toInsert;await self._scrollToSnippet($target,self.$scrollable);_.defer(async function(){dragAndDropResolve();await self._callForEachChildSnippet($target,function(editor,$snippet){return editor.buildSnippet();});$target.trigger('content_changed');await self._mutex.exec(()=>{const proms=[];self.trigger_up('snippet_dropped',{$target:$target,addPostDropAsync:prom=>proms.push(prom),});return Promise.all(proms);});await self._updateInvisibleDOM();self._disableUndroppableSnippets();self.options.wysiwyg.odooEditor.unbreakableStepUnactive();self.options.wysiwyg.odooEditor.historyStep();self.$el.find('.oe_snippet_thumbnail').removeClass('o_we_already_dragging');});}else{$toInsert.remove();dragAndDropResolve();self.$el.find('.oe_snippet_thumbnail').removeClass('o_we_already_dragging');}},},});this.draggableComponent=new SmoothScrollOnDrag(this,$snippets,$scrollingElement,smoothScrollOptions);},_registerDefaultTexts:function($in){if($in===undefined){$in=this.$snippets.find('.oe_snippet_body');}
$in.find('*').addBack().contents().filter(function(){return this.nodeType===3&&this.textContent.match(/\S/);}).parent().addClass('o_default_snippet_text');},_updateRightPanelContent:function({content,tab,...options}){this._closeWidgets();this._currentTab=tab||this.tabs.BLOCKS;if(content){while(this.customizePanel.firstChild){this.customizePanel.removeChild(this.customizePanel.firstChild);}
$(this.customizePanel).append(content);if(this._currentTab===this.tabs.OPTIONS&&!options.forceEmptyTab){this._addToolbar();}}
this.$('.o_snippet_search_filter').toggleClass('d-none',this._currentTab!==this.tabs.BLOCKS);this.$('#o_scroll').toggleClass('d-none',this._currentTab!==this.tabs.BLOCKS);this.customizePanel.classList.toggle('d-none',this._currentTab===this.tabs.BLOCKS);this.$('#snippets_menu button').removeClass('active');this.$('.o_we_add_snippet_btn').toggleClass('active',this._currentTab===this.tabs.BLOCKS);this.$('.o_we_customize_snippet_btn').toggleClass('active',this._currentTab===this.tabs.OPTIONS);},async _scrollToSnippet($el,$scrollable){return dom.scrollTo($el[0],{extraOffset:50,$scrollable:$scrollable});},_createLoadingElement(){const loaderContainer=document.createElement('div');const loader=document.createElement('i');const loaderContainerClassList=['o_we_ui_loading','d-flex','justify-content-center','align-items-center',];const loaderClassList=['fa','fa-circle-o-notch','fa-spin','fa-4x',];loaderContainer.classList.add(...loaderContainerClassList);loader.classList.add(...loaderClassList);loaderContainer.appendChild(loader);return loaderContainer;},async _execWithLoadingEffect(action,contentLoading=true,delay=500){const mutexExecResult=this._mutex.exec(action);if(!this.loadingTimers[contentLoading]){const addLoader=()=>{if(this._loadingEffectDisabled||this.loadingElements[contentLoading]){return;}
this.loadingElements[contentLoading]=this._createLoadingElement();if(contentLoading){this.$snippetEditorArea.append(this.loadingElements[contentLoading]);}else{this.el.appendChild(this.loadingElements[contentLoading]);}};if(delay){this.loadingTimers[contentLoading]=setTimeout(addLoader,delay);}else{addLoader();}
this._mutex.getUnlockedDef().then(()=>{if(delay){clearTimeout(this.loadingTimers[contentLoading]);this.loadingTimers[contentLoading]=undefined;}
if(this.loadingElements[contentLoading]){this.loadingElements[contentLoading].remove();this.loadingElements[contentLoading]=null;}});}
return mutexExecResult;},_activateEmptyOptionsTab(){this._updateRightPanelContent({content:this.emptyOptionsTabContent,tab:this.tabs.OPTIONS,forceEmptyTab:true,});},_onActivateInsertionZones:function(ev){this._activateInsertionZones(ev.data.$selectorSiblings,ev.data.$selectorChildren);},_onActivateSnippet:function(ev){const prom=this._activateSnippet(ev.data.$snippet,ev.data.previewMode,ev.data.ifInactiveOptions);if(ev.data.onSuccess){prom.then(()=>ev.data.onSuccess());}},_onCallForEachChildSnippet:function(ev){const prom=this._callForEachChildSnippet(ev.data.$snippet,ev.data.callback);if(ev.data.onSuccess){prom.then(()=>ev.data.onSuccess());}},_onOverlaysCoverUpdate:function(ev){this.snippetEditors.forEach(editor=>{if(ev.data.overlayVisible){editor.toggleOverlayVisibility(true);}
editor.cover();});},_onCloneSnippet:async function(ev){ev.stopPropagation();const editor=await this._createSnippetEditor(ev.data.$snippet);await editor.clone();if(ev.data.onSuccess){ev.data.onSuccess();}},_onDeactivateSnippet:function(){this._activateSnippet(false);},_onSnippetDragAndDropStart:function(){this.snippetEditorDragging=true;},_onSnippetDragAndDropStop:async function(ev){this.snippetEditorDragging=false;const $modal=ev.data.$snippet.closest('.modal');await this._destroyEditors($modal.length?$modal:null);await this._activateSnippet(ev.data.$snippet);},_onHideOverlay:function(){for(const editor of this.snippetEditors){editor.toggleOverlay(false);}},_onInstallBtnClick:function(ev){var self=this;var $snippet=$(ev.currentTarget).closest('[data-module-id]');var moduleID=$snippet.data('moduleId');var name=$snippet.attr('name');new Dialog(this,{title:_.str.sprintf(_t("Install %s"),name),size:'medium',$content:$('<div/>',{text:_.str.sprintf(_t("Do you want to install the %s App?"),name)}).append($('<a/>',{target:'_blank',href:'/web#id='+moduleID+'&view_type=form&model=ir.module.module&action=base.open_module_tree',text:_t("More info about this app."),class:'ml4',})),buttons:[{text:_t("Save and Install"),classes:'btn-primary',click:function(){this.$footer.find('.btn').toggleClass('o_hidden');this._rpc({model:'ir.module.module',method:'button_immediate_install',args:[[moduleID]],}).then(()=>{self.trigger_up('request_save',{reloadEditor:true,_toMutex:true,});}).guardedCatch(reason=>{reason.event.preventDefault();this.close();self.displayNotification({message:_.str.sprintf(_t("Could not install module <strong>%s</strong>"),owl.utils.escape(name)),type:'danger',sticky:true,messageIsHtml:true,});});},},{text:_t("Install in progress"),icon:'fa-spin fa-circle-o-notch fa-spin mr8',classes:'btn-primary disabled o_hidden',},{text:_t("Cancel"),close:true,}],}).open();},_onInvisibleEntryClick:async function(ev){ev.preventDefault();const $snippet=$(this.invisibleDOMMap.get(ev.currentTarget));const isVisible=await this._execWithLoadingEffect(async()=>{const editor=await this._createSnippetEditor($snippet);return editor.toggleTargetVisibility();},true);$(ev.currentTarget).find('.fa').toggleClass('fa-eye',isVisible).toggleClass('fa-eye-slash',!isVisible);return this._activateSnippet(isVisible?$snippet:false);},_onBlocksTabClick:function(ev){this._activateSnippet(false).then(()=>{this._updateRightPanelContent({content:[],tab:this.tabs.BLOCKS,});});},_onOptionsTabClick:function(ev){if(!ev.currentTarget.classList.contains('active')){this._activateEmptyOptionsTab();}},_onDeleteBtnClick:function(ev){const $snippet=$(ev.target).closest('.oe_snippet');const snippetId=parseInt(ev.currentTarget.dataset.snippetId);ev.stopPropagation();new Dialog(this,{size:'medium',title:_t('Confirmation'),$content:$('<div><p>'+_.str.sprintf(_t("Are you sure you want to delete the snippet: %s ?"),$snippet.attr('name'))+'</p></div>'),buttons:[{text:_t("Yes"),close:true,classes:'btn-primary',click:async()=>{await this._rpc({model:'ir.ui.view',method:'delete_snippet',kwargs:{'view_id':snippetId,'template_key':this.options.snippets,},});await this._loadSnippetsTemplates(true);},},{text:_t("No"),close:true,}],}).open();},_onRenameBtnClick:function(ev){const $snippet=$(ev.target).closest('.oe_snippet');const snippetName=$snippet.attr('name');const confirmText=_t('Confirm');const cancelText=_t('Cancel');const $input=$(`
            <we-input class="o_we_user_value_widget w-100 mx-1">
                <div>
                    <input type="text" autocomplete="chrome-off" value="${snippetName}" class="text-left"/>
                    <we-button class="o_we_confirm_btn o_we_text_success fa fa-check" title="${confirmText}"/>
                    <we-button class="o_we_cancel_btn o_we_text_danger fa fa-times" title="${cancelText}"/>
                </div>
            </we-input>
        `);$snippet.find('we-button').remove();$snippet.find('span.oe_snippet_thumbnail_title').replaceWith($input);const $textInput=$input.find('input');$textInput.focus();$textInput.select();$snippet.find('.oe_snippet_thumbnail').addClass('o_we_already_dragging');$input.find('.o_we_confirm_btn').click(async()=>{const name=$textInput.val();if(name!==snippetName){this._execWithLoadingEffect(async()=>{await this._rpc({model:'ir.ui.view',method:'rename_snippet',kwargs:{'name':name,'view_id':parseInt(ev.target.dataset.snippetId),'template_key':this.options.snippets,},});},true);}
await this._loadSnippetsTemplates(name!==snippetName);});$input.find('.o_we_cancel_btn').click(async()=>{await this._loadSnippetsTemplates(false);});},_onMouseDown:function(){const $blockedArea=$('#wrapwrap');this.options.wysiwyg.odooEditor.automaticStepSkipStack();$blockedArea.addClass('o_we_no_pointer_events');const reenable=()=>{this.options.wysiwyg.odooEditor.automaticStepSkipStack();$blockedArea.removeClass('o_we_no_pointer_events');};const enableTimeoutID=setTimeout(()=>reenable(),5000);$(document).one('mouseup',()=>{clearTimeout(enableTimeoutID);reenable();});},_onGetSnippetVersions:function(ev){const snippet=this.el.querySelector(`.oe_snippet > [data-snippet="${ev.data.snippetName}"]`);ev.data.onSuccess(snippet&&{vcss:snippet.dataset.vcss,vjs:snippet.dataset.vjs,vxml:snippet.dataset.vxml,});},_onReloadSnippetTemplate:async function(ev){await this._activateSnippet(false);await this._loadSnippetsTemplates(true);},_onBlockPreviewOverlays:function(ev){this._blockPreviewOverlays=true;},_onUnblockPreviewOverlays:function(ev){this._blockPreviewOverlays=false;},_onRemoveSnippet:async function(ev){ev.stopPropagation();const editor=await this._createSnippetEditor(ev.data.$snippet);await editor.removeSnippet(ev.data.shouldRecordUndo);if(ev.data.onSuccess){ev.data.onSuccess();}},_onSaveRequest:function(ev){const data=ev.data||{};if(ev.target===this&&!data._toMutex){return;}
delete data._toMutex;ev.stopPropagation();this._execWithLoadingEffect(()=>{if(data.reloadEditor){data.reload=false;const oldOnSuccess=data.onSuccess;data.onSuccess=async function(){if(oldOnSuccess){await oldOnSuccess.call(this,...arguments);}
window.location.href=window.location.origin+window.location.pathname+'?enable_editor=1';};}
this.trigger_up('request_save',data);},true);},_onSnippetClick(){const $els=this.getEditableArea().find('.oe_structure.oe_empty').addBack('.oe_structure.oe_empty');for(const el of $els){if(!el.children.length){$(el).odooBounce('o_we_snippet_area_animation');}}},_onSnippetEditionRequest:function(ev){this._execWithLoadingEffect(ev.data.exec,true);},_onSnippetEditorDestroyed(ev){ev.stopPropagation();const index=this.snippetEditors.indexOf(ev.target);this.snippetEditors.splice(index,1);},_onSnippetCloned:function(ev){this._updateInvisibleDOM();},_onSnippetRemoved:function(){this._disableUndroppableSnippets();this._updateInvisibleDOM();},_onSnippetOptionUpdate(ev){ev.stopPropagation();(async()=>{const editors=this._enabledEditorHierarchy.filter(editor=>!!editor.$target[0].closest('body'));await Promise.all(editors.map(editor=>editor.updateOptionsUI()));await Promise.all(editors.map(editor=>editor.updateOptionsUIVisibility()));if(editors[0]!==this._enabledEditorHierarchy[0]){this._activateSnippet(editors[0].$target);}
ev.data.onSuccess();})();},_onSnippetOptionVisibilityUpdate:async function(ev){if(!ev.data.show){await this._activateSnippet(false);}
await this._updateInvisibleDOM();},_onSnippetThumbnailURLRequest(ev){const $snippet=this.$snippets.has(`[data-snippet="${ev.data.key}"]`);ev.data.onSuccess($snippet.length?$snippet[0].dataset.oeThumbnail:'');},_onUserValueWidgetOpening:function(){this._closeWidgets();this.el.classList.add('o_we_backdrop');},_onUserValueWidgetClosing:function(){this.el.classList.remove('o_we_backdrop');},_onSnippetSearchInput:function(){this._filterSnippets();},_onSnippetSearchResetClick:function(){this._filterSnippets('');},_addToolbar(toolbarMode="text"){let titleText=_t("Inline Text");switch(toolbarMode){case"image":titleText=_t("Image Formatting");break;case"video":titleText=_t("Video Formatting");break;case"picto":titleText=_t("Icon Formatting");break;}
this.options.wysiwyg.toolbar.el.classList.remove('oe-floating');const $customizeBlock=$('<WE-CUSTOMIZEBLOCK-OPTIONS id="o_we_editor_toolbar_container"/>');const $title=$("<we-title><span>"+titleText+"</span></we-title>");$customizeBlock.append($title);$customizeBlock.append(this.options.wysiwyg.toolbar.$el);$(this.customizePanel).append($customizeBlock);const $customizeTableBlock=$(QWeb.render('web_editor.toolbar.table-options'));this.options.wysiwyg.odooEditor.bindExecCommand($customizeTableBlock[0]);$(this.customizePanel).append($customizeTableBlock);this._$removeFormatButton=this._$removeFormatButton||this.options.wysiwyg.toolbar.$el.find('#removeFormat');$title.append(this._$removeFormatButton);this.options.wysiwyg.toolbar.$el.find('#table').remove();this._checkEditorToolbarVisibility();},_checkEditorToolbarVisibility:function(e){const $toolbarContainer=this.$('#o_we_editor_toolbar_container');const $toolbarTableContainer=this.$('#o-we-editor-table-container');const docSelection=document.getSelection();const $currentSelectionTarget=docSelection&&docSelection.rangeCount>0?$(docSelection.getRangeAt(0).commonAncestorContainer):$();if($currentSelectionTarget.closest('#o_we_editor_toolbar_container').length||(e&&$(e.target).closest('#o_we_editor_toolbar_container').length)){return;}
const selection=this.options.wysiwyg.odooEditor.document.getSelection();const range=selection&&selection.rangeCount&&selection.getRangeAt(0);if(!range||!$(range.commonAncestorContainer).parents('#wrapwrap, .iframe-editor-wrapper .o_editable').length||$(range.commonAncestorContainer).parent('[data-oe-model]:not([data-oe-type="html"]):not([data-oe-field="arch"])').length||(e&&$(e.target).closest('.fa, img').length||this.options.wysiwyg.lastMediaClicked&&$(this.options.wysiwyg.lastMediaClicked).is('.fa, img'))||(this.options.wysiwyg.lastElement&&!this.options.wysiwyg.lastElement.isContentEditable)){$toolbarContainer.hide();}else{$toolbarContainer.show();}
const isInsideTD=!!(range&&$(range.startContainer).closest('.o_editable td').length&&$(range.endContainer).closest('.o_editable td').length);$toolbarTableContainer.toggleClass('d-none',!isInsideTD);},_onDiscardClick:function(){this.trigger_up('request_cancel');},_onMobilePreviewClick:async function(){throw new Error('implement me');},_onUndo:async function(){this.options.wysiwyg.undo();},_onRedo:async function(){this.options.wysiwyg.redo();},_onRequestEditable:function(ev){ev.data.callback($(this.options.wysiwyg.odooEditor.editable));},_onEnableLoadingEffect:function(){this._loadingEffectDisabled=false;},_onDisableLoadingEffect:function(){this._loadingEffectDisabled=true;Object.keys(this.loadingElements).forEach(key=>{if(this.loadingElements[key]){this.loadingElements[key].remove();this.loadingElements[key]=null;}});},});return{SnippetsMenu:SnippetsMenu,SnippetEditor:SnippetEditor,globalSelector:globalSelector,};});;

/* /web_editor/static/src/js/editor/toolbar.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('web_editor.toolbar',function(require){'use strict';var Widget=require('web.Widget');const Toolbar=Widget.extend({xmlDependencies:['/web_editor/static/src/xml/editor.xml'],init:function(parent,template='web_editor.toolbar'){this._super.apply(this,arguments);this.template=template;},});return Toolbar;});;

/* /web_editor/static/src/js/editor/snippets.options.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('web_editor.snippets.options',function(require){'use strict';var core=require('web.core');const{ColorpickerWidget}=require('web.Colorpicker');const Dialog=require('web.Dialog');const{scrollTo}=require('web.dom');const rpc=require('web.rpc');const time=require('web.time');var Widget=require('web.Widget');var ColorPaletteWidget=require('web_editor.ColorPalette').ColorPaletteWidget;const weUtils=require('web_editor.utils');const{normalizeColor,getBgImageURL,backgroundImageCssToParts,backgroundImagePartsToCss,DEFAULT_PALETTE,}=weUtils;var weWidgets=require('wysiwyg.widgets');const{loadImage,loadImageInfo,applyModifications,removeOnImageChangeAttrs,isImageSupportedForProcessing,}=require('web_editor.image_processing');var qweb=core.qweb;var _t=core._t;function _addTitleAndAllowedAttributes(el,title,options){let tooltipEl=el;if(title){const titleEl=_buildTitleElement(title);tooltipEl=titleEl;el.appendChild(titleEl);}
if(options&&options.classes){el.classList.add(...options.classes);}
if(options&&options.tooltip){tooltipEl.title=options.tooltip;}
if(options&&options.placeholder){el.setAttribute('placeholder',options.placeholder);}
if(options&&options.dataAttributes){for(const key in options.dataAttributes){el.dataset[key]=options.dataAttributes[key];}}
return el;}
function _buildElement(tagName,title,options){const el=document.createElement(tagName);return _addTitleAndAllowedAttributes(el,title,options);}
function _buildTitleElement(title){const titleEl=document.createElement('we-title');titleEl.textContent=title;return titleEl;}
const _buildImgElementCache={};async function _buildImgElement(src){if(!(src in _buildImgElementCache)){_buildImgElementCache[src]=(async()=>{if(src.split('.').pop()==='svg'){const response=await window.fetch(src);const text=await response.text();const parser=new window.DOMParser();const xmlDoc=parser.parseFromString(text,'text/xml');return xmlDoc.getElementsByTagName('svg')[0];}else{const imgEl=document.createElement('img');imgEl.src=src;return imgEl;}})();}
const node=await _buildImgElementCache[src];return node.cloneNode(true);}
function _buildRowElement(title,options){const groupEl=_buildElement('we-row',title,options);const rowEl=document.createElement('div');groupEl.appendChild(rowEl);if(options&&options.childNodes){options.childNodes.forEach(node=>rowEl.appendChild(node));}
return groupEl;}
function _buildCollapseElement(title,options){const groupEl=_buildElement('we-collapse',title,options);const titleEl=groupEl.querySelector('we-title');const children=options&&options.childNodes||[];if(titleEl){titleEl.remove();children.unshift(titleEl);}
let i=0;for(i=0;i<children.length;i++){groupEl.appendChild(children[i]);if(children[i].nodeType===Node.ELEMENT_NODE){break;}}
const togglerEl=document.createElement('we-toggler');togglerEl.classList.add('o_we_collapse_toggler');groupEl.appendChild(togglerEl);const containerEl=document.createElement('div');children.slice(i+1).forEach(node=>containerEl.appendChild(node));groupEl.appendChild(containerEl);return groupEl;}
function createPropertyProxy(obj,propertyName,value){return new Proxy(obj,{get:function(obj,prop){if(prop===propertyName){return value;}
return obj[prop];},set:function(obj,prop,val){if(prop===propertyName){return(value=val);}
return Reflect.set(...arguments);},});}
function registerUserValueWidget(widgetName,parent,title,options,$target){const widget=new userValueWidgetsRegistry[widgetName](parent,title,options,$target);parent.registerSubWidget(widget);return widget;}
const NULL_ID='__NULL__';const UserValueWidget=Widget.extend({className:'o_we_user_value_widget',custom_events:{'user_value_update':'_onUserValueNotification',},init:function(parent,title,options,$target){this._super(...arguments);this.title=title;this.options=options;this._userValueWidgets=[];this._value='';this.$target=$target;},async willStart(){await this._super(...arguments);if(this.options.dataAttributes.img){this.imgEl=await _buildImgElement(this.options.dataAttributes.img);}},_makeDescriptive:function(){const $el=this._super(...arguments);const el=$el[0];_addTitleAndAllowedAttributes(el,this.title,this.options);this.containerEl=document.createElement('div');if(this.imgEl){this.containerEl.appendChild(document.createTextNode('\u200B'));this.containerEl.appendChild(this.imgEl);}
el.appendChild(this.containerEl);return $el;},async start(){await this._super(...arguments);if(this.el.classList.contains('o_we_img_animate')){const buildImgExtensionSwitcher=(from,to)=>{const regex=new RegExp(`${from}$`,'i');return ev=>{const img=ev.currentTarget.getElementsByTagName("img")[0];img.src=img.src.replace(regex,to);};};this.$el.on('mouseenter.img_animate',buildImgExtensionSwitcher('png','gif'));this.$el.on('mouseleave.img_animate',buildImgExtensionSwitcher('gif','png'));}},destroy(){if(this.$el){this.$el.off('.img_animate');}
this._super(...arguments);},close:function(){if(!this.el){return;}
this.trigger_up('user_value_widget_closing');this.el.classList.remove('o_we_widget_opened');this._userValueWidgets.forEach(widget=>widget.close());},enable(){this.$el.click();},findWidget:function(name){for(const widget of this._userValueWidgets){if(widget.getName()===name){return widget;}
const depWidget=widget.findWidget(name);if(depWidget){return depWidget;}}
return null;},getActiveValue:function(methodName){return this._value;},getDefaultValue:function(methodName){const possibleValues=this._methodsParams.optionsPossibleValues[methodName];return possibleValues&&possibleValues[0]||'';},getDependencies:function(){return this._dependencies;},getMethodsNames:function(){return this._methodsNames;},getMethodsParams:function(methodName){const params=_.extend({},this._methodsParams);if(methodName){params.possibleValues=params.optionsPossibleValues[methodName]||[];params.activeValue=this.getActiveValue(methodName);params.defaultValue=this.getDefaultValue(methodName);}
return params;},getName:function(){return this._methodsParams.name||'';},getValue:function(methodName){const isActive=this.isActive();if(!methodName||!this._methodsNames.includes(methodName)){return isActive?'true':'';}
if(isActive){return this.getActiveValue(methodName);}
return this.getDefaultValue(methodName);},isActive:function(){return this._value&&this._value!==NULL_ID;},isContainer:function(){return false;},isPreviewed:function(){const focusEl=document.activeElement;if(focusEl&&focusEl.tagName==='INPUT'&&(this.el===focusEl||this.el.contains(focusEl))){return true;}
return this.el.classList.contains('o_we_preview');},loadMethodsData:function(validMethodNames,extraParams){this._methodsNames=[];this._methodsParams=_.extend({},extraParams);this._methodsParams.optionsPossibleValues={};this._dependencies=[];this._triggerWidgetsNames=[];this._triggerWidgetsValues=[];for(const key in this.el.dataset){const dataValue=this.el.dataset[key].trim();if(key==='dependencies'){this._dependencies.push(...dataValue.split(/\s*,\s*/g));}else if(key==='trigger'){this._triggerWidgetsNames.push(...dataValue.split(/\s*,\s*/g));}else if(key==='triggerValue'){this._triggerWidgetsValues.push(...dataValue.split(/\s*,\s*/g));}else if(validMethodNames.includes(key)){this._methodsNames.push(key);this._methodsParams.optionsPossibleValues[key]=dataValue.split(/\s*\|\s*/g);}else{this._methodsParams[key]=dataValue;}}
this._userValueWidgets.forEach(widget=>{const inheritedParams=_.extend({},this._methodsParams);inheritedParams.optionsPossibleValues=null;widget.loadMethodsData(validMethodNames,inheritedParams);const subMethodsNames=widget.getMethodsNames();const subMethodsParams=widget.getMethodsParams();for(const methodName of subMethodsNames){if(!this._methodsNames.includes(methodName)){this._methodsNames.push(methodName);this._methodsParams.optionsPossibleValues[methodName]=[];}
for(const subPossibleValue of subMethodsParams.optionsPossibleValues[methodName]){this._methodsParams.optionsPossibleValues[methodName].push(subPossibleValue);}}});for(const methodName of this._methodsNames){const arr=this._methodsParams.optionsPossibleValues[methodName];const uniqArr=arr.filter((v,i,arr)=>i===arr.indexOf(v));this._methodsParams.optionsPossibleValues[methodName]=uniqArr;}
this._methodsNames.sort();},notifyValueChange:function(previewMode,isSimulatedEvent){if(!this._methodsNames.length){console.warn('UserValueWidget with no methods notifying value change');}
const isPreviewed=this.isPreviewed();if(!previewMode&&!isPreviewed){this.notifyValueChange(true);}
const data={previewMode:previewMode||false,isSimulatedEvent:!!isSimulatedEvent,};if(previewMode===true||previewMode===false){data.prepare=()=>this.el.classList.add('o_we_preview');}else if(previewMode==='reset'){data.prepare=()=>this.el.classList.remove('o_we_preview');}
this.trigger_up('user_value_update',data);},open(){this.trigger_up('user_value_widget_opening');this.el.classList.add('o_we_widget_opened');},registerSubWidget:function(widget){this._userValueWidgets.push(widget);},async setValue(value,methodName){this._value=value;this.el.classList.remove('o_we_preview');},toggleVisibility:function(show){this.el.classList.toggle('d-none',!show);},_handleNotifierEvent:function(ev){if(!ev){return true;}
if(ev._seen){return false;}
ev._seen=true;if(ev.preventDefault){ev.preventDefault();}
return true;},_onUserValueChange:function(ev){if(this._handleNotifierEvent(ev)){this.notifyValueChange(false);}},_onUserValueNotification:function(ev){ev.data.widget=this;if(!ev.data.triggerWidgetsNames){ev.data.triggerWidgetsNames=[];}
ev.data.triggerWidgetsNames.push(...this._triggerWidgetsNames);if(!ev.data.triggerWidgetsValues){ev.data.triggerWidgetsValues=[];}
ev.data.triggerWidgetsValues.push(...this._triggerWidgetsValues);},_onUserValuePreview:function(ev){if(this._handleNotifierEvent(ev)){this.notifyValueChange(true);}},_onUserValueReset:function(ev){if(this._handleNotifierEvent(ev)){this.notifyValueChange('reset');}},});const ButtonUserValueWidget=UserValueWidget.extend({tagName:'we-button',events:{'click':'_onButtonClick','click [role="button"]':'_onInnerButtonClick','mouseenter':'_onUserValuePreview','mouseleave':'_onUserValueReset',},async willStart(){await this._super(...arguments);if(this.options.dataAttributes.activeImg){this.activeImgEl=await _buildImgElement(this.options.dataAttributes.activeImg);}},_makeDescriptive(){const $el=this._super(...arguments);if(this.imgEl){$el[0].classList.add('o_we_icon_button');}
if(this.activeImgEl){this.containerEl.appendChild(this.activeImgEl);}
return $el;},start:function(parent,title,options){if(this.options&&this.options.childNodes){this.options.childNodes.forEach(node=>this.containerEl.appendChild(node));}
return this._super(...arguments);},getActiveValue:function(methodName){const possibleValues=this._methodsParams.optionsPossibleValues[methodName];return possibleValues&&possibleValues[possibleValues.length-1]||'';},isActive:function(){return(this.isPreviewed()!==this.el.classList.contains('active'));},loadMethodsData:function(validMethodNames){this._super.apply(this,arguments);for(const methodName of this._methodsNames){const possibleValues=this._methodsParams.optionsPossibleValues[methodName];if(possibleValues.length<=1){possibleValues.unshift('');}}},async setValue(value,methodName){await this._super(...arguments);let active=!!value;if(methodName){if(!this._methodsNames.includes(methodName)){return;}
active=(this.getActiveValue(methodName)===value);}
if(this.imgEl&&this.activeImgEl){this.imgEl.classList.toggle('d-none',active);this.activeImgEl.classList.toggle('d-none',!active);}
this.el.classList.toggle('active',active);},_onButtonClick:function(ev){if(!ev._innerButtonClicked){this._onUserValueChange(ev);}},_onInnerButtonClick:function(ev){ev._innerButtonClicked=true;},});const CheckboxUserValueWidget=ButtonUserValueWidget.extend({className:(ButtonUserValueWidget.prototype.className||'')+' o_we_checkbox_wrapper',start:function(){const checkboxEl=document.createElement('we-checkbox');this.containerEl.appendChild(checkboxEl);return this._super(...arguments);},enable(){this.$('we-checkbox').click();},_onButtonClick(ev){if(!ev.target.closest('we-title, we-checkbox')){return;}
return this._super(...arguments);},});const BaseSelectionUserValueWidget=UserValueWidget.extend({async start(){await this._super(...arguments);this.menuEl=document.createElement('we-selection-items');if(this.options&&this.options.childNodes){this.options.childNodes.forEach(node=>{if(node){if(node.nodeType===Node.ELEMENT_NODE){node.insertBefore(document.createTextNode('\u200B'),node.firstChild);}
this.menuEl.appendChild(node);}});}
this.containerEl.appendChild(this.menuEl);},getMethodsParams(methodName){const params=this._super(...arguments);const activeWidget=this._getActiveSubWidget();if(!activeWidget){return params;}
return Object.assign(activeWidget.getMethodsParams(...arguments),params);},getValue(methodName){const activeWidget=this._getActiveSubWidget();if(activeWidget){return activeWidget.getActiveValue(methodName);}
return this._super(...arguments);},isContainer(){return true;},async setValue(value,methodName){const _super=this._super.bind(this);for(const widget of this._userValueWidgets){await widget.setValue(NULL_ID,methodName);}
for(const widget of[...this._userValueWidgets].reverse()){await widget.setValue(value,methodName);if(widget.isActive()){break;}}
await _super(...arguments);},_getActiveSubWidget(){const previewedWidget=this._userValueWidgets.find(widget=>widget.isPreviewed());if(previewedWidget){return previewedWidget;}
return this._userValueWidgets.find(widget=>widget.isActive());},});const SelectUserValueWidget=BaseSelectionUserValueWidget.extend({tagName:'we-select',events:{'click':'_onClick',},async start(){await this._super(...arguments);if(this.options&&this.options.valueEl){this.containerEl.insertBefore(this.options.valueEl,this.menuEl);}
this.menuTogglerEl=document.createElement('we-toggler');this.menuTogglerEl.appendChild(document.createTextNode('\u200B'));this.iconEl=this.imgEl||null;const icon=this.el.dataset.icon;if(icon){this.iconEl=document.createElement('i');this.iconEl.classList.add('fa','fa-fw',icon);}
if(this.iconEl){this.el.classList.add('o_we_icon_select');this.menuTogglerEl.appendChild(this.iconEl);}
this.containerEl.insertBefore(this.menuTogglerEl,this.menuEl);const dropdownCaretEl=document.createElement('span');dropdownCaretEl.classList.add('o_we_dropdown_caret');this.containerEl.appendChild(dropdownCaretEl);},close:function(){this._super(...arguments);if(this.menuTogglerEl){this.menuTogglerEl.classList.remove('active');}},isPreviewed:function(){return this._super(...arguments)||this.menuTogglerEl.classList.contains('active');},open(){this._super(...arguments);this.menuTogglerEl.classList.add('active');},async setValue(){await this._super(...arguments);if(this.iconEl){return;}
if(this.menuTogglerItemEl){this.menuTogglerItemEl.remove();this.menuTogglerItemEl=null;}
let textContent='\u200B';const activeWidget=this._userValueWidgets.find(widget=>!widget.isPreviewed()&&widget.isActive());if(activeWidget){const svgTag=activeWidget.el.querySelector('svg');const value=(activeWidget.el.dataset.selectLabel||(!svgTag&&activeWidget.el.textContent.replace('\u200B','').trim()));const imgSrc=activeWidget.el.dataset.img;if(value){textContent=value;}else if(imgSrc){this.menuTogglerItemEl=document.createElement('img');this.menuTogglerItemEl.src=imgSrc;}else{const fakeImgEl=activeWidget.el.querySelector('.o_we_fake_img_item');if(fakeImgEl){this.menuTogglerItemEl=fakeImgEl.cloneNode(true);}}}else{textContent="/";}
this.menuTogglerEl.textContent=textContent;if(this.menuTogglerItemEl){this.menuTogglerEl.appendChild(this.menuTogglerItemEl);}},enable(){if(!this.menuTogglerEl.classList.contains('active')){this.menuTogglerEl.click();}},_shouldIgnoreClick(ev){return!!ev.target.closest('[role="button"]');},_onClick:function(ev){if(this._shouldIgnoreClick(ev)){return;}
if(!this.menuTogglerEl.classList.contains('active')){this.open();}else{this.close();}
const activeButton=this._userValueWidgets.find(widget=>widget.isActive());if(activeButton){this.menuEl.scrollTop=activeButton.el.offsetTop-(this.menuEl.offsetHeight/2);}},});const ButtonGroupUserValueWidget=BaseSelectionUserValueWidget.extend({tagName:'we-button-group',});const UnitUserValueWidget=UserValueWidget.extend({start:async function(){const unit=this.el.dataset.unit||'';this.el.dataset.unit=unit;if(this.el.dataset.saveUnit===undefined){this.el.dataset.saveUnit=unit;}
return this._super(...arguments);},getActiveValue:function(methodName){const activeValue=this._super(...arguments);const params=this._methodsParams;if(!params.unit){return activeValue;}
const defaultValue=this.getDefaultValue(methodName,false);return activeValue.split(/\s+/g).map(v=>{const numValue=parseFloat(v);if(isNaN(numValue)){return defaultValue;}else{const value=weUtils.convertNumericToUnit(numValue,params.unit,params.saveUnit,params.cssProperty,this.$target);return`${this._floatToStr(value)}${params.saveUnit}`;}}).join(' ');},getDefaultValue:function(methodName,useInputUnit){const defaultValue=this._super(...arguments);const params=this._methodsParams;if(!params.unit){return defaultValue;}
const unit=useInputUnit?params.unit:params.saveUnit;const numValue=weUtils.convertValueToUnit(defaultValue||'0',unit,params.cssProperty,this.$target);if(isNaN(numValue)){return defaultValue;}
return`${this._floatToStr(numValue)}${unit}`;},isActive:function(){const isSuperActive=this._super(...arguments);const params=this._methodsParams;if(!params.unit){return isSuperActive;}
return isSuperActive&&this._floatToStr(parseFloat(this._value))!=='0';},async setValue(value,methodName){const params=this._methodsParams;if(params.unit){value=value.split(' ').map(v=>{const numValue=weUtils.convertValueToUnit(v,params.unit,params.cssProperty,this.$target);if(isNaN(numValue)){return'';}
return this._floatToStr(numValue);}).join(' ');}
return this._super(value,methodName);},_floatToStr:function(value){return`${parseFloat(value.toFixed(5))}`;},});const InputUserValueWidget=UnitUserValueWidget.extend({tagName:'we-input',events:{'input input':'_onInputInput','blur input':'_onInputBlur','keydown input':'_onInputKeydown',},start:async function(){await this._super(...arguments);const unit=this.el.dataset.unit;this.inputEl=document.createElement('input');this.inputEl.setAttribute('type','text');this.inputEl.setAttribute('autocomplete','chrome-off');this.inputEl.setAttribute('placeholder',this.el.getAttribute('placeholder')||'');this.inputEl.classList.toggle('text-left',!unit);this.inputEl.classList.toggle('text-right',!!unit);this.containerEl.appendChild(this.inputEl);var unitEl=document.createElement('span');unitEl.textContent=unit;this.containerEl.appendChild(unitEl);if(unit.length>3){this.el.classList.add('o_we_large');}},async setValue(){await this._super(...arguments);this.inputEl.value=this._value;},_onInputInput:function(ev){this._value=this.inputEl.value;this._onUserValuePreview(ev);},_onInputBlur:function(ev){setTimeout(()=>{if(ev.currentTarget===document.activeElement){return;}
this._onUserValueChange(ev);});},_onInputKeydown:function(ev){switch(ev.which){case $.ui.keyCode.ENTER:{this._onUserValueChange(ev);break;}
case $.ui.keyCode.UP:case $.ui.keyCode.DOWN:{const input=ev.currentTarget;const params=this._methodsParams;if(!params.unit&&!params.step){break;}
let value=parseFloat(input.value||input.placeholder);if(isNaN(value)){value=0.0;}
let step=parseFloat(params.step);if(isNaN(step)){step=1.0;}
value+=(ev.which===$.ui.keyCode.UP?step:-step);input.value=this._floatToStr(value);$(input).trigger('input');break;}}},});const MultiUserValueWidget=UserValueWidget.extend({tagName:'we-multi',start:function(){if(this.options&&this.options.childNodes){this.options.childNodes.forEach(node=>this.containerEl.appendChild(node));}
return this._super(...arguments);},getValue:function(methodName){const value=this._userValueWidgets.map(widget=>{return widget.getValue(methodName);}).join(' ').trim();return value||this._super(...arguments);},isContainer:function(){return true;},async setValue(value,methodName){let values=value.split(/\s*\|\s*/g);if(values.length===1){values=value.split(/\s+/g);}
for(let i=0;i<this._userValueWidgets.length-1;i++){await this._userValueWidgets[i].setValue(values.shift()||'',methodName);}
await this._userValueWidgets[this._userValueWidgets.length-1].setValue(values.join(' '),methodName);},});const ColorpickerUserValueWidget=SelectUserValueWidget.extend({className:(SelectUserValueWidget.prototype.className||'')+' o_we_so_color_palette',custom_events:_.extend({},SelectUserValueWidget.prototype.custom_events,{'custom_color_picked':'_onCustomColorPicked','color_picked':'_onColorPicked','color_hover':'_onColorHovered','color_leave':'_onColorLeft','enter_key_color_colorpicker':'_onEnterKey'}),start:async function(){const _super=this._super.bind(this);const args=arguments;if(this.options.dataAttributes.lazyPalette==='true'){this.colorPalette=new Widget(this);this.colorPalette.getColorNames=()=>[];await this.colorPalette.appendTo(document.createDocumentFragment());}else{await this._renderColorPalette();}
this.colorPreviewEl=document.createElement('span');this.colorPreviewEl.classList.add('o_we_color_preview');this.options.childNodes=[this.colorPalette.el];this.options.valueEl=this.colorPreviewEl;return _super(...args);},open:function(){if(this.colorPalette.setSelectedColor){this.colorPalette.setSelectedColor(this._ccValue,this._value);}else{this._colorPaletteRenderPromise=this._renderColorPalette();}
this._super(...arguments);},close:function(){this._super(...arguments);if(this._customColorValue&&this._customColorValue!==this._value){this._value=this._customColorValue;this._customColorValue=false;this._onUserValueChange();}},getMethodsParams:function(){return _.extend(this._super(...arguments),{colorNames:this.colorPalette.getColorNames(),});},getValue:function(methodName){const isCCMethod=(this._methodsParams.withCombinations===methodName);let value=this._super(...arguments);if(isCCMethod){value=this._ccValue;}else if(typeof this._customColorValue==='string'){value=this._customColorValue;}
if(typeof this._previewColor==='string'){return isCCMethod?this._previewCC:this._previewColor;}
if(value){const useCssColor=this.options.dataAttributes.hasOwnProperty('useCssColor');const cssCompatible=this.options.dataAttributes.hasOwnProperty('cssCompatible');if((useCssColor||cssCompatible)&&!ColorpickerWidget.isCSSColor(value)){if(useCssColor){value=weUtils.getCSSVariableValue(value);}else{value=`var(--${value})`;}}}
return value;},isContainer:function(){return false;},isActive:function(){return!!this._ccValue||!weUtils.areCssValuesEqual(this._value,'rgba(0, 0, 0, 0)');},async setValue(color,methodName,...rest){const isCCMethod=(this._methodsParams.withCombinations===methodName);await this._super(isCCMethod?this._value:color,methodName,...rest);if(isCCMethod){this._ccValue=color;}
await this._colorPaletteRenderPromise;const classes=weUtils.computeColorClasses(this.colorPalette.getColorNames());this.colorPreviewEl.classList.remove(...classes);this.colorPreviewEl.style.removeProperty('background-color');this.colorPreviewEl.style.removeProperty('background-image');if(this._ccValue){this.colorPreviewEl.classList.add('o_cc',`o_cc${this._ccValue}`);}
if(this._value){if(ColorpickerWidget.isCSSColor(this._value)){this.colorPreviewEl.style.backgroundColor=this._value;}else if(!weUtils.isColorGradient(this._value)){this.colorPreviewEl.classList.add(`bg-${this._value}`);}else{this.colorPreviewEl.style.backgroundImage=this._value;}}
if(this.colorPalette.setSelectedColor){this.colorPalette.setSelectedColor(this._ccValue,this._value,false);}},_renderColorPalette:function(){const options={selectedCC:this._ccValue,selectedColor:this._value,};if(this.options.dataAttributes.excluded){options.excluded=this.options.dataAttributes.excluded.replace(/ /g,'').split(',');}
if(this.options.dataAttributes.opacity){options.opacity=this.options.dataAttributes.opacity;}
if(this.options.dataAttributes.withCombinations){options.withCombinations=!!this.options.dataAttributes.withCombinations;}
if(this.options.dataAttributes.withGradients){options.withGradients=!!this.options.dataAttributes.withGradients;}
if(this.options.dataAttributes.noTransparency){options.noTransparency=!!this.options.dataAttributes.noTransparency;options.excluded=[...(options.excluded||[]),'transparent_grayscale'];}
if(this.options.dataAttributes.selectedTab){options.selectedTab=this.options.dataAttributes.selectedTab;}
const oldColorPalette=this.colorPalette;this.colorPalette=new ColorPaletteWidget(this,options);if(oldColorPalette){return this.colorPalette.insertAfter(oldColorPalette.el).then(()=>{oldColorPalette.destroy();});}
return this.colorPalette.appendTo(document.createDocumentFragment());},_shouldIgnoreClick(ev){return ev.originalEvent.__isColorpickerClick||this._super(...arguments);},_onCustomColorPicked:function(ev){this._customColorValue=ev.data.color;},_onColorPicked:function(ev){this._previewCC=false;this._previewColor=false;this._customColorValue=false;this._ccValue=ev.data.ccValue;this._value=ev.data.color;this._onUserValueChange(ev);},_onColorHovered:function(ev){this._previewCC=ev.data.ccValue;this._previewColor=ev.data.color;this._onUserValuePreview(ev);},_onColorLeft:function(ev){this._previewCC=false;this._previewColor=false;this._onUserValueReset(ev);},_onEnterKey:function(){this.close();},});const MediapickerUserValueWidget=UserValueWidget.extend({tagName:'we-button',events:{'click':'_onEditMedia',},async start(){await this._super(...arguments);if(this.options.dataAttributes.buttonStyle){const iconEl=document.createElement('i');iconEl.classList.add('fa','fa-fw','fa-camera');$(this.containerEl).prepend(iconEl);}else{this.el.classList.add('o_we_no_toggle','o_we_bg_success');this.containerEl.textContent=_t("Replace");}},_openDialog(el,{images=false,videos=false}){el.src=this._value;const $editable=this.$target.closest('.o_editable');const mediaDialog=new weWidgets.MediaDialog(this,{noImages:!images,noVideos:!videos,noIcons:true,noDocuments:true,isForBgVideo:true,vimeoPreviewIds:['299225971','414790269','420192073','368484050','334729960','417478345','312451183','415226028','367762632','340475898','374265101','370467553'],'res_model':$editable.data('oe-model'),'res_id':$editable.data('oe-id'),},el).open();return mediaDialog;},async setValue(){await this._super(...arguments);this.el.classList.toggle('active',this.isActive());},_onEditMedia:function(ev){},});const ImagepickerUserValueWidget=MediapickerUserValueWidget.extend({_onEditMedia(ev){const dummyEl=document.createElement('img');const dialog=this._openDialog(dummyEl,{images:true});dialog.on('save',this,data=>{this._value=dummyEl.getAttribute('src');this._onUserValueChange();});},});const VideopickerUserValueWidget=MediapickerUserValueWidget.extend({_onEditMedia(ev){const dummyEl=document.createElement('iframe');const dialog=this._openDialog(dummyEl,{videos:true});dialog.on('save',this,data=>{this._value=data.bgVideoSrc;this._onUserValueChange();});},});const DatetimePickerUserValueWidget=InputUserValueWidget.extend({events:{'blur input':'_onInputBlur','change.datetimepicker':'_onDateTimePickerChange','error.datetimepicker':'_onDateTimePickerError','input input':'_onDateInputInput',},defaultFormat:time.getLangDatetimeFormat(),init:function(){this._super(...arguments);this._value=moment().unix().toString();this.__libInput=0;},start:async function(){await this._super(...arguments);const datetimePickerId=_.uniqueId('datetimepicker');this.el.classList.add('o_we_large');this.inputEl.classList.add('datetimepicker-input','mx-0','text-left');this.inputEl.setAttribute('id',datetimePickerId);this.inputEl.setAttribute('data-target','#'+datetimePickerId);const datepickersOptions={minDate:moment({y:1000}),maxDate:moment().add(200,'y'),calendarWeeks:true,defaultDate:moment().format(),icons:{close:'fa fa-check primary',},locale:moment.locale(),format:this.defaultFormat,sideBySide:true,buttons:{showClear:true,showClose:true,showToday:true,},widgetParent:'body',allowInputToggle:true,};this.__libInput++;const $input=$(this.inputEl);$input.datetimepicker(datepickersOptions);this.__libInput--;const libObject=$input.data('datetimepicker');const oldFunc=libObject._getTemplate;libObject._getTemplate=function(){const $template=oldFunc.call(this,...arguments);$template.addClass('o_we_no_overlay o_we_datetimepicker');return $template;};},getMethodsParams:function(){return _.extend(this._super(...arguments),{format:this.defaultFormat,});},isPreviewed:function(){return this._super(...arguments)||!!$(this.inputEl).data('datetimepicker').widget;},async setValue(){await this._super(...arguments);let momentObj=null;if(this._value){momentObj=moment.unix(this._value);if(!momentObj.isValid()){momentObj=moment();}}
this.__libInput++;$(this.inputEl).datetimepicker('date',momentObj);this.__libInput--;},_onDateTimePickerChange:function(ev){if(this.__libInput>0){return;}
if(!ev.date||!ev.date.isValid()){this._value='';}else{this._value=ev.date.unix().toString();}
this._onUserValuePreview(ev);},_onDateTimePickerError:function(ev){ev.stopPropagation();},_onDateInputInput(ev){if(!this.inputEl.value){this._value='';this._onUserValuePreview(ev);}},});const DatePickerUserValueWidget=DatetimePickerUserValueWidget.extend({defaultFormat:time.getLangDateFormat(),});const ListUserValueWidget=UserValueWidget.extend({tagName:'we-list',events:{'click we-button.o_we_select_remove_option':'_onRemoveItemClick','click we-button.o_we_list_add_optional':'_onAddCustomItemClick','click we-button.o_we_list_add_existing':'_onAddExistingItemClick','click we-select.o_we_user_value_widget.o_we_add_list_item':'_onAddItemSelectClick','click we-button.o_we_checkbox_wrapper':'_onAddItemCheckboxClick','change table input':'_onListItemChange',},willStart(){if(this.options.createWidget){this.createWidget=this.options.createWidget;this.createWidget.setParent(this);this.registerSubWidget(this.createWidget);}
return this._super(...arguments);},start(){this.addItemTitle=this.el.dataset.addItemTitle||_t("Add");if(this.el.dataset.availableRecords){this.records=JSON.parse(this.el.dataset.availableRecords);}else{this.isCustom=!this.el.dataset.notEditable;}
if(this.el.dataset.defaults||this.el.dataset.hasDefault){this.hasDefault=this.el.dataset.hasDefault||'unique';this.selected=this.el.dataset.defaults?JSON.parse(this.el.dataset.defaults):[];}
this.listTable=document.createElement('table');const tableWrapper=document.createElement('div');tableWrapper.classList.add('o_we_table_wrapper');tableWrapper.appendChild(this.listTable);this.containerEl.appendChild(tableWrapper);this.el.classList.add('o_we_fw');this._makeListItemsSortable();if(this.createWidget){return this.createWidget.appendTo(this.containerEl);}},getMethodsParams(){return _.extend(this._super(...arguments),{records:this.records,});},setValue(){this._super(...arguments);const currentValues=JSON.parse(this._value);this.listTable.innerHTML='';if(this.addItemButton){this.addItemButton.remove();}
if(this.createWidget){const selectedIds=currentValues.map(({id})=>id).filter(id=>typeof id==='number');const selectedIdsDomain=['id','not in',selectedIds];const selectedIdsDomainIndex=this.createWidget.options.domain.findIndex(domain=>domain[0]==='id'&&domain[1]==='not in');if(selectedIdsDomainIndex>-1){this.createWidget.options.domain[selectedIdsDomainIndex]=selectedIdsDomain;}else{this.createWidget.options.domain=[...this.createWidget.options.domain,selectedIdsDomain];}
this.createWidget.setValue('');this.createWidget.inputEl.value='';$(this.createWidget.inputEl).trigger('input');}else{if(this.isCustom){this.addItemButton=document.createElement('we-button');this.addItemButton.textContent=this.addItemTitle;this.addItemButton.classList.add('o_we_list_add_optional');}else{this.addItemButton=document.createElement('we-select');this.addItemButton.classList.add('o_we_user_value_widget','o_we_add_list_item');const divEl=document.createElement('div');this.addItemButton.appendChild(divEl);const togglerEl=document.createElement('we-toggler');togglerEl.textContent=this.addItemTitle;divEl.appendChild(togglerEl);this.selectMenuEl=document.createElement('we-selection-items');divEl.appendChild(this.selectMenuEl);}
this.containerEl.appendChild(this.addItemButton);}
currentValues.forEach(value=>{if(typeof value==='object'){const recordData=value;const{id,display_name}=recordData;delete recordData.id;delete recordData.display_name;this._addItemToTable(id,display_name,recordData);}else{this._addItemToTable(value,value);}});if(!this.createWidget&&!this.isCustom){this._reloadSelectDropdown(currentValues);}
this._makeListItemsSortable();},getValue(methodName){if(this.createWidget&&this.createWidget.getMethodsNames().includes(methodName)){return this.createWidget.getValue(methodName);}
return this._value;},_addItemToTable(id,value=this.el.dataset.defaultValue||_t("Item"),recordData){const trEl=document.createElement('tr');if(!this.el.dataset.unsortable){const draggableEl=document.createElement('we-button');draggableEl.classList.add('o_we_drag_handle','o_we_link','fa','fa-fw','fa-arrows');draggableEl.dataset.noPreview='true';const draggableTdEl=document.createElement('td');draggableTdEl.appendChild(draggableEl);trEl.appendChild(draggableTdEl);}
const inputEl=document.createElement('input');inputEl.type=this.el.dataset.inputType||'text';if(value){inputEl.value=value;}
if(id){inputEl.name=id;}
if(recordData){for(const key of Object.keys(recordData)){inputEl.dataset[key]=recordData[key];}}
inputEl.disabled=!this.isCustom;const buttonEl=document.createElement('we-button');buttonEl.classList.add('o_we_select_remove_option','o_we_link','o_we_text_danger','fa','fa-fw','fa-minus');buttonEl.dataset.removeOption=id;const inputTdEl=document.createElement('td');inputTdEl.classList.add('o_we_list_record_name');inputTdEl.appendChild(inputEl);trEl.appendChild(inputTdEl);if(this.hasDefault){const checkboxEl=document.createElement('we-button');checkboxEl.classList.add('o_we_user_value_widget','o_we_checkbox_wrapper');if(this.selected.includes(id)){checkboxEl.classList.add('active');}
const div=document.createElement('div');const checkbox=document.createElement('we-checkbox');div.appendChild(checkbox);checkboxEl.appendChild(div);checkboxEl.appendChild(checkbox);const checkboxTdEl=document.createElement('td');checkboxTdEl.appendChild(checkboxEl);trEl.appendChild(checkboxTdEl);}
const buttonTdEl=document.createElement('td');buttonTdEl.appendChild(buttonEl);trEl.appendChild(buttonTdEl);this.listTable.appendChild(trEl);},_makeListItemsSortable(){if(this.el.dataset.unsortable){return;}
$(this.listTable).sortable({axis:'y',handle:'.o_we_drag_handle',items:'tr',cursor:'move',opacity:0.6,stop:(event,ui)=>{this._notifyCurrentState();},});},_notifyCurrentState(){const values=[...this.listTable.querySelectorAll('.o_we_list_record_name input')].map(el=>{const id=this.isCustom?el.value:el.name;const idInt=parseInt(id);return Object.assign({id:isNaN(idInt)?id:idInt,name:el.value,display_name:el.value,},el.dataset);});if(this.hasDefault){const checkboxes=[...this.listTable.querySelectorAll('we-button.o_we_checkbox_wrapper.active')];this.selected=checkboxes.map(el=>{const input=el.parentElement.previousSibling.firstChild;const id=input.name||input.value;const idInt=parseInt(id);return isNaN(idInt)?id:idInt;});values.forEach(v=>{v.selected=this.selected.includes(v.id);});}
this._value=JSON.stringify(values);this.notifyValueChange(false);if(!this.createWidget&&!this.isCustom){this._reloadSelectDropdown(values);}},_reloadSelectDropdown(currentValues){this.selectMenuEl.innerHTML='';this.records.forEach(el=>{if(!currentValues.find(v=>v.id===el.id)){const option=document.createElement('we-button');option.classList.add('o_we_list_add_existing');option.dataset.addOption=el.id;option.dataset.noPreview='true';const divEl=document.createElement('div');divEl.textContent=el.display_name;option.appendChild(divEl);this.selectMenuEl.appendChild(option);}});if(!this.selectMenuEl.children.length){const title=document.createElement('we-title');title.textContent=_t("No more records");this.selectMenuEl.appendChild(title);}},_onAddCustomItemClick(){this._addItemToTable();this._notifyCurrentState();},_onAddExistingItemClick(ev){const value=ev.currentTarget.dataset.addOption;this._addItemToTable(value,ev.currentTarget.textContent);this._notifyCurrentState();},_onAddItemSelectClick(ev){ev.currentTarget.querySelector('we-toggler').classList.toggle('active');},_onAddItemCheckboxClick:function(ev){const isActive=ev.currentTarget.classList.contains('active');if(this.hasDefault==='unique'){this.listTable.querySelectorAll('we-button.o_we_checkbox_wrapper.active').forEach(el=>el.classList.remove('active'));}
ev.currentTarget.classList.toggle('active',!isActive);this._notifyCurrentState();},_onListItemChange(){this._notifyCurrentState();},_onRemoveItemClick(ev){const minElements=this.el.dataset.allowEmpty?0:1;if(ev.target.closest('table').querySelectorAll('tr').length>minElements){ev.target.closest('tr').remove();this._notifyCurrentState();}},_onUserValueNotification(ev){const{widget,previewMode,prepare}=ev.data;if(widget&&widget===this.createWidget){if(widget.options.createMethod&&widget.getValue(widget.options.createMethod)){return this._super(ev);}
ev.stopPropagation();if(previewMode){return;}
prepare();const recordData=JSON.parse(widget.getMethodsParams('addRecord').recordData);const{id,display_name}=recordData;delete recordData.id;delete recordData.display_name;this._addItemToTable(id,display_name,recordData);this._notifyCurrentState();}
return this._super(ev);},});const RangeUserValueWidget=UnitUserValueWidget.extend({tagName:'we-range',events:{'change input':'_onInputChange','input input':'_onInputInput',},async start(){await this._super(...arguments);this.input=document.createElement('input');this.input.type="range";let min=this.el.dataset.min&&parseFloat(this.el.dataset.min)||0;let max=this.el.dataset.max&&parseFloat(this.el.dataset.max)||100;const step=this.el.dataset.step&&parseFloat(this.el.dataset.step)||1;if(min>max){[min,max]=[max,min];this.input.classList.add('o_we_inverted_range');}
this._setInputAttributes(min,max,step);this.containerEl.appendChild(this.input);},loadMethodsData(validMethodNames){this._super(...arguments);for(const methodName of this._methodsNames){const possibleValues=this._methodsParams.optionsPossibleValues[methodName];if(possibleValues.length>1){this._setInputAttributes(0,possibleValues.length-1,1);break;}}},async setValue(value,methodName){await this._super(...arguments);const possibleValues=this._methodsParams.optionsPossibleValues[methodName];this.input.value=possibleValues.length>1?possibleValues.indexOf(value):this._value;},getValue(methodName){const value=this._super(...arguments);const possibleValues=this._methodsParams.optionsPossibleValues[methodName];return possibleValues.length>1?possibleValues[+value]:value;},_onInputChange(ev){this._value=ev.target.value;this._onUserValueChange(ev);},_onInputInput(ev){this._value=ev.target.value;this._onUserValuePreview(ev);},_setInputAttributes(min,max,step){this.input.setAttribute('min',min);this.input.setAttribute('max',max);this.input.setAttribute('step',step);},});const SelectPagerUserValueWidget=SelectUserValueWidget.extend({className:(SelectUserValueWidget.prototype.className||'')+' o_we_select_pager',events:Object.assign({},SelectUserValueWidget.prototype.events,{'click .o_we_pager_next, .o_we_pager_prev':'_onPageChange',}),async start(){const _super=this._super.bind(this);this.pages=this.options.childNodes.filter(node=>node.matches&&node.matches('we-select-page'));this.numPages=this.pages.length;const prev=document.createElement('i');prev.classList.add('o_we_pager_prev','fa','fa-chevron-left');this.pageNum=document.createElement('span');this.currentPage=0;const next=document.createElement('i');next.classList.add('o_we_pager_next','fa','fa-chevron-right');const pagerControls=document.createElement('div');pagerControls.classList.add('o_we_pager_controls');pagerControls.appendChild(prev);pagerControls.appendChild(this.pageNum);pagerControls.appendChild(next);this.pageName=document.createElement('b');const pagerHeader=document.createElement('div');pagerHeader.classList.add('o_we_pager_header');pagerHeader.appendChild(this.pageName);pagerHeader.appendChild(pagerControls);await _super(...arguments);this.menuEl.classList.add('o_we_has_pager');$(this.menuEl).prepend(pagerHeader);this._updatePage();},_shouldIgnoreClick(ev){return!!ev.target.closest('.o_we_pager_header')||this._super(...arguments);},_updatePage(){this.pages.forEach((page,i)=>page.classList.toggle('active',i===this.currentPage));this.pageNum.textContent=`${this.currentPage + 1}/${this.numPages}`;const activePage=this.pages.find((page,i)=>i===this.currentPage);this.pageName.textContent=activePage.getAttribute('string');},_onPageChange(ev){ev.preventDefault();ev.stopPropagation();const delta=ev.target.matches('.o_we_pager_next')?1:-1;this.currentPage=(this.currentPage+this.numPages+delta)%this.numPages;this._updatePage();},_onClick(ev){const activeButton=this._getActiveSubWidget();if(activeButton){const currentPage=this.pages.indexOf(activeButton.el.closest('we-select-page'));if(currentPage!==-1){this.currentPage=currentPage;this._updatePage();}}
return this._super(...arguments);},});const Many2oneUserValueWidget=SelectUserValueWidget.extend({className:(SelectUserValueWidget.prototype.className||'')+' o_we_many2one',events:Object.assign({},SelectUserValueWidget.prototype.events,{'input .o_we_m2o_search input':'_onSearchInput','keydown .o_we_m2o_search input':'_onSearchKeydown','click .o_we_m2o_search_more':'_onSearchMoreClick',}),configAttributes:['model','fields','limit','domain','callWith','createMethod'],init(parent,title,options,$target){this.afterSearch=[];this.displayNameCache={};this._rpcCache={};const{dataAttributes}=options;Object.assign(options,{limit:'5',fields:'[]',domain:'[]',callWith:'id',});this.configAttributes.forEach(attr=>{if(dataAttributes.hasOwnProperty(attr)){options[attr]=dataAttributes[attr];delete dataAttributes[attr];}});options.limit=parseInt(options.limit);options.fields=JSON.parse(options.fields);if(!options.fields.includes('display_name')){options.fields.push('display_name');}
options.domain=JSON.parse(options.domain);return this._super(...arguments);},async start(){await this._super(...arguments);this.inputEl=document.createElement('input');this.inputEl.setAttribute('placeholder',_t("Search for records..."));const searchEl=document.createElement('div');searchEl.classList.add('o_we_m2o_search');searchEl.appendChild(this.inputEl);this.menuEl.appendChild(searchEl);this.searchMore=document.createElement('div');this.searchMore.classList.add('o_we_m2o_search_more');this.searchMore.textContent=_t("Search more...");this.searchMore.title=_t("Search to show more records");if(this.options.createMethod){this.createInput=new InputUserValueWidget(this,undefined,{classes:['o_we_large'],dataAttributes:{noPreview:'true'},},this.$target);this.createButton=new ButtonUserValueWidget(this,undefined,{classes:['flex-grow-0'],dataAttributes:{noPreview:'true',[this.options.createMethod]:'',},childNodes:[document.createTextNode(_t("Create"))],},this.$target);this.createButton.isActive=()=>false;await Promise.all([this.createInput.appendTo(document.createDocumentFragment()),this.createButton.appendTo(document.createDocumentFragment()),]);this.registerSubWidget(this.createInput);this.registerSubWidget(this.createButton);this.createWidget=_buildRowElement('',{classes:['o_we_full_row','o_we_m2o_create','p-1'],childNodes:[this.createInput.el,this.createButton.el],});}
return this._search('');},async setValue(value,methodName){await this._super(...arguments);if(this.menuTogglerEl.textContent==='/'){if(value!==''){this.menuTogglerEl.textContent=await this._getDisplayName(parseInt(value));}else{this.menuTogglerEl.textContent=_t("Choose a record...");}}},getValue(methodName){if(methodName===this.options.createMethod&&this.createInput){return this.createInput._value;}
return this._super(...arguments);},isContainer(){return false;},open(){if(this.createInput){this.createInput.setValue('');}
return this._super(...arguments);},async _rpc(){const cacheId=JSON.stringify(...arguments);if(!this._rpcCache[cacheId]){this._rpcCache[cacheId]=this._super(...arguments);}
return this._rpcCache[cacheId];},async _search(needle){this._userValueWidgets=this._userValueWidgets.filter(widget=>!widget.isDestroyed());this._userValueWidgets.filter(widget=>{return widget instanceof ButtonUserValueWidget&&widget.el.parentElement.matches('we-selection-items');}).forEach(button=>{if(button.isPreviewed()){button.notifyValueChange('reset');}
button.destroy();});const recTuples=await this._rpc({model:this.options.model,method:'name_search',kwargs:{name:needle,args:this.options.domain,operator:"ilike",limit:this.options.limit+1,},});const records=await this._rpc({model:this.options.model,method:'read',args:[recTuples.map(([id,_name])=>id),this.options.fields],});records.forEach(record=>{this.displayNameCache[record.id]=record.display_name;});await Promise.all(records.slice(0,this.options.limit).map(async record=>{const buttonDataAttributes=Object.assign({},this.options.dataAttributes);Object.keys(buttonDataAttributes).forEach(key=>{buttonDataAttributes[key]=buttonDataAttributes[key]||record[this.options.callWith];});const buttonWidget=new ButtonUserValueWidget(this,undefined,{dataAttributes:Object.assign({recordData:JSON.stringify(record)},buttonDataAttributes),childNodes:[document.createTextNode(record.display_name)],},this.$target);this.registerSubWidget(buttonWidget);await buttonWidget.appendTo(this.menuEl);if(this._methodsNames){buttonWidget.loadMethodsData(this._methodsNames);}}));if(this._methodsNames){this._methodsNames.forEach(methodName=>{this.setValue(this._value,methodName);});}
const hasMore=records.length>this.options.limit;if(hasMore){this.menuEl.appendChild(this.searchMore);this.searchMore.classList.remove('d-none');}else{this.searchMore.classList.add('d-none');}
if(this.createWidget){this.menuEl.appendChild(this.createWidget);}
this.waitingForSearch=false;this.afterSearch.forEach(cb=>cb());this.afterSearch=[];},async _getDisplayName(recordId){if(!this.displayNameCache.hasOwnProperty(recordId)){this.displayNameCache[recordId]=(await this._rpc({model:this.options.model,method:'read',args:[[recordId],['display_name']],}))[0].display_name;}
return this.displayNameCache[recordId];},_onClick(ev){if(ev.target.closest('.o_we_m2o_search_more, .o_we_m2o_search, .o_we_m2o_create')&&!ev.target.closest('we-button')){ev.stopPropagation();return;}
return this._super(...arguments);},_onSearchInput(ev){clearTimeout(this.searchIntent);this.waitingForSearch=true;this.searchIntent=setTimeout(()=>{this._search(ev.target.value);},500);},_onSearchKeydown(ev){if(ev.which!==$.ui.keyCode.ENTER){return;}
const action=()=>{const firstButton=this.menuEl.querySelector(':scope > we-button');if(firstButton){firstButton.click();}};if(this.waitingForSearch){this.afterSearch.push(action);}else{action();}},_onSearchMoreClick(ev){this.inputEl.focus();},_onUserValueNotification(ev){const{widget}=ev.data;if(widget&&widget===this.createInput){ev.stopPropagation();return;}
if(widget&&widget===this.createButton){if(!this.createInput._value){ev.stopPropagation();}
return;}
if(widget!==this.createButton&&this.createInput){this.createInput._value='';}
return this._super(ev);},});const Many2manyUserValueWidget=UserValueWidget.extend({configAttributes:['model','recordId','m2oField','createMethod','fakem2m'],init(parent,title,options,$target){const{dataAttributes}=options;this.configAttributes.forEach(attr=>{if(dataAttributes.hasOwnProperty(attr)){options[attr]=dataAttributes[attr];delete dataAttributes[attr];}});return this._super(...arguments);},async willStart(){await this._super(...arguments);if(this.options.fakem2m){this.m2oModel=this.options.model;return;}
const{model,recordId,m2oField}=this.options;const[record]=await this._rpc({model:model,method:'read',args:[[parseInt(recordId)],[m2oField]],});const selectedRecordIds=record[m2oField];const[modelData]=await this._rpc({model:'ir.model.fields',method:'search_read',args:[[['model','=',model],['name','=',m2oField]],['relation','field_description']],});this.m2oModel=modelData.relation;this.m2oName=modelData.field_description;const selectedRecords=await this._rpc({model:this.m2oModel,method:'read',args:[selectedRecordIds,['display_name']],});this._value=JSON.stringify(selectedRecords);},async start(){this.el.classList.add('o_we_m2m');const m2oDataAttributes=Object.entries(this.options.dataAttributes).filter(([attrName])=>{return Many2oneUserValueWidget.prototype.configAttributes.includes(attrName);});m2oDataAttributes.push(['model',this.m2oModel],['addRecord',''],['createMethod',this.options.createMethod],);this.createWidget=new Many2oneUserValueWidget(null,undefined,{dataAttributes:Object.fromEntries(m2oDataAttributes),},this.$target);this.listWidget=registerUserValueWidget('we-list',this,undefined,{dataAttributes:{unsortable:'true',notEditable:'true',allowEmpty:'true'},createWidget:this.createWidget,},this.$target);await this.listWidget.appendTo(this.containerEl);this.listWidget.el.querySelector('we-select').style.position='static';this.el.style.position='relative';},loadMethodsData(validMethodNames,...rest){this._super(['addRecord',...validMethodNames],...rest);this._methodsNames=this._methodsNames.filter(name=>name!=='addRecord');},setValue(value,methodName){if(methodName===this.options.createMethod){return this.createWidget.setValue(value,methodName);}
if(!value){value=this._value;}
this._super(value,methodName);this.listWidget.setValue(this._value);},getValue(methodName){return this.listWidget.getValue(methodName);},_onUserValueNotification(ev){const{widget,previewMode}=ev.data;if(!widget){return this._super(ev);}
if(widget===this.listWidget){ev.stopPropagation();this._value=widget._value;this.notifyValueChange(previewMode);}},});const userValueWidgetsRegistry={'we-button':ButtonUserValueWidget,'we-checkbox':CheckboxUserValueWidget,'we-select':SelectUserValueWidget,'we-button-group':ButtonGroupUserValueWidget,'we-input':InputUserValueWidget,'we-multi':MultiUserValueWidget,'we-colorpicker':ColorpickerUserValueWidget,'we-datetimepicker':DatetimePickerUserValueWidget,'we-datepicker':DatePickerUserValueWidget,'we-list':ListUserValueWidget,'we-imagepicker':ImagepickerUserValueWidget,'we-videopicker':VideopickerUserValueWidget,'we-range':RangeUserValueWidget,'we-select-pager':SelectPagerUserValueWidget,'we-many2one':Many2oneUserValueWidget,'we-many2many':Many2manyUserValueWidget,};const SnippetOptionWidget=Widget.extend({tagName:'we-customizeblock-option',events:{'click .o_we_collapse_toggler':'_onCollapseTogglerClick',},custom_events:{'user_value_update':'_onUserValueUpdate','user_value_widget_critical':'_onUserValueWidgetCritical',},isTopOption:false,isTopFirstOption:false,forceNoDeleteButton:false,displayOverlayOptions:false,init:function(parent,$uiElements,$target,$overlay,data,options){this._super.apply(this,arguments);this.$originalUIElements=$uiElements;this.$target=$target;this.$overlay=$overlay;this.data=data;this.options=options;this.className='snippet-option-'+this.data.optionName;this.ownerDocument=this.$target[0].ownerDocument;this._userValueWidgets=[];this._actionQueues=new Map();},willStart:async function(){await this._super(...arguments);return this._renderOriginalXML().then(uiFragment=>{this.uiFragment=uiFragment;});},renderElement:function(){this._super(...arguments);this.el.appendChild(this.uiFragment);this.uiFragment=null;},async onFocus(){},onBuilt:function(){},async onBlur(){},onClone:function(options){},onMove:function(){},onRemove:async function(){},onTargetShow:async function(){},onTargetHide:async function(){},cleanForSave:async function(){},registerSubWidget(widget){this._userValueWidgets.push(widget);},selectClass:function(previewMode,widgetValue,params){for(const classNames of params.possibleValues){if(classNames){this.$target[0].classList.remove(...classNames.trim().split(/\s+/g));}}
if(widgetValue){this.$target[0].classList.add(...widgetValue.trim().split(/\s+/g));}},selectDataAttribute:function(previewMode,widgetValue,params){const value=this._selectAttributeHelper(widgetValue,params);this.$target[0].dataset[params.attributeName]=value;},selectAttribute:function(previewMode,widgetValue,params){const value=this._selectAttributeHelper(widgetValue,params);if(value){this.$target[0].setAttribute(params.attributeName,value);}else{this.$target[0].removeAttribute(params.attributeName);}},selectProperty:function(previewMode,widgetValue,params){if(!params.propertyName){throw new Error('Property name missing');}
const value=this._selectValueHelper(widgetValue,params);this.$target[0][params.propertyName]=value;},selectStyle:async function(previewMode,widgetValue,params){this.$target[0].classList.add('o_we_force_no_transition');const _restoreTransitions=()=>this.$target[0].classList.remove('o_we_force_no_transition');if(params.cssProperty==='background-color'){this.$target.trigger('background-color-event',previewMode);}
let cssProps=weUtils.CSS_SHORTHANDS[params.cssProperty]||[params.cssProperty];for(const cssProp of cssProps){this.$target[0].style.setProperty(cssProp,'');}
if(params.extraClass){this.$target.removeClass(params.extraClass);}
let bgImageParts=undefined;if(params.withGradients&&params.cssProperty==='background-color'){const styles=getComputedStyle(this.$target[0]);bgImageParts=backgroundImageCssToParts(styles['background-image']);delete bgImageParts.gradient;const combined=backgroundImagePartsToCss(bgImageParts);this.$target[0].style.setProperty('background-image','');applyCSS.call(this,'background-image',combined,styles);}
if(params.colorNames&&params.colorPrefix){const colorNames=params.colorNames.filter(name=>!weUtils.isColorCombinationName(name));const classes=weUtils.computeColorClasses(colorNames,params.colorPrefix);this.$target[0].classList.remove(...classes);if(colorNames.includes(widgetValue)){const originalCSSValue=window.getComputedStyle(this.$target[0])[cssProps[0]];const className=params.colorPrefix+widgetValue;this.$target[0].classList.add(className);if(originalCSSValue!==window.getComputedStyle(this.$target[0])[cssProps[0]]){this.$target.addClass(params.extraClass);_restoreTransitions();return;}
this.$target[0].classList.remove(className);}}
const styles=window.getComputedStyle(this.$target[0]);const htmlPropValue=weUtils.getCSSVariableValue(widgetValue);if(htmlPropValue){widgetValue=`var(--${widgetValue})`;}
if(params.withGradients&&params.cssProperty==='background-color'&&weUtils.isColorGradient(widgetValue)){cssProps=['background-image'];bgImageParts.gradient=widgetValue;widgetValue=backgroundImagePartsToCss(bgImageParts);applyCSS.call(this,'background-color','rgba(0, 0, 0, 0)',styles);}
const values=widgetValue.replace(/,\s/g,',').split(/\s+/g);while(values.length<cssProps.length){switch(values.length){case 1:case 2:{values.push(values[0]);break;}
case 3:{values.push(values[1]);break;}
default:{values.push(values[values.length-1]);}}}
let hasUserValue=false;for(let i=cssProps.length-1;i>0;i--){hasUserValue=applyCSS.call(this,cssProps[i],values.pop(),styles)||hasUserValue;}
hasUserValue=applyCSS.call(this,cssProps[0],values.join(' '),styles)||hasUserValue;function applyCSS(cssProp,cssValue,styles){if(!weUtils.areCssValuesEqual(styles[cssProp],cssValue)){this.$target[0].style.setProperty(cssProp,cssValue,'important');return true;}
return false;}
if(params.extraClass){this.$target.toggleClass(params.extraClass,hasUserValue);}
_restoreTransitions();},async selectColorCombination(previewMode,widgetValue,params){if(params.colorNames){const names=params.colorNames.filter(weUtils.isColorCombinationName);const classes=weUtils.computeColorClasses(names);this.$target[0].classList.remove(...classes);if(widgetValue){this.$target[0].classList.add('o_cc',`o_cc${widgetValue}`);}}},$:function(){return this.$target.find.apply(this.$target,arguments);},closeWidgets:function(){this._userValueWidgets.forEach(widget=>widget.close());},findWidget:function(name){for(const widget of this._userValueWidgets){if(widget.getName()===name){return widget;}
const depWidget=widget.findWidget(name);if(depWidget){return depWidget;}}
return null;},notify:function(name,data){if(name==='target'){this.setTarget(data);}},setTarget:function($target){this.$target=$target;},updateUI:async function({noVisibility}={}){const proms=this._userValueWidgets.map(async widget=>{const methodsNames=widget.getMethodsNames();for(const methodName of methodsNames){const params=widget.getMethodsParams(methodName);let obj=this;if(params.applyTo){const $firstSubTarget=this.$(params.applyTo).eq(0);if(!$firstSubTarget.length){continue;}
obj=createPropertyProxy(this,'$target',$firstSubTarget);}
const value=await this._computeWidgetState.call(obj,methodName,params);if(value===undefined){continue;}
const normalizedValue=this._normalizeWidgetValue(value);await widget.setValue(normalizedValue,methodName);}});await Promise.all(proms);if(!noVisibility){await this.updateUIVisibility();}},updateUIVisibility:async function(){const proms=this._userValueWidgets.map(async widget=>{const params=widget.getMethodsParams();let obj=this;if(params.applyTo){const $firstSubTarget=this.$(params.applyTo).eq(0);if(!$firstSubTarget.length){widget.toggleVisibility(false);return;}
obj=createPropertyProxy(this,'$target',$firstSubTarget);}
const allSubWidgets=[widget];let i=0;while(i<allSubWidgets.length){allSubWidgets.push(...allSubWidgets[i]._userValueWidgets);i++;}
const proms=allSubWidgets.map(async widget=>{const show=await this._computeWidgetVisibility.call(obj,widget.getName(),params);if(!show){widget.toggleVisibility(false);return;}
const dependencies=widget.getDependencies();const dependenciesData=[];dependencies.forEach(depName=>{const toBeActive=(depName[0]!=='!');if(!toBeActive){depName=depName.substr(1);}
const widget=this._requestUserValueWidgets(depName,true)[0];if(widget){dependenciesData.push({widget:widget,toBeActive:toBeActive,});}});const dependenciesOK=!dependenciesData.length||dependenciesData.some(depData=>{return(depData.widget.isActive()===depData.toBeActive);});widget.toggleVisibility(dependenciesOK);});return Promise.all(proms);});const showUI=await this._computeVisibility();this.el.classList.toggle('d-none',!showUI);await Promise.all(proms);for(const el of this.$el.find('we-row')){el.classList.toggle('d-none',!$(el).find('> div > .o_we_user_value_widget').not('.d-none').length);}
for(const el of this.$el.find('we-collapse')){const $el=$(el);el.classList.toggle('d-none',$el.children().first().hasClass('d-none'));const hasNoVisibleElInCollapseMenu=!$el.children().last().children().not('.d-none').length;if(hasNoVisibleElInCollapseMenu){this._toggleCollapseEl(el,false);}
el.querySelector('.o_we_collapse_toggler').classList.toggle('d-none',hasNoVisibleElInCollapseMenu);}},async _checkIfWidgetsUpdateNeedWarning(widgets){const messages=[];for(const widget of widgets){const message=widget.getMethodsParams().warnMessage;if(message){messages.push(message);}}
return messages.join(' ');},async _checkIfWidgetsUpdateNeedReload(widgets){return false;},_computeVisibility:async function(){return true;},_computeWidgetState:async function(methodName,params){switch(methodName){case'selectClass':{let maxNbClasses=0;let activeClassNames='';for(const classNames of params.possibleValues){if(!classNames){continue;}
const classes=classNames.split(/\s+/g);if(params.stateToFirstClass){if(this.$target[0].classList.contains(classes[0])){return classNames;}else{continue;}}
if(classes.length>=maxNbClasses&&classes.every(className=>this.$target[0].classList.contains(className))){maxNbClasses=classes.length;activeClassNames=classNames;}}
return activeClassNames;}
case'selectAttribute':case'selectDataAttribute':{const attrName=params.attributeName;let attrValue;if(methodName==='selectAttribute'){attrValue=this.$target[0].getAttribute(attrName);}else if(methodName==='selectDataAttribute'){attrValue=this.$target[0].dataset[attrName];}
attrValue=(attrValue||'').trim();if(params.saveUnit&&!params.withUnit){attrValue=attrValue.split(/\s+/g).map(v=>v+params.saveUnit).join(' ');}
return attrValue||params.attributeDefaultValue||'';}
case'selectStyle':{let usedCC=undefined;if(params.colorPrefix&&params.colorNames){for(const c of params.colorNames){const className=weUtils.computeColorClasses([c],params.colorPrefix)[0];if(this.$target[0].classList.contains(className)){if(weUtils.isColorCombinationName(c)){usedCC=c;continue;}
return c;}}}
this.$target[0].classList.add('o_we_force_no_transition');const _restoreTransitions=()=>this.$target[0].classList.remove('o_we_force_no_transition');const styles=window.getComputedStyle(this.$target[0]);if(params.withGradients&&params.cssProperty==='background-color'){const parts=backgroundImageCssToParts(styles['background-image']);if(parts.gradient){return parts.gradient;}}
const cssProps=weUtils.CSS_SHORTHANDS[params.cssProperty]||[params.cssProperty];const cssValues=cssProps.map(cssProp=>{let value=styles[cssProp].trim();if(cssProp==='box-shadow'){const inset=value.includes('inset');let values=value.replace(/,\s/g,',').replace('inset','').trim().split(/\s+/g);const color=values.find(s=>!s.match(/^\d/));values=values.join(' ').replace(color,'').trim();value=`${color} ${values}${inset ? ' inset' : ''}`;}
return value;});if(cssValues.length===4&&weUtils.areCssValuesEqual(cssValues[3],cssValues[1],params.cssProperty,this.$target)){cssValues.pop();}
if(cssValues.length===3&&weUtils.areCssValuesEqual(cssValues[2],cssValues[0],params.cssProperty,this.$target)){cssValues.pop();}
if(cssValues.length===2&&weUtils.areCssValuesEqual(cssValues[1],cssValues[0],params.cssProperty,this.$target)){cssValues.pop();}
_restoreTransitions();const value=cssValues.join(' ');if(params.cssProperty==='background-color'&&params.withCombinations){if(usedCC){const ccValue=weUtils.getCSSVariableValue(`o-cc${usedCC}-bg`).trim();if(weUtils.areCssValuesEqual(value,ccValue)){return'';}}else{const rgba=ColorpickerWidget.convertCSSColorToRgba(value);if(rgba&&rgba.opacity<0.001){return'';}}}
return value;}
case'selectColorCombination':{if(params.colorNames){for(const c of params.colorNames){if(!weUtils.isColorCombinationName(c)){continue;}
const className=weUtils.computeColorClasses([c])[0];if(this.$target[0].classList.contains(className)){return c;}}}
return'';}}},_computeWidgetVisibility:async function(widgetName,params){if(widgetName==='move_up_opt'||widgetName==='move_left_opt'){return!this.$target.is(':first-child');}
if(widgetName==='move_down_opt'||widgetName==='move_right_opt'){return!this.$target.is(':last-child');}
return true;},_extraInfoFromDescriptionElement:function(el){return{title:el.getAttribute('string'),options:{classes:el.classList,dataAttributes:el.dataset,tooltip:el.title,placeholder:el.getAttribute('placeholder'),childNodes:[...el.childNodes],},};},_normalizeWidgetValue:function(value){value=`${value}`.trim();value=ColorpickerWidget.normalizeCSSColor(value);return value;},_renderCustomWidgets:function(uiFragment){return Promise.resolve();},_renderCustomXML:function(uiFragment){return Promise.resolve();},_renderOriginalXML:async function($xml){const uiFragment=document.createDocumentFragment();($xml||this.$originalUIElements).clone(true).appendTo(uiFragment);await this._renderCustomXML(uiFragment);for(const[itemName,build]of[['we-row',_buildRowElement],['we-collapse',_buildCollapseElement]]){uiFragment.querySelectorAll(itemName).forEach(el=>{const infos=this._extraInfoFromDescriptionElement(el);const groupEl=build(infos.title,infos.options);el.parentNode.insertBefore(groupEl,el);el.parentNode.removeChild(el);});}
await this._renderXMLWidgets(uiFragment);await this._renderCustomWidgets(uiFragment);if(this.isDestroyed()){return uiFragment;}
const validMethodNames=[];for(const key in this){validMethodNames.push(key);}
this._userValueWidgets.forEach(widget=>{widget.loadMethodsData(validMethodNames);});return uiFragment;},_renderXMLWidgets:function(parentEl,parentWidget){const proms=[...parentEl.children].map(el=>{const widgetName=el.tagName.toLowerCase();if(!userValueWidgetsRegistry.hasOwnProperty(widgetName)){return this._renderXMLWidgets(el,parentWidget);}
const infos=this._extraInfoFromDescriptionElement(el);const widget=registerUserValueWidget(widgetName,parentWidget||this,infos.title,infos.options,this.$target);return widget.insertAfter(el).then(()=>{parentEl.removeChild(el);if(widget.isContainer()){return this._renderXMLWidgets(widget.el,widget);}});});return Promise.all(proms);},_requestUserValueWidgets:function(...args){const widgetNames=args;let allowParentOption=false;const lastArg=args[args.length-1];if(typeof lastArg==='boolean'){widgetNames.pop();allowParentOption=lastArg;}
const widgets=[];for(const widgetName of widgetNames){let widget=null;this.trigger_up('user_value_widget_request',{name:widgetName,onSuccess:_widget=>widget=_widget,allowParentOption:allowParentOption,});if(widget){widgets.push(widget);}}
return widgets;},_rerenderXML:async function(callback){this._userValueWidgets.forEach(widget=>widget.destroy());this._userValueWidgets=[];this.$el.empty();let $xml=undefined;if(callback){$xml=await callback.call(this);}
return this._renderOriginalXML($xml).then(uiFragment=>{this.$el.append(uiFragment);return this.updateUI();});},_select:async function(previewMode,widget){let $applyTo=null;if(previewMode===true){this.options.wysiwyg.odooEditor.automaticStepUnactive('preview_option');}
for(const methodName of widget.getMethodsNames()){const widgetValue=widget.getValue(methodName);const params=widget.getMethodsParams(methodName);if(params.applyTo){if(!$applyTo){$applyTo=this.$(params.applyTo);}
const proms=_.map($applyTo,subTargetEl=>{const proxy=createPropertyProxy(this,'$target',$(subTargetEl));return this[methodName].call(proxy,previewMode,widgetValue,params);});await Promise.all(proms);}else{await this[methodName](previewMode,widgetValue,params);}}
if(previewMode==='reset'||previewMode===false){this.options.wysiwyg.odooEditor.automaticStepActive('preview_option');}
($applyTo||this.$target).trigger('content_changed');},_selectAttributeHelper(value,params){if(!params.attributeName){throw new Error('Attribute name missing');}
return this._selectValueHelper(value,params);},_selectValueHelper(value,params){if(params.saveUnit&&!params.withUnit){value=value.split(params.saveUnit).join('');}
if(params.extraClass){this.$target.toggleClass(params.extraClass,params.defaultValue!==value);}
return value;},_toggleCollapseEl(collapseEl,show){collapseEl.classList.toggle('active',show);collapseEl.querySelector('we-toggler.o_we_collapse_toggler').classList.toggle('active',show);},_onCollapseTogglerClick(ev){const currentCollapseEl=ev.currentTarget.closest('we-collapse');this._toggleCollapseEl(currentCollapseEl);for(const collapseEl of currentCollapseEl.querySelectorAll('we-collapse')){this._toggleCollapseEl(collapseEl,false);}},_onUserValueUpdate:async function(ev){ev.stopPropagation();const widget=ev.data.widget;const previewMode=ev.data.previewMode;let requiresReload=false;if(!ev.data.previewMode&&!ev.data.isSimulatedEvent){const linkedWidgets=this._requestUserValueWidgets(...ev.data.triggerWidgetsNames);const widgets=[ev.data.widget].concat(linkedWidgets);const warnMessage=await this._checkIfWidgetsUpdateNeedWarning(widgets);if(warnMessage){const okWarning=await new Promise(resolve=>{Dialog.confirm(this,warnMessage,{confirm_callback:()=>resolve(true),cancel_callback:()=>resolve(false),});});if(!okWarning){return;}}
const reloadMessage=await this._checkIfWidgetsUpdateNeedReload(widgets);requiresReload=!!reloadMessage;if(requiresReload){const save=await new Promise(resolve=>{Dialog.confirm(this,_t("To apply this change, we need to save all your previous modifications and reload the page.")+' '
+(typeof reloadMessage==='string'?reloadMessage:''),{buttons:[{text:_t('Save and Reload'),classes:'btn-primary',close:true,click:()=>resolve(true),},{text:_t("Cancel"),close:true,click:()=>resolve(false)}],});});if(!save){return;}}}
if(!this._actionQueues.get(widget)){this._actionQueues.set(widget,[]);}
const currentAction={previewMode};this._actionQueues.get(widget).push(currentAction);const shouldRecordUndo=(!previewMode&&!ev.data.isSimulatedEvent);if(shouldRecordUndo){this.options.wysiwyg.odooEditor.unbreakableStepUnactive();}
this.trigger_up('snippet_edition_request',{exec:async()=>{if(this.isDestroyed()){return;}
const actionQueue=this._actionQueues.get(widget).filter(({previewMode},i,actions)=>{const prev=actions[i-1];const next=actions[i+1];if(previewMode===true&&next&&next.previewMode){return false;}else if(previewMode==='reset'&&prev&&prev.previewMode){return false;}
return true;});if(!actionQueue.includes(currentAction)){this._actionQueues.set(widget,actionQueue);return;}
this._actionQueues.set(widget,actionQueue.filter(action=>action!==currentAction));if(ev.data.prepare){ev.data.prepare();}
if(previewMode&&(widget.$el.closest('[data-no-preview="true"]').length)){return;}
await this._select(previewMode,widget);if(shouldRecordUndo){this.options.wysiwyg.odooEditor.historyStep();}
if(previewMode){return;}
await new Promise(resolve=>setTimeout(()=>{this.trigger_up('snippet_option_update',{onSuccess:()=>resolve(),});}));}});if(ev.data.isSimulatedEvent){return;}
const linkedWidgets=this._requestUserValueWidgets(...ev.data.triggerWidgetsNames);if(linkedWidgets.length!==ev.data.triggerWidgetsNames.length){console.warn('Missing widget to trigger');return;}
let i=0;const triggerWidgetsValues=ev.data.triggerWidgetsValues;for(const linkedWidget of linkedWidgets){const widgetValue=triggerWidgetsValues[i];if(widgetValue!==undefined){const normValue=this._normalizeWidgetValue(widgetValue);if(previewMode===true){linkedWidget._previewColor=normValue;}else if(previewMode===false){linkedWidget._previewColor=false;linkedWidget._value=normValue;}else{linkedWidget._previewColor=false;}}
linkedWidget.notifyValueChange(previewMode,true);i++;}
if(requiresReload){this.trigger_up('request_save',{reloadEditor:true,});}},_onUserValueWidgetCritical(){this.trigger_up('remove_snippet',{$snippet:this.$target,});},});const registry={};registry.sizing=SnippetOptionWidget.extend({displayOverlayOptions:true,start:function(){var self=this;var def=this._super.apply(this,arguments);this.$handles=this.$overlay.find('.o_handle');var resizeValues=this._getSize();this.$handles.on('mousedown',function(ev){ev.preventDefault();resizeValues=self._getSize();var $handle=$(ev.currentTarget);var compass=false;var XY=false;if($handle.hasClass('n')){compass='n';XY='Y';}else if($handle.hasClass('s')){compass='s';XY='Y';}else if($handle.hasClass('e')){compass='e';XY='X';}else if($handle.hasClass('w')){compass='w';XY='X';}
var resize=resizeValues[compass];if(!resize){return;}
var current=0;var cssProperty=resize[2];var cssPropertyValue=parseInt(self.$target.css(cssProperty));_.each(resize[0],function(val,key){if(self.$target.hasClass(val)){current=key;}else if(resize[1][key]===cssPropertyValue){current=key;}});var begin=current;var beginClass=self.$target.attr('class');var regClass=new RegExp('\\s*'+resize[0][begin].replace(/[-]*[0-9]+/,'[-]*[0-9]+'),'g');var cursor=$handle.css('cursor')+'-important';var $body=$(this.ownerDocument.body);$body.addClass(cursor);var xy=ev['page'+XY];var bodyMouseMove=function(ev){ev.preventDefault();var dd=ev['page'+XY]-xy+resize[1][begin];var next=current+(current+1===resize[1].length?0:1);var prev=current?(current-1):0;var change=false;if(dd>(2*resize[1][next]+resize[1][current])/3){self.$target.attr('class',(self.$target.attr('class')||'').replace(regClass,''));self.$target.addClass(resize[0][next]);current=next;change=true;}
if(prev!==current&&dd<(2*resize[1][prev]+resize[1][current])/3){self.$target.attr('class',(self.$target.attr('class')||'').replace(regClass,''));self.$target.addClass(resize[0][prev]);current=prev;change=true;}
if(change){self._onResize(compass,beginClass,current);self.trigger_up('cover_update');$handle.addClass('o_active');}};var bodyMouseUp=function(){$body.off('mousemove',bodyMouseMove);$body.off('mouseup',bodyMouseUp);$body.removeClass(cursor);$handle.removeClass('o_active');var $handlers=self.$overlay.find('.o_handle');$handlers.addClass('o_active').delay(300).queue(function(){$handlers.removeClass('o_active').dequeue();});if(begin===current){return;}
setTimeout(function(){self.options.wysiwyg.odooEditor.historyStep();},0);};$body.on('mousemove',bodyMouseMove);$body.on('mouseup',bodyMouseUp);});_.each(resizeValues,(value,key)=>{this.$handles.filter('.'+key).toggleClass('readonly',!value);});return def;},onFocus:function(){this._onResize();},setTarget:function(){this._super(...arguments);this._onResize();},_getSize:function(){},_onResize:function(compass,beginClass,current){var self=this;var resizeValues=this._getSize();var $handles=this.$overlay.find('.o_handle');_.each(resizeValues,function(resizeValue,direction){var classes=resizeValue[0];var values=resizeValue[1];var cssProperty=resizeValue[2];var $handle=$handles.filter('.'+direction);var current=0;var cssPropertyValue=parseInt(self.$target.css(cssProperty));_.each(classes,function(className,key){if(self.$target.hasClass(className)){current=key;}else if(values[key]===cssPropertyValue){current=key;}});$handle.toggleClass('o_handle_start',current===0);$handle.toggleClass('o_handle_end',current===classes.length-1);});var ml=this.$target.css('margin-left');this.$overlay.find('.o_handle.w').css({width:ml,left:'-'+ml,});this.$overlay.find('.o_handle.e').css({width:0,});_.each(this.$overlay.find(".o_handle.n, .o_handle.s"),function(handle){var $handle=$(handle);var direction=$handle.hasClass('n')?'top':'bottom';$handle.height(self.$target.css('padding-'+direction));});this.$target.trigger('content_changed');},});registry['sizing_y']=registry.sizing.extend({_getSize:function(){var nClass='pt';var nProp='padding-top';var sClass='pb';var sProp='padding-bottom';if(this.$target.is('hr')){nClass='mt';nProp='margin-top';sClass='mb';sProp='margin-bottom';}
var grid=[];for(var i=0;i<=(256/8);i++){grid.push(i*8);}
grid.splice(1,0,4);this.grid={n:[grid.map(v=>nClass+v),grid,nProp],s:[grid.map(v=>sClass+v),grid,sProp],};return this.grid;},});registry['sizing_x']=registry.sizing.extend({onClone:function(options){this._super.apply(this,arguments);if(options.isCurrent){var _class=this.$target.attr('class').replace(/\s*(offset-xl-|offset-lg-)([0-9-]+)/g,'');this.$target.attr('class',_class);}},_getSize:function(){var width=this.$target.closest('.row').width();var gridE=[1,2,3,4,5,6,7,8,9,10,11,12];var gridW=[0,1,2,3,4,5,6,7,8,9,10,11];this.grid={e:[_.map(gridE,v=>('col-lg-'+v)),_.map(gridE,v=>width/12*v),'width'],w:[_.map(gridW,v=>('offset-lg-'+v)),_.map(gridW,v=>width/12*v),'margin-left'],};return this.grid;},_onResize:function(compass,beginClass,current){if(compass==='w'){var beginCol=Number(beginClass.match(/col-lg-([0-9]+)|$/)[1]||0);var beginOffset=Number(beginClass.match(/offset-lg-([0-9-]+)|$/)[1]||beginClass.match(/offset-xl-([0-9-]+)|$/)[1]||0);var offset=Number(this.grid.w[0][current].match(/offset-lg-([0-9-]+)|$/)[1]||0);if(offset<0){offset=0;}
var colSize=beginCol-(offset-beginOffset);if(colSize<=0){colSize=1;offset=beginOffset+beginCol-1;}
this.$target.attr('class',this.$target.attr('class').replace(/\s*(offset-xl-|offset-lg-|col-lg-)([0-9-]+)/g,''));this.$target.addClass('col-lg-'+(colSize>12?12:colSize));if(offset>0){this.$target.addClass('offset-lg-'+offset);}}
this._super.apply(this,arguments);},});registry.Box=SnippetOptionWidget.extend({setShadow(previewMode,widgetValue,params){this.$target.toggleClass(params.shadowClass,!!widgetValue);const defaultShadow=this._getDefaultShadow(widgetValue,params.shadowClass);this.$target[0].style.setProperty('box-shadow',defaultShadow,'important');if(widgetValue==='outset'){this.$target[0].style.setProperty('box-shadow','');}},_computeWidgetState(methodName,params){if(methodName==='setShadow'){const shadowValue=this.$target.css('box-shadow');if(!shadowValue||shadowValue==='none'){return'';}
return this.$target.css('box-shadow').includes('inset')?'inset':'outset';}
return this._super(...arguments);},async _computeWidgetVisibility(widgetName,params){if(widgetName==='fake_inset_shadow_opt'){return false;}
return this._super(...arguments);},_getDefaultShadow(type,shadowClass){const el=document.createElement('div');if(type){el.classList.add(shadowClass);}
document.body.appendChild(el);switch(type){case'outset':{return $(el).css('box-shadow');}
case'inset':{return $(el).css('box-shadow')+' inset';}}
el.remove();return'';}});registry.layout_column=SnippetOptionWidget.extend({start:function(){this.$el.find('we-button[data-name="zero_cols_opt"]').toggleClass('d-none',!this.$target.is('.s_allow_columns'));return this._super(...arguments);},selectCount:async function(previewMode,widgetValue,params){const previousNbColumns=this.$('> .row').children().length;let $row=this.$('> .row');if(!$row.length){$row=this.$target.contents().wrapAll($('<div class="row"><div class="col-lg-12"/></div>')).parent().parent();}
const nbColumns=parseInt(widgetValue);await this._updateColumnCount($row,(nbColumns||1)-$row.children().length);await new Promise(resolve=>setTimeout(resolve));if(nbColumns===0){$row.contents().unwrap().contents().unwrap();this.trigger_up('activate_snippet',{$snippet:this.$target});}else if(previousNbColumns===0){this.trigger_up('activate_snippet',{$snippet:this.$('> .row').children().first()});}},_computeWidgetState:function(methodName,params){if(methodName==='selectCount'){return this.$('> .row').children().length;}
return this._super(...arguments);},_updateColumnCount:async function($row,count){if(!count){return;}
if(count>0){var $lastColumn=$row.children().last();for(var i=0;i<count;i++){await new Promise(resolve=>{this.trigger_up('clone_snippet',{$snippet:$lastColumn,onSuccess:resolve});});}}else{var self=this;for(const el of $row.children().slice(count)){await new Promise(resolve=>{self.trigger_up('remove_snippet',{$snippet:$(el),onSuccess:resolve,shouldRecordUndo:false});});}}
this._resizeColumns($row.children());this.trigger_up('cover_update');},_resizeColumns:function($columns){const colsLength=$columns.length;var colSize=Math.floor(12/colsLength)||1;var colOffset=Math.floor((12-colSize*colsLength)/2);var colClass='col-lg-'+colSize;_.each($columns,function(column){var $column=$(column);$column.attr('class',$column.attr('class').replace(/\b(col|offset)-lg(-\d+)?\b/g,''));$column.addClass(colClass);});if(colOffset){$columns.first().addClass('offset-lg-'+colOffset);}},});registry.SnippetMove=SnippetOptionWidget.extend({displayOverlayOptions:true,start:function(){var $buttons=this.$el.find('we-button');var $overlayArea=this.$overlay.find('.o_overlay_move_options');$overlayArea.prepend($buttons[0]);$overlayArea.append($buttons[1]);return this._super(...arguments);},onFocus:function(){const $allOptions=this.$el.parent();if($allOptions.find('we-customizeblock-option').length<=1){$allOptions.addClass('d-none');}},moveSnippet:function(previewMode,widgetValue,params){const isNavItem=this.$target[0].classList.contains('nav-item');const $tabPane=isNavItem?$(this.$target.find('.nav-link')[0].hash):null;switch(widgetValue){case'prev':this.$target.prev().before(this.$target);if(isNavItem){$tabPane.prev().before($tabPane);}
break;case'next':this.$target.next().after(this.$target);if(isNavItem){$tabPane.next().after($tabPane);}
break;}
if(!this.$target.is(this.data.noScroll)&&(params.name==='move_up_opt'||params.name==='move_down_opt')){scrollTo(this.$target[0],{extraOffset:50,easing:'linear',duration:550,});}},});registry.ReplaceMedia=SnippetOptionWidget.extend({async replaceMedia(){this.$target.dblclick();},});registry.ImageTools=SnippetOptionWidget.extend({async crop(){this.trigger_up('hide_overlay');this.trigger_up('disable_loading_effect');new weWidgets.ImageCropWidget(this,this.$target[0]).appendTo(this.options.wysiwyg.$editable);await new Promise(resolve=>{this.$target.one('image_cropper_destroyed',resolve);});this.trigger_up('enable_loading_effect');},async transform(){this.trigger_up('hide_overlay');this.trigger_up('disable_loading_effect');const document=this.$target[0].ownerDocument;this.$target.transfo({document});const mousedown=mousedownEvent=>{if(!$(mousedownEvent.target).closest('.transfo-container').length){this.$target.transfo('destroy');$(document).off('mousedown',mousedown);}};$(document).on('mousedown',mousedown);await new Promise(resolve=>{document.addEventListener('mouseup',resolve,{once:true});});this.trigger_up('enable_loading_effect');},async resetCrop(){const cropper=new weWidgets.ImageCropWidget(this,this.$target[0]);await cropper.appendTo(this.options.wysiwyg.$editable);await cropper.reset();},async resetTransform(){this.$target.attr('style',(this.$target.attr('style')||'').replace(/[^;]*transform[\w:]*;?/g,''));},_isTransformed(){return this.$target.is('[style*="transform"]');},_isCropped(){return this.$target.hasClass('o_we_image_cropped');},async _computeWidgetState(methodName,params){if(methodName==='selectStyle'&&params.cssProperty==='width'){const width=this.$target[0].style.width.trim();if(width[width.length-1]==='%'){return`${parseInt(width)}%`;}else{return'';}}else if(methodName==='transform'){return this._isTransformed()?'true':'';}else if(methodName==='crop'){return this._isCropped()?'true':'';}
return this._super(...arguments);},_computeWidgetVisibility(widgetName,params){if(params.optionsPossibleValues.resetTransform){return this._isTransformed();}
if(params.optionsPossibleValues.resetCrop){return this._isCropped();}
return this._super(...arguments);},});const ImageHandlerOption=SnippetOptionWidget.extend({async willStart(){const _super=this._super.bind(this);await this._initializeImage();return _super(...arguments);},async start(){await this._super(...arguments);const weightEl=document.createElement('span');weightEl.classList.add('o_we_image_weight','o_we_tag','d-none');weightEl.title=_t("Size");this.$weight=$(weightEl);},async updateUI(){await this._super(...arguments);if(this._filesize===undefined){await this._applyOptions(false);}
if(this._filesize!==undefined){this.$weight.text(`${this._filesize.toFixed(1)} kb`);this.$weight.removeClass('d-none');this._relocateWeightEl();}},selectWidth(previewMode,widgetValue,params){this._getImg().dataset.resizeWidth=widgetValue;return this._applyOptions();},async setQuality(previewMode,widgetValue,params){if(previewMode){return;}
this._getImg().dataset.quality=widgetValue;return this._applyOptions();},glFilter(previewMode,widgetValue,params){const dataset=this._getImg().dataset;if(widgetValue){dataset.glFilter=widgetValue;}else{delete dataset.glFilter;}
return this._applyOptions();},customFilter(previewMode,widgetValue,params){const img=this._getImg();const{filterOptions}=img.dataset;const{filterProperty}=params;if(filterProperty==='filterColor'){widgetValue=normalizeColor(widgetValue);}
const newOptions=Object.assign(JSON.parse(filterOptions||"{}"),{[filterProperty]:widgetValue});img.dataset.filterOptions=JSON.stringify(newOptions);return this._applyOptions();},_computeVisibility(){const src=this._getImg().getAttribute('src');return src&&src!=='/';},async _computeWidgetState(methodName,params){const img=this._getImg();await new Promise((resolve,reject)=>{if(img.complete){resolve();return;}
img.addEventListener('load',resolve,{once:true});img.addEventListener('error',resolve,{once:true});});switch(methodName){case'selectWidth':return img.naturalWidth;case'setFilter':return img.dataset.filter;case'glFilter':return img.dataset.glFilter||"";case'setQuality':return img.dataset.quality||75;case'customFilter':{const{filterProperty}=params;const options=JSON.parse(img.dataset.filterOptions||"{}");const defaultValue=filterProperty==='blend'?'normal':0;return options[filterProperty]||defaultValue;}}
return this._super(...arguments);},_relocateWeightEl(){},async _renderCustomXML(uiFragment){const img=this._getImg();if(!this.originalSrc||!this._isImageSupportedForProcessing(img)){[...uiFragment.childNodes].forEach(node=>node.remove());return;}
const $select=$(uiFragment).find('we-select[data-name=width_select_opt]');(await this._computeAvailableWidths()).forEach(([value,label])=>{$select.append(`<we-button data-select-width="${value}">${label}</we-button>`);});if(this._getImageMimetype(img)!=='image/jpeg'){uiFragment.querySelector('we-range[data-set-quality]').remove();}},async _computeAvailableWidths(){const img=this._getImg();const original=await loadImage(this.originalSrc);const maxWidth=img.dataset.width?img.naturalWidth:original.naturalWidth;const optimizedWidth=Math.min(maxWidth,this._computeMaxDisplayWidth());this.optimizedWidth=optimizedWidth;const widths={128:'128px',256:'256px',512:'512px',1024:'1024px',1920:'1920px',};widths[img.naturalWidth]=_.str.sprintf(_t("%spx"),img.naturalWidth);widths[optimizedWidth]=_.str.sprintf(_t("%dpx (Suggested)"),optimizedWidth);widths[maxWidth]=_.str.sprintf(_t("%dpx (Original)"),maxWidth);return Object.entries(widths).filter(([width])=>width<=maxWidth).sort(([v1],[v2])=>v1-v2);},async _applyOptions(update=true){const img=this._getImg();if(!update&&!(img&&img.complete)){return;}
if(!this._isImageSupportedForProcessing(img)){this.originalId=null;return;}
const dataURL=await applyModifications(img,{mimetype:this._getImageMimetype(img)});this._filesize=dataURL.split(',')[1].length/4*3/1024;if(update){img.classList.add('o_modified_image_to_save');const loadedImg=await loadImage(dataURL,img);this._applyImage(loadedImg);return loadedImg;}
return img;},async _loadImageInfo(attachmentSrc=''){const img=this._getImg();await loadImageInfo(img,this._rpc.bind(this),attachmentSrc);if(!img.dataset.originalId){this.originalId=null;this.originalSrc=null;return;}
this.originalId=img.dataset.originalId;this.originalSrc=img.dataset.originalSrc;},async _autoOptimizeImage(){await this._loadImageInfo();await this._rerenderXML();this._getImg().dataset.resizeWidth=this.optimizedWidth;await this._applyOptions();await this.updateUI();},_getImg(){},_computeMaxDisplayWidth(){},_applyImage(img){},_getImageMimetype(img){return img.dataset.mimetype;},async _initializeImage(){return this._loadImageInfo();},_isImageSupportedForProcessing(img){return isImageSupportedForProcessing(this._getImageMimetype(img));},});const _addAnimatedShapeLabel=function addAnimatedShapeLabel(containerEl){const labelEl=document.createElement('span');labelEl.classList.add('o_we_shape_animated_label');const labelStr=_t("Animated");labelEl.textContent=labelStr[0];const spanEl=document.createElement('span');spanEl.textContent=labelStr.substr(1);labelEl.appendChild(spanEl);containerEl.classList.add('position-relative');containerEl.appendChild(labelEl);return labelEl;};registry.ImageOptimize=ImageHandlerOption.extend({init(){this.shapeCache={};return this._super(...arguments);},start(){this.$target.on('image_changed.ImageOptimization',this._onImageChanged.bind(this));this.$target.on('image_cropped.ImageOptimization',this._onImageCropped.bind(this));return this._super(...arguments);},destroy(){this.$target.off('.ImageOptimization');return this._super(...arguments);},async setImgShape(previewMode,widgetValue,params){const img=this._getImg();const saveData=previewMode===false;if(widgetValue){await this._loadShape(widgetValue);if(previewMode==='reset'&&img.dataset.shapeColors){await this._applyShapeAndColors(false,img.dataset.shapeColors.split(';'));}else{await this._applyShapeAndColors(saveData);if(saveData&&img.dataset.mimetype!=='image/svg+xml'){img.dataset.originalMimetype=img.dataset.mimetype;img.dataset.mimetype='image/svg+xml';}}}else{img.src=await applyModifications(img,{mimetype:this._getImageMimetype(img)});delete img.dataset.shape;delete img.dataset.shapeColors;delete img.dataset.fileName;if(saveData){img.dataset.mimetype=img.dataset.originalMimetype;delete img.dataset.originalMimetype;}}
img.classList.add('o_modified_image_to_save');},async setImgShapeColor(previewMode,widgetValue,params){const img=this._getImg();const newColorId=parseInt(params.colorId);const oldColors=img.dataset.shapeColors.split(';');const newColors=oldColors.slice(0);newColors[newColorId]=this._getCSSColorValue(widgetValue===''?`o-color-${(newColorId + 1)}`:widgetValue);await this._applyShapeAndColors(true,newColors);img.classList.add('o_modified_image_to_save');},async _applyOptions(){const img=await this._super(...arguments);if(img&&img.dataset.shape){await this._loadShape(img.dataset.shape);if(/^data:/.test(img.src)){await this._applyShapeAndColors(true,(img.dataset.shapeColors&&img.dataset.shapeColors.split(';')));}}
return img;},async _loadShape(shapeName){const[module,directory,fileName]=shapeName.split('/');let shape=this.shapeCache[fileName];if(!shape){const shapeURL=`/${module}/static/image_shapes/${directory}/${fileName}.svg`;shape=await(await fetch(shapeURL)).text();this.shapeCache[fileName]=shape;}
this._getImg().dataset.shape=shapeName;},async _applyShapeAndColors(save,newColors){const img=this._getImg();let shape=this.shapeCache[img.dataset.shape.split('/')[2]];const oldColors=Object.values(DEFAULT_PALETTE).map(color=>shape.includes(color)?color:null);if(!newColors){newColors=oldColors.map((color,i)=>color!==null?this._getCSSColorValue(`o-color-${(i + 1)}`):null);}
newColors.forEach((color,i)=>shape=shape.replace(new RegExp(oldColors[i],'g'),this._getCSSColorValue(color)));await this._writeShape(shape);if(save){img.dataset.shapeColors=newColors.join(';');}},async _writeShape(svgText){const img=this._getImg();const svg=new DOMParser().parseFromString(svgText,'image/svg+xml').documentElement;const imgDataURL=await applyModifications(img,{mimetype:this._getImageMimetype(img)});svg.removeChild(svg.querySelector('#preview'));svg.querySelector('image').setAttribute('xlink:href',imgDataURL);const originalImage=await loadImage(img.src);svg.setAttribute('width',originalImage.naturalWidth);svg.setAttribute('height',originalImage.naturalHeight);const blob=new Blob([svg.outerHTML],{type:'image/svg+xml',});const reader=new FileReader();const readPromise=new Promise(resolve=>{reader.addEventListener('load',()=>resolve(reader.result));});reader.readAsDataURL(blob);const dataURL=await readPromise;const imgFilename=(img.dataset.originalSrc.split('/').pop()).split('.')[0];img.dataset.fileName=`${imgFilename}.svg`;return loadImage(dataURL,img);},_computeMaxDisplayWidth(){const displayWidth=this._getImg().clientWidth;if(this.$target.closest('[class*="col-lg"]').length){if(this.$target.closest('.container, .o_container_small').length){return Math.min(1920,Math.max(displayWidth,690));}
return Math.min(1920,Math.max(displayWidth,962));}
return displayWidth;},_getImg(){return this.$target[0];},_relocateWeightEl(){const leftPanelEl=this.$overlay.data('$optionsSection')[0];const titleTextEl=leftPanelEl.querySelector('we-title > span');this.$weight.appendTo(titleTextEl);},async _computeWidgetVisibility(widgetName,params){if(widgetName.startsWith('img-shape-color')){const img=this._getImg();const shapeName=img.dataset.shape;if(!shapeName){return false;}
const colors=img.dataset.shapeColors.split(';');return colors[parseInt(params.colorId)];}
return this._super();},_computeWidgetState(methodName,params){switch(methodName){case'setImgShape':return this._getImg().dataset.shape||'';case'setImgShapeColor':{const img=this._getImg();return(img.dataset.shapeColors&&img.dataset.shapeColors.split(';')[parseInt(params.colorId)])||'';}}
return this._super(...arguments);},async _renderCustomXML(uiFragment){await this._super(...arguments);uiFragment.querySelectorAll('we-select-page we-button[data-set-img-shape]').forEach(btn=>{const image=document.createElement('img');const[moduleName,directory,shapeName]=btn.dataset.setImgShape.split('/');image.src=`/${moduleName}/static/image_shapes/${directory}/${shapeName}.svg`;$(btn).prepend(image);if(btn.dataset.animated){_addAnimatedShapeLabel(btn);}});},_getImageMimetype(img){if(img.dataset.shape){return img.dataset.originalMimetype;}
return this._super(...arguments);},_getCSSColorValue(color){if(!color||ColorpickerWidget.isCSSColor(color)){return color;}
return weUtils.getCSSVariableValue(color);},async _initializeImage(){const img=this._getImg();const match=img.src.match(/\/web_editor\/image_shape\/(\w+\.\w+)/);if(img.dataset.shape&&match){return this._loadImageInfo(`/web/image/${match[1]}`);}
return this._super(...arguments);},async _loadImageInfo(){await this._super(...arguments);const img=this._getImg();if(img.dataset.shape&&img.dataset.mimetype!=='image/svg+xml'){img.dataset.originalMimetype=img.dataset.mimetype;if(!this._isImageSupportedForProcessing(img)){delete img.dataset.shape;delete img.dataset.shapeColors;delete img.dataset.fileName;delete img.dataset.originalMimetype;return;}
img.dataset.mimetype='image/svg+xml';}},async _onImageChanged(ev){this.trigger_up('snippet_edition_request',{exec:async()=>{await this._autoOptimizeImage();this.trigger_up('cover_update');}});},async _onImageCropped(ev){const img=this._getImg();if(img.dataset.shape){await this._loadShape(img.dataset.shape);await this._applyShapeAndColors(true,(img.dataset.shapeColors&&img.dataset.shapeColors.split(';')));}
await this._rerenderXML();},});registry.BackgroundOptimize=ImageHandlerOption.extend({start(){this.$target.on('background_changed.BackgroundOptimize',this._onBackgroundChanged.bind(this));return this._super(...arguments);},destroy(){this.$target.off('.BackgroundOptimize');return this._super(...arguments);},async cleanForSave(){const img=this._getImg();if(img.matches('.o_modified_image_to_save')){this.$target.addClass('o_modified_image_to_save');Object.entries(img.dataset).forEach(([key,value])=>{this.$target[0].dataset[key]=value;});this.$target[0].dataset.bgSrc=img.getAttribute('src');}},_getImg(){return this.img;},_computeMaxDisplayWidth(){return 1920;},async _loadImageInfo(){this.img=new Image();Object.entries(this.$target[0].dataset).filter(([key])=>!['oeId','oeModel','oeField','oeXpath','noteId'].includes(key)).forEach(([key,value])=>{this.img.dataset[key]=value;});const src=getBgImageURL(this.$target[0]);this.img.src=src.startsWith('/')?src:'';return await this._super(...arguments);},_relocateWeightEl(){this.trigger_up('option_update',{optionNames:['BackgroundImage'],name:'add_size_indicator',data:this.$weight,});this.$weight.css({'width':'200px','flex':'0 0 0','margin-left':'auto',});},_applyImage(img){const parts=backgroundImageCssToParts(this.$target.css('background-image'));parts.url=`url('${img.getAttribute('src')}')`;const combined=backgroundImagePartsToCss(parts);this.$target.css('background-image',combined);},async _onBackgroundChanged(ev,previewMode){if(!previewMode){this.trigger_up('snippet_edition_request',{exec:async()=>{await this._autoOptimizeImage();}});}},});registry.BackgroundToggler=SnippetOptionWidget.extend({toggleBgImage(previewMode,widgetValue,params){if(!widgetValue){this.$target.find('> .o_we_bg_filter').remove();const[bgImageWidget]=this._requestUserValueWidgets('bg_image_opt');const bgImageOpt=bgImageWidget.getParent();return bgImageOpt.background(false,'',bgImageWidget.getMethodsParams('background'));}else{this._requestUserValueWidgets('bg_image_opt')[0].el.click();}},toggleBgShape(previewMode,widgetValue,params){const[shapeWidget]=this._requestUserValueWidgets('bg_shape_opt');const shapeOption=shapeWidget.getParent();return shapeOption._toggleShape();},async selectFilterColor(previewMode,widgetValue,params){let filterEl=this.$target[0].querySelector(':scope > .o_we_bg_filter');const rgba=widgetValue&&ColorpickerWidget.convertCSSColorToRgba(widgetValue);if(!widgetValue||rgba&&rgba.opacity<0.001){if(filterEl){filterEl.remove();}
return;}
if(!filterEl){filterEl=document.createElement('div');filterEl.classList.add('o_we_bg_filter');const lastBackgroundEl=this._getLastPreFilterLayerElement();if(lastBackgroundEl){$(lastBackgroundEl).after(filterEl);}else{this.$target.prepend(filterEl);}}
const obj=createPropertyProxy(this,'$target',$(filterEl));params.cssProperty='background-color';return this.selectStyle.call(obj,previewMode,widgetValue,params);},_computeWidgetState(methodName,params){switch(methodName){case'toggleBgImage':{const[bgImageWidget]=this._requestUserValueWidgets('bg_image_opt');const bgImageOpt=bgImageWidget.getParent();return!!bgImageOpt._computeWidgetState('background',bgImageWidget.getMethodsParams('background'));}
case'toggleBgShape':{const[shapeWidget]=this._requestUserValueWidgets('bg_shape_opt');const shapeOption=shapeWidget.getParent();return!!shapeOption._computeWidgetState('shape',shapeWidget.getMethodsParams('shape'));}
case'selectFilterColor':{const filterEl=this.$target[0].querySelector(':scope > .o_we_bg_filter');if(!filterEl){return'';}
const obj=createPropertyProxy(this,'$target',$(filterEl));params.cssProperty='background-color';return this._computeWidgetState.call(obj,'selectStyle',params);}}
return this._super(...arguments);},_getLastPreFilterLayerElement(){return null;},});registry.BackgroundImage=SnippetOptionWidget.extend({start:function(){this.__customImageSrc=getBgImageURL(this.$target[0]);return this._super(...arguments);},background:async function(previewMode,widgetValue,params){if(previewMode===true){this.__customImageSrc=getBgImageURL(this.$target[0]);}else if(previewMode==='reset'){widgetValue=this.__customImageSrc;}else{this.__customImageSrc=widgetValue;}
this._setBackground(widgetValue);if(previewMode!=='reset'){removeOnImageChangeAttrs.forEach(attr=>delete this.$target[0].dataset[attr]);this.$target.trigger('background_changed',[previewMode]);}},async dynamicColor(previewMode,widgetValue,params){const currentSrc=getBgImageURL(this.$target[0]);switch(previewMode){case true:this.previousSrc=currentSrc;break;case'reset':this._setBackground(this.previousSrc);return;}
const newURL=new URL(currentSrc,window.location.origin);newURL.searchParams.set(params.colorName,normalizeColor(widgetValue));const src=newURL.pathname+newURL.search;await loadImage(src);this._setBackground(src);if(!previewMode){this.previousSrc=src;}},notify(name,data){if(name==='add_size_indicator'){this._requestUserValueWidgets('bg_image_opt')[0].$el.after(data);}else{this._super(...arguments);}},setTarget:function(){const oldBgURL=getBgImageURL(this.$target);this._setBackground('');this._super(...arguments);if(oldBgURL){this._setBackground(oldBgURL);}
this.__customImageSrc=getBgImageURL(this.$target[0]);},_computeWidgetState:function(methodName,params){switch(methodName){case'background':return getBgImageURL(this.$target[0]);case'dynamicColor':return new URL(getBgImageURL(this.$target[0]),window.location.origin).searchParams.get(params.colorName);}
return this._super(...arguments);},_computeWidgetVisibility(widgetName,params){if('colorName'in params){const src=new URL(getBgImageURL(this.$target[0]),window.location.origin);return src.searchParams.has(params.colorName);}else if(widgetName==='main_color_opt'){const src=new URL(getBgImageURL(this.$target[0]),window.location.origin);return src.origin===window.location.origin&&src.pathname.startsWith('/web_editor/shape/');}
return this._super(...arguments);},_setBackground(backgroundURL){const parts=backgroundImageCssToParts(this.$target.css('background-image'));if(backgroundURL){parts.url=`url('${backgroundURL}')`;this.$target.addClass('oe_img_bg o_bg_img_center');}else{delete parts.url;this.$target.removeClass('oe_img_bg o_bg_img_center');}
const combined=backgroundImagePartsToCss(parts);this.$target.css('background-image',combined);},});registry.BackgroundShape=SnippetOptionWidget.extend({updateUI(){if(this.rerender){this.rerender=false;return this._rerenderXML();}
return this._super.apply(this,arguments);},shape(previewMode,widgetValue,params){this._handlePreviewState(previewMode,()=>{return{shape:widgetValue,colors:this._getImplicitColors(widgetValue,this._getShapeData().colors),flip:[]};});},color(previewMode,widgetValue,params){this._handlePreviewState(previewMode,()=>{const{colorName}=params;const{colors:previousColors}=this._getShapeData();const newColor=normalizeColor(widgetValue)||this._getDefaultColors()[colorName];const newColors=Object.assign(previousColors,{[colorName]:newColor});return{colors:newColors};});},flipX(previewMode,widgetValue,params){this._flipShape(previewMode,'x');},flipY(previewMode,widgetValue,params){this._flipShape(previewMode,'y');},_computeWidgetState(methodName,params){switch(methodName){case'shape':{return this._getShapeData().shape;}
case'color':{const{shape,colors:customColors}=this._getShapeData();const colors=Object.assign(this._getDefaultColors(),customColors);const color=shape&&colors[params.colorName];return color||'';}
case'flipX':{const hasFlipClass=this.$target.find('> .o_we_shape.o_we_flip_x').length!==0;return hasFlipClass||this._getShapeData().flip.includes('x');}
case'flipY':{const hasFlipClass=this.$target.find('> .o_we_shape.o_we_flip_y').length!==0;return hasFlipClass||this._getShapeData().flip.includes('y');}}
return this._super(...arguments);},_renderCustomXML(uiFragment){Object.keys(this._getDefaultColors()).map(colorName=>{uiFragment.querySelector('[data-name="colors"]').prepend($(`<we-colorpicker data-color="true" data-color-name="${colorName}"></we-colorpicker>`)[0]);});uiFragment.querySelectorAll('we-select-pager we-button[data-shape]').forEach(btn=>{const btnContent=document.createElement('div');btnContent.classList.add('o_we_shape_btn_content','position-relative','border-dark');const btnContentInnerDiv=document.createElement('div');btnContentInnerDiv.classList.add('o_we_shape');btnContent.appendChild(btnContentInnerDiv);if(btn.dataset.animated){_addAnimatedShapeLabel(btnContent);}
const{shape}=btn.dataset;const shapeEl=btnContent.querySelector('.o_we_shape');shapeEl.classList.add(`o_${shape.replace(/\//g, '_')}`);btn.append(btnContent);});return uiFragment;},async _computeWidgetVisibility(widgetName,params){if(widgetName==='shape_none_opt'){return false;}
return this._super(...arguments);},_flipShape(previewMode,axis){this._handlePreviewState(previewMode,()=>{const flip=new Set(this._getShapeData().flip);if(flip.has(axis)){flip.delete(axis);}else{flip.add(axis);}
return{flip:[...flip]};});},_insertShapeContainer(newContainer){const target=this.$target[0];const shapeContainer=target.querySelector(':scope > .o_we_shape');if(shapeContainer){shapeContainer.remove();}
if(newContainer){const preShapeLayerElement=this._getLastPreShapeLayerElement();if(preShapeLayerElement){$(preShapeLayerElement).after(newContainer);}else{this.$target.prepend(newContainer);}}
return newContainer;},_createShapeContainer(shape){const shapeContainer=this._insertShapeContainer(document.createElement('div'));this.$target[0].style.position='relative';shapeContainer.className=`o_we_shape o_${shape.replace(/\//g, '_')}`;return shapeContainer;},_handlePreviewState(previewMode,computeShapeData){const target=this.$target[0];let changedShape=false;if(previewMode==='reset'){this._insertShapeContainer(this.prevShapeContainer);if(this.prevShape){target.dataset.oeShapeData=this.prevShape;}else{delete target.dataset.oeShapeData;}
return;}else{if(previewMode===true){const shapeContainer=target.querySelector(':scope > .o_we_shape');this.prevShapeContainer=shapeContainer&&shapeContainer.cloneNode(true);this.prevShape=target.dataset.oeShapeData;}
const curShapeData=target.dataset.oeShapeData||{};const newShapeData=computeShapeData();const{shape:curShape}=curShapeData;changedShape=newShapeData.shape!==curShape;this._markShape(newShapeData);if(previewMode===false&&changedShape){this.rerender=true;}}
const json=target.dataset.oeShapeData;const{shape,colors,flip=[]}=json?JSON.parse(json):{};let shapeContainer=target.querySelector(':scope > .o_we_shape');if(!shape){return this._insertShapeContainer(null);}
if(changedShape){shapeContainer=this._createShapeContainer(shape);}
shapeContainer.classList.remove('o_we_flip_x','o_we_flip_y');if(colors||flip.length){$(shapeContainer).css('background-image',`url("${this._getShapeSrc()}")`);shapeContainer.style.backgroundPosition='';if(flip.length){let[xPos,yPos]=$(shapeContainer).css('background-position').split(' ').map(p=>parseFloat(p));xPos=flip.includes('x')?-xPos+100:xPos;yPos=flip.includes('y')?-yPos+100:yPos;shapeContainer.style.backgroundPosition=`${xPos}% ${yPos}%`;}}else{$(shapeContainer).css('background-image','');$(shapeContainer).css('background-position','');}
if(previewMode===false){this.prevShapeContainer=shapeContainer.cloneNode(true);this.prevShape=target.dataset.oeShapeData;}},_markShape(newData){const defaultColors=this._getDefaultColors();const shapeData=Object.assign(this._getShapeData(),newData);const areColorsDefault=Object.entries(shapeData.colors).every(([colorName,colorValue])=>{return defaultColors[colorName]&&colorValue.toLowerCase()===defaultColors[colorName].toLowerCase();});if(areColorsDefault){delete shapeData.colors;}
if(!shapeData.shape){delete this.$target[0].dataset.oeShapeData;}else{this.$target[0].dataset.oeShapeData=JSON.stringify(shapeData);}},_getLastPreShapeLayerElement(){const $filterEl=this.$target.find('> .o_we_bg_filter');if($filterEl.length){return $filterEl[0];}
return null;},_getShapeSrc(){const{shape,colors,flip}=this._getShapeData();if(!shape){return'';}
const searchParams=Object.entries(colors).map(([colorName,colorValue])=>{const encodedCol=encodeURIComponent(colorValue);return`${colorName}=${encodedCol}`;});if(flip.length){searchParams.push(`flip=${flip.sort().join('')}`);}
return`/web_editor/shape/${shape}.svg?${searchParams.join('&')}`;},_getShapeData(target=this.$target[0]){const defaultData={shape:'',colors:this._getDefaultColors($(target)),flip:[],};const json=target.dataset.oeShapeData;return json?Object.assign(defaultData,JSON.parse(json.replace(/'/g,'"'))):defaultData;},_getDefaultColors($target=this.$target){const $shapeContainer=$target.find('> .o_we_shape').clone().addClass('d-none').appendTo(document.body);const shapeContainer=$shapeContainer[0];$shapeContainer.css('background-image','');const shapeSrc=shapeContainer&&getBgImageURL(shapeContainer);$shapeContainer.remove();if(!shapeSrc){return{};}
const url=new URL(shapeSrc,window.location.origin);return Object.fromEntries(url.searchParams.entries());},_getShapeDefaultColors(shapeId){const $shapeContainer=this.$el.find(".o_we_shape_menu we-button[data-shape='"+shapeId+"'] div.o_we_shape");const shapeContainer=$shapeContainer[0];const shapeSrc=shapeContainer&&getBgImageURL(shapeContainer);const url=new URL(shapeSrc,window.location.origin);return Object.fromEntries(url.searchParams.entries());},_getImplicitColors(shape,previousColors){const defaultColors=this._getShapeDefaultColors(shape);let colors=previousColors||{};let sibling=this.$target[0].previousElementSibling;while(sibling){colors=Object.assign(this._getShapeData(sibling).colors||{},colors);sibling=sibling.previousElementSibling;}
const defaultKeys=Object.keys(defaultColors);colors=Object.assign(defaultColors,colors);return _.pick(colors,defaultKeys);},_toggleShape(){if(this._getShapeData().shape){return this._handlePreviewState(false,()=>({shape:''}));}else{const target=this.$target[0];const previousSibling=target.previousElementSibling;const[shapeWidget]=this._requestUserValueWidgets('bg_shape_opt');const possibleShapes=shapeWidget.getMethodsParams('shape').possibleValues;let shapeToSelect;if(previousSibling){const previousShape=this._getShapeData(previousSibling).shape;shapeToSelect=possibleShapes.find((shape,i)=>{return possibleShapes[i-1]===previousShape;});}else{shapeToSelect=possibleShapes[1];}
this.trigger_up('snippet_edition_request',{exec:()=>{this._requestUserValueWidgets('bg_shape_opt')[0].enable();}});this._createShapeContainer(shapeToSelect);return this._handlePreviewState(false,()=>({shape:shapeToSelect,colors:this._getImplicitColors(shapeToSelect)}));}},});registry.BackgroundPosition=SnippetOptionWidget.extend({xmlDependencies:['/web_editor/static/src/xml/editor.xml'],start:function(){this._super.apply(this,arguments);this._initOverlay();$(window).on('resize.bgposition',()=>this._dimensionOverlay());},destroy:function(){this._toggleBgOverlay(false);$(window).off('.bgposition');this._super.apply(this,arguments);},backgroundType:function(previewMode,widgetValue,params){this.$target.toggleClass('o_bg_img_opt_repeat',widgetValue==='repeat-pattern');this.$target.css('background-position','');this.$target.css('background-size','');},backgroundPositionOverlay:async function(previewMode,widgetValue,params){await new Promise(resolve=>{this.img=document.createElement('img');this.img.addEventListener('load',()=>resolve());this.img.src=getBgImageURL(this.$target[0]);});const position=this.$target.css('background-position').split(' ').map(v=>parseInt(v));const delta=this._getBackgroundDelta();this.originalPosition={left:position[0],top:position[1],};this.currentPosition={left:position[0]/100*delta.x||0,top:position[1]/100*delta.y||0,};const rect=this.$target[0].getBoundingClientRect();const viewportTop=$(window).scrollTop();const viewportBottom=viewportTop+$(window).height();const visibleHeight=rect.top<viewportTop?Math.max(0,Math.min(viewportBottom,rect.bottom)-viewportTop):rect.top<viewportBottom?Math.min(viewportBottom,rect.bottom)-rect.top:0;if(visibleHeight<200){await scrollTo(this.$target[0],{extraOffset:50});}
this._toggleBgOverlay(true);},selectStyle:function(previewMode,widgetValue,params){if(params.cssProperty==='background-size'&&!this.$target.hasClass('o_bg_img_opt_repeat')){return;}
this._super(...arguments);},_computeVisibility:function(){return this._super(...arguments)&&!!getBgImageURL(this.$target[0]);},_computeWidgetState:function(methodName,params){if(methodName==='backgroundType'){return this.$target.css('background-repeat')==='repeat'?'repeat-pattern':'cover';}
return this._super(...arguments);},_initOverlay:function(){this.$backgroundOverlay=$(qweb.render('web_editor.background_position_overlay'));this.$overlayContent=this.$backgroundOverlay.find('.o_we_overlay_content');this.$overlayBackground=this.$overlayContent.find('.o_overlay_background');this.$backgroundOverlay.on('click','.o_btn_apply',()=>{this.$target.css('background-position',this.$bgDragger.css('background-position'));this._toggleBgOverlay(false);});this.$backgroundOverlay.on('click','.o_btn_discard',()=>{this._toggleBgOverlay(false);});this.$backgroundOverlay.insertAfter(this.$overlay);},_dimensionOverlay:function(){if(!this.$backgroundOverlay.is('.oe_active')){return;}
const $wrapwrap=$('#wrapwrap');const targetOffset=this.$target.offset();this.$backgroundOverlay.css({width:$wrapwrap.innerWidth(),height:$wrapwrap.innerHeight(),});this.$overlayContent.offset(targetOffset);this.$bgDragger.css({width:`${this.$target.innerWidth()}px`,height:`${this.$target.innerHeight()}px`,});const topPos=Math.max(0,$(window).scrollTop()-this.$target.offset().top);this.$overlayContent.find('.o_we_overlay_buttons').css('top',`${topPos}px`);},_toggleBgOverlay:function(activate){if(!this.$backgroundOverlay||this.$backgroundOverlay.is('.oe_active')===activate){return;}
if(!activate){this.$backgroundOverlay.removeClass('oe_active');this.trigger_up('unblock_preview_overlays');this.trigger_up('activate_snippet',{$snippet:this.$target});$(document).off('click.bgposition');return;}
this.trigger_up('hide_overlay');this.trigger_up('activate_snippet',{$snippet:this.$target,previewMode:true,});this.trigger_up('block_preview_overlays');this.$bgDragger=this.$target.clone().empty();this.$bgDragger.removeClass('o_editable');this.$bgDragger.css('background-attachment',this.$target.css('background-attachment'));this.$bgDragger.on('mousedown',this._onDragBackgroundStart.bind(this));this.$bgDragger.tooltip({title:'Click and drag the background to adjust its position!',trigger:'manual',container:this.$backgroundOverlay});this.$overlayBackground.empty().append(this.$bgDragger);this.$backgroundOverlay.addClass('oe_active');this._dimensionOverlay();this.$bgDragger.tooltip('show');window.setTimeout(()=>$(document).on('click.bgposition',this._onDocumentClicked.bind(this)),0);},_getBackgroundDelta:function(){const bgSize=this.$target.css('background-size');if(bgSize!=='cover'){let[width,height]=bgSize.split(' ');if(width==='auto'&&(height==='auto'||!height)){return{x:this.$target.outerWidth()-this.img.naturalWidth,y:this.$target.outerHeight()-this.img.naturalHeight,};}
[width,height]=[parseInt(width),parseInt(height)];return{x:this.$target.outerWidth()-(width||(height*this.img.naturalWidth/this.img.naturalHeight)),y:this.$target.outerHeight()-(height||(width*this.img.naturalHeight/this.img.naturalWidth)),};}
const renderRatio=Math.max(this.$target.outerWidth()/this.img.naturalWidth,this.$target.outerHeight()/this.img.naturalHeight);return{x:this.$target.outerWidth()-Math.round(renderRatio*this.img.naturalWidth),y:this.$target.outerHeight()-Math.round(renderRatio*this.img.naturalHeight),};},_onDragBackgroundStart:function(ev){ev.preventDefault();this.$bgDragger.addClass('o_we_grabbing');const $document=$(this.ownerDocument);$document.on('mousemove.bgposition',this._onDragBackgroundMove.bind(this));$document.one('mouseup',()=>{this.$bgDragger.removeClass('o_we_grabbing');$document.off('mousemove.bgposition');});},_onDragBackgroundMove:function(ev){ev.preventDefault();const delta=this._getBackgroundDelta();this.currentPosition.left=clamp(this.currentPosition.left+ev.originalEvent.movementX,[0,delta.x]);this.currentPosition.top=clamp(this.currentPosition.top+ev.originalEvent.movementY,[0,delta.y]);const percentPosition={left:this.currentPosition.left/delta.x*100,top:this.currentPosition.top/delta.y*100,};percentPosition.left=isFinite(percentPosition.left)?percentPosition.left:this.originalPosition.left;percentPosition.top=isFinite(percentPosition.top)?percentPosition.top:this.originalPosition.top;this.$bgDragger.css('background-position',`${percentPosition.left}% ${percentPosition.top}%`);function clamp(val,bounds){bounds=bounds.sort();return Math.max(bounds[0],Math.min(val,bounds[1]));}},_onDocumentClicked:function(ev){if(!$(ev.target).closest('.o_we_background_position_overlay')){this._toggleBgOverlay(false);}},});registry.ColoredLevelBackground=registry.BackgroundToggler.extend({start:function(){this._markColorLevel();return this._super(...arguments);},onBuilt:function(){this._markColorLevel();},_markColorLevel:function(){this.$target.addClass('o_colored_level');},});registry.ContainerWidth=SnippetOptionWidget.extend({cleanForSave:function(){this.$target.removeClass('o_container_preview');},selectClass:async function(previewMode,widgetValue,params){await this._super(...arguments);if(previewMode==='reset'){this.$target.removeClass('o_container_preview');}else if(previewMode){this.$target.addClass('o_container_preview');}},});registry.many2one=SnippetOptionWidget.extend({async willStart(){const{oeMany2oneModel,oeMany2oneId}=this.$target[0].dataset;this.fields=['name','display_name'];return Promise.all([this._super(...arguments),this._rpc({model:oeMany2oneModel,method:'read',args:[[parseInt(oeMany2oneId)],this.fields],}).then(([initialRecord])=>{this.initialRecord=initialRecord;}),]);},async changeRecord(previewMode,widgetValue,params){const target=this.$target[0];if(previewMode==='reset'){this.$target.data('oeMany2oneId',this.prevId);target.dataset.oeMany2oneId=this.prevId;this.$target.empty().append(this.$prevContents);return this._rerenderContacts(this.prevId,this.prevRecordName);}
const record=JSON.parse(params.recordData);if(previewMode===true){this.prevId=parseInt(target.dataset.oeMany2oneId);this.$prevContents=this.$target.contents();this.prevRecordName=this.prevRecordName||this.initialRecord.name;}
this.$target.data('oeMany2oneId',record.id);target.dataset.oeMany2oneId=record.id;if(target.dataset.oeType!=='contact'){target.textContent=record.name;}
await this._rerenderContacts(record.id,record.name);if(previewMode===false){this.prevId=record.id;this.$prevContents=this.$target.contents();this.prevRecordName=record.name;}},_computeWidgetState(methodName,params){if(methodName==='changeRecord'){return this.$target[0].dataset.oeMany2oneId;}
return this._super(...arguments);},async _renderCustomXML(uiFragment){const many2oneWidget=document.createElement('we-many2one');many2oneWidget.dataset.changeRecord='';const model=this.$target[0].dataset.oeMany2oneModel;const[{name:modelName}]=await this._rpc({model:'ir.model',method:'search_read',args:[[['model','=',model]],['name']],});many2oneWidget.setAttribute('String',modelName);many2oneWidget.dataset.model=model;many2oneWidget.dataset.fields=JSON.stringify(this.fields);uiFragment.appendChild(many2oneWidget);},async _rerenderContacts(contactId,defaultText){const selector=[`[data-oe-model="${this.$target.data('oe-model')}"]`,`[data-oe-id="${this.$target.data('oe-id')}"]`,`[data-oe-field="${this.$target.data('oe-field')}"]`,`[data-oe-contact-options!='${this.$target[0].dataset.oeContactOptions}']`,].join('');let $toRerender=$(selector);if(this.$target[0].dataset.oeType==='contact'){$toRerender=$toRerender.add(this.$target);}
await Promise.all($toRerender.attr('data-oe-many2one-id',contactId).data('oe-many2one-id',contactId).map(async(i,node)=>{if(node.dataset.oeType==='contact'){const html=await this._rpc({model:'ir.qweb.field.contact',method:'get_record_to_html',args:[[contactId]],kwargs:{options:JSON.parse(node.dataset.oeContactOptions)},});$(node).html(html);}else{node.textContent=defaultText;}}));},});registry.VersionControl=SnippetOptionWidget.extend({xmlDependencies:['/web_editor/static/src/xml/snippets.xml'],start:function(){this.trigger_up('get_snippet_versions',{snippetName:this.$target[0].dataset.snippet,onSuccess:snippetVersions=>{const isUpToDate=snippetVersions&&['vjs','vcss','vxml'].every(key=>this.$target[0].dataset[key]===snippetVersions[key]);if(!isUpToDate){this.$el.prepend(qweb.render('web_editor.outdated_block_message'));}},});return this._super(...arguments);},});registry.SnippetSave=SnippetOptionWidget.extend({xmlDependencies:['/web_editor/static/src/xml/editor.xml'],isTopOption:true,saveSnippet:function(previewMode,widgetValue,params){return new Promise(resolve=>{Dialog.confirm(this,_t("To save a snippet, we need to save all your previous modifications and reload the page."),{cancel_callback:()=>resolve(false),buttons:[{text:_t("Save and Reload"),classes:'btn-primary',close:true,click:()=>{const snippetKey=this.$target[0].dataset.snippet;let thumbnailURL;this.trigger_up('snippet_thumbnail_url_request',{key:snippetKey,onSuccess:url=>thumbnailURL=url,});let context;this.trigger_up('context_get',{callback:ctx=>context=ctx,});this.trigger_up('request_save',{reloadEditor:true,onSuccess:async()=>{const defaultSnippetName=_.str.sprintf(_t("Custom %s"),this.data.snippetName);const targetCopyEl=this.$target[0].cloneNode(true);delete targetCopyEl.dataset.name;await rpc.query({model:'ir.ui.view',method:'save_snippet',kwargs:{'name':defaultSnippetName,'arch':targetCopyEl.outerHTML,'template_key':this.options.snippets,'snippet_key':snippetKey,'thumbnail_url':thumbnailURL,'context':context,},});},});resolve(true);}},{text:_t("Cancel"),close:true,click:()=>resolve(false),}]});});},});registry.DynamicSvg=SnippetOptionWidget.extend({start(){this.$target.on('image_changed.DynamicSvg',this._onImageChanged.bind(this));return this._super(...arguments);},destroy(){this.$target.off('.DynamicSvg');return this._super(...arguments);},async color(previewMode,widgetValue,params){const target=this.$target[0];switch(previewMode){case true:this.previousSrc=target.getAttribute('src');break;case'reset':target.src=this.previousSrc;return;}
const newURL=new URL(target.src,window.location.origin);newURL.searchParams.set(params.colorName,normalizeColor(widgetValue));const src=newURL.pathname+newURL.search;await loadImage(src);target.src=src;if(!previewMode){this.previousSrc=src;}},_computeWidgetState(methodName,params){switch(methodName){case'color':return new URL(this.$target[0].src,window.location.origin).searchParams.get(params.colorName);}
return this._super(...arguments);},_computeWidgetVisibility(widgetName,params){if('colorName'in params){return new URL(this.$target[0].src,window.location.origin).searchParams.get(params.colorName);}
return this._super(...arguments);},_computeVisibility(methodName,params){return this.$target.is("img[src^='/web_editor/shape/']");},_onImageChanged(methodName,params){return this.updateUI();},});registry.MultipleItems=SnippetOptionWidget.extend({async addItem(previewMode,widgetValue,params){const $target=this.$(params.item);const addBeforeItem=params.addBefore==='true';if($target.length){await new Promise(resolve=>{this.trigger_up('clone_snippet',{$snippet:$target,onSuccess:resolve,});});if(addBeforeItem){$target.before($target.next());}
if(params.selectItem!=='false'){this.trigger_up('activate_snippet',{$snippet:addBeforeItem?$target.prev():$target.next(),});}
this._addItemCallback($target);}},async removeItem(previewMode,widgetValue,params){const $target=this.$(params.item);if($target.length){await new Promise(resolve=>{this.trigger_up('remove_snippet',{$snippet:$target,onSuccess:resolve,});});this._removeItemCallback($target);}},_addItemCallback($target){},_removeItemCallback($target){},});registry.SelectTemplate=SnippetOptionWidget.extend({custom_events:Object.assign({},SnippetOptionWidget.prototype.custom_events,{'user_value_widget_opening':'_onWidgetOpening',}),init(){this._super(...arguments);this.containerSelector='';this.selectTemplateWidgetName='';},async start(){this.containerEl=this.containerSelector?this.$target.find(this.containerSelector)[0]:this.$target[0];this._templates={};return this._super(...arguments);},async selectTemplate(previewMode,widgetValue,params){await this._templatesLoading;if(previewMode==='reset'){if(!this.beforePreviewNodes){return;}
while(this.containerEl.lastChild){this.containerEl.removeChild(this.containerEl.lastChild);}
for(const node of this.beforePreviewNodes){this.containerEl.appendChild(node);}
this.beforePreviewNodes=null;return;}
if(!this.beforePreviewNodes){this.beforePreviewNodes=[...this.containerEl.childNodes];}
while(this.containerEl.lastChild){this.containerEl.removeChild(this.containerEl.lastChild);}
this.containerEl.insertAdjacentHTML('beforeend',this._templates[widgetValue]);if(!previewMode){this.beforePreviewNodes=null;}},async _getTemplate(xmlid){if(!this._templates[xmlid]){this._templates[xmlid]=await this._rpc({model:'ir.ui.view',method:'render_public_asset',args:[`${xmlid}`,{}],kwargs:{context:this.options.context,},});}
return this._templates[xmlid];},_onWidgetOpening(ev){if(this._templatesLoading||ev.target.getName()!==this.selectTemplateWidgetName){return;}
const templateParams=ev.target.getMethodsParams('selectTemplate');const proms=templateParams.possibleValues.map(async xmlid=>{if(!xmlid){return;}
await this._getTemplate(xmlid);});this._templatesLoading=Promise.all(proms);},});return{SnippetOptionWidget:SnippetOptionWidget,snippetOptionRegistry:registry,NULL_ID:NULL_ID,UserValueWidget:UserValueWidget,userValueWidgetsRegistry:userValueWidgetsRegistry,UnitUserValueWidget:UnitUserValueWidget,addTitleAndAllowedAttributes:_addTitleAndAllowedAttributes,buildElement:_buildElement,buildTitleElement:_buildTitleElement,buildRowElement:_buildRowElement,buildCollapseElement:_buildCollapseElement,addAnimatedShapeLabel:_addAnimatedShapeLabel,Class:SnippetOptionWidget,registry:registry,};});;

/* /web_editor/static/src/js/wysiwyg/wysiwyg.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('web_editor.wysiwyg',function(require){'use strict';const dom=require('web.dom');const core=require('web.core');const Widget=require('web.Widget');const Dialog=require('web.Dialog');const customColors=require('web_editor.custom_colors');const{ColorPaletteWidget}=require('web_editor.ColorPalette');const{ColorpickerWidget}=require('web.Colorpicker');const concurrency=require('web.concurrency');const{device}=require('web.config');const weContext=require('web_editor.context');const OdooEditorLib=require('@web_editor/../lib/odoo-editor/src/OdooEditor');const snippetsEditor=require('web_editor.snippet.editor');const Toolbar=require('web_editor.toolbar');const weWidgets=require('wysiwyg.widgets');const wysiwygUtils=require('@web_editor/js/wysiwyg/wysiwyg_utils');const weUtils=require('web_editor.utils');const{PeerToPeer}=require('@web_editor/js/wysiwyg/PeerToPeer');const{Mutex}=require('web.concurrency');var _t=core._t;const OdooEditor=OdooEditorLib.OdooEditor;const getDeepRange=OdooEditorLib.getDeepRange;const getInSelection=OdooEditorLib.getInSelection;const isBlock=OdooEditorLib.isBlock;const rgbToHex=OdooEditorLib.rgbToHex;const preserveCursor=OdooEditorLib.preserveCursor;const closestElement=OdooEditorLib.closestElement;var id=0;const faZoomClassRegex=RegExp('fa-[0-9]x');const mediaSelector='img, .fa, .o_image, .media_iframe_video';const Wysiwyg=Widget.extend({xmlDependencies:[],defaultOptions:{lang:'odoo',colors:customColors,recordInfo:{context:{}},},init:function(parent,options){this._super.apply(this,arguments);this.id=++id;this.options=options;this.options.autohideToolbar=typeof this.options.autohideToolbar==='boolean'?this.options.autohideToolbar:!options.snippets;this.saving_mutex=new concurrency.Mutex();this.colorpickers={};this._onDocumentMousedown=this._onDocumentMousedown.bind(this);this._onBlur=this._onBlur.bind(this);},start:async function(){const _super=this._super;const self=this;var options=this._editorOptions();this._value=options.value;this.$editable=this.$editable||this.$el;this.$editable.html(this._value);this.$editable.data('wysiwyg',this);this.$editable.data('oe-model',options.recordInfo.res_model);this.$editable.data('oe-id',options.recordInfo.res_id);document.addEventListener('mousedown',this._onDocumentMousedown,true);this.$editable.on('blur',this._onBlur);this.toolbar=new Toolbar(this,this.options.toolbarTemplate);await this.toolbar.appendTo(document.createElement('void'));const commands=this._getCommands();let editorCollaborationOptions;if(options.collaborationChannel){editorCollaborationOptions=this.setupCollaboration(options.collaborationChannel);}
this.odooEditor=new OdooEditor(this.$editable[0],Object.assign({_t:_t,toolbar:this.toolbar.$el[0],document:this.options.document,autohideToolbar:!!this.options.autohideToolbar,isRootEditable:this.options.isRootEditable,placeholder:this.options.placeholder,controlHistoryFromDocument:this.options.controlHistoryFromDocument,getContentEditableAreas:this.options.getContentEditableAreas,defaultLinkAttributes:this.options.userGeneratedContent?{rel:'ugc'}:{},getContextFromParentRect:options.getContextFromParentRect,getPowerboxElement:()=>{const selection=document.getSelection();if(selection.isCollapsed&&selection.rangeCount){const node=closestElement(selection.anchorNode,'P, DIV');return!(node&&node.hasAttribute&&node.hasAttribute('data-oe-model'))&&node;}},isHintBlacklisted:node=>{return node.hasAttribute&&(node.hasAttribute('data-target')||node.hasAttribute('data-oe-model'));},noScrollSelector:'body, .note-editable, .o_content, #wrapwrap',commands:commands,plugins:options.editorPlugins,},editorCollaborationOptions));const $wrapwrap=$('#wrapwrap');if($wrapwrap.length){$wrapwrap[0].addEventListener('scroll',this.odooEditor.multiselectionRefresh,{passive:true});}
if(this._peerToPeerLoading){this._peerToPeerLoading.then(()=>this.ptp.notifyAllClients('ptp_join'));}
this._observeOdooFieldChanges();this.$editable.on('mousedown touchstart','[data-oe-field]',function(){self.odooEditor.observerUnactive();const $field=$(this);if(($field.data('oe-type')==="datetime"||$field.data('oe-type')==="date")){let selector='[data-oe-id="'+$field.data('oe-id')+'"]';selector+='[data-oe-field="'+$field.data('oe-field')+'"]';selector+='[data-oe-model="'+$field.data('oe-model')+'"]';const $linkedFieldNodes=self.$editable.find(selector).addBack(selector);$linkedFieldNodes.addClass('o_editable_date_field_linked');if(!$field.hasClass('o_editable_date_field_format_changed')){$linkedFieldNodes.text($field.data('oe-original-with-format'));$linkedFieldNodes.addClass('o_editable_date_field_format_changed');$linkedFieldNodes.filter('.oe_hide_on_date_edit').addClass('d-none');setTimeout(()=>{Wysiwyg.setRange($linkedFieldNodes.filter(':not(.oe_hide_on_date_edit)')[0]);},0);}}
if($field.data('oe-type')==="monetary"){$field.attr('contenteditable',false);$field.find('.oe_currency_value').attr('contenteditable',true);}
if($field.data('oe-type')==="image"){$field.attr('contenteditable',false);$field.find('img').attr('contenteditable',true);}
if($field.is('[data-oe-many2one-id]')){$field.attr('contenteditable',false);}
self.odooEditor.observerActive();});this.$editable.on('click','.o_image, .media_iframe_video',e=>e.preventDefault());this.showTooltip=true;this.$editable.on('dblclick',mediaSelector,function(){self.showTooltip=false;const $el=$(this);let params={node:$el};$el.selectElement();if($el.is('.fa')){params.htmlClass=[...$el[0].classList].filter((className)=>{return!className.startsWith('fa')||faZoomClassRegex.test(className);}).join(' ');}
self.openMediaDialog(params);});this.$editable.on('dblclick','a',function(ev){if(!this.getAttribute('data-oe-model')&&self.toolbar.$el.is(':visible')){self.showTooltip=false;self.toggleLinkTools({forceOpen:true,link:this,noFocusUrl:$(ev.target).data('popover-widget-initialized'),});}});if(options.snippets){$(this.odooEditor.document.body).addClass('editor_enable');this.snippetsMenu=new snippetsEditor.SnippetsMenu(this,Object.assign({wysiwyg:this,selectorEditableArea:'.o_editable',},options));await this._insertSnippetMenu();}
if(this.options.getContentEditableAreas){$(this.options.getContentEditableAreas()).find('*').off('mousedown mouseup click');}
this._configureToolbar(options);$(this.odooEditor.editable).on('click',this._updateEditorUI.bind(this));$(this.odooEditor.editable).on('keydown',this._updateEditorUI.bind(this));$(this.odooEditor.editable).on('keydown',this._handleShortcuts.bind(this));this._updateEditorUI();return _super.apply(this,arguments).then(()=>{if(this.options.autohideToolbar){if(this.odooEditor.isMobile){$(this.odooEditor.editable).before(this.toolbar.$el);}else{$(document.body).append(this.toolbar.$el);}}});},setupCollaboration(collaborationChannel){const modelName=collaborationChannel.collaborationModelName;const fieldName=collaborationChannel.collaborationFieldName;const resId=collaborationChannel.collaborationResId;const channelName=`editor_collaboration:${modelName}:${fieldName}:${resId}`;if(!(modelName&&fieldName&&resId)||Wysiwyg.activeCollaborationChannelNames.has(channelName)){return;}
const startCollaborationTime=new Date().getTime();const currentClientId=Math.floor(Math.random()*Math.pow(2,52)).toString();this._collaborationChannelName=channelName;Wysiwyg.activeCollaborationChannelNames.add(channelName);this.call('bus_service','onNotification',this,(notifications)=>{for(const[channel,busData]of notifications){if(channel[1]==='editor_collaboration'&&channel[2]===modelName&&channel[3]===fieldName&&channel[4]===resId){this._peerToPeerLoading.then(()=>this.ptp.handleNotification(busData));}}});this.call('bus_service','addChannel',this._collaborationChannelName);this.call('bus_service','startPolling');let historySyncAtLeastOnce=false;let historySyncFinished=false;const isClientFirst=(clientA,clientB)=>{if(clientA.startTime===clientB.startTime){return clientA.id.localCompare(clientB.id)===-1;}else{return clientA.startTime<clientB.startTime;}};const rpcMutex=new Mutex();this._peerToPeerLoading=new Promise(async(resolve)=>{let iceServers=await this._rpc({route:'/web_editor/get_ice_servers'});if(!iceServers.length){iceServers=[{urls:['stun:stun1.l.google.com:19302','stun:stun2.l.google.com:19302',],}];}
this.ptp=new PeerToPeer({peerConnectionConfig:{iceServers},currentClientId:currentClientId,broadcastAll:(rpcData)=>{return rpcMutex.exec(async()=>{return this._rpc({route:'/web_editor/bus_broadcast',params:{model_name:modelName,field_name:fieldName,res_id:resId,bus_data:rpcData,},});});},onRequest:{get_start_time:()=>startCollaborationTime,get_client_name:async()=>{if(!this._userName){this._userName=(await this._rpc({model:"res.users",method:"search_read",args:[[['id','=',this.getSession().user_id]],['name']],}))[0].name;}
return this._userName;},get_missing_steps:(params)=>this.odooEditor.historyGetMissingSteps(params.requestPayload),get_history_from_snapshot:()=>this.odooEditor.historyGetSnapshotSteps(),get_collaborative_selection:()=>this.odooEditor.getCurrentCollaborativeSelection(),},onNotification:async({fromClientId,notificationName,notificationPayload})=>{switch(notificationName){case'ptp_remove':this.odooEditor.multiselectionRemove(notificationPayload);break;case'ptp_disconnect':this.ptp.removeClient(fromClientId);this.odooEditor.multiselectionRemove(fromClientId);break;case'rtc_data_channel_open':fromClientId=notificationPayload.connectionClientId;const remoteStartTime=await this.ptp.requestClient(fromClientId,'get_start_time',undefined,{transport:'rtc'});this.ptp.clientsInfos[fromClientId].startTime=remoteStartTime;this.ptp.requestClient(fromClientId,'get_client_name',undefined,{transport:'rtc'}).then((clientName)=>{this.ptp.clientsInfos[fromClientId].clientName=clientName;});if(!historySyncAtLeastOnce){historySyncAtLeastOnce=true;await editorCollaborationOptions.onHistoryNeedSync();historySyncFinished=true;}else{const remoteSelection=await this.ptp.requestClient(fromClientId,'get_collaborative_selection',undefined,{transport:'rtc'});if(remoteSelection){this.odooEditor.onExternalMultiselectionUpdate(remoteSelection);}}
break;case'oe_history_step':if(historySyncFinished){this.odooEditor.onExternalHistorySteps([notificationPayload]);}
break;case'oe_history_set_selection':const client=this.ptp.clientsInfos[fromClientId];if(!client){return;}
const selection=notificationPayload;selection.clientName=client.clientName;this.odooEditor.onExternalMultiselectionUpdate(selection);break;}}});resolve();});const editorCollaborationOptions={collaborationClientId:currentClientId,onHistoryStep:(historyStep)=>{if(!this.ptp)return;this.ptp.notifyAllClients('oe_history_step',historyStep,{transport:'rtc'});},onCollaborativeSelectionChange:_.throttle((collaborativeSelection)=>{if(!this.ptp)return;this.ptp.notifyAllClients('oe_history_set_selection',collaborativeSelection,{transport:'rtc'});},50),onHistoryMissingParentSteps:async({step,fromStepId})=>{if(!this.ptp)return;const missingSteps=await this.ptp.requestClient(step.clientId,'get_missing_steps',{fromStepId:fromStepId,toStepId:step.id},{transport:'rtc'});if(missingSteps===-1||!missingSteps.length){console.warn('Editor get_missing_steps result is erroneous.');return;}
this.ptp&&this.odooEditor.onExternalHistorySteps(missingSteps.concat([step]));},onHistoryNeedSync:async()=>{if(!this.ptp)return;let firstClientId=currentClientId;let firstClientStartTime=startCollaborationTime;const connectedClientIds=this.ptp.getConnectedClientIds();for(const clientId of connectedClientIds){const clientInfo=this.ptp.clientsInfos[clientId];if(!clientInfo.startTime){continue;}
const isCurrentClientFirst=isClientFirst({startTime:clientInfo.startTime,id:clientId,},{startTime:firstClientStartTime,id:firstClientId,});if(isCurrentClientFirst){firstClientStartTime=clientInfo.startTime;firstClientId=clientId;}}
if(firstClientId!==currentClientId){const historySteps=await this.ptp.requestClient(firstClientId,'get_history_from_snapshot',undefined,{transport:'rtc'});this.odooEditor.historyResetFromSteps(historySteps);const remoteSelection=await this.ptp.requestClient(firstClientId,'get_collaborative_selection',undefined,{transport:'rtc'});if(remoteSelection){this.odooEditor.onExternalMultiselectionUpdate(remoteSelection);}}},}
return editorCollaborationOptions;},destroy:function(){if(this._collaborationChannelName){Wysiwyg.activeCollaborationChannelNames.delete(this._collaborationChannelName);}
if(this.odooEditor){this.odooEditor.destroy();}
if(this._peerToPeerLoading){this._peerToPeerLoading.then(()=>{this.call('bus_service','deleteChannel',this._collaborationChannelName);this.ptp.closeAllConnections();});}
this.$editable&&this.$editable.off('blur',this._onBlur);document.removeEventListener('mousedown',this._onDocumentMousedown,true);const $body=$(document.body);$body.off('mousemove',this.resizerMousemove);$body.off('mouseup',this.resizerMouseup);const $wrapwrap=$('#wrapwrap');if($wrapwrap.length){$('#wrapwrap')[0].removeEventListener('scroll',this.odooEditor.multiselectionRefresh,{passive:true});}
this._super();},renderElement:function(){this.$editable=this.options.editable||$('<div class="note-editable">');if(this.options.resizable&&!device.isMobile){const $wrapper=$('<div class="o_wysiwyg_wrapper odoo-editor">');$wrapper.append(this.$editable);this.$resizer=$(`<div class="o_wysiwyg_resizer">
                <div class="o_wysiwyg_resizer_hook"></div>
                <div class="o_wysiwyg_resizer_hook"></div>
                <div class="o_wysiwyg_resizer_hook"></div>
            </div>`);$wrapper.append(this.$resizer);this._replaceElement($wrapper);const minHeight=this.options.minHeight||100;this.$editable.height(this.options.height||minHeight);let startOffsetTop;let startHeight;const $body=$(document.body);const resizerMousedown=(e)=>{e.preventDefault();e.stopPropagation();$body.on('mousemove',this.resizerMousemove);$body.on('mouseup',this.resizerMouseup);startHeight=this.$editable.height();startOffsetTop=e.pageY;};this.resizerMousemove=(e)=>{const offsetTop=e.pageY-startOffsetTop;let height=startHeight+offsetTop;if(height<minHeight){height=minHeight;}
this.$editable.height(height);};this.resizerMouseup=()=>{$body.off('mousemove',this.resizerMousemove);$body.off('mouseup',this.resizerMouseup);};this.$resizer.on('mousedown',resizerMousedown);}else{this._replaceElement(this.$editable);}},getEditable:function(){return this.$editable;},isDirty:function(){return this._value!==(this.$editable.html()||this.$editable.val());},getValue:function(options){var $editable=options&&options.$layout||this.$editable.clone();$editable.find('[contenteditable]').removeAttr('contenteditable');$editable.find('[class=""]').removeAttr('class');$editable.find('[style=""]').removeAttr('style');$editable.find('[title=""]').removeAttr('title');$editable.find('[alt=""]').removeAttr('alt');$editable.find('[data-original-title=""]').removeAttr('data-original-title');$editable.find('a.o_image, span.fa, i.fa').html('');$editable.find('[aria-describedby]').removeAttr('aria-describedby').removeAttr('data-original-title');this.odooEditor.cleanForSave($editable[0]);return $editable.html();},save:function(){var isDirty=this.isDirty();var html=this.getValue();if(this.$editable.is('textarea')){this.$editable.val(html);}else{this.$editable.html(html);}
return Promise.resolve({isDirty:isDirty,html:html});},saveContent:async function(reload=true){await this.saveToServer(reload);},historyReset:function(){this.odooEditor.historyReset();},saveToServer:async function(reload=true){const defs=[];this.trigger_up('edition_will_stopped');this.trigger_up('ready_to_save',{defs:defs});await Promise.all(defs);this._cleanForSave();if(this.snippetsMenu){await this.snippetsMenu.cleanForSave();}
const editables=this.options.getContentEditableAreas();await this.saveModifiedImages(editables.length?$(editables):this.$editable);await this._saveViewBlocks();this.trigger_up('edition_was_stopped');window.onbeforeunload=null;if(reload){window.location.reload();}},cancel:function(reload){var self=this;return new Promise((resolve,reject)=>{if(!this.odooEditor.historySize().length){resolve();}else{var confirm=Dialog.confirm(this,_t("If you discard the current edits, all unsaved changes will be lost. You can cancel to return to edit mode."),{confirm_callback:resolve,});confirm.on('closed',self,reject);}}).then(function(){if(reload!==false){window.onbeforeunload=null;return self._reload();}});},saveModifiedImages:function($editable=this.$editable){const defs=_.map($editable,async editableEl=>{const{oeModel:resModel,oeId:resId}=editableEl.dataset;const proms=[...editableEl.querySelectorAll('.o_modified_image_to_save')].map(async el=>{const isBackground=!el.matches('img');el.classList.remove('o_modified_image_to_save');const newAttachmentSrc=await this._rpc({route:`/web_editor/modify_image/${el.dataset.originalId}`,params:{res_model:resModel,res_id:parseInt(resId),data:(isBackground?el.dataset.bgSrc:el.getAttribute('src')).split(',')[1],mimetype:el.dataset.mimetype,name:(el.dataset.fileName?el.dataset.fileName:null),},});if(isBackground){const parts=weUtils.backgroundImageCssToParts($(el).css('background-image'));parts.url=`url('${newAttachmentSrc}')`;const combined=weUtils.backgroundImagePartsToCss(parts);$(el).css('background-image',combined);delete el.dataset.bgSrc;}else{el.setAttribute('src',newAttachmentSrc);}});return Promise.all(proms);});return Promise.all(defs);},setValue:function(value){this.$editable.html(value);this.odooEditor.sanitize();},undo:function(){this.odooEditor.historyUndo();},redo:function(){this.odooEditor.historyRedo();},focus:function(){if(!this.odooEditor.historyResetLatestComputedSelection()){const range=document.createRange();const elementToTarget=this.$editable[0].lastElementChild?this.$editable[0].lastElementChild:this.$editable[0];range.selectNodeContents(elementToTarget);range.collapse();const selection=this.odooEditor.document.getSelection();selection.removeAllRanges();selection.addRange(range);}},_observeOdooFieldChanges:function(){const observerOptions={childList:true,subtree:true,attributes:true,characterData:true,};if(this.odooFieldObservers){for(let observerData of this.odooFieldObservers){observerData.observer.observe(observerData.field,observerOptions);}}else{const odooFieldSelector='[data-oe-model], [data-oe-translation-id]';const $odooFields=this.$editable.find(odooFieldSelector);this.odooFieldObservers=[];$odooFields.each((i,field)=>{const observer=new MutationObserver(()=>{let $node=$(field);let $nodes=$odooFields.filter(function(){return this!==field;});if($node.data('oe-model')){$nodes=$nodes.filter('[data-oe-model="'+$node.data('oe-model')+'"]').filter('[data-oe-id="'+$node.data('oe-id')+'"]').filter('[data-oe-field="'+$node.data('oe-field')+'"]');}
if($node.data('oe-translation-id')){$nodes=$nodes.filter('[data-oe-translation-id="'+$node.data('oe-translation-id')+'"]');}
if($node.data('oe-type')){$nodes=$nodes.filter('[data-oe-type="'+$node.data('oe-type')+'"]');}
if($node.data('oe-expression')){$nodes=$nodes.filter('[data-oe-expression="'+$node.data('oe-expression')+'"]');}else if($node.data('oe-xpath')){$nodes=$nodes.filter('[data-oe-xpath="'+$node.data('oe-xpath')+'"]');}
if($node.data('oe-contact-options')){$nodes=$nodes.filter("[data-oe-contact-options='"+$node[0].dataset.oeContactOptions+"']");}
let nodes=$node.get();if($node.data('oe-type')==="many2one"){$nodes=$nodes.add($('[data-oe-model]').filter(function(){return this!==$node[0]&&nodes.indexOf(this)===-1;}).filter('[data-oe-many2one-model="'+$node.data('oe-many2one-model')+'"]').filter('[data-oe-many2one-id="'+$node.data('oe-many2one-id')+'"]').filter('[data-oe-type="many2one"]'));$nodes=$nodes.add($('[data-oe-model]').filter(function(){return this!==$node[0]&&nodes.indexOf(this)===-1;}).filter('[data-oe-model="'+$node.data('oe-many2one-model')+'"]').filter('[data-oe-id="'+$node.data('oe-many2one-id')+'"]').filter('[data-oe-field="name"]'));}
this._pauseOdooFieldObservers();if($node.hasClass('o_editable_date_field_format_changed')){$nodes.addClass('o_editable_date_field_format_changed');}
$nodes.html($node.html());this._observeOdooFieldChanges();});observer.observe(field,observerOptions);this.odooFieldObservers.push({field:field,observer:observer});});}},_pauseOdooFieldObservers:function(){for(let observerData of this.odooFieldObservers){observerData.observer.disconnect();}},toggleLinkTools(options={}){if(this.snippetsMenu&&!options.forceDialog){if(this.linkTools){this.linkTools.destroy();}
if(options.forceOpen||!this.linkTools){const $btn=this.toolbar.$el.find('#create-link');this.linkTools=new weWidgets.LinkTools(this,{wysiwyg:this,noFocusUrl:options.noFocusUrl},this.odooEditor.editable,{},$btn,options.link||this.lastMediaClicked);const _onMousedown=ev=>{if(!ev.target.closest('.oe-toolbar')&&!ev.target.closest('.ui-autocomplete')){this.linkTools&&this.linkTools.destroy();this.linkTools=undefined;this.odooEditor.document.removeEventListener('mousedown',_onMousedown,true);}};this.odooEditor.document.addEventListener('mousedown',_onMousedown,true);this.linkTools.appendTo(this.toolbar.$el);}else{this.linkTools=undefined;}}else{const linkDialog=new weWidgets.LinkDialog(this,{forceNewWindow:this.options.linkForceNewWindow,wysiwyg:this,},this.$editable[0],{},undefined,options.link);const restoreSelection=preserveCursor(this.odooEditor.document);linkDialog.open();linkDialog.on('save',this,data=>{const linkWidget=linkDialog.linkWidget;getDeepRange(this.$editable[0],{range:data.range,select:true});if(!linkWidget.$link.length){linkWidget.$link=$(linkWidget.getOrCreateLink(this.$editable[0]));}
if(this.options.userGeneratedContent){data.rel='ugc';}
linkWidget.applyLinkToDom(data);this.odooEditor.historyStep();setTimeout(()=>this.odooEditor.document.getSelection().collapseToEnd(),0);});linkDialog.on('closed',this,function(){if(linkDialog.destroyAction!=='save'){restoreSelection();}});}},openMediaDialog(params={}){const sel=this.odooEditor.document.getSelection();const fontawesomeIcon=getInSelection(this.odooEditor.document,'.fa');if(fontawesomeIcon&&sel.toString().trim()===""){params.node=$(fontawesomeIcon);params.htmlClass=[...fontawesomeIcon.classList].filter((className)=>{return!className.startsWith('fa')||faZoomClassRegex.test(className);}).join(' ');}
if(!sel.rangeCount){return;}
const range=sel.getRangeAt(0);const restoreSelection=preserveCursor(this.odooEditor.document);const $node=$(params.node);const $editable=$(OdooEditorLib.closestElement(range.startContainer,'.o_editable'));const model=$editable.data('oe-model');const field=$editable.data('oe-field');const type=$editable.data('oe-type');const mediaParams=Object.assign({res_model:model,res_id:$editable.data('oe-id'),domain:$editable.data('oe-media-domain'),useMediaLibrary:field&&(model==='ir.ui.view'&&field==='arch'||type==='html'),},this.options.mediaModalParams,params);const mediaDialog=new weWidgets.MediaDialog(this,mediaParams,$node);mediaDialog.open();mediaDialog.on('save',this,function(element){if(params.htmlClass){element.className+=" "+params.htmlClass;}
restoreSelection();if(wysiwygUtils.isImg($node[0])){$node.replaceWith(element);this.odooEditor.unbreakableStepUnactive();this.odooEditor.historyStep();}else if(element){this.odooEditor.execCommand('insertHTML',element.outerHTML);}});mediaDialog.on('closed',this,function(){if(mediaDialog.destroyAction!=='save'){restoreSelection();}});},_configureToolbar:function(options){const $toolbar=this.toolbar.$el;const openTools=e=>{e.preventDefault();e.stopImmediatePropagation();e.stopPropagation();switch(e.target.id){case'create-link':this.toggleLinkTools();break;case'media-insert':case'media-replace':this.openMediaDialog();break;case'media-description':new weWidgets.AltDialog(this,{},this.lastMediaClicked).open();break;}};if(!this.options.snippets){$toolbar.find('#justify, #table, #media-insert').remove();}
$toolbar.find('#create-link, #media-insert, #media-replace, #media-description').click(openTools);$toolbar.find('#image-shape div, #fa-spin').click(e=>{if(!this.lastMediaClicked){return;}
this.lastMediaClicked.classList.toggle(e.target.id);e.target.classList.toggle('active',$(this.lastMediaClicked).hasClass(e.target.id));});const $imageWidthButtons=$toolbar.find('#image-width div');$imageWidthButtons.click(e=>{if(!this.lastMediaClicked){return;}
this.lastMediaClicked.style.width=e.target.id;for(const button of $imageWidthButtons){button.classList.toggle('active',this.lastMediaClicked.style.width===button.id);}});$toolbar.find('#image-padding .dropdown-item').click(e=>{if(!this.lastMediaClicked){return;}
$(this.lastMediaClicked).removeClass((index,className)=>((className.match(/(^|\s)padding-\w+/g)||[]).join(' '))).addClass(e.target.dataset.class);});$toolbar.on('mousedown',e=>{const justifyBtn=e.target.closest('#justify div.btn');if(!justifyBtn||!this.lastMediaClicked){return;}
e.originalEvent.stopImmediatePropagation();e.originalEvent.stopPropagation();e.originalEvent.preventDefault();const mode=justifyBtn.id.replace('justify','').toLowerCase();const classes=mode==='center'?['d-block','mx-auto']:['float-'+mode];const doAdd=classes.some(className=>!this.lastMediaClicked.classList.contains(className));this.lastMediaClicked.classList.remove('float-left','float-right');if(this.lastMediaClicked.classList.contains('mx-auto')){this.lastMediaClicked.classList.remove('d-block','mx-auto');}
if(doAdd){this.lastMediaClicked.classList.add(...classes);}
this._updateMediaJustifyButton(justifyBtn.id);});$toolbar.find('#image-crop').click(e=>{if(!this.lastMediaClicked){return;}
new weWidgets.ImageCropWidget(this,this.lastMediaClicked).appendTo(this.$editable);});$toolbar.find('#image-transform').click(e=>{if(!this.lastMediaClicked){return;}
const $image=$(this.lastMediaClicked);if($image.data('transfo-destroy')){$image.removeData('transfo-destroy');return;}
$image.transfo({document:this.odooEditor.document});const mouseup=()=>{$('#image-transform').toggleClass('active',$image.is('[style*="transform"]'));};$(this.odooEditor.document).on('mouseup',mouseup);const mousedown=mousedownEvent=>{if(!$(mousedownEvent.target).closest('.transfo-container').length){$image.transfo('destroy');$(this.odooEditor.document).off('mousedown',mousedown).off('mouseup',mouseup);}
if($(mousedownEvent.target).closest('#image-transform').length){$image.data('transfo-destroy',true).attr('style',($image.attr('style')||'').replace(/[^;]*transform[\w:]*;?/g,''));}
$image.trigger('content_changed');};$(this.odooEditor.document).on('mousedown',mousedown);});$toolbar.find('#image-delete').click(e=>{if(!this.lastMediaClicked){return;}
$(this.lastMediaClicked).remove();this.lastMediaClicked=undefined;});$toolbar.find('#fa-resize div').click(e=>{if(!this.lastMediaClicked){return;}
const $target=$(this.lastMediaClicked);const sValue=e.target.dataset.value;$target.attr('class',$target.attr('class').replace(/\s*fa-[0-9]+x/g,''));if(+sValue>1){$target.addClass('fa-'+sValue+'x');}
this._updateFaResizeButtons();});const $colorpickerGroup=$toolbar.find('#colorInputButtonGroup');if($colorpickerGroup.length){this._createPalette();}
setTimeout(()=>{const scrollableContainer=this.$el.scrollParent();if(!options.snippets&&scrollableContainer.length){}},0);},_getSelectedColor($,eventName){const selection=this.odooEditor.document.getSelection();const range=selection.rangeCount&&selection.getRangeAt(0);const targetNode=range&&range.startContainer;const targetElement=targetNode&&targetNode.nodeType===Node.ELEMENT_NODE?targetNode:targetNode&&targetNode.parentNode;const backgroundImage=$(targetElement).css('background-image');let backgroundGradient=false;if(weUtils.isColorGradient(backgroundImage)){const textGradient=targetElement.classList.contains('text-gradient');if(eventName==="foreColor"&&textGradient||eventName!=="foreColor"&&!textGradient){backgroundGradient=backgroundImage;}}
return backgroundGradient||$(targetElement).css(eventName==="foreColor"?'color':'backgroundColor');},_createPalette(){const $dropdownContent=this.toolbar.$el.find('#colorInputButtonGroup .colorPalette');for(const elem of $dropdownContent){const eventName=elem.dataset.eventName;let colorpicker=null;const mutex=new concurrency.MutexedDropPrevious();const $=elem.ownerDocument.defaultView.$;const $dropdown=$(elem).closest('.colorpicker-group , .dropdown');let manualOpening=false;$dropdown.on('hide.bs.dropdown',ev=>{return!(ev.clickEvent&&ev.clickEvent.originalEvent&&ev.clickEvent.originalEvent.__isColorpickerClick);});$dropdown.on('show.bs.dropdown',()=>{if(manualOpening){return true;}
mutex.exec(()=>{const oldColorpicker=colorpicker;const hookEl=oldColorpicker?oldColorpicker.el:elem;const selectedColor=this._getSelectedColor($,eventName);const selection=this.odooEditor.document.getSelection();const range=selection.rangeCount&&selection.getRangeAt(0);const hadNonCollapsedSelection=range&&!selection.isCollapsed;colorpicker=new ColorPaletteWidget(this,{excluded:['transparent_grayscale'],$editable:$(this.odooEditor.editable),selectedColor:selectedColor,selectedTab:weUtils.isColorGradient(selectedColor)?'gradients':'theme-colors',withGradients:true,});this.colorpickers[eventName]=colorpicker;colorpicker.on('custom_color_picked color_picked',null,ev=>{if(hadNonCollapsedSelection){this.odooEditor.historyResetLatestComputedSelection(true);}
this._processAndApplyColor(eventName,ev.data.color);this._updateEditorUI();});colorpicker.on('color_hover color_leave',null,ev=>{if(hadNonCollapsedSelection){this.odooEditor.historyResetLatestComputedSelection(true);}
this.odooEditor.historyPauseSteps();try{this._processAndApplyColor(eventName,ev.data.color);}finally{this.odooEditor.historyUnpauseSteps();}});colorpicker.on('enter_key_color_colorpicker',null,()=>{$dropdown.children('.dropdown-toggle').dropdown('hide');});return colorpicker.replace(hookEl).then(()=>{if(oldColorpicker){oldColorpicker.destroy();}
manualOpening=true;$dropdown.children('.dropdown-toggle').dropdown('show');const $colorpicker=$dropdown.find('.colorpicker');const colorpickerHeight=$colorpicker.outerHeight();const toolbarContainerTop=dom.closestScrollable(this.toolbar.el).getBoundingClientRect().top;const toolbarColorButtonTop=this.toolbar.el.querySelector('#colorInputButtonGroup').getBoundingClientRect().top;$dropdown[0].classList.toggle('dropup',colorpickerHeight+toolbarContainerTop<=toolbarColorButtonTop);manualOpening=false;});});return false;});}},_processAndApplyColor:function(eventName,color){if(!color){color='inherit';}else if(!ColorpickerWidget.isCSSColor(color)&&!weUtils.isColorGradient(color)){color=(eventName==="foreColor"?'text-':'bg-')+color;}
this.odooEditor.execCommand('applyColor',color,eventName==='foreColor'?'color':'backgroundColor',this.lastMediaClicked);const hexColor=this._colorToHex(color);this.odooEditor.updateColorpickerLabels({[eventName==='foreColor'?'foreColor':'hiliteColor']:hexColor,});},_colorToHex:function(color){if(color.startsWith('#')){return color;}else if(weUtils.isColorGradient(color)){return color;}else{let rgbColor;if(color.startsWith('rgb')){rgbColor=color;}else{const $font=$(`<font class="${color}"/>`);$(document.body).append($font);const propertyName=color.startsWith('text')?'color':'backgroundColor';rgbColor=$font.css(propertyName);$font.remove();}
return rgbToHex(rgbColor);}},_handleShortcuts:function(e){if(e&&e.key==='k'&&(e.ctrlKey||e.metaKey)){e.preventDefault();this.toggleLinkTools();}
if(e&&e.key==='a'&&(e.ctrlKey||e.metaKey)){e.preventDefault();const selection=this.odooEditor.document.getSelection();const containerSelector='#wrap>*, [contenteditable], .oe_structure>*';let $deepestParent=selection?$(selection.anchorNode).parentsUntil(containerSelector).last():$();if($deepestParent.is('html')){$deepestParent=this.$editable.find(containerSelector);}
if($deepestParent.length){const range=document.createRange();range.selectNodeContents($deepestParent.parent()[0]);selection.removeAllRanges();selection.addRange(range);}}},_updateEditorUI:function(e){this.odooEditor.automaticStepSkipStack();const editorWindow=this.odooEditor.document.defaultView;const $target=e?editorWindow.$(e.target):editorWindow.$();this.toolbar.$el.find('#mediaParagraphDropdownButton').attr('id','paragraphDropdownButton');const selection=this.odooEditor.document.getSelection();const range=selection.rangeCount&&selection.getRangeAt(0);const $rangeContainer=range&&$(range.commonAncestorContainer);const spansBlocks=range&&!!$rangeContainer.contents().filter((i,node)=>isBlock(node)).length;this.toolbar.$el.find('#create-link').toggleClass('d-none',!range||spansBlocks);const isInMedia=$target.is(mediaSelector);this.toolbar.$el.find(['#image-shape','#image-width','#image-padding','#image-edit','#media-replace',].join(',')).toggleClass('d-none',!isInMedia);if(this.snippetsMenu&&$target.is('img')){this.toolbar.$el.find('#media-replace').toggleClass('d-none',true);}
this.toolbar.$el.find(['#image-transform','#image-crop','#media-description',].join(',')).toggleClass('d-none',!$target.is('img'));this.lastMediaClicked=isInMedia&&e.target;this.lastElement=$target[0];this.toolbar.$el.find(['#style','#decoration','#font-size','#justifyFull','#list','#colorInputButtonGroup','#table','#create-link','#media-insert',].join(',')).toggleClass('d-none',isInMedia);this.toolbar.$el.find('#colorInputButtonGroup, #create-link').toggleClass('d-none',isInMedia&&!$target.is('.fa'));this.toolbar.$el.find('.only_fa').toggleClass('d-none',!$target.is('.fa'));this.toolbar.$el.toggleClass('noarrow',isInMedia);this.$editable.find('.o_we_selected_image').removeClass('o_we_selected_image');if(isInMedia){this.odooEditor.automaticStepSkipStack();const selection=this.odooEditor.document.getSelection();const range=this.odooEditor.document.createRange();range.selectNode(this.lastMediaClicked);selection.removeAllRanges();selection.addRange(range);this.toolbar.$el.find('#unlink').toggleClass('d-none',true);if(this.options.autohideToolbar){const imagePosition=this.lastMediaClicked.getBoundingClientRect();this.toolbar.$el.css({visibility:'visible',top:imagePosition.top+10+'px',left:imagePosition.left+10+'px',});}
for(const button of this.toolbar.$el.find('#image-shape div, #fa-spin')){button.classList.toggle('active',$(e.target).hasClass(button.id));}
for(const button of this.toolbar.$el.find('#image-width div')){button.classList.toggle('active',e.target.style.width===button.id);}
this._updateMediaJustifyButton();this._updateFaResizeButtons();}
const link=getInSelection(this.odooEditor.document,'a');if(isInMedia||link){this.showTooltip=true;setTimeout(()=>{if(!this.showTooltip||$target.attr('title')!==undefined){return;}
$target.tooltip({title:_t('Double-click to edit'),trigger:'manual',container:'body'}).tooltip('show');setTimeout(()=>$target.tooltip('dispose'),800);},400);}
for(let eventName in this.colorpickers){const selectedColor=this._getSelectedColor($,eventName);if(selectedColor){this.colorpickers[eventName].setSelectedColor(null,selectedColor,false);}}},_updateMediaJustifyButton:function(commandState){if(!this.lastMediaClicked){return;}
const $paragraphDropdownButton=this.toolbar.$el.find('#paragraphDropdownButton, #mediaParagraphDropdownButton');$paragraphDropdownButton.attr('id','mediaParagraphDropdownButton');let resetAlignment=true;if(!commandState){const justifyMapping=[['float-left','justifyLeft'],['mx-auto','justifyCenter'],['float-right','justifyRight'],];commandState=(justifyMapping.find(pair=>(this.lastMediaClicked.classList.contains(pair[0])))||[])[1];resetAlignment=!commandState;}
const $buttons=this.toolbar.$el.find('#justify div.btn');let newClass;if(commandState){const direction=commandState.replace('justify','').toLowerCase();newClass=`fa-align-${direction === 'full' ? 'justify' : direction}`;resetAlignment=!['float-left','mx-auto','float-right'].some(className=>(this.lastMediaClicked.classList.contains(className)));}
for(const button of $buttons){button.classList.toggle('active',!resetAlignment&&button.id===commandState);}
$paragraphDropdownButton.removeClass((index,className)=>((className.match(/(^|\s)fa-align-\w+/g)||[]).join(' ')));if(commandState&&!resetAlignment){$paragraphDropdownButton.addClass(newClass);}else{$paragraphDropdownButton.addClass('fa-align-justify');}},_updateFaResizeButtons:function(){if(!this.lastMediaClicked){return;}
const $buttons=this.toolbar.$el.find('#fa-resize div');const match=this.lastMediaClicked.className.match(/\s*fa-([0-9]+)x/);const value=match&&match[1]?match[1]:'1';for(const button of $buttons){button.classList.toggle('active',button.dataset.value===value);}},_editorOptions:function(){var self=this;var options=Object.assign({},this.defaultOptions,this.options);options.onChange=function(html,$editable){$editable.trigger('content_changed');self.trigger_up('wysiwyg_change');};options.onUpload=function(attachments){self.trigger_up('wysiwyg_attachment',attachments);};options.onFocus=function(){self.trigger_up('wysiwyg_focus');};options.onBlur=function(){self.trigger_up('wysiwyg_blur');};return options;},_insertSnippetMenu:function(){return this.snippetsMenu.insertBefore(this.$el);},_saveTranslationElement:function($el,context,withLang=true){if($el.data('oe-translation-id')){return this._rpc({model:'ir.translation',method:'save_html',args:[[+$el.data('oe-translation-id')],this._getEscapedElement($el).html()],context:context,});}else{var viewID=$el.data('oe-id');if(!viewID){return Promise.resolve();}
return this._rpc({model:'ir.ui.view',method:'save',args:[viewID,this._getEscapedElement($el).prop('outerHTML'),!$el.data('oe-expression')&&$el.data('oe-xpath')||null,],context:context,},withLang?undefined:{noContextKeys:'lang',});}},_cleanForSave:function(){this.odooEditor.clean();this.$editable.find('.oe_edited_link').removeClass('oe_edited_link');},_getCommands:function(){const commands=[{groupName:'Basic blocks',title:'Quote',description:'Add a blockquote section.',fontawesome:'fa-quote-right',callback:()=>{this.odooEditor.execCommand('setTag','blockquote');},},{groupName:'Basic blocks',title:'Code',description:'Add a code section.',fontawesome:'fa-code',callback:()=>{this.odooEditor.execCommand('setTag','pre');},},{groupName:'Navigation',title:'Link',description:'Add a link.',fontawesome:'fa-link',callback:()=>{this.toggleLinkTools({forceDialog:true});},},{groupName:'Navigation',title:'Button',description:'Add a button.',fontawesome:'fa-link',callback:()=>{this.toggleLinkTools({forceDialog:true});setTimeout(()=>{$(".o_link_dialog .link-style[value=primary]").click();},150);},},{groupName:'Medias',title:'Image',description:'Insert an image.',fontawesome:'fa-file-image-o',callback:()=>{this.openMediaDialog();},},{groupName:'Medias',title:'Video',description:'Insert a video.',fontawesome:'fa-file-video-o',callback:()=>{this.openMediaDialog({noVideos:false,noImages:true,noIcons:true,noDocuments:true});},},];if(this.options.snippets){commands.push(...this._getSnippetsCommands());}
return commands;},_getSnippetsCommands:function(){const snippetCommandCallback=(selector)=>{const $separatorBody=$(selector);const $clonedBody=$separatorBody.clone();const range=getDeepRange(this.odooEditor.editable);const block=closestElement(range.endContainer,'p, div, ol, ul, cl, h1, h2, h3, h4, h5, h6');block&&block.after($clonedBody[0]);};return[{groupName:'Website',title:'Alert',description:'Insert an alert snippet.',fontawesome:'fa-info',callback:()=>{snippetCommandCallback('.oe_snippet_body[data-snippet="s_alert"]');},},{groupName:'Website',title:'Rating',description:'Insert a rating snippet.',fontawesome:'fa-star-half-o',callback:()=>{snippetCommandCallback('.oe_snippet_body[data-snippet="s_rating"]');},},{groupName:'Website',title:'Card',description:'Insert a card snippet.',fontawesome:'fa-sticky-note',callback:()=>{snippetCommandCallback('.oe_snippet_body[data-snippet="s_card"]');},},{groupName:'Website',title:'Share',description:'Insert a share snippet.',fontawesome:'fa-share-square-o',callback:()=>{snippetCommandCallback('.oe_snippet_body[data-snippet="s_share"]');},},{groupName:'Website',title:'Text Highlight',description:'Insert a text Highlight snippet.',fontawesome:'fa-sticky-note',callback:()=>{snippetCommandCallback('.oe_snippet_body[data-snippet="s_text_highlight"]');},},{groupName:'Website',title:'Chart',description:'Insert a chart snippet.',fontawesome:'fa-bar-chart',callback:()=>{snippetCommandCallback('.oe_snippet_body[data-snippet="s_chart"]');},},{groupName:'Website',title:'Progress Bar',description:'Insert a progress bar snippet.',fontawesome:'fa-spinner',callback:()=>{snippetCommandCallback('.oe_snippet_body[data-snippet="s_progress_bar"]');},},{groupName:'Website',title:'Badge',description:'Insert a badge snippet.',fontawesome:'fa-tags',callback:()=>{snippetCommandCallback('.oe_snippet_body[data-snippet="s_badge"]');},},{groupName:'Website',title:'Blockquote',description:'Insert a blockquote snippet.',fontawesome:'fa-quote-left',callback:()=>{snippetCommandCallback('.oe_snippet_body[data-snippet="s_blockquote"]');},},{groupName:'Website',title:'Separator',description:'Insert an horizontal separator sippet.',fontawesome:'fa-minus',callback:()=>{snippetCommandCallback('.oe_snippet_body[data-snippet="s_hr"]');},},];},editable:function(){return $('#wrapwrap [data-oe-model]').not('.o_not_editable').filter(function(){return!$(this).closest('.o_not_editable').length;}).not('link, script').not('[data-oe-readonly]').not('img[data-oe-field="arch"], br[data-oe-field="arch"], input[data-oe-field="arch"]').not('.oe_snippet_editor').add('.o_editable');},_saveViewBlocks:function(context){const $allBlocks=$((this.options||{}).savableSelector).filter('.o_dirty');const $dirty=$('.o_dirty');$dirty.removeAttr('contentEditable').removeClass('o_dirty oe_carlos_danger o_is_inline_editable');$('.o_editable').removeClass('o_editable o_is_inline_editable o_editable_date_field_linked o_editable_date_field_format_changed');const defs=_.map($allBlocks,(el)=>{const $el=$(el);$el.find('[class]').filter(function(){if(!this.getAttribute('class').match(/\S/)){this.removeAttribute('class');}});return this.saving_mutex.exec(()=>{let saveElement='_saveElement';if(this.options.enableTranslation){saveElement='_saveTranslationElement';}
return this[saveElement]($el,context||weContext.get()).then(function(){$el.removeClass('o_dirty');}).guardedCatch(function(response){var id=_.uniqueId('carlos_danger_');$el.addClass('o_dirty oe_carlos_danger '+id);$('.o_editable.'+id).removeClass(id).popover({trigger:'hover',content:response.message.data.message||'',placement:'auto top',}).popover('show');});});});return Promise.all(defs).then(function(){window.onbeforeunload=null;}).guardedCatch((failed)=>{this.cancel();this.start();});},_attachTooltips:function(){$(document.body).tooltip({selector:'[data-oe-readonly]',container:'body',trigger:'hover',delay:{'show':1000,'hide':100},placement:'bottom',title:_t("Readonly field")}).on('click',function(){$(this).tooltip('hide');});},_getEscapedElement:function($el){var escaped_el=$el.clone();var to_escape=escaped_el.find('*').addBack();to_escape=to_escape.not(to_escape.filter('object,iframe,script,style,[data-oe-model][data-oe-model!="ir.ui.view"]').find('*').addBack());to_escape.contents().each(function(){if(this.nodeType===3){this.nodeValue=$('<div />').text(this.nodeValue).html();}});return escaped_el;},_saveElement:function($el,context,withLang){var viewID=$el.data('oe-id');if(!viewID){return Promise.resolve();}
return this._rpc({model:'ir.ui.view',method:'save',args:[viewID,this._getEscapedElement($el).prop('outerHTML'),!$el.data('oe-expression')&&$el.data('oe-xpath')||null,],context:context,},withLang?undefined:{noContextKeys:'lang',});},_reload:function(){window.location.hash='scrollTop='+window.document.body.scrollTop;if(window.location.search.indexOf('enable_editor')>=0){window.location.href=window.location.href.replace(/&?enable_editor(=[^&]*)?/g,'');}else{window.location.reload(true);}
return new Promise(function(){});},_onDocumentMousedown:function(e){if(!e.target.classList.contains('o_editable_date_field_linked')){this.$editable.find('.o_editable_date_field_linked').removeClass('o_editable_date_field_linked');}
if(e.target.closest('.oe-toolbar')){this._onToolbar=true;}else{if(this._pendingBlur&&!e.target.closest('.o_wysiwyg_wrapper')){this.trigger_up('wysiwyg_blur');this._pendingBlur=false;}
this._onToolbar=false;}},_onBlur:function(){if(this._onToolbar){this._pendingBlur=true;}else{this.trigger_up('wysiwyg_blur');}},});Wysiwyg.activeCollaborationChannelNames=new Set();Wysiwyg.getRange=function(ownerDocument){const selection=(ownerDocument||document).getSelection();if(selection.rangeCount===0){return{sc:null,so:0,ec:null,eo:0,};}
const range=selection.getRangeAt(0);return{sc:range.startContainer,so:range.startOffset,ec:range.endContainer,eo:range.endOffset,};};Wysiwyg.setRange=function(startNode,startOffset=0,endNode=startNode,endOffset=startOffset){const selection=document.getSelection();selection.removeAllRanges();const range=new Range();range.setStart(startNode,startOffset);range.setEnd(endNode,endOffset);selection.addRange(range);};return Wysiwyg;});odoo.define('web_editor.widget',function(require){'use strict';return{Dialog:require('wysiwyg.widgets.Dialog'),MediaDialog:require('wysiwyg.widgets.MediaDialog'),LinkDialog:require('wysiwyg.widgets.LinkDialog'),};});;

/* /web_editor/static/src/js/wysiwyg/wysiwyg_iframe.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('web_editor.wysiwyg.iframe',function(require){'use strict';var Wysiwyg=require('web_editor.wysiwyg');var ajax=require('web.ajax');var core=require('web.core');var config=require('web.config');var qweb=core.qweb;var promiseCommon;var promiseWysiwyg;Wysiwyg.include({init:function(parent,options){this._super.apply(this,arguments);if(this.options.inIframe){this._onUpdateIframeId='onLoad_'+this.id;}
this.__extraAssetsForIframe=[];},willStart:async function(){if(!this.options.inIframe){return this._super();}
var defAsset;if(this.options.iframeCssAssets){defAsset=ajax.loadAsset(this.options.iframeCssAssets);}else{defAsset=Promise.resolve({cssLibs:[],cssContents:[]});}
promiseWysiwyg=promiseWysiwyg||ajax.loadAsset('web_editor.wysiwyg_iframe_editor_assets');this.defAsset=Promise.all([promiseWysiwyg,defAsset]);this.$target=this.$el;const _super=this._super.bind(this);await this.defAsset;await _super();},start:async function(){const _super=this._super.bind(this);if(!this.options.inIframe){return _super();}else{await this._loadIframe();return _super();}},_editorOptions:function(){let options=this._super.apply(this,arguments);options.getContextFromParentRect=()=>{return this.$iframe&&this.$iframe.length?this.$iframe[0].getBoundingClientRect():{top:0,left:0};};return options;},_loadIframe:function(){var self=this;this.$iframe=$('<iframe class="wysiwyg_iframe">').css({'min-height':'55vh',width:'100%'});var avoidDoubleLoad=0;var def=new Promise(function(resolve){window.top[self._onUpdateIframeId]=function(_avoidDoubleLoad){if(_avoidDoubleLoad!==avoidDoubleLoad){console.warn('Wysiwyg iframe double load detected');return;}
delete window.top[self._onUpdateIframeId];var $iframeTarget=self.$iframe.contents().find('#iframe_target');const $targetClone=$iframeTarget.clone();$targetClone.find('script').remove();$iframeTarget.html($targetClone.html());self.$iframeBody=$iframeTarget;$iframeTarget.attr("isMobile",config.device.isMobile);const $utilsZone=$('<div class="iframe-utils-zone">');self.$utilsZone=$utilsZone;const $iframeWrapper=$('<div class="iframe-editor-wrapper odoo-editor">');const $codeview=$('<textarea class="o_codeview d-none"/>');self.$editable.addClass('o_editable oe_structure');$iframeTarget.append($codeview);$iframeTarget.append($iframeWrapper);$iframeTarget.append($utilsZone);$iframeWrapper.append(self.$editable);self.options.toolbarHandler=$('#web_editor-top-edit',self.$iframe[0].contentWindow.document);$iframeTarget.on('click','.o_fullscreen_btn',function(){$("body").toggleClass("o_field_widgetTextHtml_fullscreen");var full=$("body").hasClass("o_field_widgetTextHtml_fullscreen");self.$iframe.parents().toggleClass('o_form_fullscreen_ancestor',full);$(window).trigger("resize");});resolve();};});this.$iframe.data('loadDef',def);this.$iframe.on('load',function onLoad(ev){var _avoidDoubleLoad=++avoidDoubleLoad;self.defAsset.then(function(assets){if(_avoidDoubleLoad!==avoidDoubleLoad){console.warn('Wysiwyg immediate iframe double load detected');return;}
var iframeContent=qweb.render('wysiwyg.iframeContent',{assets:assets.concat(self.__extraAssetsForIframe),updateIframeId:self._onUpdateIframeId,avoidDoubleLoad:_avoidDoubleLoad});self.$iframe[0].contentWindow.document.open("text/html","replace").write(iframeContent);});self.options.document=self.$iframe[0].contentWindow.document;});this.$iframe.insertAfter(this.$editable);return def;},_insertSnippetMenu:function(){if(this.options.inIframe){return this.snippetsMenu.appendTo(this.$utilsZone);}else{return this._super.apply(this,arguments);}},});});;

/* /web_unsplash/static/src/js/unsplashapi.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('unsplash.api',function(require){'use strict';var Class=require('web.Class');var rpc=require('web.rpc');var Mixins=require('web.mixins');var ServicesMixin=require('web.ServicesMixin');var UnsplashCore=Class.extend(Mixins.EventDispatcherMixin,ServicesMixin,{init:function(parent){Mixins.EventDispatcherMixin.init.call(this,arguments);this.setParent(parent);this._cache={};this.clientId=false;},getImages:function(query,pageSize){var from=0;var to=pageSize;var cachedData=this._cache[query];if(cachedData&&(cachedData.images.length>=to||(cachedData.totalImages!==0&&cachedData.totalImages<to))){return Promise.resolve({images:cachedData.images.slice(from,to),isMaxed:to>cachedData.totalImages});}
return this._fetchImages(query).then(function(cachedData){return{images:cachedData.images.slice(from,to),isMaxed:to>cachedData.totalImages};});},_fetchImages:function(query){if(!this._cache[query]){this._cache[query]={images:[],maxPages:0,totalImages:0,pageCached:0};}
var cachedData=this._cache[query];var payload={query:query,page:cachedData.pageCached+1,per_page:30,};return this._rpc({route:'/web_unsplash/fetch_images',params:payload,}).then(function(result){if(result.error){return Promise.reject(result.error);}
cachedData.pageCached++;cachedData.images.push.apply(cachedData.images,result.results);cachedData.maxPages=result.total_pages;cachedData.totalImages=result.total;return cachedData;});},});return UnsplashCore;});;

/* /web_unsplash/static/src/js/unsplash_image_widget.js defined in bundle 'web_editor.assets_wysiwyg' */
odoo.define('web_unsplash.image_widgets',function(require){'use strict';var core=require('web.core');var UnsplashAPI=require('unsplash.api');const{UploadProgressToast}=require('@web_editor/js/wysiwyg/widgets/upload_progress_toast');var widgetsMedia=require('wysiwyg.widgets.media');const{_t}=require('web.core');var unsplashAPI=null;const originalEvents=widgetsMedia.ImageWidget.prototype.events;const clickHandler=originalEvents['click .o_existing_attachment_cell'];if(!clickHandler){throw new Error(`Couldn't find a handler for o_existing_attachment_cell clicks.
The unsplash image widget needs to prevent this handler from executing on unsplash attachments.`);}
_.extend(originalEvents,{'click .o_existing_attachment_cell:not(.o_unsplash_attachment_cell)':clickHandler,});delete originalEvents['click .o_existing_attachment_cell'];widgetsMedia.ImageWidget.include({xmlDependencies:widgetsMedia.ImageWidget.prototype.xmlDependencies.concat(['/web_unsplash/static/src/xml/unsplash_image_widget.xml']),events:_.extend({},widgetsMedia.ImageWidget.prototype.events,{'click .o_unsplash_attachment_cell[data-imgid]':'_onUnsplashImgClick','click button.save_unsplash':'_onSaveUnsplashCredentials',}),init:function(){this._super.apply(this,arguments);this._unsplash={selectedImages:{},isMaxed:false,query:false,error:false,records:[],};if(unsplashAPI===null){this.unsplashAPI=new UnsplashAPI(this);unsplashAPI=this.unsplashAPI;}else{this.unsplashAPI=unsplashAPI;this.unsplashAPI.setParent(this);}},destroy:function(){this.unsplashAPI.setParent(undefined);this._super.apply(this,arguments);},_save:async function(){const _super=this._super;const selectedImages=this._unsplash.selectedImages;const imagesCount=Object.keys(selectedImages).length;if(imagesCount){this.saved=true;await this._setUpProgressToast([{name:imagesCount>1?_.str.sprintf(_t("Uploading %s '%s' images."),imagesCount,this._unsplash.query):_.str.sprintf(_t("Uploading '%s' image."),this._unsplash.query),size:null,}]);const images=await this.uploader.rpcShowProgress({route:'/web_unsplash/attachment/add',params:{unsplashurls:selectedImages,res_model:this.options.res_model,res_id:this.options.res_id,query:this._unsplash.query,},},0);this.uploader.close(3000);this.attachments.push(...images);this.selectedAttachments.push(...images);}
return _super.apply(this,arguments);},search:async function(needle){var self=this;await this._super(...arguments);this._unsplash.query=needle;if(!needle){this._unsplash.records=[];return;}
await this.unsplashAPI.getImages(needle,this.numberOfAttachmentsToDisplay).then(function(res){self._unsplash.isMaxed=res.isMaxed;self._unsplash.records=res.images;self._unsplash.error=false;},function(err){self._unsplash.error=err;});},hasContent(){if(this.searchService==='all'){return this._super(...arguments)||(this.unsplashRecords&&this.unsplashRecords.length);}else if(this.searchService==='unsplash'){return(this.unsplashRecords&&this.unsplashRecords.length);}
return this._super(...arguments);},_highlightSelected:function(){this._super.apply(this,arguments);const $select=this.$('.o_unsplash_attachment_cell[data-imgid]').filter((i,el)=>{return $(el).data('imgid')in this._unsplash.selectedImages;}).addClass('o_we_attachment_selected');return $select;},_loadMoreImages:function(forceSearch){if(!this.$('.o_we_search').val()){return this._super(forceSearch);}
this.numberOfAttachmentsToDisplay+=10;this.search(this.$('.o_we_search').val()).then(()=>this._renderThumbnails());},_renderThumbnails:function(){this._super(...arguments);this.$('.unsplash_error').empty();if(!['all','unsplash'].includes(this.searchService)){return;}
if(this._unsplash.query&&this._unsplash.error){this.$('.unsplash_error').html(core.qweb.render('web_unsplash.dialog.error.content',{status:this._unsplash.error,}));return;}
if(['all','unsplash'].includes(this.searchService)&&this._unsplash.query&&!this._unsplash.isMaxed){this.$('.o_load_more').removeClass('d-none');this.$('.o_load_done_msg').addClass('d-none');}},_renderExisting:function(attachments){this.unsplashRecords=this._unsplash.records.map(record=>{const url=new URL(record.urls.regular);url.searchParams.set('h',2*this.MIN_ROW_HEIGHT);url.searchParams.delete('w');return Object.assign({},record,{url:url.toString(),});});return this._super(...arguments);},_selectAttachement:function(attachment,save){if(!this.options.multiImages){this._unsplash.selectedImages={};}
this._super(...arguments);},_onSaveUnsplashCredentials:function(){var self=this;var key=this.$('#accessKeyInput').val().trim();var appId=this.$('#appIdInput').val().trim();this.$('#accessKeyInput').toggleClass('is-invalid',!key);this.$('#appIdInput').toggleClass('is-invalid',!appId);if(key&&appId){if(!this.$el.find('.is-invalid').length){this._rpc({route:'/web_unsplash/save_unsplash',params:{key:key,appId:appId},}).then(function(){self.unsplashAPI.clientId=key;self._unsplash.error=false;self.search(self._unsplash.query).then(()=>self._renderThumbnails());});}}},_onUnsplashImgClick:function(ev){if(this.saved){return;}
const{imgid,url,downloadUrl,description}=ev.currentTarget.dataset;if(!this.options.multiImages){this._unsplash.selectedImages={};this.selectedAttachments=[];}
if(imgid in this._unsplash.selectedImages){delete this._unsplash.selectedImages[imgid];}else{const _1920Url=new URL(url);_1920Url.searchParams.set('w','1920');this._unsplash.selectedImages[imgid]={url:_1920Url.href,download_url:downloadUrl,description:description};}
this._highlightSelected();if(!this.options.multiImages){this.trigger_up('save_request');}},});});